<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=1024, initial-scale=1, user-scalable=no" />
  <title id="pageTitle">Sakshi Automobiles Dashboard - Combined Finance + GST + Statement (Tiranga 3D Secure) - v16 App Title Real-Time Update Fixed - 5D Tiranga Type Buttons - Custom Beep Settings - Beep Volume 200% - All Bugs Fixed</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-3d@1.0.0/dist/chartjs-plugin-3d.min.js"></script>

  <!-- jsPDF + autoTable for PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- DOMPurify for input sanitization -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

  <!-- CryptoJS for encryption -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <!-- License: This code is provided as-is for educational purposes. No warranty. -->

  <!-- Inline Styles (updated for HD 5D Tiranga, optimized, colored backgrounds, big company name, Tiranga cards, header Tiranga, remove profile bg, swap phone state, 5D Tiranga type buttons, custom beep settings, beep volume 200%, enhanced 5D dashboard cards, added 5D TRANSPARENT BUTTON style, wavy snake title animation, custom Hindu Tilak above title with enhanced symbols) -->
  <style>
    :root {
      --base-font-size: 18px;
      --currency-size: 24px;
      --input-font-size: 18px;
      --tab-font-size: 18px;
      --modal-font-size: 18px;
      --table-font-size: 16px;
      --button-font-size: 18px;
      --text-shadow-alpha: 1.0;
      --text-shadow-alpha2: 0.5;

      /* TIRANGA 5D */
      --bg-1: linear-gradient(135deg, #fff8ef 0%, #eaf6e7 50%, #f0f8ff 100%);
      --bg-2: linear-gradient(to bottom, #ff9933 0%, #ffffff 33.33%, #2345a0 33.33%, #ffffff 66.67%, #2345a0 66.67%, #2345a0 100%);
      --accent-1: #ff9933;
      --accent-2: #138808;
      --accent-3: #2345a0;
      --accent-4: #ffffff;
      --accent-5: #000000;
      --text-on-accent: #ffffff;
      --danger-color: #d92525;
      --danger-shadow: rgba(217, 37, 37, 0.25);
      --warning-color: #b95f00;
      --warning-shadow: rgba(185, 95, 0, 0.25);
      --main-text-color: #111;
      --date-color: #111;
      --invoice-color: #111;
      --days-color: #b95f00;
      --days-ago-color: #b95f00;
      --company-color: #111;
      --amount-color: #138808;
      --button-bg-color: linear-gradient(135deg, #ff9933 0%, #ffffff 33%, #2345a0 100%);
      --card-bg-color: linear-gradient(to bottom, #ff9933 33%, #ffffff 33%, #ffffff 66%, #138808 66%);
      --header-bg-color: linear-gradient(to bottom, #ff9933 33%, #ffffff 33%, #ffffff 66%, #138808 66%);
      --warning-text-color: #b95f00;
      --sl-color: #111;
      --green-5d: #138808;
      --purple-5d: #800080;
    }
    * { box-sizing: border-box; }
    html { font-size: var(--base-font-size); }
    body {
      font-family: 'Segoe UI', Inter, Arial, sans-serif;
      margin: 0; padding: 0;
      background: var(--bg-1);
      background-attachment: fixed;
      color: var(--main-text-color);
      font-size: 1rem;
      text-transform: uppercase;
      font-weight: 800;
      text-shadow: 0px 1px 0px rgba(255,255,255,.3), 0px -1px 0px rgba(0,0,0,var(--text-shadow-alpha)), 0px -2px 0px rgba(0,0,0,var(--text-shadow-alpha2)), 0px 0px 10px rgba(255,153,51,0.1);
      animation: bgShift 15s ease-in-out infinite alternate;
      filter: brightness(1.1) contrast(1.05);
    }
    @keyframes bgShift {
      0% { background-position: 0% 50%; filter: hue-rotate(0deg); }
      100% { background-position: 100% 50%; filter: hue-rotate(5deg); }
    }
    input, textarea, select, .suggestions li, #password-input, #security-answer-input {
      text-transform: uppercase;
      text-shadow: none;
      font-weight: 600;
      font-size: var(--input-font-size);
    }
    textarea {
      text-transform: none;
    }
    .modal-actions button, .lock-box button {
      text-shadow: none;
    }

    /* Wavy Snake Title Animation */
    .wavy span {
      display: inline-block;
      animation: snake-wave 2s ease-in-out infinite;
    }
    .wavy span:nth-child(1) { animation-delay: 0s; }
    .wavy span:nth-child(2) { animation-delay: 0.1s; }
    .wavy span:nth-child(3) { animation-delay: 0.2s; }
    .wavy span:nth-child(4) { animation-delay: 0.3s; }
    .wavy span:nth-child(5) { animation-delay: 0.4s; }
    .wavy span:nth-child(6) { animation-delay: 0.5s; }
    .wavy span:nth-child(7) { animation-delay: 0.6s; }
    .wavy span:nth-child(8) { animation-delay: 0.7s; }
    .wavy span:nth-child(9) { animation-delay: 0.8s; }
    .wavy span:nth-child(10) { animation-delay: 0.9s; }
    .wavy span:nth-child(11) { animation-delay: 1.0s; }
    .wavy span:nth-child(12) { animation-delay: 1.1s; }
    .wavy span:nth-child(13) { animation-delay: 1.2s; }
    .wavy span:nth-child(14) { animation-delay: 1.3s; }
    .wavy span:nth-child(15) { animation-delay: 1.4s; }
    .wavy span:nth-child(16) { animation-delay: 1.5s; }
    .wavy span:nth-child(17) { animation-delay: 1.6s; }
    .wavy span:nth-child(18) { animation-delay: 1.7s; }
    .wavy span:nth-child(19) { animation-delay: 1.8s; }
    .wavy span:nth-child(20) { animation-delay: 1.9s; }
    .wavy span:nth-child(21) { animation-delay: 2.0s; }
    .wavy span:nth-child(22) { animation-delay: 2.1s; }
    .wavy span:nth-child(23) { animation-delay: 2.2s; }
    .wavy span:nth-child(24) { animation-delay: 2.3s; }
    .wavy span:nth-child(25) { animation-delay: 2.4s; }
    /* Add more if needed for longer text */
    @keyframes snake-wave {
      0%, 100% { transform: translateY(0); }
      50% { transform: scale(1.05) translateY(-5px); }
    }

    /* Custom Hindu Tilak Above Title */
    #hinduTilak {
      display: none;
      text-align: center;
      font-size: 3em;
      color: #ffd700; /* Golden color */
      margin-bottom: 10px;
      animation: tilakGlow 4s ease-in-out infinite alternate;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.5);
    }
    @keyframes tilakGlow {
      0% { text-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
      100% { text-shadow: 0 0 30px rgba(255, 215, 0, 1.0), 0 0 50px rgba(255, 215, 0, 0.7); }
    }

    /* LOCK SCREEN 5D TIRANGA */
    #lockScreen {
      position: fixed;
      inset: 0;
      background: var(--bg-2);
      background-attachment: fixed;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: lockPulse 10s ease-in-out infinite alternate;
      filter: brightness(1.05) contrast(1.1);
      box-shadow: inset 0 0 100px rgba(255,153,51,0.3), inset 0 0 100px rgba(19,136,8,0.2), inset 0 0 100px rgba(35,69,160,0.2);
    }
    @keyframes lockPulse {
      0% { filter: brightness(1.05) contrast(1.1) hue-rotate(0deg); }
      100% { filter: brightness(1.15) contrast(1.2) hue-rotate(10deg); }
    }
    .lock-box {
      background: linear-gradient(to bottom, #ff9933 33%, #ffffff 33%, #ffffff 66%, #138808 66%);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5), 0 10px 25px rgba(255,153,51,0.3), 0 8px 20px rgba(19,136,8,0.2), 0 6px 15px rgba(35,69,160,0.2);
      border: 4px solid var(--accent-3);
      text-align: center;
      max-width: 400px;
      width: 90%;
      min-height: 300px;
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      animation: lockFloat 6s ease-in-out infinite alternate;
    }
    @keyframes lockFloat {
      0% { transform: translateY(0) scale(1); }
      100% { transform: translateY(-20px) scale(1.02); }
    }
    .lock-box h2 {
      color: var(--accent-3);
      margin-bottom: 20px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5), 0 0 20px rgba(255,255,51,0.5);
    }
    .lock-box input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 2px solid var(--accent-3);
      border-radius: 10px;
      font-size: 1.2em;
      text-align: center;
      background: rgba(255,255,255,0.8);
    }
    .lock-box button {
      margin-top: 20px;
      padding: 12px 24px;
      background: var(--accent-2);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1.2em;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(19,136,8,0.4);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .lock-box button:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(19,136,8,0.6);
    }
    .lock-box .error {
      color: var(--danger-color);
      margin-top: 10px;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    .lock-box .forget-btn {
      background: var(--accent-3);
      margin-left: 10px;
    }

    /* SIDEBAR (Windows 10 like, HD 5D) */
    .sidebar {
      width: 220px;
      background: linear-gradient(180deg, var(--accent-3) 0%, var(--accent-2) 100%);
      box-shadow: 4px 0 25px var(--shadow-blue), 0 0 20px rgba(255,153,51,0.1);
      padding: 20px 0;
      position: fixed;
      height: 100vh;
      left: 0;
      top: 0;
      z-index: 1000;
      animation: slideInLeft 1.5s ease-out;
      transition: transform 0.4s ease;
      filter: drop-shadow(0 0 10px var(--accent-3));
    }
    @keyframes slideInLeft {
      from { transform: translateX(-100%) scale(0.95); }
      to { transform: translateX(0) scale(1); }
    }
    .sidebar.hidden { transform: translateX(-100%); }
    .sidebar .app-title {
      color: var(--text-on-accent);
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.4em;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5), 0 0 10px rgba(255,255,255,0.3);
      animation: titleGlow 3s ease-in-out infinite alternate;
    }
    @keyframes titleGlow {
      0% { text-shadow: 1px 1px 3px rgba(0,0,0,0.5), 0 0 10px rgba(255,255,255,0.3); }
      100% { text-shadow: 1px 1px 3px rgba(0,0,0,0.5), 0 0 20px rgba(255,255,255,0.6); }
    }
    .sidebar .tab-btn {
      display: block;
      width: 100%;
      background: transparent;
      color: var(--text-on-accent);
      border: none;
      padding: 14px 20px;
      margin-bottom: 10px;
      text-align: left;
      cursor: pointer;
      font-weight: 700;
      font-size: var(--tab-font-size);
      transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
      text-shadow: none;
      border-radius: 0;
      position: relative;
    }
    .sidebar .tab-btn:hover {
      background: rgba(255,255,255,0.2);
      transform: translateX(8px) scale(1.02);
      box-shadow: 0 0 15px rgba(255,255,255,0.2);
    }
    .sidebar .tab-btn.active {
      background: var(--accent-1);
      color: var(--accent-3);
      box-shadow: inset 0 0 15px rgba(255,153,51,0.5), 0 0 10px rgba(255,153,51,0.3);
    }

    /* Hamburger Menu for Mobile - Disabled */
    .hamburger {
      display: none !important;
    }

    /* MAIN CONTENT AREA */
    .main-content {
      margin-left: 220px;
      width: calc(100% - 220px);
      padding: 20px;
      transition: margin-left 0.5s ease;
      animation: fadeIn 1s ease-out;
      filter: brightness(1.02);
      position: relative;
    }
    @keyframes fadeIn {
      0% { opacity: 0; transform: translateY(20px) scale(0.98); }
      100% { transform: translateY(0) scale(1); opacity: 1; }
    }

    /* BACK BUTTON */
    #backBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      background: var(--accent-3);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: var(--button-font-size);
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 15px var(--shadow-blue), 0 0 10px rgba(255,153,51,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      display: none;
      z-index: 1001;
    }
    #backBtn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px var(--shadow-blue), 0 0 15px rgba(255,153,51,0.2);
    }

    /* CARDS - Enhanced 5D Design */
    .card {
      background: var(--card-bg-color);
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 15px 40px var(--shadow-blue), 0 5px 15px var(--shadow-saffron), 0 5px 15px var(--shadow-green), 0 0 20px rgba(255,153,51,0.1);
      border-left: 6px solid var(--accent-3);
      position: relative;
      z-index: 1;
      margin-bottom: 20px;
      transition: box-shadow 0.3s ease-in-out, transform 0.3s ease, filter 0.3s;
      animation: cardFadeIn 1s ease-out;
      backdrop-filter: blur(5px);
      perspective: 1000px; /* Added for 5D */
    }
    @keyframes cardFadeIn {
      0% { opacity: 0; transform: translateY(20px) scale(0.95); box-shadow: none; }
      100% { opacity: 1; transform: translateY(0) scale(1); box-shadow: 0 15px 40px var(--shadow-blue), 0 5px 15px var(--shadow-saffron), 0 5px 15px var(--shadow-green), 0 0 20px rgba(255,153,51,0.1); }
    }
    .card.editing-highlight {
        box-shadow: 0 0 0 4px var(--accent-3), 0 15px 40px var(--shadow-blue);
    }
    .header-card {
      padding: 18px 22px;
      margin-bottom: 14px;
      background: var(--header-bg-color);
      border-left: 10px solid var(--accent-1);
      box-shadow: 0 4px 15px var(--shadow-saffron), 0 0 10px rgba(255,153,51,0.2);
    }
    /* BIG COMPANY NAME */
    .header-card h3 {
      font-size: 3em;
      margin: 0;
      text-align: center;
      color: var(--accent-3);
      text-shadow: 3px 3px 6px rgba(0,0,0,0.7), 0 0 30px rgba(255,255,51,0.8);
    }

    .cards-grid { display: grid; grid-template-columns: repeat(1,1fr); gap: 16px; margin-bottom: 20px; }
    @media(min-width:700px) { .cards-grid { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); } }
    .summary-card {
      border-radius: 20px;
      padding: 18px;
      background: var(--card-bg-color);
      border-left: 5px solid var(--accent-2);
      box-shadow: 0 12px 30px var(--shadow-blue), 0 8px 20px var(--shadow-saffron), 0 6px 15px var(--shadow-green), 0 0 15px rgba(255,153,51,0.1);
      transition: transform .15s, box-shadow .15s, filter 0.3s;
      animation: cardFloat 8s ease-in-out infinite alternate;
      backdrop-filter: blur(3px);
      position: relative;
      overflow: hidden;
      perspective: 1000px; /* Added for 5D */
      transform-style: preserve-3d; /* Added for 5D */
    }
    @keyframes cardFloat {
      0% { transform: translateY(0) scale(1) rotateX(0deg); }
      100% { transform: translateY(-12px) scale(1.01) rotateX(1deg); }
    }
    .summary-card:hover { 
      transform: translateY(-6px) scale(1.03) rotateX(5deg) rotateY(5deg); 
      box-shadow: 0 20px 45px var(--shadow-blue), 0 12px 30px var(--shadow-saffron), 0 10px 25px var(--shadow-green), 0 0 20px rgba(255,153,51,0.2); 
      filter: brightness(1.1); 
    }
    .summary-card::before { /* Added for 5D depth */
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 50%, rgba(0,0,0,0.05) 100%);
      pointer-events: none;
      z-index: 1;
    }
    .summary-card .card-icon { 
      font-size: 4rem; 
      margin-bottom: 8px; 
      animation: iconBounce 3s ease-in-out infinite; 
      position: relative; 
      z-index: 2; 
      transform: translateZ(20px); /* Added for 5D */
    }
    @keyframes iconBounce {
      0%, 100% { transform: scale(1) translateZ(20px); }
      50% { transform: scale(1.15) translateZ(25px); }
    }
    .summary-card p { 
      margin:0; 
      color: var(--accent-3); 
      font-weight:600; 
      font-size:1rem; 
      position: relative; 
      z-index: 2; 
      transform: translateZ(10px); /* Added for 5D */
    }
    .summary-card h2 { 
      margin:7px 0; 
      font-size:1.5rem; 
      color: var(--accent-1); 
      text-shadow:0 1px 5px #fff6, 0 2px 8px var(--shadow-blue), 0 0 10px rgba(255,153,51,0.2); 
      animation: textGlow 5s ease-in-out infinite alternate; 
      position: relative; 
      z-index: 2; 
      transform: translateZ(15px); /* Added for 5D */
    }
    @keyframes textGlow {
      0% { text-shadow: 0 1px 5px #fff6, 0 2px 15px var(--shadow-blue); }
      100% { text-shadow: 0 1px 10px #fff6, 0 2px 15px var(--shadow-blue), 0 0 15px rgba(255,153,51,0.3); }
    }
    .card-sl {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 1rem;
      font-weight: 600;
      text-shadow: 0px 1px 0px rgba(255,255,255,.3), 0px -1px 0px rgba(0,0,0,var(--text-shadow-alpha)), 0px -2px 0px rgba(0,0,0,var(--text-shadow-alpha2)), 0px 0px 8px rgba(128,0,128,0.3);
      z-index: 2;
      transform: translateZ(5px); /* Added for 5D */
    }
    .card-entries {
      position: absolute;
      top: 35%;
      right: 10px;
      transform: translateY(-50%) translateZ(10px); /* Added for 5D */
      font-size: 1rem;
      font-weight: 600;
      text-shadow: 0px 1px 0px rgba(255,255,255,.3), 0px -1px 0px rgba(0,0,0,var(--text-shadow-alpha)), 0px -2px 0px rgba(0,0,0,var(--text-shadow-alpha2)), 0px 0px 8px rgba(128,0,128,0.3);
      z-index: 2;
    }

    .grid-two { display:grid; grid-template-columns:1fr; gap:16px; margin-bottom:20px; }
    @media(min-width:900px) { .grid-two { grid-template-columns: 1fr 400px; } }

    canvas { width:100% !important; height:240px !important; background:#f1f6fa; border-radius:12px; box-shadow:0 4px 15px var(--shadow-blue), 0 0 10px rgba(255,153,51,0.1); animation: chartPulse 6s ease-in-out infinite; }
    @keyframes chartPulse {
      0%, 100% { box-shadow: 0 4px 15px var(--shadow-blue); }
      50% { box-shadow: 0 6px 25px var(--shadow-blue), 0 8px 35px var(--shadow-green); }
    }
    .table-wrap { overflow:auto; }
    table { width:100%; border-collapse:collapse; margin-top:8px; font-size: var(--table-font-size); background:transparent; }
    thead th { background: var(--accent-3); color: var(--text-on-accent); padding:12px; font-weight:800; border-bottom:3px solid var(--accent-1); position:sticky; top:0; z-index: 10; text-shadow:none; }
    tbody td { background:#fff; padding:12px; border-bottom:1px solid #e8eaef; text-align:left; }
    tbody tr:hover td { background: #f7fafc; animation: rowHighlight 0.4s ease; }
    @keyframes rowHighlight {
      0% { background: #f7fafc; }
      100% { background: #e0f7fa; }
    }
    .no-results-row td { text-align: center; padding: 20px; font-style: italic; color: #7a869a; background: #fdfdff !important; }

    .currency { font-size: var(--currency-size); font-weight:900; color: var(--amount-color); text-shadow: 0 1px 4px #fff5, 0 2px 8px var(--shadow-green), 0 0 8px rgba(255,153,51,0.1); }
    .currency::after { content: '.'; }
    .muted { color: var(--accent-3); font-size:0.9rem; font-weight:600; }
    .card-title { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap:12px; flex-wrap: wrap; }
    .card-title .badge { background: #e9effc; border-color: #d1ddf1; color: var(--accent-3); font-weight: bold; }

    .gst-legend { margin-top:10px; font-size:16px; color: var(--accent-3); }
    .gst-legend-item { display:flex; gap:8px; align-items:center; }
    .legend-color { width:14px; height:14px; display:inline-block; border-radius:4px; }

    .gst-summary { margin-top:10px; padding:10px; background:#f7faff; border-radius:10px; border:1px solid #eef2f7; font-weight:700; color: var(--accent-2); text-align:center; }

    .gst-controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:8px; }
    .summary { display:flex; flex-wrap:wrap; gap:20px; margin-top:12px; }
    .payment-summary { margin-top:12px; color: var(--accent-2); }

    .controls-row, .filter-row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .filter-row { margin: 12px 0; padding: 12px; background: #f7faff; border-radius: 10px; border: 1px solid #eef2f7; }

    .statement-form { display:grid; grid-template-columns: repeat(2, minmax(240px,1fr)); gap:12px; }
    @media (max-width:700px){ .statement-form { grid-template-columns: 1fr; } }
    .statement-actions { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .badge.ok { background:#e8fff0; border-color:#bde5cd; color:#0f7a3a; }
    .badge.warn { background:#fff6e5; border-color:#ffe0ad; color:#9a5e00; }
    .lookup-form { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    @media (max-width: 600px) { .lookup-form { grid-template-columns: 1fr; } }
    .lookup-result { padding: 14px; border: 1px solid #e2e8f0; border-radius: 10px; background: #f7fafc; }

    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid var(--text-on-accent);
      border-radius: 50%;
      width: 18px; height: 18px;
      display: inline-block;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .btn-spinner {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        display: none;
    }
    button.loading .btn-spinner { display: block; }
    button.loading .btn-text { visibility: hidden; }

    .autocomplete { position: relative; display:inline-block; min-width:240px; }
    .autocomplete input { width: 280px; max-width: 100%; padding-right:8px; }
    .suggestions {
      position: absolute;
      z-index: 9999;
      left: 0; right: 0;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-top: none;
      max-height: 240px;
      overflow: auto;
      box-shadow: 0 8px 30px rgba(35,69,160,0.08), 0 0 15px rgba(255,153,51,0.1);
      list-style: none;
      margin: 0;
      padding: 4px 0;
      display: none;
    }
    .suggestions[aria-hidden="false"] { display: block; }
    .suggestions li {
      padding: 10px 14px;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #1a2633;
    }
    .suggestions li:hover,
    .suggestions li.active {
      background: #f1f6ff;
      color: #2345a0;
    }

    .pagination-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin-top: 16px;
    }
    .pagination-btn {
        padding: 8px 14px;
        border-radius: 8px;
        border: 1px solid #dde3ea;
        background: #fff;
        cursor: pointer;
        font-weight: 600;
        color: var(--accent-3);
        text-shadow: none;
    }
    .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .pagination-btn.active {
        background: var(--accent-3);
        color: #fff;
        border-color: var(--accent-3);
    }

    .toast {
      position: fixed; right: 18px; bottom: 18px;
      background: #0b8b3a; color:#fff; padding:12px 16px; border-radius:12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18), 0 0 15px rgba(255,153,51,0.1);
      opacity: 0; transform: translateY(12px); transition: all .2s ease;
      z-index: 9999;
      text-shadow: none;
    }
    .toast.show { opacity: 1; transform: translateY(0px); }

    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 12000;
      align-items: center; justify-content: center; padding: 20px;
    }
    .modal {
      width: 100%; max-width: 1000px;
      background: #fff; border-radius: 14px; padding: 20px;
      box-shadow: 0 25px 70px rgba(0,0,0,0.35), 0 0 20px rgba(255,153,51,0.1);
      max-height: 90vh; overflow: auto;
      font-size: var(--modal-font-size);
      role: dialog;
      aria-modal: true;
    }
    .modal h3, .modal h4 { margin:0 0 10px 0; color: var(--accent-3); }
    .modal h4 { margin-top: 15px; border-bottom: 1px solid var(--accent-3); padding-bottom: 5px; }
    .share-section { border: 1px solid #f1f3f5; padding: 12px; border-radius: 10px; margin-bottom: 8px; background:#fbfdfb;}
    .share-row { display:flex; justify-content:space-between; gap:12px; align-items:center; padding:6px 0; border-bottom:1px dashed #f2f4f6;}
    .share-row:last-child { border-bottom:none; }
    .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    .small-muted { font-size:0.9rem; color:#6b7786; }

    .reminder-card { border-left-color: var(--accent-1); }
    .reminder-item { padding: 10px 0; border-bottom: 1px dashed #eee; }
    .reminder-item:last-child { border-bottom: none; }
    .reminder-item strong { color: var(--accent-2); }
    .reminder-item .date-tag { font-weight: bold; color: var(--danger-color); }
    .no-reminders { color: #7a869a; font-style: italic; }

    .action-group {
        display: flex;
        gap: 8px;
        justify-content: flex-start;
        align-items: center;
    }
    .action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 20px;
        color: white;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        background: linear-gradient(135deg, #ff9933 0%, #ffffff 50%, #2345a0 100%);
        box-shadow: 0 4px 15px rgba(255,153,51,0.3), 0 2px 8px rgba(255,255,255,0.5), 0 0 10px rgba(35,69,160,0.8);
        transition: transform 0.2s, box-shadow 0.2s;
        min-width: 65px;
        text-align: center;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
    }
    .action-btn:active {
        transform: translateY(2px);
        box-shadow: 0 2px 8px rgba(255,153,51,0.5);
    }
    .action-btn.view {
        background: linear-gradient(135deg, #ff9933 0%, #ffffff 50%, #2345a0 100%);
        box-shadow: 0 4px 15px rgba(255,153,51,0.3), 0 2px 8px rgba(255,255,255,0.5), 0 0 10px rgba(35,69,160,0.8);
    }
    .action-btn.edit {
        background: linear-gradient(135deg, #ff9933 0%, #ffffff 50%, #2345a0 100%);
        box-shadow: 0 4px 15px rgba(255,153,51,0.3), 0 2px 8px rgba(255,255,255,0.5), 0 0 10px rgba(35,69,160,0.8);
        color: white;
    }
    .action-btn.delete {
        background: linear-gradient(135deg, #ff9933 0%, #ffffff 50%, #2345a0 100%);
        box-shadow: 0 4px 15px rgba(255,153,51,0.3), 0 2px 8px rgba(255,255,255,0.5), 0 0 10px rgba(35,69,160,0.8);
    }

    /* Updated button styles for primary and ghost to be 5D TIRANGA type */
    button, .primary, .ghost {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        background: linear-gradient(135deg, #ff9933 0%, #ffffff 33%, #2345a0 100%);
        color: white;
        font-weight: 700;
        font-size: var(--button-font-size);
        cursor: pointer;
        box-shadow: 0 6px 20px rgba(255,153,51,0.4), 0 4px 12px rgba(255,255,255,0.6), 0 0 15px rgba(35,69,160,0.9);
        transition: transform 0.2s, box-shadow 0.2s;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
    }
    button:hover, .primary:hover, .ghost:hover {
        transform: scale(1.05) translateY(-2px);
        box-shadow: 0 8px 25px rgba(255,153,51,0.5), 0 6px 15px rgba(255,255,255,0.7), 0 0 20px rgba(35,69,160,1.0);
    }
    button:active, .primary:active, .ghost:active {
        transform: translateY(1px);
        box-shadow: 0 4px 12px rgba(255,153,51,0.6);
    }
    .ghost {
        background: linear-gradient(135deg, #ff9933 0%, #ffffff 33%, #2345a0 100%);
        color: white;
    }

    /* New Button Style: 5D STYLE TRANSPARENT */
    [data-button-style="transparent"] button,
    [data-button-style="transparent"] .primary,
    [data-button-style="transparent"] .ghost {
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255,153,51,0.5);
        color: var(--accent-3);
        box-shadow: 0 6px 20px rgba(255,153,51,0.2), 0 4px 12px rgba(255,255,255,0.3), 0 0 15px rgba(35,69,160,0.5);
        text-shadow: none;
    }
    [data-button-style="transparent"] button:hover,
    [data-button-style="transparent"] .primary:hover,
    [data-button-style="transparent"] .ghost:hover {
        background: rgba(255,255,255,0.2);
        border-color: rgba(255,153,51,0.7);
        box-shadow: 0 8px 25px rgba(255,153,51,0.3), 0 6px 15px rgba(255,255,255,0.4), 0 0 20px rgba(35,69,160,0.7);
    }

    /* New Button Style: Uiverse Button 1 (absoluteSTrange) */
    [data-button-style="uiverse-absolute-strange"] button,
    [data-button-style="uiverse-absolute-strange"] .primary,
    [data-button-style="uiverse-absolute-strange"] .ghost {
        background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.05) 100%);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.2);
        color: rgba(255,255,255,0.9);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.1), inset 0 -1px 0 rgba(0,0,0,0.1);
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        position: relative;
    }
    [data-button-style="uiverse-absolute-strange"] button::before,
    [data-button-style="uiverse-absolute-strange"] .primary::before,
    [data-button-style="uiverse-absolute-strange"] .ghost::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
        opacity: 0;
        transition: opacity 0.3s;
    }
    [data-button-style="uiverse-absolute-strange"] button:hover::before,
    [data-button-style="uiverse-absolute-strange"] .primary:hover::before,
    [data-button-style="uiverse-absolute-strange"] .ghost:before {
        opacity: 1;
    }
    [data-button-style="uiverse-absolute-strange"] button:hover,
    [data-button-style="uiverse-absolute-strange"] .primary:hover,
    [data-button-style="uiverse-absolute-strange"] .ghost:hover {
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.25) 50%, rgba(255,255,255,0.1) 100%);
        box-shadow: 0 6px 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.2), inset 0 -1px 0 rgba(0,0,0,0.2);
        transform: translateY(-1px);
    }

    /* New Button Style: Uiverse Button 2 (absoluteSTrange) */
    [data-button-style="uiverse-button-2"] button,
    [data-button-style="uiverse-button-2"] .primary,
    [data-button-style="uiverse-button-2"] .ghost {
        background: linear-gradient(135deg, rgba(0,0,0,0.05) 0%, rgba(255,255,255,0.1) 50%, rgba(0,0,0,0.05) 100%);
        backdrop-filter: blur(15px);
        border: 2px solid rgba(255,255,255,0.3);
        color: rgba(255,255,255,0.95);
        box-shadow: 0 8px 30px rgba(0,0,0,0.4), 0 4px 15px rgba(255,255,255,0.2), inset 0 1px 0 rgba(255,255,255,0.3);
        text-shadow: 0 1px 3px rgba(0,0,0,0.7);
        position: relative;
        overflow: hidden;
    }
    [data-button-style="uiverse-button-2"] button::before,
    [data-button-style="uiverse-button-2"] .primary::before,
    [data-button-style="uiverse-button-2"] .ghost::before {
        content: '';
        position: absolute;
        top: -50%; left: -50%; right: -50%; bottom: -50%;
        background: conic-gradient(from 0deg, transparent 0deg, rgba(255,255,255,0.1) 180deg, transparent 360deg);
        animation: rotate 4s linear infinite;
        opacity: 0;
        transition: opacity 0.3s;
    }
    [data-button-style="uiverse-button-2"] button:hover::before,
    [data-button-style="uiverse-button-2"] .primary:hover::before,
    [data-button-style="uiverse-button-2"] .ghost:before {
        opacity: 1;
    }
    [data-button-style="uiverse-button-2"] button:hover,
    [data-button-style="uiverse-button-2"] .primary:hover,
    [data-button-style="uiverse-button-2"] .ghost:hover {
        background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0.2) 100%);
        border-color: rgba(255,255,255,0.5);
        box-shadow: 0 10px 40px rgba(0,0,0,0.5), 0 6px 20px rgba(255,255,255,0.3), inset 0 1px 0 rgba(255,255,255,0.4);
        transform: translateY(-2px) scale(1.02);
    }
    @keyframes rotate {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* New Button Style: 5D TRANSPARENT BUTTON */
    [data-button-style="5d-transparent-button"] button,
    [data-button-style="5d-transparent-button"] .primary,
    [data-button-style="5d-transparent-button"] .ghost {
        background: rgba(255,255,255,0.05);
        backdrop-filter: blur(25px);
        border: 3px solid transparent;
        background-clip: padding-box;
        border-image: linear-gradient(135deg, rgba(255,153,51,0.8), rgba(255,255,255,0.5), rgba(35,69,160,0.8)) 1;
        color: rgba(255,255,255,0.9);
        box-shadow: 0 10px 30px rgba(255,153,51,0.3), 0 5px 15px rgba(255,255,255,0.4), 0 0 20px rgba(35,69,160,0.6);
        text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        position: relative;
        overflow: hidden;
        transform: perspective(1000px) rotateX(0deg);
    }
    [data-button-style="5d-transparent-button"] button::before,
    [data-button-style="5d-transparent-button"] .primary::before,
    [data-button-style="5d-transparent-button"] .ghost::before {
        content: '';
        position: absolute;
        top: -100%; left: -100%; right: -100%; bottom: -100%;
        background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.2) 50%, transparent 70%);
        animation: shimmer 3s ease-in-out infinite;
        opacity: 0.7;
    }
    [data-button-style="5d-transparent-button"] button:hover::before,
    [data-button-style="5d-transparent-button"] .primary:hover::before,
    [data-button-style="5d-transparent-button"] .ghost:before {
        opacity: 1;
    }
    [data-button-style="5d-transparent-button"] button:hover,
    [data-button-style="5d-transparent-button"] .primary:hover,
    [data-button-style="5d-transparent-button"] .ghost:hover {
        background: rgba(255,255,255,0.15);
        border-image: linear-gradient(135deg, rgba(255,153,51,1), rgba(255,255,255,0.8), rgba(35,69,160,1)) 1;
        box-shadow: 0 15px 40px rgba(255,153,51,0.5), 0 8px 25px rgba(255,255,255,0.6), 0 0 30px rgba(35,69,160,0.8);
        transform: perspective(1000px) rotateX(-5deg) scale(1.05) translateY(-3px);
        color: rgba(255,255,255,1);
    }
    @keyframes shimmer {
        0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    @media (max-width:900px) {
      .cards-grid { grid-template-columns: repeat(2,1fr); }
      :root { --currency-size: 20px; }
    }
    .speech-controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 16px;
        margin-top: 12px;
    }

    #g-summary-container {
        margin-top: 20px;
        padding: 14px;
        background-color: #f7faff;
        border: 1px solid #eef2f7;
        border-radius: 10px;
        font-size: 1.1rem;
        line-height: 1.6;
    }
    #g-summary-container .summary-line {
        margin-bottom: 8px;
        font-weight: bold;
    }
    #g-summary-container .summary-line .currency {
        font-size: 1.2rem;
    }
    #g-summary-container .rate-block {
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px dashed #dde3ea;
    }
    #g-summary-container .rate-block:last-of-type {
        border-bottom: none;
    }

    #tax-rate-list {
        list-style: none;
        padding: 0;
        margin-top: 10px;
    }
    #tax-rate-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #f0f0f0;
    }

    .delete-rate, .edit-company, .delete-company, .edit-section, .delete-section, .edit-dashboard-card, .delete-dashboard-card {
        color: var(--danger-color);
        background: transparent;
        border: none;
        cursor: pointer;
        font-weight: bold;
        margin-left: 8px;
        text-shadow: none;
    }
    .edit-company, .edit-section, .edit-dashboard-card { color: var(--accent-3); }

    .accordion-header {
      cursor: pointer;
      padding: 12px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #f0f3f7;
    }
    .accordion-header::after {
      content: '‚ñº';
      font-size: 0.9em;
      transition: transform 0.2s;
      text-shadow: none;
    }
    .modal-content {
      max-height: 90vh;
      overflow-y: auto;
    }
    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out, padding 0.3s ease-out;
      padding: 0 10px;
    }
    .accordion-item.active .accordion-header::after {
      transform: rotate(180deg);
    }
    .accordion-item.active .accordion-content {
      padding: 18px 10px;
      max-height: 2200px;
      transition: max-height 0.5s ease-in, padding 0.5s ease-in;
    }

    .text-3d {
      font-weight: 800;
      color: var(--sl-color);
      text-shadow: 0px 1px 0px rgba(255,255,255,.3), 0px -1px 0px rgba(0,0,0,var(--text-shadow-alpha)), 0px -2px 0px rgba(0,0,0,var(--text-shadow-alpha2)), 0px 0px 8px rgba(255,153,51,0.1);
    }
    .text-3d-yellow {
      font-weight: 800;
      color: #b95f00;
      text-shadow: 0px 1px 0px rgba(255,230,150,0.4), 0px -1px 0px rgba(80,50,0,0.6), 0px -2px 0px rgba(80,50,0,0.2), 0px 0px 6px rgba(255,153,51,0.1);
    }
    .text-3d-red {
      font-weight: 800;
      color: var(--danger-color);
      text-shadow: 0px 1px 0px rgba(255,150,150,0.4), 0px -1px 0px rgba(0,0,0,0.6), 0px -2px 0px rgba(0,0,0,0.2), 0px 0px 6px rgba(255,153,51,0.1);
    }
    .text-3d-blue {
      font-weight: 800;
      color: var(--accent-3);
      text-shadow: 0px 1px 0px rgba(150,180,255,0.4), 0px -1px 0px rgba(0,20,80,0.6), 0px -2px 0px rgba(0,20,80,0.2), 0px 0px 6px rgba(255,153,51,0.1);
    }
    .text-3d-orange {
      font-weight: 800;
      color: var(--danger-color);
      text-shadow: 0px 1px 0px rgba(255,200,100,0.4), 0px -1px 0px rgba(90,50,0,0.6), 0px -2px 0px rgba(90,50,0,0.2), 0px 0px 6px rgba(255,153,51,0.1);
    }
    .text-3d-purple {
      font-weight: 800;
      color: var(--purple-5d);
      text-shadow: 0px 1px 0px rgba(200,150,255,0.4), 0px -1px 0px rgba(50,0,50,0.6), 0px -2px 0px rgba(50,0,0,0.2), 0px 0px 6px rgba(255,153,51,0.1);
    }
    .text-3d-green {
      font-weight: 800;
      color: var(--green-5d);
      text-shadow: 0px 1px 0px rgba(150,255,150,0.4), 0px -1px 0px rgba(0,80,0,0.6), 0px -2px 0px rgba(0,80,0,0.2), 0px 0px 6px rgba(255,153,51,0.1);
    }

    /* Custom classes for date and invoice */
    .date-text {
      color: var(--date-color);
    }
    .invoice-text {
      color: var(--invoice-color);
    }
    .days-text {
      font-weight: 800;
      color: var(--days-color);
      text-shadow: 0px 1px 0px rgba(255,255,255,.3), 0px -1px 0px rgba(0,0,0,var(--text-shadow-alpha)), 0px -2px 0px rgba(0,0,0,var(--text-shadow-alpha2));
    }
    .days-ago-text {
      font-weight: 800;
      color: var(--days-ago-color);
      text-shadow: 0px 1px 0px rgba(255,255,255,.3), 0px -1px 0px rgba(0,0,0,var(--text-shadow-alpha)), 0px -2px 0px rgba(0,0,0,var(--text-shadow-alpha2));
    }
    .company-text {
      color: var(--company-color);
    }
    .warning-text {
      color: var(--warning-text-color);
    }

    @media print {
      body { padding: 0; background: #fff; text-transform: uppercase; text-shadow: none; }
      .no-print, .sidebar, #settingsSection, #dashboardSection, #statementSection:not(.printing),
      #financeApp:not(.printing), #gstApp:not(.printing), #purchaseBillReportSection:not(.printing),
      #companyReportSection:not(.printing) { display: none !important; }

      .card { box-shadow: none; border: 1px solid #ccc; border-radius: 0; }
      .finance-header, .statement-header { margin: 0 0 8px 0; }
      .printing { display: block !important; }
      .printing .filter-row, .printing .pagination-controls, .printing .action-group, .printing .card-title .controls-row { display: none !important; }
    }

    /* Security settings in settings (added back for lock screen) */
    .security-settings {
        display: block;
    }
    /* Profile display in dashboard */
    .profile-info {
        margin-top: 10px;
        padding: 10px;
        border-radius: 10px;
        font-size: 0.9rem;
        text-align: center;
    }
    .profile-info p {
        margin: 2px 0;
        text-transform: none;
    }
    .profile-info .profile-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
    }

    /* Loading overlay for heavy operations */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10001;
      display: none;
    }
    .loading-overlay.show { display: flex; }
    .loading-overlay .spinner { width: 50px; height: 50px; border-width: 6px; }

    /* Edit Payment Grid Layout */
    #f-editPaymentDetails .controls-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
    #f-editPaymentDetails .controls-row > * {
        grid-column: span 1;
    }
    #f-editPaymentDetails .controls-row > :nth-child(1),
    #f-editPaymentDetails .controls-row > :nth-child(2),
    #f-editPaymentDetails .controls-row > :nth-child(3),
    #f-editPaymentDetails .controls-row > :nth-child(4) {
        grid-column: span 1;
    }
    #f-editPaymentDetails .controls-row > :nth-child(5),
    #f-editPaymentDetails .controls-row > :nth-child(6) {
        grid-column: span 1;
    }
    /* Custom styles for select and input */
    #f-editPaymentSelect {
        min-width: 500px;
        width: auto;
    }
    #f-editPaymentCompany {
        width: auto;
        min-width: 200px;
    }
    #f-editPaymentDetails input, #f-editPaymentDetails select {
        width: auto;
        min-width: 200px;
    }
  </style>
</head>
<body>
  <!-- LOCK SCREEN 5D TIRANGA -->
  <div id="lockScreen">
    <div class="lock-box">
      <h2>üîí SECURE LOCK</h2>
      <p style="font-size: 0.8em; color: #b95f00;">‚ö†Ô∏è Password stored in browser (not secure). Use server-side for production.</p>
      <input type="password" id="password-input" placeholder="ENTER PASSWORD" aria-label="Enter Password" />
      <div>
        <button id="unlock-btn" aria-label="Unlock Application">UNLOCK</button>
        <button id="forget-btn" class="forget-btn" aria-label="Forget Password">FORGET PASSWORD?</button>
      </div>
      <div id="lock-error" class="error"></div>
    </div>
  </div>

  <!-- Hamburger Menu for Mobile - Disabled -->
  <!-- <button class="hamburger" id="hamburgerBtn">‚ò∞</button> -->

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div id="hinduTilak">‡•ê</div>
    <h1 class="app-title" id="typed-title"></h1>
    <button id="tabDashboard" class="tab-btn active" title="Dashboard" aria-current="page">1. üìä DASHBOARD</button>
    <button id="tabFinance" class="tab-btn inactive" title="Finance App">2. üí∞ FINANCE</button>
    <button id="tabStatement" class="tab-btn inactive" title="Statements">3. üìÑ STATEMENT</button>
    <button id="tabReports" class="tab-btn inactive" title="Reports & Navigation">4. üìä REPORTS</button>
    <button id="tabSettings" class="tab-btn inactive" title="Settings" aria-label="Settings">5. ‚öôÔ∏è SETTINGS</button>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content">
    <!-- BACK BUTTON -->
    <button id="backBtn" aria-label="Back to Previous Section">üîô BACK</button>

    <!-- DASHBOARD -->
    <section id="dashboardSection">
      <div class="card header-card">
        <div class="card-title">
          <div>
            <h3 id="companyTitle" style="margin:0; text-align: center;">SAKSHI AUTOMOBILES</h3>
            <div id="profileInfo" class="profile-info no-print">
              <p><strong>Address:</strong> <span id="displayAddress"></span></p>
              <p><strong>GSTIN:</strong> <span id="displayGstin"></span></p>
              <div class="profile-row">
                <p><strong>Phone:</strong> <span id="displayPhone"></span></p>
                <p><strong>State Code:</strong> <span id="displayStateCode"></span></p>
              </div>
              <div class="profile-row">
                <p><strong>Email:</strong> <span id="displayEmail"></span></p>
                <p><strong>Website:</strong> <span id="displayWebsite"></span></p>
              </div>
            </div>
            <p class="muted" id="companyDetails" style="margin:2px 0 0 0;">QUICK OVERVIEW OF YOUR BUSINESS METRICS</p>
          </div>
          <div class="controls-row no-print">
              <button id="refreshAll" aria-label="Refresh Data">Refresh</button>
          </div>
        </div>
      </div>

      <!-- Dashboard Filters -->
      <div class="filter-row" id="dashboardFilters">
        <label for="dashboardFromDate">From: <input type="date" id="dashboardFromDate" aria-label="Dashboard From Date"></label>
        <label for="dashboardToDate">To: <input type="date" id="dashboardToDate" aria-label="Dashboard To Date"></label>
        <label for="dashboardCompanyFilter">Company: <select id="dashboardCompanyFilter" aria-label="Dashboard Company Filter"><option value="">All Companies</option></select></label>
        <button class="ghost reset-filters" id="resetDashboardFilters" aria-label="Reset Dashboard Filters">Reset Filters</button>
      </div>

      <div class="cards-grid" id="dashboardCards"></div>

      <!-- QUICK SEARCH CARD -->
      <div class="card" id="quickSearchCard">
        <h3>Quick Search</h3>
        <form class="controls-row" id="quickSearchForm">
          <label for="quickSearchInvoice">Invoice No: <input type="text" id="quickSearchInvoice" placeholder="Enter Invoice No" /></label>
          <label for="quickSearchCheck">Check No: <input type="text" id="quickSearchCheck" placeholder="Enter Check No" /></label>
          <button type="submit" class="primary">Search</button>
          <button type="reset" class="ghost">Reset Filters</button>
        </form>
        <div id="quickSearchResult" style="margin-top: 10px;"></div>
      </div>

      <div class="grid-two">
        <div class="card">
          <div class="card-title"><strong>SALES OVER TIME</strong><span class="muted" id="salesSub"></span></div>
          <canvas id="salesChart" aria-label="Sales chart" role="img"></canvas>
        </div>
        <div class="card">
          <div class="card-title"><strong>GST BREAKDOWN</strong><span class="muted" id="gstSub"></span></div>
          <canvas id="gstChart" aria-label="GST breakdown" role="img"></canvas>
          <div id="gstSummary" class="gst-summary"></div>
        </div>
      </div>
    </section>

    <!-- FINANCE APP -->
    <section id="financeApp">
      <h2 class="card finance-header no-print">Finance Management App</h2>

      <section id="f-invoiceCard" class="card no-print">
        <h3>Add / Edit Invoice</h3>
        <form id="f-invoiceForm" class="controls-row" autocomplete="off">
          <label for="f-invoiceNo">Invoice No: <input type="text" id="f-invoiceNo" required aria-label="Invoice Number"></label>
          <p id="f-invoiceExistMsg" class="muted" aria-live="polite" style="margin:0;"></p>

          <label for="f-companyName">Company Name:
            <div class="autocomplete" style="display:inline-block;">
              <input type="text" id="f-companyName" required placeholder="Select or type company name" aria-autocomplete="list" aria-haspopup="listbox" aria-label="Company Name" />
              <ul id="companyNameSuggestions" class="suggestions" role="listbox" aria-hidden="true"></ul>
            </div>
          </label>

          <label for="f-invoiceAmount">Invoice Amount: <input type="number" id="f-invoiceAmount" min="0" step="0.01" required aria-label="Invoice Amount"></label>
          <label for="f-invoiceDate">Invoice Date: <input type="date" id="f-invoiceDate" required aria-label="Invoice Date"></label>
          <input type="hidden" id="f-editingInvoice" value="">
          <button type="submit" id="f-invoiceSubmitBtn" class="primary" title="Save Invoice" aria-label="Save Invoice">
            <span class="btn-text">Save Invoice</span>
            <span class="btn-spinner"><span class="spinner"></span></span>
          </button>
          <button type="reset" class="ghost" title="Clear Form" aria-label="Clear Invoice Form">CLEAR</button>
        </form>
      </section>

      <section id="f-paymentCard" class="card no-print">
        <h3>Add Payment</h3>
        <form id="f-paymentForm" class="controls-row">
          <label for="f-paymentType">Payment Type:
            <select id="f-paymentType" aria-label="Payment Type">
              <option value="check">CHECK PAYMENT</option>
              <option value="cash">CASH PAYMENT</option>
              <option value="online">ONLINE PAYMENT</option>
              <option value="batan">MULTIPLE CHECK PAYMENT</option>
              <option value="multi_cash">MULTIPLE CASH PAYMENT</option>
              <option value="multi_online">MULTIPLE ONLINE PAYMENT</option>
              <option value="credit">CREDIT NOTE</option>
            </select>
          </label>
          <div id="f-checkDetails" class="controls-row">
              <label for="f-checkNo">Check No: <input type="text" id="f-checkNo" placeholder="Enter check number" aria-label="Check Number"></label>
          </div>
          <div id="f-creditDetails" class="controls-row" style="display:none;">
              <label for="f-creditNoteNo">Credit Note No: <input type="text" id="f-creditNoteNo" placeholder="Enter credit note number" aria-label="Credit Note Number"></label>
          </div>
          <div id="f-batanDetails" class="controls-row" style="display:none;">
              <label for="f-batanInvoices">MULTIPLE CHECK PAYMENT: <textarea id="f-batanInvoices" placeholder="INV001,INV002" aria-label="Mult Invoice Check"></textarea></label>
          </div>
          <div id="f-multiCashDetails" class="controls-row" style="display:none;">
              <label for="f-multiCashInvoices">MULTIPLE CASH PAYMENT: <textarea id="f-multiCashInvoices" placeholder="INV001,INV002" aria-label="Mult Cash Payment"></textarea></label>
          </div>
          <div id="f-multiOnlineDetails" class="controls-row" style="display:none;">
              <label for="f-multiOnlineInvoices">MULTIPLE ONLINE PAYMENT: <textarea id="f-multiOnlineInvoices" placeholder="INV001,INV002" aria-label="Mult Online Payment"></textarea></label>
          </div>
          <label for="f-paymentAmount">Amount: <input type="number" id="f-paymentAmount" min="0" step="0.01" required aria-label="Payment Amount"></label>
          <label for="f-paymentDate">Date: <input type="date" id="f-paymentDate" required aria-label="Payment Date"></label>
          <label for="f-paymentInvoiceNo" id="f-paymentInvoiceNoLabel">Invoice No: <input type="text" id="f-paymentInvoiceNo" placeholder="Link to which invoice?" required aria-label="Invoice Number for Payment"></label>
          <p id="f-invoicePaymentInfo" class="muted" aria-live="polite" style="margin:0;"></p>
          <p id="f-checkDuplicateMsg" class="muted" aria-live="polite" style="margin:0;"></p>
          <button type="submit" class="primary" title="Add Payment" aria-label="Add Payment">Add Payment</button>
          <button type="reset" class="ghost" title="Clear Form" aria-label="Clear Payment Form">CLEAR</button>
        </form>
      </section>

      <!-- Edit Payment Section Added Here -->
      <section id="f-editPaymentCard" class="card no-print">
        <h3>Edit Payment</h3>
        <form id="f-editPaymentForm" class="controls-row">
          <label for="f-editPaymentSelect">Select Payment to Edit:
            <select id="f-editPaymentSelect" aria-label="Select Payment to Edit">
              <option value="">Select a payment</option>
            </select>
          </label>
          <label for="f-editPaymentSearch">Search by Invoice No: <input type="text" id="f-editPaymentSearch" placeholder="Enter invoice no" aria-label="Search Payments by Invoice No"></label>
          <button class="ghost reset-filters" aria-label="Reset Edit Payment Filters">Reset Filters</button>
          <div id="f-editPaymentDetails" style="display:none;">
            <div class="controls-row">
              <label for="f-editPaymentSL">SL: <input type="text" id="f-editPaymentSL" readonly aria-label="Payment SL"></label>
              <label for="f-editPaymentType">Payment Type:
                <select id="f-editPaymentType" aria-label="Edit Payment Type">
                  <option value="check">CHECK PAYMENT</option>
                  <option value="cash">CASH PAYMENT</option>
                  <option value="online">ONLINE PAYMENT</option>
                  <option value="batan">MULTIPLE CHECK PAYMENT</option>
                  <option value="multi_cash">MULTIPLE CASH PAYMENT</option>
                  <option value="multi_online">MULTIPLE ONLINE PAYMENT</option>
                  <option value="credit">CREDIT NOTE</option>
                </select>
              </label>
              <label for="f-editCheckNo">Check No: <input type="text" id="f-editCheckNo" placeholder="Enter check number" aria-label="Edit Check Number"></label>
              <label for="f-editCreditNoteNo">Credit Note No: <input type="text" id="f-editCreditNoteNo" placeholder="Enter credit note number" aria-label="Edit Credit Note Number"></label>
              <label for="f-editPaymentAmount">Amount: <input type="number" id="f-editPaymentAmount" min="0" step="0.01" required aria-label="Edit Payment Amount"></label>
              <label for="f-editPaymentDate">Date: <input type="date" id="f-editPaymentDate" required aria-label="Edit Payment Date"></label>
              <label for="f-editPaymentInvoiceNo">Invoice No: <input type="text" id="f-editPaymentInvoiceNo" placeholder="Link to which invoice?" required aria-label="Edit Invoice Number for Payment"></label>
              <label for="f-editPaymentCompany">Company Name: <input type="text" id="f-editPaymentCompany" readonly aria-label="Company Name" placeholder="Company name"></label>
            </div>
            <input type="hidden" id="f-editingPaymentId" value="">
            <button type="submit" class="primary" title="Update Payment" aria-label="Update Payment">Update Payment</button>
            <button type="reset" class="ghost" title="Clear Form" aria-label="Clear Edit Payment Form">CLEAR</button>
          </div>
        </form>
      </section>

      <section class="card" aria-live="polite" data-print-area="f-reportCard">
        <div class="card-title">
          <h3>Invoice & Payment Report</h3>
          <div class="controls-row no-print">
              <span id="f-inv-filter-indicator" class="badge" style="display:none;">FILTERS ACTIVE</span>
              <button class="ghost print-section-btn" data-target="f-reportCard" aria-label="Print Report">üñ®Ô∏è PRINT</button>
              <button class="ghost" onclick="exportFinanceReportToPdf('invoices', false)" aria-label="Download PDF">DOWNLOAD PDF</button>
              <button class="ghost" onclick="openShareModal()" aria-label="Share Report">SHARE OPTION</button>
          </div>
        </div>
        <div class="filter-row" data-filter-group="invoices">
          <label for="f-inv-fromDate">From: <input type="date" id="f-inv-fromDate" aria-label="From Date"></label>
          <label for="f-inv-toDate">To: <input type="date" id="f-inv-toDate" aria-label="To Date"></label>
          <label for="f-inv-companyFilter">Company: <select id="f-inv-companyFilter" aria-label="Company Filter"><option value="">All Companies</option></select></label>
          <label for="f-statusFilter">Status:
            <select id="f-statusFilter" aria-label="Status Filter">
              <option value="all">ALL</option>
              <option value="paid">PAID</option>
              <option value="partial">PARTIAL</option>
              <option value="pending">PENDING</option>
            </select>
          </label>
          <label for="f-searchBox">Search:
            <input type="text" id="f-searchBox" placeholder="Invoice No" aria-label="Search Invoice">
          </label>
          <button class="ghost reset-filters" aria-label="Reset Filters">Reset Filters</button>
        </div>
        <div class="table-wrap">
          <table id="f-reportTable" role="table">
            <thead>
              <tr>
                <th scope="col">SL</th><th scope="col">Invoice No</th><th scope="col">Company Name</th><th scope="col">Invoice Amount</th><th scope="col">Invoice Date</th>
                <th scope="col">Total Paid</th><th scope="col">Remaining</th><th scope="col">Status</th><th scope="col">Details</th><th scope="col" class="no-print">ACTIONS</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="pagination-controls" id="f-reportPagination"></div>
        <div class="summary" style="margin-top:10px;">
          <div><strong>TOTAL INVOICE AMOUNT:</strong> <span class="currency" id="f-totalInvoiceAmount">0</span></div>
          <div><strong>TOTAL PAID:</strong> <span class="currency" id="f-totalPaid">0</span></div>
          <div><strong>TOTAL REMAINING:</strong> <span class="currency" id="f-totalRemaining">0</span></div>
        </div>
      </section>

      <section id="f-returnCard" class="card no-print">
        <h3>Add / Edit Return Item</h3>
        <form id="f-returnForm" class="controls-row" autocomplete="off">
          <label for="f-returnCompanyName">Company Name:
            <div class="autocomplete" style="display:inline-block;">
              <input type="text" id="f-returnCompanyName" required placeholder="Select or type company" aria-label="Return Company Name" />
              <ul id="returnCompanyNameSuggestions" class="suggestions" role="listbox" aria-hidden="true"></ul>
            </div>
          </label>
          <label for="f-returnItemName">Item Name: <input type="text" id="f-returnItemName" required aria-label="Item Name"></label>
          <label for="f-returnQuantity">Quantity: <input type="number" id="f-returnQuantity" min="1" step="1" required aria-label="Quantity"></label>
          <label for="f-returnMrp">MRP: <input type="number" id="f-returnMrp" min="0" step="0.01" required aria-label="MRP"></label>
          <label for="f-returnCreditNoteNo">Credit Note No: <input type="text" id="f-returnCreditNoteNo" placeholder="Enter credit note number" aria-label="Credit Note Number"></label>
          <label for="f-returnDate">Return Date: <input type="date" id="f-returnDate" required aria-label="Return Date"></label>
          <input type="hidden" id="f-editingReturnId" value="">
          <button type="submit" id="f-returnSubmitBtn" class="primary" title="Save Return Item" aria-label="Save Return">
            <span class="btn-text">Save Return</span>
            <span class="btn-spinner"><span class="spinner"></span></span>
          </button>
          <button type="reset" class="ghost" title="Clear Form" aria-label="Clear Return Form">CLEAR</button>
        </form>
      </section>

      <section class="card" data-print-area="f-returnReportCard">
        <div class="card-title">
            <h3>Return Items Report</h3>
            <div class="controls-row no-print">
              <span id="f-return-filter-indicator" class="badge" style="display:none;">FILTERS ACTIVE</span>
              <button class="ghost print-section-btn" data-target="f-returnReportCard" aria-label="Print Return Report">üñ®Ô∏è PRINT</button>
              <button class="ghost" onclick="exportReturnsToPdf(false)" aria-label="Download Return PDF">DOWNLOAD PDF</button>
              <button class="ghost" onclick="openShareModal()" aria-label="Share Return Report">SHARE OPTION</button>
            </div>
        </div>
         <div class="filter-row" data-filter-group="returns">
          <label for="f-return-fromDate">From: <input type="date" id="f-return-fromDate" aria-label="Return From Date"></label>
          <label for="f-return-toDate">To: <input type="date" id="f-return-toDate" aria-label="Return To Date"></label>
          <label for="f-return-companyFilter">Company: <select id="f-return-companyFilter" aria-label="Return Company Filter"><option value="">All Companies</option></select></label>
          <button class="ghost reset-filters" aria-label="Reset Return Filters">Reset Filters</button>
        </div>
        <div class="table-wrap">
          <table id="f-returnTable" role="table">
            <thead>
              <tr><th scope="col">SL</th><th scope="col">Company Name</th><th scope="col">Item Name</th><th scope="col">Quantity</th><th scope="col">MRP</th><th scope="col">Total</th><th scope="col">Credit Note No</th><th scope="col">Return Date</th><th scope="col">Status</th><th scope="col" class="no-print">ACTIONS</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="pagination-controls" id="f-returnPagination"></div>
        <div class="summary" style="margin-top:10px;">
          <div><strong>TOTAL RETURN AMOUNT (MRP):</strong> <span class="currency" id="f-totalReturnAmount">0</span></div>
        </div>
      </section>
      <section id="f-defectiveCheckCard" class="card no-print">
        <h3>Log Defective Check</h3>
        <form id="f-defectiveCheckForm" class="controls-row">
            <label for="f-defectiveCheckNo">Check No: <input type="text" id="f-defectiveCheckNo" required aria-label="Defective Check Number"></label>
            <label for="f-defectiveCheckDate">Date: <input type="date" id="f-defectiveCheckDate" required aria-label="Defective Check Date"></label>
            <input type="hidden" id="f-editingDefectiveCheckId" value="">
            <button type="submit" id="f-defectiveCheckSubmitBtn" class="primary" title="Log Defective Check" aria-label="Log Defective Check">
              <span class="btn-text">Log Check</span>
              <span class="btn-spinner"><span class="spinner"></span></span>
            </button>
            <button type="reset" class="ghost" title="Clear Form" aria-label="Clear Defective Check Form">CLEAR</button>
        </form>
      </section>

      <section class="card" data-print-area="f-defectiveCheckReportCard">
          <div class="card-title">
            <h3>Defective Checks Report</h3>
            <div class="controls-row no-print">
              <span id="f-defective-filter-indicator" class="badge" style="display:none;">FILTERS ACTIVE</span>
              <button class="ghost print-section-btn" data-target="f-defectiveCheckReportCard" aria-label="Print Defective Checks">üñ®Ô∏è PRINT</button>
              <button class="ghost" onclick="exportDefectiveChecksToPdf(false)" aria-label="Download Defective Checks PDF">DOWNLOAD PDF</button>
              <button class="ghost" onclick="openShareModal()" aria-label="Share Defective Checks">SHARE OPTION</button>
            </div>
          </div>
          <div class="filter-row" data-filter-group="defectiveChecks">
            <label for="f-defective-fromDate">From: <input type="date" id="f-defective-fromDate" aria-label="Defective From Date"></label>
            <label for="f-defective-toDate">To: <input type="date" id="f-defective-toDate" aria-label="Defective To Date"></label>
            <button class="ghost reset-filters" aria-label="Reset Defective Filters">Reset Filters</button>
          </div>
          <div class="table-wrap">
              <table id="f-defectiveCheckTable" role="table">
                  <thead>
                      <tr><th scope="col">SL</th><th scope="col">Check No</th><th scope="col">Date Logged</th><th scope="col" class="no-print">ACTIONS</th></tr>
                  </thead>
                  <tbody id="f-defectiveCheckTableBody"></tbody>
              </table>
          </div>
          <div class="pagination-controls" id="f-defectiveCheckPagination"></div>
      </section>

      <section id="f-expenseCard" class="card no-print">
        <h3>Add Expense (Purchase)</h3>
        <form id="f-expenseForm" class="controls-row">
          <label for="f-expenseName">Expense Name: <input type="text" id="f-expenseName" required aria-label="Expense Name"></label>
          <label for="f-expenseAmount">Amount: <input type="number" id="f-expenseAmount" min="0" step="0.01" required aria-label="Expense Amount"></label>
          <label for="f-expenseDate">Date: <input type="date" id="f-expenseDate" required aria-label="Expense Date"></label>
          <label for="f-expensePaymentType">Payment Type:
            <select id="f-expensePaymentType" aria-label="Expense Payment Type">
              <option value="cash">CASH</option>
              <option value="online">ONLINE</option>
              <option value="pending">PENDING</option>
              <option value="lic">LIC</option>
            </select>
          </label>
          <input type="hidden" id="f-editingExpenseId" value="">
          <button type="submit" id="f-expenseSubmitBtn" class="primary" title="Add Expense" aria-label="Add Expense">
            <span class="btn-text">Add Expense</span>
            <span class="btn-spinner"><span class="spinner"></span></span>
          </button>
          <button type="reset" class="ghost" title="Clear Form" aria-label="Clear Expense Form">CLEAR</button>
        </form>
      </section>

      <section class="card" data-print-area="f-expenseReportCard">
        <div class="card-title">
          <h3>Expense Report</h3>
           <div class="controls-row no-print">
              <span id="f-exp-filter-indicator" class="badge" style="display:none;">FILTERS ACTIVE</span>
              <button class="ghost print-section-btn" data-target="f-expenseReportCard" aria-label="Print Expense Report">üñ®Ô∏è PRINT</button>
              <button class="ghost" onclick="exportFinanceReportToPdf('expenses', false)" aria-label="Download Expense PDF">DOWNLOAD PDF</button>
              <button class="ghost" onclick="openShareModal()" aria-label="Share Expense Report">SHARE OPTION</button>
          </div>
        </div>
        <div class="filter-row" data-filter-group="expenses">
          <label for="f-exp-fromDate">From: <input type="date" id="f-exp-fromDate" aria-label="Expense From Date"></label>
          <label for="f-exp-toDate">To: <input type="date" id="f-exp-toDate" aria-label="Expense To Date"></label>
          <label for="f-expenseSearchBox">Search:
              <input type="text" id="f-expenseSearchBox" placeholder="Search expense name" aria-label="Expense Search">
          </label>
          <button class="ghost reset-filters" aria-label="Reset Expense Filters">Reset Filters</button>
        </div>
        <div class="table-wrap">
          <table id="f-expenseTable" role="table">
            <thead>
              <tr><th scope="col">SL</th><th scope="col">Expense Name</th><th scope="col">Amount</th><th scope="col">Date</th><th scope="col">Payment Type</th><th scope="col" class="no-print">ACTIONS</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="pagination-controls" id="f-expensePagination"></div>
        <div class="summary" style="margin-top:10px;">
          <div><strong>TOTAL EXPENSE AMOUNT:</strong> <span class="currency" id="f-totalExpenseAmount">0</span></div>
        </div>
      </section>

      <section id="f-incomeCard" class="card no-print">
        <h3>Add Income</h3>
        <form id="f-incomeForm" class="controls-row">
          <label for="f-incomeAmount">Amount: <input type="number" id="f-incomeAmount" min="0" step="0.01" required aria-label="Income Amount"></label>
          <label for="f-incomeDate">Date: <input type="date" id="f-incomeDate" required aria-label="Income Date"></label>
          <label for="f-incomePaymentType">Payment Type:
            <select id="f-incomePaymentType" aria-label="Income Payment Type">
              <option value="cash">CASH</option>
              <option value="online">ONLINE</option>
            </select>
          </label>
          <input type="hidden" id="f-editingIncomeId" value="">
          <button type="submit" id="f-incomeSubmitBtn" class="primary" title="Add Income" aria-label="Add Income">
            <span class="btn-text">Add Income</span>
            <span class="btn-spinner"><span class="spinner"></span></span>
          </button>
          <button type="reset" class="ghost" title="Clear Form" aria-label="Clear Income Form">CLEAR</button>
        </form>
      </section>

      <section class="card" data-print-area="f-incomeReportCard">
        <div class="card-title">
          <h3>Income Report</h3>
          <div class="controls-row no-print">
              <span id="f-inc-filter-indicator" class="badge" style="display:none;">FILTERS ACTIVE</span>
               <button class="ghost print-section-btn" data-target="f-incomeReportCard" aria-label="Print Income Report">üñ®Ô∏è PRINT</button>
              <button class="ghost" onclick="exportFinanceReportToPdf('income', false)" aria-label="Download Income PDF">DOWNLOAD PDF</button>
              <button class="ghost" onclick="openShareModal()" aria-label="Share Income Report">SHARE OPTION</button>
          </div>
        </div>
        <div class="filter-row" data-filter-group="income">
          <label for="f-inc-fromDate">From: <input type="date" id="f-inc-fromDate" aria-label="Income From Date"></label>
          <label for="f-inc-toDate">To: <input type="date" id="f-inc-toDate" aria-label="Income To Date"></label>
          <button class="ghost reset-filters" aria-label="Reset Income Filters">Reset Filters</button>
        </div>
        <div class="table-wrap">
          <table id="f-incomeTable" role="table">
            <thead><tr><th scope="col">SL</th><th scope="col">Amount</th><th scope="col">Date</th><th scope="col">Payment Type</th><th scope="col" class="no-print">ACTIONS</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="pagination-controls" id="f-incomePagination"></div>
        <div class="summary" style="margin-top:10px;">
          <div><strong>TOTAL INCOME AMOUNT:</strong> <span class="currency" id="f-totalIncomeAmount">0</span></div>
        </div>
      </section>

      <section class="card no-print">
        <div class="card-title">
          <h3>Charts</h3>
        </div>
        <div class="grid-two">
          <div class="card">
            <strong>Income vs Expenses (by month)</strong>
            <canvas id="incExpChart" aria-label="Income vs Expenses Chart" role="img"></canvas>
          </div>
          <div class="card">
            <strong>Cashflow Trend (monthly)</strong>
            <canvas id="cashflowChart" aria-label="Cashflow Chart" role="img"></canvas>
          </div>
        </div>
      </section>
    </section>

    <!-- GST APP -->
    <section id="gstApp">
      <div id="g-gstCard" class="card gst-container" data-print-area="g-gstCard">
        <div class="card-title" style="align-items:flex-start;">
          <h2 style="margin:0; color: var(--accent-3);">GST BILLING SYSTEM</h2>
          <div class="controls-row no-print">
              <span id="g-gst-filter-indicator" class="badge" style="display:none;">FILTERS ACTIVE</span>
              <button class="ghost print-section-btn" data-target="g-gstCard" aria-label="Print GST Report">üñ®Ô∏è PRINT</button>
              <button class="ghost" onclick="exportGstToPdf(false)" aria-label="Download GST PDF">DOWNLOAD PDF</button>
              <button class="ghost" onclick="openShareModal()" aria-label="Share GST Report">SHARE OPTION</button>
          </div>
        </div>

        <div class="gst-controls no-print">
          <label for="g-amount">Amount:<input type="number" id="g-amount" aria-label="GST Amount"></label>
          <label for="g-taxRate">Tax %:<select id="g-taxRate" aria-label="GST Tax Rate"></select></label>
          <label for="g-mode">Mode:<select id="g-mode" aria-label="GST Mode"><option value="without">Without Tax</option><option value="with">With Tax</option></select></label>
          <label for="g-paymentMode">Payment:<select id="g-paymentMode" aria-label="GST Payment Mode"><option value="cash">CASH</option><option value="online">ONLINE</option></select></label>
          <button id="g-addBtn" class="primary" title="Add GST Item" aria-label="Add GST Item">
            <span class="btn-text">Add</span>
            <span class="btn-spinner"><span class="spinner"></span></span>
          </button>
          <button type="reset" class="ghost" title="Clear Form" aria-label="Clear GST Form">CLEAR</button>
        </div>

        <div class="filter-row" data-filter-group="gst">
          <label for="g-gst-fromDate">From: <input type="date" id="g-gst-fromDate" aria-label="GST From Date"></label>
          <label for="g-gst-toDate">To: <input type="date" id="g-gst-toDate" aria-label="GST To Date"></label>
          <label for="g-gst-paymentFilter">Payment: <select id="g-gst-paymentFilter" aria-label="GST Payment Filter"><option value="all">ALL</option><option value="cash">CASH</option><option value="online">ONLINE</option></select></label>
          <label for="g-gst-taxFilter">Tax Rate: <select id="g-gst-taxFilter" aria-label="GST Tax Filter"></select></label>
          <button class="ghost reset-filters" aria-label="Reset GST Filters">Reset Filters</button>
        </div>

        <div class="table-wrap">
          <table id="g-billingTable">
            <thead>
              <tr>
                <th scope="col">SL</th><th scope="col">Date</th><th scope="col">Amount</th><th scope="col">Tax%</th><th scope="col">SGST</th><th scope="col">CGST</th><th scope="col">Grand Total</th><th scope="col">Payment</th><th scope="col" class="no-print">Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="pagination-controls" id="g-billingPagination"></div>
        <div id="g-summary-container"></div>
      </div>
    </section>

    <!-- TOTAL PURCHASE BILL REPORT -->
    <section id="purchaseBillReportSection">
        <div class="card no-print">
            <h2 class="card finance-header">TOTAL PURCHASE BILL INVOICE AMOUNT REPORT</h2>
            <div class="filter-row">
                <label for="purchase-bill-from-date">From: <input type="date" id="purchase-bill-from-date" aria-label="Purchase Bill From Date"></label>
                <label for="purchase-bill-to-date">To: <input type="date" id="purchase-bill-to-date" aria-label="Purchase Bill To Date"></label>
                <label for="purchase-bill-company-filter">Company: <select id="purchase-bill-company-filter" aria-label="Purchase Bill Company Filter"><option value="">All Companies</option></select></label>
                <button id="purchase-bill-generate" class="primary" aria-label="Generate Purchase Bill Report">
                  <span class="btn-text">Generate Report</span>
                  <span class="btn-spinner"><span class="spinner"></span></span>
                </button>
                <button type="reset" class="ghost" title="Clear Form" aria-label="Clear Purchase Bill Form">CLEAR</button>
            </div>
        </div>
        <div class="card" id="purchase-bill-results-card" style="display:none;" data-print-area="purchase-bill-results-card">
            <div class="card-title">
              <h3 id="purchase-bill-title"></h3>
              <div class="controls-row no-print">
                  <button class="ghost print-section-btn" data-target="purchase-bill-results-card" aria-label="Print Purchase Bill">üñ®Ô∏è PRINT</button>
                  <button class="ghost" onclick="exportPurchaseBillReportToPdf(false)" aria-label="Download Purchase Bill PDF">DOWNLOAD PDF</button>
                  <button class="ghost" onclick="openShareModal()" aria-label="Share Purchase Bill">SHARE OPTION</button>
              </div>
            </div>
            <div class="table-wrap">
              <table id="purchaseBillReportTable">
                <thead>
                  <tr>
                    <th scope="col">SL</th><th scope="col">Invoice No.</th><th scope="col">Company Name</th><th scope="col">Invoice Amount</th><th scope="col">Invoice Date</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                    <tr><td colspan="3" style="text-align:right;font-weight:bold;">TOTAL INVOICE AMOUNT:</td><td id="purchaseBillReportTotal" style="font-weight:bold;"></td><td></td></tr>
                </tfoot>
              </table>
            </div>
        </div>
    </section>

    <!-- COMPANY TRANSACTIONS REPORT -->
    <section id="companyReportSection">
        <div class="card no-print">
            <h2 class="card finance-header">COMPANY TRANSACTIONS REPORT</h2>
            <div class="filter-row">
                <label for="company-report-select">Company: <select id="company-report-select" aria-label="Company Select"><option value="">SELECT A COMPANY</option></select></label>
                <button id="company-generate" class="primary" aria-label="Generate Company Report">
                  <span class="btn-text">VIEW REPORT</span>
                  <span class="btn-spinner"><span class="spinner"></span></span>
                </button>
                <button type="reset" class="ghost" title="Clear Form" aria-label="Clear Company Report Form">CLEAR</button>
            </div>
        </div>
        <div class="card" id="company-results-card" style="display:none;" data-print-area="company-results-card">
            <div class="card-title">
              <h3 id="company-title"></h3>
              <div class="controls-row no-print">
                  <button class="ghost print-section-btn" data-target="company-results-card" aria-label="Print Company Report">üñ®Ô∏è PRINT</button>
                  <button class="ghost" onclick="exportCompanyReportToPdf(false)" aria-label="Download Company PDF">DOWNLOAD PDF</button>
                  <button class="ghost" onclick="openShareModal()" aria-label="Share Company Report">SHARE OPTION</button>
              </div>
            </div>
            <div class="cards-grid" id="company-summary-cards"></div>
            <div class="table-wrap" style="margin-top:20px;">
              <h4 style="margin-bottom:8px;">ALL TRANSACTIONS</h4>
              <table id="companyReportTable">
                <thead>
                  <tr>
                    <th scope="col">SL</th>
                    <th scope="col">DATE</th>
                    <th scope="col">INVOICE NO.</th>
                    <th scope="col">DETAILS</th>
                    <th scope="col">AMOUNT</th>
                    <th scope="col">STATUS</th>
                    <th scope="col">DETAILS</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
        </div>
    </section>

    <!-- REPORTS SECTION -->
    <section id="reportsSection">
      <div class="card">
        <h2 class="card finance-header">üìä REPORTS & NAVIGATION</h2>
        <div class="controls-group" style="flex-wrap: wrap;">
            <button class="primary" id="navToGst" aria-label="Navigate to GST Report">GST REPORT</button>
            <button class="primary" id="navToPurchaseBill" aria-label="Navigate to Purchase Bill Report">PURCHASE BILL REPORT</button>
            <button class="primary" id="navToCompany" aria-label="Navigate to Company Report">COMPANY REPORT</button>
        </div>
        <p class="muted" style="margin-top:10px;">Quickly jump to different report sections.</p>
      </div>
    </section>

    <!-- STATEMENT APP -->
    <section id="statementSection">
      <div id="remindersSection" class="card reminder-card no-print">
        <h3 style="margin-top:0;">üîî ALL WAYS CHECK REMINDERS</h3>
        <div class="controls-row no-print" style="margin-bottom:10px;">
          <button id="filterUpcomingReminders" class="primary" aria-label="Filter Upcoming Check Reminders">TODAY'S CHECK REMINDERS</button>
          <button id="filterComingReminders" class="primary" aria-label="Filter All Coming Check Reminders">COMING CHECK REMINDER</button>
          <button id="filterOverdueReminders" class="primary" aria-label="Filter Overdue Check Reminders">OVERDUE CHECK REMINDER</button>
        </div>
        <div id="remindersList"></div>
      </div>

      <div id="pendingBillsSection" class="card reminder-card no-print">
          <h3 style="margin-top:0;">‚è∞ PENDING BILL REMINDERS</h3>
          <div id="pendingBillsList"></div>
      </div>

      <div id="returnRemindersSection" class="card reminder-card no-print">
          <h3 style="margin-top:0;">üì¶ RETURN ITEMS REMINDERS</h3>
          <div id="returnRemindersList"></div>
      </div>

      <div class="card no-print">
        <h3 class="statement-header" style="margin-top:0;">Lookup Details</h3>
        <form class="lookup-form" id="lookupForm">
            <div>
              <label for="lookupInvoiceNo">Search by Invoice No.</label>
              <input type="text" id="lookupInvoiceNo" placeholder="Enter Invoice No." aria-label="Lookup Invoice Number" />
            </div>
            <div>
              <label for="lookupCheckNo">Search by Check No.</label>
              <input type="text" id="lookupCheckNo" placeholder="Enter Check No." aria-label="Lookup Check Number" />
            </div>
        </form>
        <button id="lookupBtn" class="primary" title="Find Details" aria-label="Lookup">üîç Search</button>
        <button type="reset" class="ghost" title="Clear Form" aria-label="Clear Lookup Form">CLEAR</button>
        <div id="lookupResult" class="lookup-result" style="margin-top: 15px;">
            <p class="muted">Enter an invoice or check number to search.</p>
        </div>
      </div>

      <div class="card" data-print-area="stmPreviewCard">
        <div class="card-title">
          <div>
            <h3 class="statement-header" style="margin:0;">Statement Generator</h3>
            <p class="muted no-print" style="margin:2px 0 0 0;">Create and print statements</p>
          </div>
          <div class="statement-actions no-print">
            <button id="stmGenerate" class="primary" title="Generate Statement" aria-label="Generate Statement">
              <span class="btn-text">Generate</span>
              <span class="btn-spinner"><span class="spinner"></span></span>
            </button>
            <button id="stmPrint" class="ghost" title="Print Statement" aria-label="Print Statement">üñ® PRINT</button>
            <button id="stmExportPdf" class="ghost" title="Export Statement to PDF" aria-label="Export Statement PDF">DOWNLOAD PDF</button>
            <button id="stmWhatsapp" class="ghost" title="Share on WhatsApp" aria-label="Share Statement">SHARE OPTION</button>
          </div>
        </div>

        <form class="statement-form no-print" id="stmForm" autocomplete="off">
          <label for="stmName">Company Name
            <div class="autocomplete">
                <input type="text" id="stmName" placeholder="Company name to filter for" aria-autocomplete="list" aria-haspopup="listbox" aria-label="Statement Company Name" />
                <ul id="stmNameSuggestions" class="suggestions" role="listbox" aria-hidden="true"></ul>
            </div>
          </label>
          <label for="stmEmail">Email
            <input type="email" id="stmEmail" placeholder="name@email.com" aria-label="Statement Email" />
          </label>
          <label for="stmFrom">From Date
            <input type="date" id="stmFrom" aria-label="Statement From Date" />
          </label>
          <label for="stmTo">Upto Date
            <input type="date" id="stmTo" aria-label="Statement To Date" />
          </label>
          <label for="stmType">Statement Type
            <select id="stmType" aria-label="Statement Type">
              <option value="combined">COMBINED (ALL)</option>
              <option value="invoices">INVOICES</option>
              <option value="payments">PAYMENTS</option>
              <option value="returns">RETURN ITEMS</option>
              <option value="defectiveChecks">DEFECTIVE CHECKS</option>
              <option value="expenses">EXPENSES</option>
              <option value="income">INCOME</option>
              <option value="gst">GST LINES</option>
              <option value="pending">PENDING INVOICES</option>
            </select>
          </label>
        </form>

        <div id="stmPreviewContainer" style="margin-top:20px;">
            <div class="card-title">
              <strong>Preview</strong>
              <span id="stmMeta" class="badge ok">Awaiting Generate</span>
            </div>
            <div id="stmHeader">
              <h2 style="margin:0 0 6px 0;">Statement</h2>
              <div id="stmHeaderInfo" class="muted"></div>
            </div>
            <div class="table-wrap">
              <table id="stmTable">
                <thead><tr id="stmHeadRow"></tr></thead>
                <tbody id="stmBody"></tbody>
              </table>
            </div>
            <div id="stmTotals" style="margin-top:10px; font-weight:700;"></div>
        </div>
      </div>
    </section>

    <!-- SETTINGS APP -->
    <section id="settingsSection">
      <div class="card">
        <h2 class="card finance-header">‚öôÔ∏è Settings</h2>
        <p class="muted">Manage application preferences. All settings are saved to your browser automatically.</p>

        <div id="settings-accordion">
          <div class="accordion-item">
            <div class="accordion-header"><h3 style="margin:0;">0. üìã COMPANY PROFILE</h3></div>
            <div class="accordion-content">
              <div class="controls-row">
                  <label for="profile-company-name">Company Name: <input type="text" id="profile-company-name" required placeholder="Enter company name"></label>
              </div>
              <div class="controls-row">
                  <label for="profile-app-title">App Title: <input type="text" id="profile-app-title" placeholder="Enter app title (for sidebar)"></label>
              </div>
              <div class="controls-row">
                  <label for="profile-address">Address: <textarea id="profile-address" rows="3" placeholder="Enter address"></textarea></label>
              </div>
              <div class="controls-row">
                  <label for="profile-gstin">GSTIN: <input type="text" id="profile-gstin" placeholder="Enter GSTIN"></label>
              </div>
              <div class="controls-row">
                  <label for="profile-phone">Phone No: <input type="text" id="profile-phone" placeholder="Enter phone number"></label>
              </div>
              <div class="controls-row">
                  <label for="profile-state-code">State Code: <input type="text" id="profile-state-code" placeholder="Enter state code"></label>
              </div>
              <div class="controls-row">
                  <label for="profile-email">Email: <input type="email" id="profile-email" placeholder="Enter email address"></label>
              </div>
              <div class="controls-row">
                  <label for="profile-website">Website: <input type="url" id="profile-website" placeholder="Enter website URL"></label>
              </div>
              <button id="save-profile-btn" class="primary">Save Profile</button>
              <button type="reset" class="ghost" title="Clear Form" aria-label="Clear Profile Form">CLEAR</button>
            </div>
          </div>

          <div class="accordion-item">
            <div class="accordion-header"><h3 style="margin:0;">1. ‚öôÔ∏è DATA MANAGEMENT</h3></div>
            <div class="accordion-content">
              <div class="controls-group" style="flex-wrap: wrap;">
                  <label for="autoSaveEnabled"><input type="checkbox" id="autoSaveEnabled" aria-label="Enable Auto Save"> ENABLE AUTO SAVE</label>
                  <button id="saveAll" class="primary" title="Save to Local Storage" aria-label="Save All Data">SAVE</button>
                  <button id="loadAll" class="ghost" title="Load from Local Storage" aria-label="Load All Data">‚Ü© LOAD</button>
                  <button id="clearAll" class="ghost" title="Clear Local Storage" aria-label="Clear All Data">üóë CLEAR</button>
                  <button id="backupBtn" class="ghost" title="Backup to JSON" aria-label="Backup Data">‚¨á BACKUP</button>
                  <button id="restoreBtn" class="ghost" title="Restore from JSON" aria-label="Restore Data">‚¨Ü RESTORE</button>
                  <input id="restoreFile" type="file" accept="application/json" style="display:none" aria-label="Restore File Input" />
                  <button id="shareMainBtn" class="ghost" title="Share Data" aria-label="Share Data">SHARE OPTION</button>
                  <span id="saveBadge" class="badge">NOT SAVED</span>
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <div class="accordion-header"><h3 style="margin:0;">2. üìä REPORTS & NAVIGATION</h3></div>
            <div class="accordion-content">
              <div class="controls-group" style="flex-wrap: wrap;">
                  <button class="primary" id="navToGstSettings" aria-label="Navigate to GST Report">GST REPORT</button>
                  <button class="primary" id="navToPurchaseBillSettings" aria-label="Navigate to Purchase Bill Report">PURCHASE BILL REPORT</button>
                  <button class="primary" id="navToCompanySettings" aria-label="Navigate to Company Report">COMPANY REPORT</button>
              </div>
              <p class="muted" style="margin-top:10px;">Quickly jump to different report sections.</p>
            </div>
          </div>

          <div class="accordion-item">
            <div class="accordion-header"><h3 style="margin:0;">3. üëÅÔ∏è SECTION VISIBILITY</h3></div>
            <div class="accordion-content">
              <p class="muted">Show or hide sections in the Finance app. Uncheck to hide, check to show. You can add, edit, or delete section names here.</p>
              <div class="controls-row">
                  <label for="new-section-name-input">Section Name: <input type="text" id="new-section-name-input" placeholder="Add new section name" aria-label="New Section Name"></label>
                  <button id="add-section-btn" class="primary" aria-label="Add Section">Add Section</button>
              </div>
              <div class="table-wrap">
                  <table id="section-visibility-table">
                      <thead>
                          <tr><th scope="col">SL</th><th scope="col">SECTION NAME</th><th scope="col">VISIBLE</th><th scope="col">ACTIONS</th></tr>
                      </thead>
                      <tbody></tbody>
                      </table>
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <div class="accordion-header"><h3 style="margin:0;">4. üè¢ COMPANY (PARTY) MANAGEMENT</h3></div>
            <div class="accordion-content">
              <div class="controls-row">
                  <label for="new-company-name-input">Company Name: <input type="text" id="new-company-name-input" placeholder="Add new company" aria-label="New Company Name"></label>
                  <button id="add-company-btn" class="primary" aria-label="Add Company">Add Company</button>
              </div>
              <p class="muted" style="margin-top:10px;">MANAGE THE LIST OF COMPANIES FOR AUTOCOMPLETE AND DROPDOWNS.</p>
              <div class="table-wrap">
                  <table id="company-list-table">
                      <thead>
                          <tr><th scope="col">SL</th><th scope="col">COMPANY NAME</th><th scope="col">ACTIONS</th></tr>
                      </thead>
                      <tbody></tbody>
                      </table>
              </div>
              <div class="pagination-controls" id="company-list-pagination"></div>
            </div>
          </div>

          <div class="accordion-item">
            <div class="accordion-header"><h3 style="margin:0;">5. üí∞ GST SETTINGS</h3></div>
            <div class="accordion-content">
              <div class="controls-row">
                  <label for="new-tax-rate-input">New Tax Rate (%): <input type="number" id="new-tax-rate-input" min="0" max="100" step="0.01" placeholder="e.g., 5" aria-label="New Tax Rate"></label>
                  <button id="add-tax-rate-btn" class="primary" aria-label="Add Tax Rate">Add Rate</button>
              </div>
              <table id="tax-rate-list">
                  <thead>
                      <tr><th scope="col">SL</th><th scope="col">TAX RATE</th><th scope="col">ACTIONS</th></tr>
                  </thead>
                  <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="accordion-item">
            <div class="accordion-header"><h3 style="margin:0;">6. üìù CHECK MANAGEMENT</h3></div>
            <div class="accordion-content">
              <div class="controls-group" style="flex-wrap: wrap; margin-bottom: 10px; justify-content: space-between;">
                  <strong class="control-label">UPCOMING CHECK REMINDERS:</strong>
                  <label for="upcomingCheckRemindersEnabled"><input type="checkbox" id="upcomingCheckRemindersEnabled" aria-label="Enable Upcoming Check Reminders"> ON/OFF</label>
              </div>
              <div class="filter-row" data-filter-group="checkManagement">
                  <label for="check-management-from-date">From: <input type="date" id="check-management-from-date" aria-label="Check Management From Date"></label>
                  <label for="check-management-to-date">To: <input type="date" id="check-management-to-date" aria-label="Check Management To Date"></label>
                  <label for="check-management-company-filter">Company: <select id="check-management-company-filter" aria-label="Check Management Company Filter"><option value="">All Companies</option></select></label>
                  <label for="check-management-status-filter">Status: <select id="check-management-status-filter" aria-label="Check Management Status Filter">
                      <option value="">All</option>
                      <option value="USED">USED</option>
                      <option value="DEFECTIVE">DEFECTIVE</option>
                  </select></label>
                  <label for="check-management-search-box">Search Check No or Invoice No: <input type="text" id="check-management-search-box" placeholder="Enter check no or invoice no" aria-label="Check Management Search Box"></label>
                  <button class="ghost reset-filters" aria-label="Reset Check Management Filters">Reset Filters</button>
              </div>
              <span id="check-management-filter-indicator" class="badge" style="display:none;">FILTERS ACTIVE</span>
              <div class="table-wrap">
                  <table id="check-management-table">
                      <thead>
                          <tr><th scope="col">SL</th><th scope="col">INVOICE NO</th><th scope="col">COMPANY NAME</th><th scope="col">AMOUNT</th><th scope="col">DATE</th><th scope="col">CHECK NO</th><th scope="col">VISIBLE</th></tr>
                      </thead>
                      <tbody></tbody>
                      <tfoot id="check-management-tfoot">
                          <tr><td colspan="6" style="text-align:right;font-weight:bold;">TOTAL CHECKS:</td><td id="check-management-total" style="font-weight:bold;"></td></tr>
                          <tr><td colspan="6" style="text-align:right;font-weight:bold;">TOTAL CHECK AMOUNT:</td><td id="check-management-amount" style="font-weight:bold;"></td></tr>
                      </tfoot>
                  </table>
              </div>
              <div class="pagination-controls" id="check-management-pagination"></div>
            </div>
          </div>

          <div class="accordion-item">
            <div class="accordion-header"><h3 style="margin:0;">7. ‚è∞ AUTOMATION & REMINDERS</h3></div>
            <div class="accordion-content">
              <div class="controls-group" style="flex-wrap: wrap; margin-bottom: 10px; justify-content: space-between;">
                  <strong class="control-label">AUTO SAVE MODE:</strong>
                  <label for="autoBackupEnabled"><input type="checkbox" id="autoBackupEnabled" aria-label="Enable Auto Backup"> ON/OFF</label>
              </div>
              <p class="muted" style="margin-top:10px;">When enabled, data is saved automatically after every change.</p>
              <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
              <div class="controls-group" style="flex-wrap: wrap; margin-bottom: 10px; justify-content: space-between;">
                  <strong class="control-label">CHECK REMINDERS:</strong>
                  <label for="checkRemindersEnabled"><input type="checkbox" id="checkRemindersEnabled" aria-label="Enable Check Reminders"> ON/OFF</label>
              </div>
              <div class="controls-group">
                  <label class="control-label" for="reminderDaysInput">SHOW REMINDERS FOR CHECKS DUE IN:
                      <input id="reminderDaysInput" type="number" min="1" max="30" step="1" style="width: 60px;" aria-label="Reminder Days" />
                      <span class="control-value">DAYS</span>
                  </label>
              </div>
              <div class="controls-group">
                  <label class="control-label" for="reminderShowAfterDueInput">SHOW REMINDERS FOR CHECKS THAT ARE OVERDUE BY:
                      <input id="reminderShowAfterDueInput" type="number" min="0" max="30" step="1" style="width: 60px;" aria-label="Overdue Days" />
                      <span class="control-value">DAYS</span>
                  </label>
              </div>
              <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
              <div class="controls-group" style="flex-wrap: wrap; margin-bottom: 10px; justify-content: space-between;">
                  <strong class="control-label">PENDING BILL REMINDERS:</strong>
                  <label for="pendingBillRemindersEnabled"><input type="checkbox" id="pendingBillRemindersEnabled" aria-label="Enable Pending Bill Reminders"> ON/OFF</label>
              </div>
              <div class="controls-group">
                  <label class="control-label" for="pendingBillReminderDaysInput">SHOW BILLS PENDING FOR MORE THAN:
                      <input id="pendingBillReminderDaysInput" type="number" min="1" max="90" step="1" style="width: 60px;" aria-label="Pending Bill Days" />
                      <span class="control-value">DAYS</span>
                  </label>
              </div>
              <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
              <div class="controls-group" style="flex-wrap: wrap; margin-bottom: 10px; justify-content: space-between;">
                  <strong class="control-label">RETURN ITEMS REMINDERS:</strong>
                  <label for="returnRemindersEnabled"><input type="checkbox" id="returnRemindersEnabled" aria-label="Enable Return Reminders"> ON/OFF</label>
              </div>
              <div class="controls-group">
                  <label class="control-label" for="returnReminderDaysInput">SHOW RETURNS PENDING CREDIT NOTE FOR MORE THAN:
                      <input id="returnReminderDaysInput" type="number" min="1" max="90" step="1" style="width: 80px;" aria-label="Return Days" />
                      <span class="control-value">DAYS</span>
                  </label>
              </div>
              <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
              <div class="controls-group" style="flex-wrap: wrap; margin-bottom: 10px; justify-content: space-between;">
                  <strong class="control-label">ENABLE AUTO REFRESH:</strong>
                  <label for="autoRefreshEnabled"><input type="checkbox" id="autoRefreshEnabled" aria-label="Enable Auto Refresh"> ON/OFF</label>
              </div>
              <div id="autoRefreshSettings">
                  <div class="controls-group" style="margin-bottom: 10px;">
                      <label class="control-label" for="autoRefreshInterval">REFRESH EVERY:
                          <input id="autoRefreshInterval" type="number" min="10" max="3600" step="1" style="width: 80px;" aria-label="Refresh Interval" />
                          <span class="control-value">SECONDS</span>
                      </label>
                  </div>
                  <div class="controls-group">
                      <label class="control-label" for="autoRefreshCount">REPEAT COUNT:
                          <input id="autoRefreshCount" type="number" min="0" max="100" step="1" style="width: 80px;" aria-label="Refresh Count" />
                          <span class="control-value">TIMES (0 FOR INFINITE)</span>
                      </label>
                  </div>
                  <p class="muted" style="margin-top:10px;">The application will automatically refresh all data at the specified interval.</p>
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <div class="accordion-header"><h3 style="margin:0;">8. üßπ AUTO FIX ERRORS</h3></div>
            <div class="accordion-content">
              <div class="controls-group" style="flex-wrap: wrap; margin-bottom: 10px; justify-content: space-between;">
                  <strong class="control-label">ENABLE AUTO FIX ERRORS:</strong>
                  <label for="autoFixEnabled"><input type="checkbox" id="autoFixEnabled" aria-label="Enable Auto Fix"> ON/OFF</label>
              </div>
              <p class="muted" style="margin-top:10px;">When enabled, automatically fixes common data errors on load.</p>
              <button id="runAutoFixBtn" class="primary" aria-label="Run Auto Fix">RUN AUTO FIX NOW</button>
              <div id="autoFixResults" style="margin-top:10px; display:none;">
                  <h4>Fixes Applied:</h4>
                  <ul id="autoFixList"></ul>
              </div>
              <p class="muted" style="margin-top:10px;">Fixes include: Validating dates, ensuring positive amounts, removing duplicates, trimming names, etc.</p>
            </div>
          </div>

          <div class="accordion-item">
            <div class="accordion-header"><h3 style="margin:0;">9. üé§ SPEECH & BEEP SETTINGS</h3></div>
            <div class="accordion-content">
              <div class="speech-controls-grid">
                <div>
                  <div class="controls-group" style="flex-wrap: wrap; margin-bottom: 10px; justify-content: space-between;">
                      <strong class="control-label">BEEP ENABLED:</strong>
                      <label for="beepEnabled"><input type="checkbox" id="beepEnabled" aria-label="Enable Beep"> ON/OFF</label>
                  </div>
                  <div class="controls-group" style="flex-wrap: wrap; margin-bottom: 10px; justify-content: space-between;">
                      <strong class="control-label">BEEP VOLUME (Hz):</strong>
                      <input id="beepVolumeRange" type="range" min="0" max="2" step="0.1" aria-label="Beep Volume" />
                      <span id="beepVolumeValue">200</span>%  <!-- Changed to 200% -->
                  </div>
                  <div class="controls-group" style="flex-wrap: wrap; margin-bottom: 10px; justify-content: space-between;">
                      <strong class="control-label">BEEP FREQUENCY (Hz):</strong>
                      <input id="beepFrequencyRange" type="range" min="200" max="2000" step="50" aria-label="Beep Frequency" />
                      <span id="beepFrequencyValue">700</span> Hz
                  </div>
                  <div class="controls-group" style="flex-wrap: wrap; margin-bottom: 10px; justify-content: space-between;">
                      <strong class="control-label">BEEP DURATION (ms):</strong>
                      <input id="beepDurationRange" type="range" min="50" max="500" step="10" aria-label="Beep Duration" />
                      <span id="beepDurationValue">120</span> ms
                  </div>
                  <div class="controls-group" style="flex-wrap: wrap; margin-bottom: 10px; justify-content: space-between;">
                      <strong class="control-label">BEEP PATTERN:</strong>
                      <select id="beepPatternSelect" aria-label="Beep Pattern">
                          <option value="single">Single Beep</option>
                          <option value="double">Double Beep</option>
                          <option value="triple">Triple Beep</option>
                          <option value="morse-sos">Morse Code (SOS)</option>
                      </select>
                  </div>
                  <div class="controls-group" style="flex-wrap: wrap; margin-bottom: 10px; justify-content: space-between;">
                      <button id="testBeepBtn" class="primary" aria-label="Test Beep">TEST BEEP</button>
                      <button id="saveCustomBeepBtn" class="primary" aria-label="Save Custom Beep">SAVE CUSTOM BEEP</button>
                  </div>
                </div>
                <div>
                  <div class="controls-group" style="flex-wrap: wrap; margin-bottom: 10px; justify-content: space-between;">
                      <strong class="control-label">SPEECH ENABLED:</strong>
                      <label for="speechEnabled"><input type="checkbox" id="speechEnabled" aria-label="Enable Speech"> ON/OFF</label>
                  </div>
                  <div class="controls-group">
                      <label class="control-label" for="speechLanguage">LANGUAGE:
                          <select id="speechLanguage" aria-label="Speech Language">
                              <option value="en-IN">English (India)</option>
                              <option value="hi-IN">Hindi</option>
                              <option value="kn-IN">Kannada</option>
                              <option value="gu-IN">Gujarati</option>
                          </select>
                      </label>
                  </div>
                  <div class="controls-group">
                      <label class="control-label" for="speechVoiceType">VOICE TYPE:
                          <select id="speechVoiceType" aria-label="Voice Type">
                              <option value="female">Female</option>
                              <option value="male">Male</option>
                              <option value="any">Any</option>
                          </select>
                      </label>
                  </div>
                  <div class="controls-group">
                      <label class="control-label" for="speechSpeakButtons">SPEAK BUTTON NAMES:
                          <input type="checkbox" id="speechSpeakButtons" aria-label="Speak Buttons" />
                      </label>
                  </div>
                  <div class="controls-group">
                      <label class="control-label" for="speechVolumeRange">VOLUME:
                          <input id="speechVolumeRange" type="range" min="0" max="1" step="0.1" aria-label="Speech Volume" />
                          <span id="speechVolumeValue">100</span>%
                      </label>
                  </div>
                  <div class="controls-group">
                      <label class="control-label" for="speechPitchRange">PITCH:
                          <input id="speechPitchRange" type="range" min="0.5" max="2" step="0.1" aria-label="Speech Pitch" />
                          <span id="speechPitchValue">1.2</span>
                      </label>
                  </div>
                  <div class="controls-group">
                      <label class="control-label" for="speechRateRange">RATE:
                          <input id="speechRateRange" type="range" min="0.5" max="2" step="0.1" aria-label="Speech Rate" />
                          <span id="speechRateValue">1.0</span>
                      </label>
                  </div>
                  <button id="speechTestBtn" class="primary" aria-label="Test Speech">TEST SPEECH</button>
                </div>
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <div class="accordion-header"><h3 style="margin:0;">10. üé® UI CUSTOMIZATION</h3></div>
            <div class="accordion-content">
              <div class="controls-group">
                  <label for="textSizeRange">Base Font Size: <input id="textSizeRange" type="range" min="12" max="24" step="1" aria-label="Base Font Size" /> <span id="textSizeValue">18</span>px</label>
                  <label for="numberSizeRange">Currency Size: <input id="numberSizeRange" type="range" min="12" max="30" step="1" aria-label="Currency Size" /> <span id="numberSizeValue">24</span>px</label>
                  <label for="inputSizeRange">Input Font Size: <input id="inputSizeRange" type="range" min="12" max="20" step="1" aria-label="Input Font Size" /> <span id="inputSizeValue">18</span>px</label>
                  <label for="tabSizeRange">Tab Font Size: <input id="tabSizeRange" type="range" min="12" max="20" step="1" aria-label="Tab Font Size" /> <span id="tabSizeValue">18</span>px</label>
                  <label for="modalSizeRange">Modal Font Size: <input id="modalSizeRange" type="range" min="12" max="20" step="1" aria-label="Modal Font Size" /> <span id="modalSizeValue">18</span>px</label>
                  <label for="tableSizeRange">Table Font Size: <input id="tableSizeRange" type="range" min="12" max="16" step="1" aria-label="Table Font Size" /> <span id="tableSizeValue">16</span>px</label>
                  <label for="buttonSizeRange">Button Font Size: <input id="buttonSizeRange" type="range" min="12" max="20" step="1" aria-label="Button Font Size" /> <span id="buttonSizeValue">18</span>px</label>
                  <label for="text3DIntensityRange">3D Text Intensity: <input id="text3DIntensityRange" type="range" min="0" max="200" step="10" aria-label="3D Text Intensity" /> <span id="text3DIntensityValue">100</span>%</label>
                  <label for="currencyColorSelector">Currency Amount Color: <select id="currencyColorSelector" aria-label="Currency Color Selector"></select></label>
                  <label for="buttonStyleSelector">Button Style: <select id="buttonStyleSelector" aria-label="Button Style Selector">
                      <option value="default">Default (5D Gradient)</option>
                      <option value="transparent">5D STYLE TRANSPARENT</option>
                      <option value="uiverse-absolute-strange">Uiverse Button 1 (absoluteSTrange)</option>
                      <option value="uiverse-button-2">Uiverse Button 2 (absoluteSTrange)</option>
                      <option value="5d-transparent-button">5D TRANSPARENT BUTTON</option>
                  </select></label>
                  <label for="titleColorSelector">Sidebar Title Color: <select id="titleColorSelector" aria-label="Title Color Selector">
                      <option value="#ffffff">White (Default)</option>
                      <option value="#ff9933">Saffron</option>
                      <option value="#138808">Green</option>
                      <option value="#2345a0">Navy</option>
                      <option value="#000000">Black</option>
                      <option value="#111111">Dark Gray</option>
                      <option value="#ff0000">Red</option>
                      <option value="#00ff00">Green</option>
                      <option value="#0000ff">Blue</option>
                      <option value="#ffff00">Yellow</option>
                      <option value="#ff00ff">Magenta</option>
                      <option value="#00ffff">Cyan</option>
                      <option value="#800080">Purple</option>
                      <option value="#ffa500">Orange</option>
                      <option value="#ffc0cb">Pink</option>
                      <option value="#a52a2a">Brown</option>
                      <option value="#808080">Gray</option>
                      <option value="#800000">Maroon</option>
                      <option value="#808000">Olive</option>
                      <option value="#008080">Teal</option>
                      <option value="#000080">Navy</option>
                      <option value="#ffffe0">Light Yellow</option>
                      <option value="#87ceeb">Sky Blue</option>
                      <option value="#dc143c">Crimson</option>
                      <option value="#00ff7f">Spring Green</option>
                      <option value="#ff1493">Deep Pink</option>
                      <option value="#00bfff">Deep Sky Blue</option>
                      <option value="#ff6347">Tomato</option>
                      <option value="#daa520">Golden Rod</option>
                      <option value="#8b0000">Dark Red</option>
                      <option value="#556b2f">Dark Olive Green</option>
                      <option value="#ff4500">Orange Red</option>
                      <option value="#9370db">Medium Purple</option>
                      <option value="#32cd32">Lime Green</option>
                      <option value="#8a2be2">Blue Violet</option>
                      <option value="#5f9ea0">Cadet Blue</option>
                      <option value="#d2691e">Chocolate</option>
                      <option value="#6495ed">Cornflower Blue</option>
                      <option value="#ffb6c1">Light Pink</option>
                      <option value="#daa520">Golden Rod</option>
                      <option value="#b0c4de">Light Steel Blue</option>
                      <option value="#ffff00">Yellow</option>
                      <option value="#00ff00">Lime</option>
                      <option value="#800080">Indigo</option>
                      <option value="#800080">Violet</option>
                      <option value="#ffd700">Gold</option>
                      <option value="#c0c0c0">Silver</option>
                      <option value="#daa520">Dark Golden Rod</option>
                      <option value="#98fb98">Pale Green</option>
                      <option value="#f0e68c">Khaki</option>
                      <option value="#dda0dd">Plum</option>
                      <option value="#b0e0e6">Powder Blue</option>
                      <option value="#a0522d">Sienna</option>
                      <option value="#87ceeb">Sky Blue</option>
                      <option value="#6b8e23">Olive Drab</option>
                      <option value="#708090">Slate Gray</option>
                      <option value="#00ff7f">Spring Green</option>
                      <option value="#4682b4">Steel Blue</option>
                      <option value="#d2b48c">Tan</option>
                      <option value="#008080">Teal</option>
                      <option value="#d8bfd8">Thistle</option>
                      <option value="#ff6347">Tomato</option>
                      <option value="#40e0d0">Turquoise</option>
                      <option value="#ee82ee">Violet</option>
                      <option value="#f5deb3">Wheat</option>
                      <option value="#ffffff">White Smoke</option>
                  </select></label>
                  <label for="selectHinduTilak">Select Hindu Tilak Symbol: <select id="selectHinduTilak" aria-label="Select Hindu Tilak Symbol">
                      <option value="‡•ê">‡•ê (Om) - ‡§∏‡§∞‡•ç‡§µ‡§∂‡§ï‡•ç‡§§‡§ø‡§Æ‡§æ‡§®‡•ç</option>
                      <option value="Âçê">Âçê (Swastika) - ‡§∂‡•Å‡§≠‡§≤‡§ï‡•ç‡§∑‡§£</option>
                      <option value="‡§∂‡•ç‡§∞‡•Ä">‡§∂‡•ç‡§∞‡•Ä (Shri) - ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Æ‡•Ä ‡§ï‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï</option>
                      <option value="‡•∞">‡•∞ (Aum) - ‡§™‡§µ‡§ø‡§§‡•ç‡§∞ ‡§ß‡•ç‡§µ‡§®‡§ø</option>
                      <option value="üî±">üî± (Trident) - ‡§∂‡§ø‡§µ ‡§ï‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï</option>
                      <option value="üïâÔ∏è">üïâÔ∏è (Om Emoji) - ‡§™‡§µ‡§ø‡§§‡•ç‡§∞</option>
                      <option value="üå∫">üå∫ (Lotus) - ‡§ï‡§Æ‡§≤</option>
                      <option value="ü™î">ü™î (Diya) - ‡§¶‡•Ä‡§™‡§ï</option>
                      <option value="‚ò∏Ô∏è">‚ò∏Ô∏è (Dharma Wheel) - ‡§ß‡§∞‡•ç‡§Æ ‡§ö‡§ï‡•ç‡§∞</option>
                      <option value="üôè">üôè (Namaste) - ‡§®‡§Æ‡§∏‡•ç‡§§‡•á</option>
                      <option value="ü™ï">ü™ï (Sitar) - ‡§∏‡§Ç‡§ó‡•Ä‡§§</option>
                      <option value="üåô">üåô (Moon) - ‡§ö‡§Ç‡§¶‡•ç‡§∞‡§Æ‡§æ</option>
                      <option value="üåû">üåû (Sun) - ‡§∏‡•Ç‡§∞‡•ç‡§Ø</option>
                      <option value="üî•">üî• (Fire) - ‡§Ö‡§ó‡•ç‡§®‡§ø</option>
                      <option value="üíê">üíê (Flowers) - ‡§´‡•Ç‡§≤</option>
                      <option value="üîî">üîî (Bell) - ‡§ò‡§Ç‡§ü‡•Ä</option>
                      <option value="üìø">üìø (Mala) - ‡§Æ‡§æ‡§≤‡§æ</option>
                      <option value="ü™∑">ü™∑ (Lotus Flower) - ‡§ï‡§Æ‡§≤</option>
                      <option value="üé®">üé® (Art) - ‡§ï‡§≤‡§æ</option>
                      <option value="üêò">üêò (Elephant) - ‡§ó‡§£‡•á‡§∂</option>
                      <option value="ü™à">ü™à (Flute) - ‡§ï‡•É‡§∑‡•ç‡§£</option>
                      <option value="üèπ">üèπ (Bow) - ‡§∞‡§æ‡§Æ</option>
                      <option value="üêí">üêí (Monkey) - ‡§π‡§®‡•Å‡§Æ‡§æ‡§®</option>
                      <option value="‚öîÔ∏è">‚öîÔ∏è (Sword) - ‡§¶‡•Å‡§∞‡•ç‡§ó‡§æ</option>
                      <option value="üïØÔ∏è">üïØÔ∏è (Candle) - ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂</option>
                      <option value="üåø">üåø (Herb) - ‡§î‡§∑‡§ß‡§ø</option>
                      <option value="ü¶Å">ü¶Å (Lion) - ‡§∂‡§ï‡•ç‡§§‡§ø</option>
                      <option value="üïäÔ∏è">üïäÔ∏è (Dove) - ‡§∂‡§æ‡§Ç‡§§‡§ø</option>
                      <option value="üå∏">üå∏ (Cherry Blossom) - ‡§∏‡•Å‡§Ç‡§¶‡§∞‡§§‡§æ</option>
                      <option value="üçÉ">üçÉ (Leaf) - ‡§™‡•ç‡§∞‡§ï‡•É‡§§‡§ø</option>
                      <option value="ü™Ñ">ü™Ñ (Wand) - ‡§ú‡§æ‡§¶‡•Ç</option>
                      <option value="üåü">üåü (Star) - ‡§§‡§æ‡§∞‡§æ</option>
                      <option value="ü™ô">ü™ô (Coin) - ‡§ß‡§®</option>
                      <option value="ü™µ">ü™µ (Wood) - ‡§™‡•ç‡§∞‡§ï‡•É‡§§‡§ø</option>
                      <option value="üï∑Ô∏è">üï∑Ô∏è (Spider) - ‡§∏‡§Æ‡§∞‡•ç‡§™‡§£</option>
                      <option value="üêç">üêç (Snake) - ‡§ï‡§æ‡§≤</option>
                      <option value="ü¶Ö">ü¶Ö (Eagle) - ‡§¶‡•É‡§∑‡•ç‡§ü‡§ø</option>
                      <option value="üêÇ">üêÇ (Ox) - ‡§¨‡§≤</option>
                      <option value="ü¶ö">ü¶ö (Peacock) - ‡§Æ‡•ã‡§∞</option>
                      <option value="ü¶å">ü¶å (Deer) - ‡§∂‡§æ‡§Ç‡§§‡§ø</option>
                      <option value="üêé">üêé (Horse) - ‡§ó‡§§‡§ø</option>
                      <option value="ü¶â">ü¶â (Owl) - ‡§ú‡•ç‡§û‡§æ‡§®</option>
                      <option value="üê¢">üê¢ (Turtle) - ‡§ß‡•à‡§∞‡•ç‡§Ø</option>
                      <option value="ü¶ã">ü¶ã (Butterfly) - ‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§®</option>
                      <option value="ü¶Ñ">ü¶Ñ (Unicorn) - ‡§Ö‡§¶‡•ç‡§≠‡•Å‡§§</option>
                      <option value="üêâ">üêâ (Dragon) - ‡§∂‡§ï‡•ç‡§§‡§ø</option>
                      <option value="ü¶â">ü¶â (Owl) - ‡§¨‡•Å‡§¶‡•ç‡§ß‡§ø</option>
                      <option value="üå≥">üå≥ (Tree) - ‡§ú‡•Ä‡§µ‡§®</option>
                      <option value="üåä">üåä (Wave) - ‡§™‡•ç‡§∞‡§µ‡§æ‡§π</option>
                      <option value="‚õ∞Ô∏è">‚õ∞Ô∏è (Mountain) - ‡§∏‡•ç‡§•‡§ø‡§∞‡§§‡§æ</option>
                      <option value="üåà">üåà (Rainbow) - ‡§µ‡§ø‡§µ‡§ø‡§ß‡§§‡§æ</option>
                      <option value="‚òÅÔ∏è">‚òÅÔ∏è (Cloud) - ‡§Ü‡§ï‡§æ‡§∂</option>
                      <option value="üå™Ô∏è">üå™Ô∏è (Tornado) - ‡§∂‡§ï‡•ç‡§§‡§ø</option>
                      <option value="üå©Ô∏è">üå©Ô∏è (Storm) - ‡§â‡§∞‡•ç‡§ú‡§æ</option>
                      <option value="‚ùÑÔ∏è">‚ùÑÔ∏è (Snowflake) - ‡§Ö‡§®‡•ã‡§ñ‡§æ‡§™‡§®</option>
                      <option value="üåã">üåã (Volcano) - ‡§â‡§ó‡•ç‡§∞‡§§‡§æ</option>
                      <option value="üóª">üóª (Mount Fuji) - ‡§Æ‡§π‡§æ‡§®‡§§‡§æ</option>
                      <option value="üèîÔ∏è">üèîÔ∏è (Snow Mountain) - ‡§∂‡§ø‡§ñ‡§∞</option>
                      <option value="üèïÔ∏è">üèïÔ∏è (Camping) - ‡§™‡•ç‡§∞‡§ï‡•É‡§§‡§ø</option>
                      <option value="üèñÔ∏è">üèñÔ∏è (Beach) - ‡§∂‡§æ‡§Ç‡§§‡§ø</option>
                      <option value="üèúÔ∏è">üèúÔ∏è (Desert) - ‡§®‡§ø‡§∞‡•ç‡§ú‡§®</option>
                      <option value="üèûÔ∏è">üèûÔ∏è (National Park) - ‡§™‡•ç‡§∞‡§ï‡•É‡§§‡§ø</option>
                      <option value="üèõÔ∏è">üèõÔ∏è (Classical Building) - ‡§á‡§§‡§ø‡§π‡§æ‡§∏</option>
                      <option value="üïå">üïå (Mosque) - ‡§ß‡§∞‡•ç‡§Æ</option>
                      <option value="üïç">üïç (Synagogue) - ‡§ß‡§∞‡•ç‡§Æ</option>
                      <option value="‚õ©Ô∏è">‚õ©Ô∏è (Shinto Shrine) - ‡§ß‡§∞‡•ç‡§Æ</option>
                      <option value="üõï">üõï (Hindu Temple) - ‡§Æ‡§Ç‡§¶‡§ø‡§∞</option>
                      <option value="üïã">üïã (Kaaba) - ‡§ß‡§∞‡•ç‡§Æ</option>
                      <option value="‚õ™">‚õ™ (Church) - ‡§ß‡§∞‡•ç‡§Æ</option>
                      <option value="üïå">üïå (Mosque) - ‡§ß‡§∞‡•ç‡§Æ</option>
                      <option value="üïç">üïç (Synagogue) - ‡§ß‡§∞‡•ç‡§Æ</option>
                      <option value="‚õ©Ô∏è">‚õ©Ô∏è (Shinto Shrine) - ‡§ß‡§∞‡•ç‡§Æ</option>
                      <option value="üõï">üõï (Hindu Temple) - ‡§Æ‡§Ç‡§¶‡§ø‡§∞</option>
                      <option value="üïã">üïã (Kaaba) - ‡§ß‡§∞‡•ç‡§Æ</option>
                      <option value="‚õ™">‚õ™ (Church) - ‡§ß‡§∞‡•ç‡§Æ</option>
                      <option value="üïå">üïå (Mosque) - ‡§ß‡§∞‡•ç‡§Æ</option>
                      <option value="üïç">üïç (Synagogue) - ‡§ß‡§∞‡•ç‡§Æ</option>
                      <option value="‚õ©Ô∏è">‚õ©Ô∏è (Shinto Shrine) - ‡§ß‡§∞‡•ç‡§Æ</option>
                      <option value="üõï">üõï (Hindu Temple) - ‡§Æ‡§Ç‡§¶‡§ø‡§∞</option>
                      <option value="üïã">üïã (Kaaba) - ‡§ß‡§∞‡•ç‡§Æ</option>
                      <option value="‚õ™">‚õ™ (Church) - ‡§ß‡§∞‡•ç‡§Æ</option>
                  </select></label>
                  <label for="hinduTilakColorSelector">Hindu Tilak Color: <select id="hinduTilakColorSelector" aria-label="Hindu Tilak Color Selector">
                      <option value="#ffd700">Gold (Default)</option>
                      <option value="#ffffff">White</option>
                      <option value="#ff0000">Red</option>
                      <option value="#00ff00">Green</option>
                      <option value="#0000ff">Blue</option>
                      <option value="#ffff00">Yellow</option>
                      <option value="#ff00ff">Magenta</option>
                      <option value="#00ffff">Cyan</option>
                      <option value="#800080">Purple</option>
                      <option value="#ffa500">Orange</option>
                      <option value="#ffc0cb">Pink</option>
                      <option value="#a52a2a">Brown</option>
                      <option value="#808080">Gray</option>
                      <option value="#800000">Maroon</option>
                      <option value="#808000">Olive</option>
                      <option value="#008080">Teal</option>
                      <option value="#000080">Navy</option>
                      <option value="#ffffe0">Light Yellow</option>
                      <option value="#87ceeb">Sky Blue</option>
                      <option value="#dc143c">Crimson</option>
                      <option value="#00ff7f">Spring Green</option>
                      <option value="#ff1493">Deep Pink</option>
                      <option value="#00bfff">Deep Sky Blue</option>
                      <option value="#ff6347">Tomato</option>
                      <option value="#daa520">Golden Rod</option>
                      <option value="#8b0000">Dark Red</option>
                      <option value="#556b2f">Dark Olive Green</option>
                      <option value="#ff4500">Orange Red</option>
                      <option value="#9370db">Medium Purple</option>
                      <option value="#32cd32">Lime Green</option>
                      <option value="#8a2be2">Blue Violet</option>
                      <option value="#5f9ea0">Cadet Blue</option>
                      <option value="#d2691e">Chocolate</option>
                      <option value="#6495ed">Cornflower Blue</option>
                      <option value="#ffb6c1">Light Pink</option>
                      <option value="#daa520">Golden Rod</option>
                      <option value="#b0c4de">Light Steel Blue</option>
                      <option value="#ffff00">Yellow</option>
                      <option value="#00ff00">Lime</option>
                      <option value="#800080">Indigo</option>
                      <option value="#800080">Violet</option>
                      <option value="#ffd700">Gold</option>
                      <option value="#c0c0c0">Silver</option>
                      <option value="#daa520">Dark Golden Rod</option>
                      <option value="#98fb98">Pale Green</option>
                      <option value="#f0e68c">Khaki</option>
                      <option value="#dda0dd">Plum</option>
                      <option value="#b0e0e6">Powder Blue</option>
                      <option value="#a0522d">Sienna</option>
                      <option value="#87ceeb">Sky Blue</option>
                      <option value="#6b8e23">Olive Drab</option>
                      <option value="#708090">Slate Gray</option>
                      <option value="#00ff7f">Spring Green</option>
                      <option value="#4682b4">Steel Blue</option>
                      <option value="#d2b48c">Tan</option>
                      <option value="#008080">Teal</option>
                      <option value="#d8bfd8">Thistle</option>
                      <option value="#ff6347">Tomato</option>
                      <option value="#40e0d0">Turquoise</option>
                      <option value="#ee82ee">Violet</option>
                      <option value="#f5deb3">Wheat</option>
                      <option value="#ffffff">White Smoke</option>
                  </select></label>
                  <label for="showHinduLogo"><input type="checkbox" id="showHinduLogo" aria-label="Show Hindu Logo Above Title"> Show Hindu Logo Above Title</label>
                  <label for="slColorSelector">SL Text Color: <select id="slColorSelector" aria-label="SL Color Selector"></select></label>
                  <label for="daysColorSelector">Days Text Color: <select id="daysColorSelector" aria-label="Days Color Selector"></select></label>
                  <label for="daysAgoColorSelector">Days Ago Text Color: <select id="daysAgoColorSelector" aria-label="Days Ago Color Selector"></select></label>
                  <label for="pendingColorSelector">Pending Text Color: <select id="pendingColorSelector" aria-label="Pending Color Selector"></select></label>
                  <button id="resetSizes" class="primary" aria-label="Reset Sizes">Reset to Defaults</button>
                  <button id="saveUiSettings" class="primary" aria-label="Save UI Settings">SAVE UI SETTINGS</button>
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <div class="accordion-header"><h3 style="margin:0;">11. üìä DASHBOARD VISIBILITY</h3></div>
            <div class="accordion-content">
              <p class="muted">Show or hide dashboard cards. Uncheck to hide, check to show.</p>
              <div class="table-wrap">
                  <table id="dashboard-visibility-table">
                      <thead>
                          <tr><th scope="col">SL</th><th scope="col">CARD NAME</th><th scope="col">VISIBLE</th><th scope="col">ACTIONS</th></tr>
                      </thead>
                      <tbody></tbody>
                      </table>
              </div>
            </div>
          </div>

          <div class="accordion-item">
            <div class="accordion-header"><h3 style="margin:0;">12. üíæ BACKUP & RESTORE INFO</h3></div>
            <div class="accordion-content">
              <table id="backup-restore-table">
                  <thead>
                      <tr><th scope="col">SL</th><th scope="col">INFO</th><th scope="col">VALUE</th></tr>
                  </thead>
                  <tbody>
                      <tr><td><span class="text-3d">1</span></td><td><strong class="control-label">LAST BACKUP FILE:</strong></td><td><span id="lastBackupFileName" class="text-3d">None</span></td></tr>
                      <tr><td><span class="text-3d">2</span></td><td><strong class="control-label">LAST SELECTED RESTORE FILE:</strong></td><td><span id="lastRestoreFileName" class="text-3d">None</span></td></tr>
                  </tbody>
              </table>
            </div>
          </div>

          <div class="accordion-item">
            <div class="accordion-header"><h3 style="margin:0;">13. üáÆüá≥ 3D COLOR THEMES</h3></div>
            <div class="accordion-content">
              <div class="controls-group">
                  <label for="themeSelector">1. SELECT THEME:</label>
                  <select id="themeSelector" aria-label="Theme Selector">
                      <option value="tiranga">üáÆüá≥ TIRANGA (Saffron, White, Navy)</option>
                      <option value="custom">CUSTOM (Editable)</option>
                  </select>
                  <button id="applyThemeBtn" class="primary" aria-label="Apply Theme">APPLY THEME</button>
              </div>
              <div id="customThemeDiv" style="display: none; margin-top: 15px;">
                  <div class="controls-row">
                      <label for="customThemeName">2. Custom Theme Name: <input type="text" id="customThemeName" placeholder="My Custom Theme" aria-label="Custom Theme Name"></label>
                  </div>
                  <div class="controls-row">
                      <label for="customAccent1">3. Accent 1 (Saffron): <select id="customAccent1" aria-label="Accent 1">
                          <option value="#ff9933">Saffron</option>
                          <option value="#138808">Green</option>
                          <option value="#2345a0">Navy</option>
                          <option value="#ffffff">White</option>
                          <option value="#000000">Black</option>
                          <option value="#111111">Dark Gray</option>
                          <option value="#ff0000">Red</option>
                          <option value="#00ff00">Green</option>
                          <option value="#0000ff">Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#ff00ff">Magenta</option>
                          <option value="#00ffff">Cyan</option>
                          <option value="#800080">Purple</option>
                          <option value="#ffa500">Orange</option>
                          <option value="#ffc0cb">Pink</option>
                          <option value="#a52a2a">Brown</option>
                          <option value="#808080">Gray</option>
                          <option value="#800000">Maroon</option>
                          <option value="#808000">Olive</option>
                          <option value="#008080">Teal</option>
                          <option value="#000080">Navy</option>
                          <option value="#ffffe0">Light Yellow</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#dc143c">Crimson</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#ff1493">Deep Pink</option>
                          <option value="#00bfff">Deep Sky Blue</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#8b0000">Dark Red</option>
                          <option value="#556b2f">Dark Olive Green</option>
                          <option value="#ff4500">Orange Red</option>
                          <option value="#9370db">Medium Purple</option>
                          <option value="#32cd32">Lime Green</option>
                          <option value="#8a2be2">Blue Violet</option>
                          <option value="#5f9ea0">Cadet Blue</option>
                          <option value="#d2691e">Chocolate</option>
                          <option value="#6495ed">Cornflower Blue</option>
                          <option value="#ffb6c1">Light Pink</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#b0c4de">Light Steel Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#00ff00">Lime</option>
                          <option value="#800080">Indigo</option>
                          <option value="#800080">Violet</option>
                          <option value="#ffd700">Gold</option>
                          <option value="#c0c0c0">Silver</option>
                          <option value="#daa520">Dark Golden Rod</option>
                          <option value="#98fb98">Pale Green</option>
                          <option value="#f0e68c">Khaki</option>
                          <option value="#dda0dd">Plum</option>
                          <option value="#b0e0e6">Powder Blue</option>
                          <option value="#a0522d">Sienna</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#6b8e23">Olive Drab</option>
                          <option value="#708090">Slate Gray</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#4682b4">Steel Blue</option>
                          <option value="#d2b48c">Tan</option>
                          <option value="#008080">Teal</option>
                          <option value="#d8bfd8">Thistle</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#40e0d0">Turquoise</option>
                          <option value="#ee82ee">Violet</option>
                          <option value="#f5deb3">Wheat</option>
                          <option value="#ffffff">White Smoke</option>
                      </select></label>
                      <label for="customAccent2">4. Accent 2 (Green): <select id="customAccent2" aria-label="Accent 2">
                          <option value="#138808">Green</option>
                          <option value="#ff9933">Saffron</option>
                          <option value="#2345a0">Navy</option>
                          <option value="#ffffff">White</option>
                          <option value="#000000">Black</option>
                          <option value="#111111">Dark Gray</option>
                          <option value="#ff0000">Red</option>
                          <option value="#00ff00">Green</option>
                          <option value="#0000ff">Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#ff00ff">Magenta</option>
                          <option value="#00ffff">Cyan</option>
                          <option value="#800080">Purple</option>
                          <option value="#ffa500">Orange</option>
                          <option value="#ffc0cb">Pink</option>
                          <option value="#a52a2a">Brown</option>
                          <option value="#808080">Gray</option>
                          <option value="#800000">Maroon</option>
                          <option value="#808000">Olive</option>
                          <option value="#008080">Teal</option>
                          <option value="#000080">Navy</option>
                          <option value="#ffffe0">Light Yellow</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#dc143c">Crimson</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#ff1493">Deep Pink</option>
                          <option value="#00bfff">Deep Sky Blue</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#8b0000">Dark Red</option>
                          <option value="#556b2f">Dark Olive Green</option>
                          <option value="#ff4500">Orange Red</option>
                          <option value="#9370db">Medium Purple</option>
                          <option value="#32cd32">Lime Green</option>
                          <option value="#8a2be2">Blue Violet</option>
                          <option value="#5f9ea0">Cadet Blue</option>
                          <option value="#d2691e">Chocolate</option>
                          <option value="#6495ed">Cornflower Blue</option>
                          <option value="#ffb6c1">Light Pink</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#b0c4de">Light Steel Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#00ff00">Lime</option>
                          <option value="#800080">Indigo</option>
                          <option value="#800080">Violet</option>
                          <option value="#ffd700">Gold</option>
                          <option value="#c0c0c0">Silver</option>
                          <option value="#daa520">Dark Golden Rod</option>
                          <option value="#98fb98">Pale Green</option>
                          <option value="#f0e68c">Khaki</option>
                          <option value="#dda0dd">Plum</option>
                          <option value="#b0e0e6">Powder Blue</option>
                          <option value="#a0522d">Sienna</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#6b8e23">Olive Drab</option>
                          <option value="#708090">Slate Gray</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#4682b4">Steel Blue</option>
                          <option value="#d2b48c">Tan</option>
                          <option value="#008080">Teal</option>
                          <option value="#d8bfd8">Thistle</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#40e0d0">Turquoise</option>
                          <option value="#ee82ee">Violet</option>
                          <option value="#f5deb3">Wheat</option>
                          <option value="#ffffff">White Smoke</option>
                      </select></label>
                      <label for="customAccent3">5. Accent 3 (Navy): <select id="customAccent3" aria-label="Accent 3">
                          <option value="#2345a0">Navy</option>
                          <option value="#ff9933">Saffron</option>
                          <option value="#138808">Green</option>
                          <option value="#ffffff">White</option>
                          <option value="#000000">Black</option>
                          <option value="#111111">Dark Gray</option>
                          <option value="#ff0000">Red</option>
                          <option value="#00ff00">Green</option>
                          <option value="#0000ff">Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#ff00ff">Magenta</option>
                          <option value="#00ffff">Cyan</option>
                          <option value="#800080">Purple</option>
                          <option value="#ffa500">Orange</option>
                          <option value="#ffc0cb">Pink</option>
                          <option value="#a52a2a">Brown</option>
                          <option value="#808080">Gray</option>
                          <option value="#800000">Maroon</option>
                          <option value="#808000">Olive</option>
                          <option value="#008080">Teal</option>
                          <option value="#000080">Navy</option>
                          <option value="#ffffe0">Light Yellow</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#dc143c">Crimson</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#ff1493">Deep Pink</option>
                          <option value="#00bfff">Deep Sky Blue</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#8b0000">Dark Red</option>
                          <option value="#556b2f">Dark Olive Green</option>
                          <option value="#ff4500">Orange Red</option>
                          <option value="#9370db">Medium Purple</option>
                          <option value="#32cd32">Lime Green</option>
                          <option value="#8a2be2">Blue Violet</option>
                          <option value="#5f9ea0">Cadet Blue</option>
                          <option value="#d2691e">Chocolate</option>
                          <option value="#6495ed">Cornflower Blue</option>
                          <option value="#ffb6c1">Light Pink</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#b0c4de">Light Steel Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#00ff00">Lime</option>
                          <option value="#800080">Indigo</option>
                          <option value="#800080">Violet</option>
                          <option value="#ffd700">Gold</option>
                          <option value="#c0c0c0">Silver</option>
                          <option value="#daa520">Dark Golden Rod</option>
                          <option value="#98fb98">Pale Green</option>
                          <option value="#f0e68c">Khaki</option>
                          <option value="#dda0dd">Plum</option>
                          <option value="#b0e0e6">Powder Blue</option>
                          <option value="#a0522d">Sienna</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#6b8e23">Olive Drab</option>
                          <option value="#708090">Slate Gray</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#4682b4">Steel Blue</option>
                          <option value="#d2b48c">Tan</option>
                          <option value="#008080">Teal</option>
                          <option value="#d8bfd8">Thistle</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#40e0d0">Turquoise</option>
                          <option value="#ee82ee">Violet</option>
                          <option value="#f5deb3">Wheat</option>
                          <option value="#ffffff">White Smoke</option>
                      </select></label>
                      <label for="customAccent4">6. Accent 4 (White): <select id="customAccent4" aria-label="Accent 4">
                          <option value="#ffffff">White</option>
                          <option value="#ff9933">Saffron</option>
                          <option value="#138808">Green</option>
                          <option value="#2345a0">Navy</option>
                          <option value="#000000">Black</option>
                          <option value="#111111">Dark Gray</option>
                          <option value="#ff0000">Red</option>
                          <option value="#00ff00">Green</option>
                          <option value="#0000ff">Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#ff00ff">Magenta</option>
                          <option value="#00ffff">Cyan</option>
                          <option value="#800080">Purple</option>
                          <option value="#ffa500">Orange</option>
                          <option value="#ffc0cb">Pink</option>
                          <option value="#a52a2a">Brown</option>
                          <option value="#808080">Gray</option>
                          <option value="#800000">Maroon</option>
                          <option value="#808000">Olive</option>
                          <option value="#008080">Teal</option>
                          <option value="#000080">Navy</option>
                          <option value="#ffffe0">Light Yellow</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#dc143c">Crimson</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#ff1493">Deep Pink</option>
                          <option value="#00bfff">Deep Sky Blue</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#8b0000">Dark Red</option>
                          <option value="#556b2f">Dark Olive Green</option>
                          <option value="#ff4500">Orange Red</option>
                          <option value="#9370db">Medium Purple</option>
                          <option value="#32cd32">Lime Green</option>
                          <option value="#8a2be2">Blue Violet</option>
                          <option value="#5f9ea0">Cadet Blue</option>
                          <option value="#d2691e">Chocolate</option>
                          <option value="#6495ed">Cornflower Blue</option>
                          <option value="#ffb6c1">Light Pink</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#b0c4de">Light Steel Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#00ff00">Lime</option>
                          <option value="#800080">Indigo</option>
                          <option value="#800080">Violet</option>
                          <option value="#ffd700">Gold</option>
                          <option value="#c0c0c0">Silver</option>
                          <option value="#daa520">Dark Golden Rod</option>
                          <option value="#98fb98">Pale Green</option>
                          <option value="#f0e68c">Khaki</option>
                          <option value="#dda0dd">Plum</option>
                          <option value="#b0e0e6">Powder Blue</option>
                          <option value="#a0522d">Sienna</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#6b8e23">Olive Drab</option>
                          <option value="#708090">Slate Gray</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#4682b4">Steel Blue</option>
                          <option value="#d2b48c">Tan</option>
                          <option value="#008080">Teal</option>
                          <option value="#d8bfd8">Thistle</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#40e0d0">Turquoise</option>
                          <option value="#ee82ee">Violet</option>
                          <option value="#f5deb3">Wheat</option>
                          <option value="#ffffff">White Smoke</option>
                      </select></label>
                      <label for="customTextColor">7. Main Text Color: <select id="customTextColor" aria-label="Text Color">
                          <option value="#111111">Dark Gray</option>
                          <option value="#000000">Black</option>
                          <option value="#ffffff">White</option>
                          <option value="#ff0000">Red</option>
                          <option value="#00ff00">Green</option>
                          <option value="#0000ff">Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#ff00ff">Magenta</option>
                          <option value="#00ffff">Cyan</option>
                          <option value="#800080">Purple</option>
                          <option value="#ffa500">Orange</option>
                          <option value="#ffc0cb">Pink</option>
                          <option value="#a52a2a">Brown</option>
                          <option value="#808080">Gray</option>
                          <option value="#800000">Maroon</option>
                          <option value="#808000">Olive</option>
                          <option value="#008080">Teal</option>
                          <option value="#000080">Navy</option>
                          <option value="#ffffe0">Light Yellow</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#dc143c">Crimson</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#ff1493">Deep Pink</option>
                          <option value="#00bfff">Deep Sky Blue</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#8b0000">Dark Red</option>
                          <option value="#556b2f">Dark Olive Green</option>
                          <option value="#ff4500">Orange Red</option>
                          <option value="#9370db">Medium Purple</option>
                          <option value="#32cd32">Lime Green</option>
                          <option value="#8a2be2">Blue Violet</option>
                          <option value="#5f9ea0">Cadet Blue</option>
                          <option value="#d2691e">Chocolate</option>
                          <option value="#6495ed">Cornflower Blue</option>
                          <option value="#ffb6c1">Light Pink</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#b0c4de">Light Steel Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#00ff00">Lime</option>
                          <option value="#800080">Indigo</option>
                          <option value="#800080">Violet</option>
                          <option value="#ffd700">Gold</option>
                          <option value="#c0c0c0">Silver</option>
                          <option value="#daa520">Dark Golden Rod</option>
                          <option value="#98fb98">Pale Green</option>
                          <option value="#f0e68c">Khaki</option>
                          <option value="#dda0dd">Plum</option>
                          <option value="#b0e0e6">Powder Blue</option>
                          <option value="#a0522d">Sienna</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#6b8e23">Olive Drab</option>
                          <option value="#708090">Slate Gray</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#4682b4">Steel Blue</option>
                          <option value="#d2b48c">Tan</option>
                          <option value="#008080">Teal</option>
                          <option value="#d8bfd8">Thistle</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#40e0d0">Turquoise</option>
                          <option value="#ee82ee">Violet</option>
                          <option value="#f5deb3">Wheat</option>
                          <option value="#ffffff">White Smoke</option>
                      </select></label>
                      <label for="customDateColor">8. Date Color: <select id="customDateColor" aria-label="Date Color">
                          <option value="#111111">Dark Gray</option>
                          <option value="#000000">Black</option>
                          <option value="#ffffff">White</option>
                          <option value="#ff0000">Red</option>
                          <option value="#00ff00">Green</option>
                          <option value="#0000ff">Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#ff00ff">Magenta</option>
                          <option value="#00ffff">Cyan</option>
                          <option value="#800080">Purple</option>
                          <option value="#ffa500">Orange</option>
                          <option value="#ffc0cb">Pink</option>
                          <option value="#a52a2a">Brown</option>
                          <option value="#808080">Gray</option>
                          <option value="#800000">Maroon</option>
                          <option value="#808000">Olive</option>
                          <option value="#008080">Teal</option>
                          <option value="#000080">Navy</option>
                          <option value="#ffffe0">Light Yellow</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#dc143c">Crimson</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#ff1493">Deep Pink</option>
                          <option value="#00bfff">Deep Sky Blue</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#8b0000">Dark Red</option>
                          <option value="#556b2f">Dark Olive Green</option>
                          <option value="#ff4500">Orange Red</option>
                          <option value="#9370db">Medium Purple</option>
                          <option value="#32cd32">Lime Green</option>
                          <option value="#8a2be2">Blue Violet</option>
                          <option value="#5f9ea0">Cadet Blue</option>
                          <option value="#d2691e">Chocolate</option>
                          <option value="#6495ed">Cornflower Blue</option>
                          <option value="#ffb6c1">Light Pink</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#b0c4de">Light Steel Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#00ff00">Lime</option>
                          <option value="#800080">Indigo</option>
                          <option value="#800080">Violet</option>
                          <option value="#ffd700">Gold</option>
                          <option value="#c0c0c0">Silver</option>
                          <option value="#daa520">Dark Golden Rod</option>
                          <option value="#98fb98">Pale Green</option>
                          <option value="#f0e68c">Khaki</option>
                          <option value="#dda0dd">Plum</option>
                          <option value="#b0e0e6">Powder Blue</option>
                          <option value="#a0522d">Sienna</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#6b8e23">Olive Drab</option>
                          <option value="#708090">Slate Gray</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#4682b4">Steel Blue</option>
                          <option value="#d2b48c">Tan</option>
                          <option value="#008080">Teal</option>
                          <option value="#d8bfd8">Thistle</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#40e0d0">Turquoise</option>
                          <option value="#ee82ee">Violet</option>
                          <option value="#f5deb3">Wheat</option>
                          <option value="#ffffff">White Smoke</option>
                      </select></label>
                      <label for="customInvoiceColor">9. Invoice No Color: <select id="customInvoiceColor" aria-label="Invoice Color">
                          <option value="#111111">Dark Gray</option>
                          <option value="#000000">Black</option>
                          <option value="#ffffff">White</option>
                          <option value="#ff0000">Red</option>
                          <option value="#00ff00">Green</option>
                          <option value="#0000ff">Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#ff00ff">Magenta</option>
                          <option value="#00ffff">Cyan</option>
                          <option value="#800080">Purple</option>
                          <option value="#ffa500">Orange</option>
                          <option value="#ffc0cb">Pink</option>
                          <option value="#a52a2a">Brown</option>
                          <option value="#808080">Gray</option>
                          <option value="#800000">Maroon</option>
                          <option value="#808000">Olive</option>
                          <option value="#008080">Teal</option>
                          <option value="#000080">Navy</option>
                          <option value="#ffffe0">Light Yellow</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#dc143c">Crimson</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#ff1493">Deep Pink</option>
                          <option value="#00bfff">Deep Sky Blue</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#8b0000">Dark Red</option>
                          <option value="#556b2f">Dark Olive Green</option>
                          <option value="#ff4500">Orange Red</option>
                          <option value="#9370db">Medium Purple</option>
                          <option value="#32cd32">Lime Green</option>
                          <option value="#8a2be2">Blue Violet</option>
                          <option value="#5f9ea0">Cadet Blue</option>
                          <option value="#d2691e">Chocolate</option>
                          <option value="#6495ed">Cornflower Blue</option>
                          <option value="#ffb6c1">Light Pink</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#b0c4de">Light Steel Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#00ff00">Lime</option>
                          <option value="#800080">Indigo</option>
                          <option value="#800080">Violet</option>
                          <option value="#ffd700">Gold</option>
                          <option value="#c0c0c0">Silver</option>
                          <option value="#daa520">Dark Golden Rod</option>
                          <option value="#98fb98">Pale Green</option>
                          <option value="#f0e68c">Khaki</option>
                          <option value="#dda0dd">Plum</option>
                          <option value="#b0e0e6">Powder Blue</option>
                          <option value="#a0522d">Sienna</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#6b8e23">Olive Drab</option>
                          <option value="#708090">Slate Gray</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#4682b4">Steel Blue</option>
                          <option value="#d2b48c">Tan</option>
                          <option value="#008080">Teal</option>
                          <option value="#d8bfd8">Thistle</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#40e0d0">Turquoise</option>
                          <option value="#ee82ee">Violet</option>
                          <option value="#f5deb3">Wheat</option>
                          <option value="#ffffff">White Smoke</option>
                      </select></label>
                      <label for="customDaysColor">10. Days Color: <select id="customDaysColor" aria-label="Days Color">
                          <option value="#b95f00">Orange</option>
                          <option value="#000000">Black</option>
                          <option value="#111111">Dark Gray</option>
                          <option value="#ffffff">White</option>
                          <option value="#ff0000">Red</option>
                          <option value="#00ff00">Green</option>
                          <option value="#0000ff">Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#ff00ff">Magenta</option>
                          <option value="#00ffff">Cyan</option>
                          <option value="#800080">Purple</option>
                          <option value="#ffa500">Orange</option>
                          <option value="#ffc0cb">Pink</option>
                          <option value="#a52a2a">Brown</option>
                          <option value="#808080">Gray</option>
                          <option value="#800000">Maroon</option>
                          <option value="#808000">Olive</option>
                          <option value="#008080">Teal</option>
                          <option value="#000080">Navy</option>
                          <option value="#ffffe0">Light Yellow</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#dc143c">Crimson</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#ff1493">Deep Pink</option>
                          <option value="#00bfff">Deep Sky Blue</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#8b0000">Dark Red</option>
                          <option value="#556b2f">Dark Olive Green</option>
                          <option value="#ff4500">Orange Red</option>
                          <option value="#9370db">Medium Purple</option>
                          <option value="#32cd32">Lime Green</option>
                          <option value="#8a2be2">Blue Violet</option>
                          <option value="#5f9ea0">Cadet Blue</option>
                          <option value="#d2691e">Chocolate</option>
                          <option value="#6495ed">Cornflower Blue</option>
                          <option value="#ffb6c1">Light Pink</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#b0c4de">Light Steel Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#00ff00">Lime</option>
                          <option value="#800080">Indigo</option>
                          <option value="#800080">Violet</option>
                          <option value="#ffd700">Gold</option>
                          <option value="#c0c0c0">Silver</option>
                          <option value="#daa520">Dark Golden Rod</option>
                          <option value="#98fb98">Pale Green</option>
                          <option value="#f0e68c">Khaki</option>
                          <option value="#dda0dd">Plum</option>
                          <option value="#b0e0e6">Powder Blue</option>
                          <option value="#a0522d">Sienna</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#6b8e23">Olive Drab</option>
                          <option value="#708090">Slate Gray</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#4682b4">Steel Blue</option>
                          <option value="#d2b48c">Tan</option>
                          <option value="#008080">Teal</option>
                          <option value="#d8bfd8">Thistle</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#40e0d0">Turquoise</option>
                          <option value="#ee82ee">Violet</option>
                          <option value="#f5deb3">Wheat</option>
                          <option value="#ffffff">White Smoke</option>
                      </select></label>
                      <label for="customDaysAgoColor">11. Days Ago Color: <select id="customDaysAgoColor" aria-label="Days Ago Color">
                          <option value="#b95f00">Orange</option>
                          <option value="#000000">Black</option>
                          <option value="#111111">Dark Gray</option>
                          <option value="#ffffff">White</option>
                          <option value="#ff0000">Red</option>
                          <option value="#00ff00">Green</option>
                          <option value="#0000ff">Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#ff00ff">Magenta</option>
                          <option value="#00ffff">Cyan</option>
                          <option value="#800080">Purple</option>
                          <option value="#ffa500">Orange</option>
                          <option value="#ffc0cb">Pink</option>
                          <option value="#a52a2a">Brown</option>
                          <option value="#808080">Gray</option>
                          <option value="#800000">Maroon</option>
                          <option value="#808000">Olive</option>
                          <option value="#008080">Teal</option>
                          <option value="#000080">Navy</option>
                          <option value="#ffffe0">Light Yellow</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#dc143c">Crimson</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#ff1493">Deep Pink</option>
                          <option value="#00bfff">Deep Sky Blue</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#8b0000">Dark Red</option>
                          <option value="#556b2f">Dark Olive Green</option>
                          <option value="#ff4500">Orange Red</option>
                          <option value="#9370db">Medium Purple</option>
                          <option value="#32cd32">Lime Green</option>
                          <option value="#8a2be2">Blue Violet</option>
                          <option value="#5f9ea0">Cadet Blue</option>
                          <option value="#d2691e">Chocolate</option>
                          <option value="#6495ed">Cornflower Blue</option>
                          <option value="#ffb6c1">Light Pink</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#b0c4de">Light Steel Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#00ff00">Lime</option>
                          <option value="#800080">Indigo</option>
                          <option value="#800080">Violet</option>
                          <option value="#ffd700">Gold</option>
                          <option value="#c0c0c0">Silver</option>
                          <option value="#daa520">Dark Golden Rod</option>
                          <option value="#98fb98">Pale Green</option>
                          <option value="#f0e68c">Khaki</option>
                          <option value="#dda0dd">Plum</option>
                          <option value="#b0e0e6">Powder Blue</option>
                          <option value="#a0522d">Sienna</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#6b8e23">Olive Drab</option>
                          <option value="#708090">Slate Gray</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#4682b4">Steel Blue</option>
                          <option value="#d2b48c">Tan</option>
                          <option value="#008080">Teal</option>
                          <option value="#d8bfd8">Thistle</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#40e0d0">Turquoise</option>
                          <option value="#ee82ee">Violet</option>
                          <option value="#f5deb3">Wheat</option>
                          <option value="#ffffff">White Smoke</option>
                      </select></label>
                      <label for="customCompanyColor">12. Company Color: <select id="customCompanyColor" aria-label="Company Color">
                          <option value="#111111">Dark Gray</option>
                          <option value="#000000">Black</option>
                          <option value="#ffffff">White</option>
                          <option value="#ff0000">Red</option>
                          <option value="#00ff00">Green</option>
                          <option value="#0000ff">Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#ff00ff">Magenta</option>
                          <option value="#00ffff">Cyan</option>
                          <option value="#800080">Purple</option>
                          <option value="#ffa500">Orange</option>
                          <option value="#ffc0cb">Pink</option>
                          <option value="#a52a2a">Brown</option>
                          <option value="#808080">Gray</option>
                          <option value="#800000">Maroon</option>
                          <option value="#808000">Olive</option>
                          <option value="#008080">Teal</option>
                          <option value="#000080">Navy</option>
                          <option value="#ffffe0">Light Yellow</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#dc143c">Crimson</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#ff1493">Deep Pink</option>
                          <option value="#00bfff">Deep Sky Blue</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#8b0000">Dark Red</option>
                          <option value="#556b2f">Dark Olive Green</option>
                          <option value="#ff4500">Orange Red</option>
                          <option value="#9370db">Medium Purple</option>
                          <option value="#32cd32">Lime Green</option>
                          <option value="#8a2be2">Blue Violet</option>
                          <option value="#5f9ea0">Cadet Blue</option>
                          <option value="#d2691e">Chocolate</option>
                          <option value="#6495ed">Cornflower Blue</option>
                          <option value="#ffb6c1">Light Pink</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#b0c4de">Light Steel Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#00ff00">Lime</option>
                          <option value="#800080">Indigo</option>
                          <option value="#800080">Violet</option>
                          <option value="#ffd700">Gold</option>
                          <option value="#c0c0c0">Silver</option>
                          <option value="#daa520">Dark Golden Rod</option>
                          <option value="#98fb98">Pale Green</option>
                          <option value="#f0e68c">Khaki</option>
                          <option value="#dda0dd">Plum</option>
                          <option value="#b0e0e6">Powder Blue</option>
                          <option value="#a0522d">Sienna</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#6b8e23">Olive Drab</option>
                          <option value="#708090">Slate Gray</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#4682b4">Steel Blue</option>
                          <option value="#d2b48c">Tan</option>
                          <option value="#008080">Teal</option>
                          <option value="#d8bfd8">Thistle</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#40e0d0">Turquoise</option>
                          <option value="#ee82ee">Violet</option>
                          <option value="#f5deb3">Wheat</option>
                          <option value="#ffffff">White Smoke</option>
                      </select></label>
                      <label for="customAmountColor">13. Amount Color: <select id="customAmountColor" aria-label="Amount Color">
                          <option value="#138808">Green</option>
                          <option value="#000000">Black</option>
                          <option value="#111111">Dark Gray</option>
                          <option value="#ffffff">White</option>
                          <option value="#ff0000">Red</option>
                          <option value="#00ff00">Green</option>
                          <option value="#0000ff">Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#ff00ff">Magenta</option>
                          <option value="#00ffff">Cyan</option>
                          <option value="#800080">Purple</option>
                          <option value="#ffa500">Orange</option>
                          <option value="#ffc0cb">Pink</option>
                          <option value="#a52a2a">Brown</option>
                          <option value="#808080">Gray</option>
                          <option value="#800000">Maroon</option>
                          <option value="#808000">Olive</option>
                          <option value="#008080">Teal</option>
                          <option value="#000080">Navy</option>
                          <option value="#ffffe0">Light Yellow</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#dc143c">Crimson</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#ff1493">Deep Pink</option>
                          <option value="#00bfff">Deep Sky Blue</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#8b0000">Dark Red</option>
                          <option value="#556b2f">Dark Olive Green</option>
                          <option value="#ff4500">Orange Red</option>
                          <option value="#9370db">Medium Purple</option>
                          <option value="#32cd32">Lime Green</option>
                          <option value="#8a2be2">Blue Violet</option>
                          <option value="#5f9ea0">Cadet Blue</option>
                          <option value="#d2691e">Chocolate</option>
                          <option value="#6495ed">Cornflower Blue</option>
                          <option value="#ffb6c1">Light Pink</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#b0c4de">Light Steel Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#00ff00">Lime</option>
                          <option value="#800080">Indigo</option>
                          <option value="#800080">Violet</option>
                          <option value="#ffd700">Gold</option>
                          <option value="#c0c0c0">Silver</option>
                          <option value="#daa520">Dark Golden Rod</option>
                          <option value="#98fb98">Pale Green</option>
                          <option value="#f0e68c">Khaki</option>
                          <option value="#dda0dd">Plum</option>
                          <option value="#b0e0e6">Powder Blue</option>
                          <option value="#a0522d">Sienna</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#6b8e23">Olive Drab</option>
                          <option value="#708090">Slate Gray</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#4682b4">Steel Blue</option>
                          <option value="#d2b48c">Tan</option>
                          <option value="#008080">Teal</option>
                          <option value="#d8bfd8">Thistle</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#40e0d0">Turquoise</option>
                          <option value="#ee82ee">Violet</option>
                          <option value="#f5deb3">Wheat</option>
                          <option value="#ffffff">White Smoke</option>
                      </select></label>
                      <label for="customButtonBgColor">14. Button Background Color: <select id="customButtonBgColor" aria-label="Button BG Color">
                          <option value="#138808">Green</option>
                          <option value="#ff9933">Saffron</option>
                          <option value="#2345a0">Navy</option>
                          <option value="#ffffff">White</option>
                          <option value="#000000">Black</option>
                          <option value="#111111">Dark Gray</option>
                          <option value="#ff0000">Red</option>
                          <option value="#00ff00">Green</option>
                          <option value="#0000ff">Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#ff00ff">Magenta</option>
                          <option value="#00ffff">Cyan</option>
                          <option value="#800080">Purple</option>
                          <option value="#ffa500">Orange</option>
                          <option value="#ffc0cb">Pink</option>
                          <option value="#a52a2a">Brown</option>
                          <option value="#808080">Gray</option>
                          <option value="#800000">Maroon</option>
                          <option value="#808000">Olive</option>
                          <option value="#008080">Teal</option>
                          <option value="#000080">Navy</option>
                          <option value="#ffffe0">Light Yellow</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#dc143c">Crimson</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#ff1493">Deep Pink</option>
                          <option value="#00bfff">Deep Sky Blue</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#8b0000">Dark Red</option>
                          <option value="#556b2f">Dark Olive Green</option>
                          <option value="#ff4500">Orange Red</option>
                          <option value="#9370db">Medium Purple</option>
                          <option value="#32cd32">Lime Green</option>
                          <option value="#8a2be2">Blue Violet</option>
                          <option value="#5f9ea0">Cadet Blue</option>
                          <option value="#d2691e">Chocolate</option>
                          <option value="#6495ed">Cornflower Blue</option>
                          <option value="#ffb6c1">Light Pink</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#b0c4de">Light Steel Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#00ff00">Lime</option>
                          <option value="#800080">Indigo</option>
                          <option value="#800080">Violet</option>
                          <option value="#ffd700">Gold</option>
                          <option value="#c0c0c0">Silver</option>
                          <option value="#daa520">Dark Golden Rod</option>
                          <option value="#98fb98">Pale Green</option>
                          <option value="#f0e68c">Khaki</option>
                          <option value="#dda0dd">Plum</option>
                          <option value="#b0e0e6">Powder Blue</option>
                          <option value="#a0522d">Sienna</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#6b8e23">Olive Drab</option>
                          <option value="#708090">Slate Gray</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#4682b4">Steel Blue</option>
                          <option value="#d2b48c">Tan</option>
                          <option value="#008080">Teal</option>
                          <option value="#d8bfd8">Thistle</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#40e0d0">Turquoise</option>
                          <option value="#ee82ee">Violet</option>
                          <option value="#f5deb3">Wheat</option>
                          <option value="#ffffff">White Smoke</option>
                      </select></label>
                      <label for="customCardBgColor">15. Card Background Color: <select id="customCardBgColor" aria-label="Card BG Color">
                          <option value="#ffffff">White</option>
                          <option value="#ff9933">Saffron</option>
                          <option value="#138808">Green</option>
                          <option value="#2345a0">Navy</option>
                          <option value="#000000">Black</option>
                          <option value="#111111">Dark Gray</option>
                          <option value="#ff0000">Red</option>
                          <option value="#00ff00">Green</option>
                          <option value="#0000ff">Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#ff00ff">Magenta</option>
                          <option value="#00ffff">Cyan</option>
                          <option value="#800080">Purple</option>
                          <option value="#ffa500">Orange</option>
                          <option value="#ffc0cb">Pink</option>
                          <option value="#a52a2a">Brown</option>
                          <option value="#808080">Gray</option>
                          <option value="#800000">Maroon</option>
                          <option value="#808000">Olive</option>
                          <option value="#008080">Teal</option>
                          <option value="#000080">Navy</option>
                          <option value="#ffffe0">Light Yellow</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#dc143c">Crimson</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#ff1493">Deep Pink</option>
                          <option value="#00bfff">Deep Sky Blue</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#8b0000">Dark Red</option>
                          <option value="#556b2f">Dark Olive Green</option>
                          <option value="#ff4500">Orange Red</option>
                          <option value="#9370db">Medium Purple</option>
                          <option value="#32cd32">Lime Green</option>
                          <option value="#8a2be2">Blue Violet</option>
                          <option value="#5f9ea0">Cadet Blue</option>
                          <option value="#d2691e">Chocolate</option>
                          <option value="#6495ed">Cornflower Blue</option>
                          <option value="#ffb6c1">Light Pink</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#b0c4de">Light Steel Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#00ff00">Lime</option>
                          <option value="#800080">Indigo</option>
                          <option value="#800080">Violet</option>
                          <option value="#ffd700">Gold</option>
                          <option value="#c0c0c0">Silver</option>
                          <option value="#daa520">Dark Golden Rod</option>
                          <option value="#98fb98">Pale Green</option>
                          <option value="#f0e68c">Khaki</option>
                          <option value="#dda0dd">Plum</option>
                          <option value="#b0e0e6">Powder Blue</option>
                          <option value="#a0522d">Sienna</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#6b8e23">Olive Drab</option>
                          <option value="#708090">Slate Gray</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#4682b4">Steel Blue</option>
                          <option value="#d2b48c">Tan</option>
                          <option value="#008080">Teal</option>
                          <option value="#d8bfd8">Thistle</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#40e0d0">Turquoise</option>
                          <option value="#ee82ee">Violet</option>
                          <option value="#f5deb3">Wheat</option>
                          <option value="#ffffff">White Smoke</option>
                      </select></label>
                      <label for="customSLColor">16. SL Text Color: <select id="customSLColor" aria-label="SL Color">
                          <option value="#111111">Dark Gray</option>
                          <option value="#000000">Black</option>
                          <option value="#ffffff">White</option>
                          <option value="#ff0000">Red</option>
                          <option value="#00ff00">Green</option>
                          <option value="#0000ff">Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#ff00ff">Magenta</option>
                          <option value="#00ffff">Cyan</option>
                          <option value="#800080">Purple</option>
                          <option value="#ffa500">Orange</option>
                          <option value="#ffc0cb">Pink</option>
                          <option value="#a52a2a">Brown</option>
                          <option value="#808080">Gray</option>
                          <option value="#800000">Maroon</option>
                          <option value="#808000">Olive</option>
                          <option value="#008080">Teal</option>
                          <option value="#000080">Navy</option>
                          <option value="#ffffe0">Light Yellow</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#dc143c">Crimson</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#ff1493">Deep Pink</option>
                          <option value="#00bfff">Deep Sky Blue</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#8b0000">Dark Red</option>
                          <option value="#556b2f">Dark Olive Green</option>
                          <option value="#ff4500">Orange Red</option>
                          <option value="#9370db">Medium Purple</option>
                          <option value="#32cd32">Lime Green</option>
                          <option value="#8a2be2">Blue Violet</option>
                          <option value="#5f9ea0">Cadet Blue</option>
                          <option value="#d2691e">Chocolate</option>
                          <option value="#6495ed">Cornflower Blue</option>
                          <option value="#ffb6c1">Light Pink</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#b0c4de">Light Steel Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#00ff00">Lime</option>
                          <option value="#800080">Indigo</option>
                          <option value="#800080">Violet</option>
                          <option value="#ffd700">Gold</option>
                          <option value="#c0c0c0">Silver</option>
                          <option value="#daa520">Dark Golden Rod</option>
                          <option value="#98fb98">Pale Green</option>
                          <option value="#f0e68c">Khaki</option>
                          <option value="#dda0dd">Plum</option>
                          <option value="#b0e0e6">Powder Blue</option>
                          <option value="#a0522d">Sienna</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#6b8e23">Olive Drab</option>
                          <option value="#708090">Slate Gray</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#4682b4">Steel Blue</option>
                          <option value="#d2b48c">Tan</option>
                          <option value="#008080">Teal</option>
                          <option value="#d8bfd8">Thistle</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#40e0d0">Turquoise</option>
                          <option value="#ee82ee">Violet</option>
                          <option value="#f5deb3">Wheat</option>
                          <option value="#ffffff">White Smoke</option>
                      </select></label>
                      <label for="customWarningTextColor">17. Warning Text: <select id="customWarningTextColor" aria-label="Warning Color">
                          <option value="#b95f00">Orange</option>
                          <option value="#000000">Black</option>
                          <option value="#111111">Dark Gray</option>
                          <option value="#ffffff">White</option>
                          <option value="#ff0000">Red</option>
                          <option value="#00ff00">Green</option>
                          <option value="#0000ff">Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#ff00ff">Magenta</option>
                          <option value="#00ffff">Cyan</option>
                          <option value="#800080">Purple</option>
                          <option value="#ffa500">Orange</option>
                          <option value="#ffc0cb">Pink</option>
                          <option value="#a52a2a">Brown</option>
                          <option value="#808080">Gray</option>
                          <option value="#800000">Maroon</option>
                          <option value="#808000">Olive</option>
                          <option value="#008080">Teal</option>
                          <option value="#000080">Navy</option>
                          <option value="#ffffe0">Light Yellow</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#dc143c">Crimson</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#ff1493">Deep Pink</option>
                          <option value="#00bfff">Deep Sky Blue</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#8b0000">Dark Red</option>
                          <option value="#556b2f">Dark Olive Green</option>
                          <option value="#ff4500">Orange Red</option>
                          <option value="#9370db">Medium Purple</option>
                          <option value="#32cd32">Lime Green</option>
                          <option value="#8a2be2">Blue Violet</option>
                          <option value="#5f9ea0">Cadet Blue</option>
                          <option value="#d2691e">Chocolate</option>
                          <option value="#6495ed">Cornflower Blue</option>
                          <option value="#ffb6c1">Light Pink</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#b0c4de">Light Steel Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#00ff00">Lime</option>
                          <option value="#800080">Indigo</option>
                          <option value="#800080">Violet</option>
                          <option value="#ffd700">Gold</option>
                          <option value="#c0c0c0">Silver</option>
                          <option value="#daa520">Dark Golden Rod</option>
                          <option value="#98fb98">Pale Green</option>
                          <option value="#f0e68c">Khaki</option>
                          <option value="#dda0dd">Plum</option>
                          <option value="#b0e0e6">Powder Blue</option>
                          <option value="#a0522d">Sienna</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#6b8e23">Olive Drab</option>
                          <option value="#708090">Slate Gray</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#4682b4">Steel Blue</option>
                          <option value="#d2b48c">Tan</option>
                          <option value="#008080">Teal</option>
                          <option value="#d8bfd8">Thistle</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#40e0d0">Turquoise</option>
                          <option value="#ee82ee">Violet</option>
                          <option value="#f5deb3">Wheat</option>
                          <option value="#ffffff">White Smoke</option>
                      </select></label>
                      <label for="customCashColor">18. Cash Payment Color: <select id="customCashColor" aria-label="Cash Color">
                          <option value="#138808">Green</option>
                          <option value="#ff9933">Saffron</option>
                          <option value="#2345a0">Navy</option>
                          <option value="#ffffff">White</option>
                          <option value="#000000">Black</option>
                          <option value="#111111">Dark Gray</option>
                          <option value="#ff0000">Red</option>
                          <option value="#00ff00">Green</option>
                          <option value="#0000ff">Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#ff00ff">Magenta</option>
                          <option value="#00ffff">Cyan</option>
                          <option value="#800080">Purple</option>
                          <option value="#ffa500">Orange</option>
                          <option value="#ffc0cb">Pink</option>
                          <option value="#a52a2a">Brown</option>
                          <option value="#808080">Gray</option>
                          <option value="#800000">Maroon</option>
                          <option value="#808000">Olive</option>
                          <option value="#008080">Teal</option>
                          <option value="#000080">Navy</option>
                          <option value="#ffffe0">Light Yellow</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#dc143c">Crimson</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#ff1493">Deep Pink</option>
                          <option value="#00bfff">Deep Sky Blue</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#8b0000">Dark Red</option>
                          <option value="#556b2f">Dark Olive Green</option>
                          <option value="#ff4500">Orange Red</option>
                          <option value="#9370db">Medium Purple</option>
                          <option value="#32cd32">Lime Green</option>
                          <option value="#8a2be2">Blue Violet</option>
                          <option value="#5f9ea0">Cadet Blue</option>
                          <option value="#d2691e">Chocolate</option>
                          <option value="#6495ed">Cornflower Blue</option>
                          <option value="#ffb6c1">Light Pink</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#b0c4de">Light Steel Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#00ff00">Lime</option>
                          <option value="#800080">Indigo</option>
                          <option value="#800080">Violet</option>
                          <option value="#ffd700">Gold</option>
                          <option value="#c0c0c0">Silver</option>
                          <option value="#daa520">Dark Golden Rod</option>
                          <option value="#98fb98">Pale Green</option>
                          <option value="#f0e68c">Khaki</option>
                          <option value="#dda0dd">Plum</option>
                          <option value="#b0e0e6">Powder Blue</option>
                          <option value="#a0522d">Sienna</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#6b8e23">Olive Drab</option>
                          <option value="#708090">Slate Gray</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#4682b4">Steel Blue</option>
                          <option value="#d2b48c">Tan</option>
                          <option value="#008080">Teal</option>
                          <option value="#d8bfd8">Thistle</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#40e0d0">Turquoise</option>
                          <option value="#ee82ee">Violet</option>
                          <option value="#f5deb3">Wheat</option>
                          <option value="#ffffff">White Smoke</option>
                      </select></label>
                      <label for="customOnlineColor">19. Online Payment Color: <select id="customOnlineColor" aria-label="Online Color">
                          <option value="#138808">Green</option>
                          <option value="#ff9933">Saffron</option>
                          <option value="#2345a0">Navy</option>
                          <option value="#ffffff">White</option>
                          <option value="#000000">Black</option>
                          <option value="#111111">Dark Gray</option>
                          <option value="#ff0000">Red</option>
                          <option value="#00ff00">Green</option>
                          <option value="#0000ff">Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#ff00ff">Magenta</option>
                          <option value="#00ffff">Cyan</option>
                          <option value="#800080">Purple</option>
                          <option value="#ffa500">Orange</option>
                          <option value="#ffc0cb">Pink</option>
                          <option value="#a52a2a">Brown</option>
                          <option value="#808080">Gray</option>
                          <option value="#800000">Maroon</option>
                          <option value="#808000">Olive</option>
                          <option value="#008080">Teal</option>
                          <option value="#000080">Navy</option>
                          <option value="#ffffe0">Light Yellow</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#dc143c">Crimson</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#ff1493">Deep Pink</option>
                          <option value="#00bfff">Deep Sky Blue</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#8b0000">Dark Red</option>
                          <option value="#556b2f">Dark Olive Green</option>
                          <option value="#ff4500">Orange Red</option>
                          <option value="#9370db">Medium Purple</option>
                          <option value="#32cd32">Lime Green</option>
                          <option value="#8a2be2">Blue Violet</option>
                          <option value="#5f9ea0">Cadet Blue</option>
                          <option value="#d2691e">Chocolate</option>
                          <option value="#6495ed">Cornflower Blue</option>
                          <option value="#ffb6c1">Light Pink</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#b0c4de">Light Steel Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#00ff00">Lime</option>
                          <option value="#800080">Indigo</option>
                          <option value="#800080">Violet</option>
                          <option value="#ffd700">Gold</option>
                          <option value="#c0c0c0">Silver</option>
                          <option value="#daa520">Dark Golden Rod</option>
                          <option value="#98fb98">Pale Green</option>
                          <option value="#f0e68c">Khaki</option>
                          <option value="#dda0dd">Plum</option>
                          <option value="#b0e0e6">Powder Blue</option>
                          <option value="#a0522d">Sienna</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#6b8e23">Olive Drab</option>
                          <option value="#708090">Slate Gray</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#4682b4">Steel Blue</option>
                          <option value="#d2b48c">Tan</option>
                          <option value="#008080">Teal</option>
                          <option value="#d8bfd8">Thistle</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#40e0d0">Turquoise</option>
                          <option value="#ee82ee">Violet</option>
                          <option value="#f5deb3">Wheat</option>
                          <option value="#ffffff">White Smoke</option>
                      </select></label>
                      <label for="customCheckColor">20. Check Payment Color: <select id="customCheckColor" aria-label="Check Color">
                          <option value="#138808">Green</option>
                          <option value="#ff9933">Saffron</option>
                          <option value="#2345a0">Navy</option>
                          <option value="#ffffff">White</option>
                          <option value="#000000">Black</option>
                          <option value="#111111">Dark Gray</option>
                          <option value="#ff0000">Red</option>
                          <option value="#00ff00">Green</option>
                          <option value="#0000ff">Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#ff00ff">Magenta</option>
                          <option value="#00ffff">Cyan</option>
                          <option value="#800080">Purple</option>
                          <option value="#ffa500">Orange</option>
                          <option value="#ffc0cb">Pink</option>
                          <option value="#a52a2a">Brown</option>
                          <option value="#808080">Gray</option>
                          <option value="#800000">Maroon</option>
                          <option value="#808000">Olive</option>
                          <option value="#008080">Teal</option>
                          <option value="#000080">Navy</option>
                          <option value="#ffffe0">Light Yellow</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#dc143c">Crimson</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#ff1493">Deep Pink</option>
                          <option value="#00bfff">Deep Sky Blue</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#8b0000">Dark Red</option>
                          <option value="#556b2f">Dark Olive Green</option>
                          <option value="#ff4500">Orange Red</option>
                          <option value="#9370db">Medium Purple</option>
                          <option value="#32cd32">Lime Green</option>
                          <option value="#8a2be2">Blue Violet</option>
                          <option value="#5f9ea0">Cadet Blue</option>
                          <option value="#d2691e">Chocolate</option>
                          <option value="#6495ed">Cornflower Blue</option>
                          <option value="#ffb6c1">Light Pink</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#b0c4de">Light Steel Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#00ff00">Lime</option>
                          <option value="#800080">Indigo</option>
                          <option value="#800080">Violet</option>
                          <option value="#ffd700">Gold</option>
                          <option value="#c0c0c0">Silver</option>
                          <option value="#daa520">Dark Golden Rod</option>
                          <option value="#98fb98">Pale Green</option>
                          <option value="#f0e68c">Khaki</option>
                          <option value="#dda0dd">Plum</option>
                          <option value="#b0e0e6">Powder Blue</option>
                          <option value="#a0522d">Sienna</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#6b8e23">Olive Drab</option>
                          <option value="#708090">Slate Gray</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#4682b4">Steel Blue</option>
                          <option value="#d2b48c">Tan</option>
                          <option value="#008080">Teal</option>
                          <option value="#d8bfd8">Thistle</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#40e0d0">Turquoise</option>
                          <option value="#ee82ee">Violet</option>
                          <option value="#f5deb3">Wheat</option>
                          <option value="#ffffff">White Smoke</option>
                      </select></label>
                      <label for="customLicColor">21. LIC Payment Color: <select id="customLicColor" aria-label="LIC Color">
                          <option value="#138808">Green</option>
                          <option value="#ff9933">Saffron</option>
                          <option value="#2345a0">Navy</option>
                          <option value="#ffffff">White</option>
                          <option value="#000000">Black</option>
                          <option value="#111111">Dark Gray</option>
                          <option value="#ff0000">Red</option>
                          <option value="#00ff00">Green</option>
                          <option value="#0000ff">Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#ff00ff">Magenta</option>
                          <option value="#00ffff">Cyan</option>
                          <option value="#800080">Purple</option>
                          <option value="#ffa500">Orange</option>
                          <option value="#ffc0cb">Pink</option>
                          <option value="#a52a2a">Brown</option>
                          <option value="#808080">Gray</option>
                          <option value="#800000">Maroon</option>
                          <option value="#808000">Olive</option>
                          <option value="#008080">Teal</option>
                          <option value="#000080">Navy</option>
                          <option value="#ffffe0">Light Yellow</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#dc143c">Crimson</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#ff1493">Deep Pink</option>
                          <option value="#00bfff">Deep Sky Blue</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#8b0000">Dark Red</option>
                          <option value="#556b2f">Dark Olive Green</option>
                          <option value="#ff4500">Orange Red</option>
                          <option value="#9370db">Medium Purple</option>
                          <option value="#32cd32">Lime Green</option>
                          <option value="#8a2be2">Blue Violet</option>
                          <option value="#5f9ea0">Cadet Blue</option>
                          <option value="#d2691e">Chocolate</option>
                          <option value="#6495ed">Cornflower Blue</option>
                          <option value="#ffb6c1">Light Pink</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#b0c4de">Light Steel Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#00ff00">Lime</option>
                          <option value="#800080">Indigo</option>
                          <option value="#800080">Violet</option>
                          <option value="#ffd700">Gold</option>
                          <option value="#c0c0c0">Silver</option>
                          <option value="#daa520">Dark Golden Rod</option>
                          <option value="#98fb98">Pale Green</option>
                          <option value="#f0e68c">Khaki</option>
                          <option value="#dda0dd">Plum</option>
                          <option value="#b0e0e6">Powder Blue</option>
                          <option value="#a0522d">Sienna</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#6b8e23">Olive Drab</option>
                          <option value="#708090">Slate Gray</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#4682b4">Steel Blue</option>
                          <option value="#d2b48c">Tan</option>
                          <option value="#008080">Teal</option>
                          <option value="#d8bfd8">Thistle</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#40e0d0">Turquoise</option>
                          <option value="#ee82ee">Violet</option>
                          <option value="#f5deb3">Wheat</option>
                          <option value="#ffffff">White Smoke</option>
                      </select></label>
                      <label for="customHeaderBgColor">22. Header Background Color: <select id="customHeaderBgColor" aria-label="Header Background Color">
                          <option value="#ffffff">White</option>
                          <option value="#ff9933">Saffron</option>
                          <option value="#138808">Green</option>
                          <option value="#2345a0">Navy</option>
                          <option value="#000000">Black</option>
                          <option value="#111111">Dark Gray</option>
                          <option value="#ff0000">Red</option>
                          <option value="#00ff00">Green</option>
                          <option value="#0000ff">Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#ff00ff">Magenta</option>
                          <option value="#00ffff">Cyan</option>
                          <option value="#800080">Purple</option>
                          <option value="#ffa500">Orange</option>
                          <option value="#ffc0cb">Pink</option>
                          <option value="#a52a2a">Brown</option>
                          <option value="#808080">Gray</option>
                          <option value="#800000">Maroon</option>
                          <option value="#808000">Olive</option>
                          <option value="#008080">Teal</option>
                          <option value="#000080">Navy</option>
                          <option value="#ffffe0">Light Yellow</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#dc143c">Crimson</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#ff1493">Deep Pink</option>
                          <option value="#00bfff">Deep Sky Blue</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#8b0000">Dark Red</option>
                          <option value="#556b2f">Dark Olive Green</option>
                          <option value="#ff4500">Orange Red</option>
                          <option value="#9370db">Medium Purple</option>
                          <option value="#32cd32">Lime Green</option>
                          <option value="#8a2be2">Blue Violet</option>
                          <option value="#5f9ea0">Cadet Blue</option>
                          <option value="#d2691e">Chocolate</option>
                          <option value="#6495ed">Cornflower Blue</option>
                          <option value="#ffb6c1">Light Pink</option>
                          <option value="#daa520">Golden Rod</option>
                          <option value="#b0c4de">Light Steel Blue</option>
                          <option value="#ffff00">Yellow</option>
                          <option value="#00ff00">Lime</option>
                          <option value="#800080">Indigo</option>
                          <option value="#800080">Violet</option>
                          <option value="#ffd700">Gold</option>
                          <option value="#c0c0c0">Silver</option>
                          <option value="#daa520">Dark Golden Rod</option>
                          <option value="#98fb98">Pale Green</option>
                          <option value="#f0e68c">Khaki</option>
                          <option value="#dda0dd">Plum</option>
                          <option value="#b0e0e6">Powder Blue</option>
                          <option value="#a0522d">Sienna</option>
                          <option value="#87ceeb">Sky Blue</option>
                          <option value="#6b8e23">Olive Drab</option>
                          <option value="#708090">Slate Gray</option>
                          <option value="#00ff7f">Spring Green</option>
                          <option value="#4682b4">Steel Blue</option>
                          <option value="#d2b48c">Tan</option>
                          <option value="#008080">Teal</option>
                          <option value="#d8bfd8">Thistle</option>
                          <option value="#ff6347">Tomato</option>
                          <option value="#40e0d0">Turquoise</option>
                          <option value="#ee82ee">Violet</option>
                          <option value="#f5deb3">Wheat</option>
                          <option value="#ffffff">White Smoke</option>
                      </select></label>
                  </div>
              </div>
          </div>

          <div class="accordion-item">
            <div class="accordion-header"><h3 style="margin:0;">14. üîí LOCK SCREEN SETTINGS</h3></div>
            <div class="accordion-content">
              <div class="controls-row">
                  <label for="lockScreenEnabled">Enable Lock Screen: <input type="checkbox" id="lockScreenEnabled" aria-label="Enable Lock Screen"></label>
              </div>
              <div class="controls-row">
                  <label for="changePasswordBtn">Change Password: <button id="changePasswordBtn" class="primary" aria-label="Change Password">CHANGE PASSWORD</button></label>
              </div>
              <div class="controls-row">
                  <label for="changeSecurityAnswerBtn">Change Security Answer: <button id="changeSecurityAnswerBtn" class="primary" aria-label="Change Security Answer">CHANGE ANSWER</button></label>
              </div>
              <div class="controls-row">
                  <label for="autoGenPasswordEnabled">Auto-generate Password: <input type="checkbox" id="autoGenPasswordEnabled" aria-label="Enable Auto-generate Password"></label>
              </div>
              <div class="controls-row">
                  <label for="timeFormatType">Time Format (if Time): <select id="timeFormatType" aria-label="Time Format Type">
                      <option value="24">24-hour</option>
                      <option value="12">12-hour</option>
                      <option value="ddmmyy">DDMMYY</option>
                  </select></label>
              </div>
              <div class="controls-row">
                  <label for="todaysPasswordDisplay">Today's Password: <input type="text" id="todaysPasswordDisplay" readonly aria-label="Today's Password Display"></label>
              </div>
              <div class="controls-row">
                  <label for="togglePasswordVisibility">Show Password: <button id="togglePasswordVisibility" class="primary" aria-label="Toggle Password Visibility">SHOW</button></label>
              </div>
              <div class="controls-row">
                  <label for="currentPasswordDisplay">Current Password: <input type="text" id="currentPasswordDisplay" readonly aria-label="Current Password Display"></label>
              </div>
              <div class="controls-row">
                  <label for="toggleSecurityAnswerVisibility">Show Security Answer: <button id="toggleSecurityAnswerVisibility" class="primary" aria-label="Toggle Security Answer Visibility">SHOW</button></label>
              </div>
              <div class="controls-row">
                  <label for="currentSecurityAnswerDisplay">Current Security Answer: <input type="text" id="currentSecurityAnswerDisplay" readonly aria-label="Current Security Answer Display"></label>
              </div>
              <div class="controls-row">
                  <label for="forgetPasswordBtn">Forget Password: <button id="forgetBtn" class="primary" aria-label="Forget Password">FORGET PASSWORD</button></label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- FOLDER SELECTION SECTION BELOW SETTINGS -->
    <section id="folderSection">
      <div class="card">
        <h2>üìÇ Folder Selection</h2>
        <p id="folderBadge">No folder selected yet.</p>
        <button id="setFolderBtn" aria-label="Select Folder">Select Folder</button>
        <button id="unsetFolderBtn" aria-label="Unset Folder">UNSET</button>
        <p id="folderStatus">No folder selected yet.</p>
      </div>
    </section>

  </div>

  <!-- Share Modal Backdrop -->
  <div id="shareBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="shareTitle">
      <h3 id="shareTitle">SHARE OPTION ‚Äî PREVIEW</h3>
      <p class="small-muted">Preview of the data you'll share. Use Export buttons to get CSV/PDF for each section.</p>
      <div id="sharePreviewContainer"></div>
      <div style="margin-top:10px;">
        <strong>Notes:</strong>
        <div class="small-muted">‚Ä¢ Copy will place the full JSON (export format) into clipboard. ‚Ä¢ WhatsApp will open with a short summary and copy JSON automatically.</div>
      </div>
      <div class="modal-actions">
        <button id="shareCopyModalBtn" class="primary" title="Copy JSON data" aria-label="Copy JSON">üìã Copy JSON</button>
        <button id="shareWhatsappModalBtn" class="ghost" title="Share summary on WhatsApp" aria-label="Share on WhatsApp">üü¢ WhatsApp (summary)</button>
        <button id="closeShareModalBtn" class="ghost" title="Close" aria-label="Close Modal">‚ùå Close</button>
      </div>
    </div>
  </div>

  <!-- Universal Detail Modal -->
  <div id="detailModalBackdrop" class="modal-backdrop no-print" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="detailModalTitle">
      <h3 id="detailModalTitle">Details</h3>
      <div id="detailModalContent"></div>
      <div class="modal-actions">
        <button id="closeDetailModalBtn" class="ghost" title="Close" aria-label="Close Detail Modal">‚ùå Close</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Saved</div>

  <!-- Loading Overlay for heavy operations -->
  <div id="loadingOverlay" class="loading-overlay">
    <span class="spinner"></span>
  </div>

  <!-- Inline App JS -->
  <script>
    // Enhanced security: Encrypt passwords using CryptoJS (improved)
    function encryptPassword(pass) {
      return CryptoJS.AES.encrypt(pass, 'secret-key').toString(); // Use a proper key in production
    }
    function decryptPassword(encrypted) {
      try {
        const bytes = CryptoJS.AES.decrypt(encrypted, 'secret-key');
        return bytes.toString(CryptoJS.enc.Utf8);
      } catch (e) {
        return '';
      }
    }

    // Error handling wrapper (Fixed: Added)
    function safeExecute(fn, ...args) {
      try {
        return fn(...args);
      } catch (e) {
        console.error('Error:', e);
        showToast('Error: ' + e.message);
        return null;
      }
    }

    // Validate inputs to prevent XSS
    function sanitizeInput(input) {
      return DOMPurify.sanitize(input, { ALLOWED_TAGS: [] }).trim();
    }

    const toUpper = (str) => String(str || '').toUpperCase();
    
    // ---------------- Utilities ----------------
    const INR = n => {
      let formatted = new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR', maximumFractionDigits:2}).format(Number(n||0));
      if (formatted.endsWith('.00')) {
        formatted = formatted.slice(0, -3);
      }
      return formatted;
    };
    const showToast = (msg='Saved') => {
      console.log('Toast triggered:', msg); // Debugging log
      const t = document.getElementById('toast');
      if (!t) return;
      t.textContent = msg; t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 1400);
    };
    const uid = () => `id-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

    // Beep sound settings (Fixed: try-catch added)
    const BEEP_KEY = 'ui.beepPrefs';
    let beepPrefs = { enabled: false, volume: 2.0, frequency: 700, duration: 120, pattern: 'single' }; // Changed volume to 2.0 for 200%
    function loadBeepPrefs() {
        try { const raw = localStorage.getItem(BEEP_KEY); return raw ? JSON.parse(raw) : beepPrefs; } catch(e){ return beepPrefs; }
    }
    function saveBeepPrefs(p){ localStorage.setItem(BEEP_KEY, JSON.stringify(p)); }
    
    function playBeep(frequency, duration, pattern) {
      if (!beepPrefs.enabled) return;
      const vol = beepPrefs.volume;
      const freq = frequency || beepPrefs.frequency;
      const dur = duration || beepPrefs.duration;
      const patt = pattern || beepPrefs.pattern;
      const playSingleBeep = (freqVal, durVal) => {
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = 'sine';
          o.frequency.value = freqVal;
          g.gain.value = vol;
          o.connect(g);
          g.connect(ctx.destination);
          o.start();
          setTimeout(() => {
            o.stop();
            try { ctx.close(); } catch(e){}
          }, durVal);
        } catch (e) {
          console.warn('beep failed', e);
        }
      };
      if (patt === 'single') {
        playSingleBeep(freq, dur);
      } else if (patt === 'double') {
        playSingleBeep(freq, dur);
        setTimeout(() => playSingleBeep(freq, dur), dur + 50);
      } else if (patt === 'triple') {
        playSingleBeep(freq, dur);
        setTimeout(() => playSingleBeep(freq, dur), dur + 50);
        setTimeout(() => playSingleBeep(freq, dur), 2 * (dur + 50));
      } else if (patt === 'morse-sos') {
        // SOS: ... --- ... (3 dots, 3 dashes, 3 dots)
        const dotDur = dur;
        const dashDur = dur * 3;
        const gap = dur;
        const letterGap = dur * 3;
        // Dots: 3 short beeps
        playSingleBeep(freq, dotDur);
        setTimeout(() => playSingleBeep(freq, dotDur), gap);
        setTimeout(() => playSingleBeep(freq, dotDur), 2 * gap);
        // Dashes: 3 long beeps after letter gap
        setTimeout(() => playSingleBeep(freq, dashDur), letterGap);
        setTimeout(() => playSingleBeep(freq, dashDur), letterGap + gap);
        setTimeout(() => playSingleBeep(freq, dashDur), letterGap + 2 * gap);
        // Dots again after another letter gap
        setTimeout(() => playSingleBeep(freq, dotDur), 2 * letterGap);
        setTimeout(() => playSingleBeep(freq, dotDur), 2 * letterGap + gap);
        setTimeout(() => playSingleBeep(freq, dotDur), 2 * letterGap + 2 * gap);
      }
    }

    // Debounce for performance (Reduced to 200ms)
    function debounce(fn, wait = 200) { // Smoothed
      let timer = null;
      return function(...args) {
        const ctx = this;
        clearTimeout(timer);
        timer = setTimeout(() => {
          fn.apply(ctx, args);
        }, wait);
      };
    }

    // Use requestAnimationFrame for smoother animations
    function animate(callback) {
      requestAnimationFrame(callback);
    }

    /* Hamburger Menu for Mobile - Disabled for Desktop Force */
    // const hamburgerBtn = document.getElementById('hamburgerBtn');
    // const sidebar = document.getElementById('sidebar');
    // if (hamburgerBtn && sidebar) {
    //   hamburgerBtn.addEventListener('click', () => {
    //     sidebar.classList.toggle('show');
    //   });
    // }

    // ---------------- Size controls (localStorage) (Fixed: try-catch added) ----------------
    const ROOT = document.documentElement;
    const textSizeRange = document.getElementById('textSizeRange');
    const numberSizeRange = document.getElementById('numberSizeRange');
    const inputSizeRange = document.getElementById('inputSizeRange');
    const tabSizeRange = document.getElementById('tabSizeRange');
    const modalSizeRange = document.getElementById('modalSizeRange');
    const tableSizeRange = document.getElementById('tableSizeRange');
    const buttonSizeRange = document.getElementById('buttonSizeRange');
    const text3DIntensityRange = document.getElementById('text3DIntensityRange');
    const textSizeValue = document.getElementById('textSizeValue');
    const numberSizeValue = document.getElementById('numberSizeValue');
    const inputSizeValue = document.getElementById('inputSizeValue');
    const tabSizeValue = document.getElementById('tabSizeValue');
    const modalSizeValue = document.getElementById('modalSizeValue');
    const tableSizeValue = document.getElementById('tableSizeValue');
    const buttonSizeValue = document.getElementById('buttonSizeValue');
    const text3DIntensityValue = document.getElementById('text3DIntensityValue');
    const resetSizesBtn = document.getElementById('resetSizes');
    const SIZE_KEY = 'ui.sizePrefs';

    function storeCssDefaults() {
      const cs = getComputedStyle(ROOT);
      ROOT.dataset.defaultBase = parseInt(cs.getPropertyValue('--base-font-size')) || 18;
      ROOT.dataset.defaultCurrency = parseInt(cs.getPropertyValue('--currency-size')) || 24;
      ROOT.dataset.defaultInput = parseInt(cs.getPropertyValue('--input-font-size')) || 18;
      ROOT.dataset.defaultTab = parseInt(cs.getPropertyValue('--tab-font-size')) || 18;
      ROOT.dataset.defaultModal = parseInt(cs.getPropertyValue('--modal-font-size')) || 18;
      ROOT.dataset.defaultTable = parseInt(cs.getPropertyValue('--table-font-size')) || 16;
      ROOT.dataset.defaultButton = parseInt(cs.getPropertyValue('--button-font-size')) || 18;
    }
    function applySizes(prefs) {
      if (!prefs) return;
      if (prefs.text !== undefined) ROOT.style.setProperty('--base-font-size', prefs.text + 'px');
      if (prefs.number !== undefined) ROOT.style.setProperty('--currency-size', prefs.number + 'px');
      if (prefs.input !== undefined) ROOT.style.setProperty('--input-font-size', prefs.input + 'px');
      if (prefs.tab !== undefined) ROOT.style.setProperty('--tab-font-size', prefs.tab + 'px');
      if (prefs.modal !== undefined) ROOT.style.setProperty('--modal-font-size', prefs.modal + 'px');
      if (prefs.table !== undefined) ROOT.style.setProperty('--table-font-size', prefs.table + 'px');
      if (prefs.button !== undefined) ROOT.style.setProperty('--button-font-size', prefs.button + 'px');
      if (prefs.text3D !== undefined) {
        ROOT.style.setProperty('--text-shadow-alpha', (prefs.text3D / 100) * 1.0);
        ROOT.style.setProperty('--text-shadow-alpha2', (prefs.text3D / 100) * 0.5);
      }
    }
    function loadSizePrefs(){ try{ const raw = localStorage.getItem(SIZE_KEY); return raw? JSON.parse(raw): null; } catch(e){ return null; } }
    function saveSizePrefs(p){ localStorage.setItem(SIZE_KEY, JSON.stringify(p)); }
    function initSizeControls(){
      storeCssDefaults();
      const prefs = loadSizePrefs();
      const defaultText = parseInt(ROOT.dataset.defaultBase) || 18;
      const defaultNumber = parseInt(ROOT.dataset.defaultCurrency) || 24;
      const defaultInput = parseInt(ROOT.dataset.defaultInput) || 18;
      const defaultTab = parseInt(ROOT.dataset.defaultTab) || 18;
      const defaultModal = parseInt(ROOT.dataset.defaultModal) || 18;
      const defaultTable = parseInt(ROOT.dataset.defaultTable) || 16;
      const defaultButton = parseInt(ROOT.dataset.defaultButton) || 18;
      const textVal = (prefs && prefs.text !== undefined) ? prefs.text : defaultText;
      const numVal = (prefs && prefs.number !== undefined) ? prefs.number : defaultNumber;
      const inputVal = (prefs && prefs.input !== undefined) ? prefs.input : defaultInput;
      const tabVal = (prefs && prefs.tab !== undefined) ? prefs.tab : defaultTab;
      const modalVal = (prefs && prefs.modal !== undefined) ? prefs.modal : defaultModal;
      const tableVal = (prefs && prefs.table !== undefined) ? prefs.table : defaultTable;
      const buttonVal = (prefs && prefs.button !== undefined) ? prefs.button : defaultButton;
      const text3DVal = (prefs && prefs.text3D !== undefined) ? prefs.text3D : 100;
      if (textSizeRange) textSizeRange.value = textVal;
      if (numberSizeRange) numberSizeRange.value = numVal;
      if (inputSizeRange) inputSizeRange.value = inputVal;
      if (tabSizeRange) tabSizeRange.value = tabVal;
      if (modalSizeRange) modalSizeRange.value = modalVal;
      if (tableSizeRange) tableSizeRange.value = tableVal;
      if (buttonSizeRange) buttonSizeRange.value = buttonVal;
      if (text3DIntensityRange) text3DIntensityRange.value = text3DVal;
      if (textSizeValue) textSizeValue.textContent = textVal;
      if (numberSizeValue) numberSizeValue.textContent = numVal;
      if (inputSizeValue) inputSizeValue.textContent = inputVal;
      if (tabSizeValue) tabSizeValue.textContent = tabVal;
      if (modalSizeValue) modalSizeValue.textContent = modalVal;
      if (tableSizeValue) tableSizeValue.textContent = tableVal;
      if (buttonSizeValue) buttonSizeValue.textContent = buttonVal;
      if (text3DIntensityValue) text3DIntensityValue.textContent = text3DVal;
      applySizes({text:textVal, number:numVal, input:inputVal, tab:tabVal, modal:modalVal, table:tableVal, button:buttonVal, text3D:text3DVal});
    }
    function handleTextSizeChange(e){
      const val = parseInt(e.target.value,10);
      textSizeValue.textContent = val;
      applySizes({ text: val, number: parseInt(numberSizeRange.value,10), input: parseInt(inputSizeRange.value,10), tab: parseInt(tabSizeRange.value,10), modal: parseInt(modalSizeRange.value,10), table: parseInt(tableSizeRange.value,10), button: parseInt(buttonSizeRange.value,10), text3D: parseInt(text3DIntensityRange.value,10) });
      const prefs = loadSizePrefs() || {}; prefs.text = val; saveSizePrefs(prefs);
    }
    function handleNumberSizeChange(e){
      const val = parseInt(e.target.value,10);
      numberSizeValue.textContent = val;
      applySizes({ text: parseInt(textSizeRange.value,10), number: val, input: parseInt(inputSizeRange.value,10), tab: parseInt(tabSizeRange.value,10), modal: parseInt(modalSizeRange.value,10), table: parseInt(tableSizeRange.value,10), button: parseInt(buttonSizeRange.value,10), text3D: parseInt(text3DIntensityRange.value,10) });
      const prefs = loadSizePrefs() || {}; prefs.number = val; saveSizePrefs(prefs);
    }
    function handleInputSizeChange(e){
      const val = parseInt(e.target.value,10);
      inputSizeValue.textContent = val;
      applySizes({ text: parseInt(textSizeRange.value,10), number: parseInt(numberSizeRange.value,10), input: val, tab: parseInt(tabSizeRange.value,10), modal: parseInt(modalSizeRange.value,10), table: parseInt(tableSizeRange.value,10), button: parseInt(buttonSizeRange.value,10), text3D: parseInt(text3DIntensityRange.value,10) });
      const prefs = loadSizePrefs() || {}; prefs.input = val; saveSizePrefs(prefs);
    }
    function handleTabSizeChange(e){
      const val = parseInt(e.target.value,10);
      tabSizeValue.textContent = val;
      applySizes({ text: parseInt(textSizeRange.value,10), number: parseInt(numberSizeRange.value,10), input: parseInt(inputSizeRange.value,10), tab: val, modal: parseInt(modalSizeRange.value,10), table: parseInt(tableSizeRange.value,10), button: parseInt(buttonSizeRange.value,10), text3D: parseInt(text3DIntensityRange.value,10) });
      const prefs = loadSizePrefs() || {}; prefs.tab = val; saveSizePrefs(prefs);
    }
    function handleModalSizeChange(e){
      const val = parseInt(e.target.value,10);
      modalSizeValue.textContent = val;
      applySizes({ text: parseInt(textSizeRange.value,10), number: parseInt(numberSizeRange.value,10), input: parseInt(inputSizeRange.value,10), tab: parseInt(tabSizeRange.value,10), modal: val, table: parseInt(tableSizeRange.value,10), button: parseInt(buttonSizeRange.value,10), text3D: parseInt(text3DIntensityRange.value,10) });
      const prefs = loadSizePrefs() || {}; prefs.modal = val; saveSizePrefs(prefs);
    }
    function handleTableSizeChange(e){
      const val = parseInt(e.target.value,10);
      tableSizeValue.textContent = val;
      applySizes({ text: parseInt(textSizeRange.value,10), number: parseInt(numberSizeRange.value,10), input: parseInt(inputSizeRange.value,10), tab: parseInt(tabSizeRange.value,10), modal: parseInt(modalSizeRange.value,10), table: val, button: parseInt(buttonSizeRange.value,10), text3D: parseInt(text3DIntensityRange.value,10) });
      const prefs = loadSizePrefs() || {}; prefs.table = val; saveSizePrefs(prefs);
    }
    function handleButtonSizeChange(e){
      const val = parseInt(e.target.value,10);
      buttonSizeValue.textContent = val;
      applySizes({ text: parseInt(textSizeRange.value,10), number: parseInt(numberSizeRange.value,10), input: parseInt(inputSizeRange.value,10), tab: parseInt(tabSizeRange.value,10), modal: parseInt(modalSizeRange.value,10), table: parseInt(tableSizeRange.value,10), button: val, text3D: parseInt(text3DIntensityRange.value,10) });
      const prefs = loadSizePrefs() || {}; prefs.button = val; saveSizePrefs(prefs);
    }
    function handleText3DIntensityChange(e){
      const val = parseInt(e.target.value,10);
      text3DIntensityValue.textContent = val;
      applySizes({ text: parseInt(textSizeRange.value,10), number: parseInt(numberSizeRange.value,10), input: parseInt(inputSizeRange.value,10), tab: parseInt(tabSizeRange.value,10), modal: parseInt(modalSizeRange.value,10), table: parseInt(tableSizeRange.value,10), button: parseInt(buttonSizeRange.value,10), text3D: val });
      const prefs = loadSizePrefs() || {}; prefs.text3D = val; saveSizePrefs(prefs);
    }
    if (textSizeRange) textSizeRange.addEventListener('input', handleTextSizeChange);
    if (numberSizeRange) numberSizeRange.addEventListener('input', handleNumberSizeChange);
    if (inputSizeRange) inputSizeRange.addEventListener('input', handleInputSizeChange);
    if (tabSizeRange) tabSizeRange.addEventListener('input', handleTabSizeChange);
    if (modalSizeRange) modalSizeRange.addEventListener('input', handleModalSizeChange);
    if (tableSizeRange) tableSizeRange.addEventListener('input', handleTableSizeChange);
    if (buttonSizeRange) buttonSizeRange.addEventListener('input', handleButtonSizeChange);
    if (text3DIntensityRange) text3DIntensityRange.addEventListener('input', handleText3DIntensityChange);
    if (resetSizesBtn) resetSizesBtn.addEventListener('click', resetSizes);
    function resetSizes() {
      const defaultPrefs = { text: 18, number: 24, input: 18, tab: 18, modal: 18, table: 16, button: 18, text3D: 100 };
      applySizes(defaultPrefs);
      saveSizePrefs(defaultPrefs);
      if (textSizeRange) textSizeRange.value = 18;
      if (numberSizeRange) numberSizeRange.value = 24;
      if (inputSizeRange) inputSizeRange.value = 18;
      if (tabSizeRange) textSizeRange.value = 18;
      if (modalSizeRange) modalSizeRange.value = 18;
      if (tableSizeRange) tableSizeRange.value = 16;
      if (buttonSizeRange) buttonSizeRange.value = 18;
      if (text3DIntensityRange) text3DIntensityRange.value = 100;
      if (textSizeValue) textSizeValue.textContent = 18;
      if (numberSizeValue) numberSizeValue.textContent = 24;
      if (inputSizeValue) inputSizeValue.textContent = 18;
      if (tabSizeValue) textSizeValue.textContent = 18;
      if (modalSizeValue) modalSizeValue.textContent = 18;
      if (tableSizeValue) tableSizeValue.textContent = 16;
      if (buttonSizeValue) buttonSizeValue.textContent = 18;
      if (text3DIntensityValue) text3DIntensityValue.textContent = 100;
    }
    
    // ---------------- General & App Settings (Fixed: try-catch added) ----------------
    const SETTINGS_KEY = 'app.settings.v89';
    let appSettings = {
        reminderDays: 3,
        autoBackup: true,
        checkRemindersEnabled: true,
        pendingBillRemindersEnabled: true,
        pendingBillReminderDays: 15,
        returnRemindersEnabled: true,
        returnReminderDays: 7,
        showUpcomingReminders: true,
        reminderShowAfterDue: 7,
        taxRates: [18, 28],
        dashboardVisibility: [
            { name: "TOTAL INVOICE PURCHASE", id: "totalSales", visible: true },
            { name: "TOTAL EXPENSES (‡§ñ‡§∞‡•ç‡§ö‡•ã‡§Ç)", id: "totalPurchases", visible: true },
            { name: "GST COLLECTED", id: "gstCollected", visible: true },
            { name: "ONLINE PAYMENTS", id: "onlinePayments", visible: true },
            { name: "CASH PAYMENTS", id: "cashPayments", visible: true },
            { name: "CHECK PAYMENTS", id: "checkPayments", visible: true },
            { name: "TOTAL INCOME", id: "totalIncome", visible: true },
            { name: "PENDING BILLS", id: "pendingBills", visible: true },
            { name: "RETURN ITEMS", id: "returnItems", visible: true },
            { name: "NET PROFIT", id: "netProfit", visible: true },
        ],
        sectionVisibility: [
            { name: "Add / Edit Invoice", id: "f-invoiceCard", visible: true },
            { name: "Add Payment", id: "f-paymentCard", visible: true },
            { name: "Invoice & Payment Report", id: "f-reportCard", visible: true },
            { name: "Add / Edit Return Item", id: "f-returnCard", visible: true },
            { name: "Return Items Report", id: "f-returnReportCard", visible: true },
            { name: "Log Defective Check", id: "f-defectiveCheckCard", visible: true },
            { name: "Defective Checks Report", id: "f-defectiveCheckReportCard", visible: true },
            { name: "Add Expense (Purchase)", id: "f-expenseCard", visible: true },
            { name: "Expense Report", id: "f-expenseReportCard", visible: true },
            { name: "Add Income", id: "f-incomeCard", visible: true },
            { name: "Income Report", id: "f-incomeReportCard", visible: true }
        ],
        lockScreenEnabled: true,
        profile: {
            companyName: 'SAKSHI AUTOMOBILES',
            appTitle: '',  // Added for sidebar app title
            address: '',
            gstin: '',
            phone: '',
            stateCode: '',
            email: '',
            website: ''
        }
    };

    function loadAppSettings() {
        try {
            const raw = localStorage.getItem(SETTINGS_KEY);
            if (raw) {
                const parsed = JSON.parse(raw);
                const merged = { ...appSettings, ...parsed };
                if (!merged.autoRefresh) merged.autoRefresh = appSettings.autoRefresh; // Ensure autoRefresh object exists
                if (!Array.isArray(merged.taxRates) || merged.taxRates.length === 0) {
                    merged.taxRates = [18, 28]; // Fallback
                }
                if (!Array.isArray(merged.sectionVisibility) || merged.sectionVisibility.length === 0) {
                    merged.sectionVisibility = appSettings.sectionVisibility; // Ensure sectionVisibility array exists
                }
                if (!Array.isArray(merged.dashboardVisibility) || merged.dashboardVisibility.length === 0) {
                    merged.dashboardVisibility = appSettings.dashboardVisibility; // Ensure dashboardVisibility array exists
                }
                if (!merged.profile) merged.profile = appSettings.profile;
                if (!merged.profile.appTitle) merged.profile.appTitle = merged.profile.companyName; // Default to company name
                if (!merged.profile.email) merged.profile.email = '';
                if (!merged.profile.website) merged.profile.website = '';
                return merged;
            }
            return appSettings;
        } catch (e) {
            return appSettings;
        }
    }
    function saveAppSettings() {
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
    }

    function applySectionVisibility() {
        const visibility = appSettings.sectionVisibility || [];
        const sections = {
            'f-invoiceCard': document.getElementById('f-invoiceCard'),
            'f-paymentCard': document.getElementById('f-paymentCard'),
            'f-reportCard': document.querySelector('.card[data-print-area="f-reportCard"]'),
            'f-returnCard': document.getElementById('f-returnCard'),
            'f-returnReportCard': document.querySelector('.card[data-print-area="f-returnReportCard"]'),
            'f-defectiveCheckCard': document.getElementById('f-defectiveCheckCard'),
            'f-defectiveCheckReportCard': document.querySelector('.card[data-print-area="f-defectiveCheckReportCard"]'),
            'f-expenseCard': document.getElementById('f-expenseCard'),
            'f-expenseReportCard': document.querySelector('.card[data-print-area="f-expenseReportCard"]'),
            'f-incomeCard': document.getElementById('f-incomeCard'),
            'f-incomeReportCard': document.querySelector('.card[data-print-area="f-incomeReportCard"]')
        };
        Object.keys(sections).forEach(key => {
            const sec = visibility.find(s => s.id === key);
            const el = sections[key];
            if (el) el.style.display = sec && sec.visible !== false ? 'block' : 'none';
        });
    }

    function updateSectionTitles() {
        const visibility = appSettings.sectionVisibility || [];
        visibility.forEach(sec => {
            const el = document.querySelector(`#${sec.id} h3`);
            if (el) el.textContent = sec.name;
        });
    }

    function initSectionVisibilityControls() {
        const addBtn = document.getElementById('add-section-btn');
        const input = document.getElementById('new-section-name-input');
        const tbody = document.querySelector('#section-visibility-table tbody');

        function render() {
            tbody.innerHTML = '';
            appSettings.sectionVisibility.forEach((sec, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="text-3d">${index + 1}</span></td>
                    <td><span class="text-3d">${toUpper(sec.name)}</span></td>
                    <td><input type="checkbox" ${sec.visible !== false ? 'checked' : ''} data-index="${index}" /></td>
                    <td>
                        <button class="edit-section" data-index="${index}">‚úèÔ∏è EDIT</button>
                        <button class="delete-section" data-index="${index}">‚ùå DELETE</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            // Add event listeners for checkboxes
            tbody.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.index);
                    appSettings.sectionVisibility[idx].visible = e.target.checked;
                    saveAppSettings();
                    applySectionVisibility();
                    showToast('Section visibility updated');
                });
            });
            tbody.querySelectorAll('.edit-section').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = parseInt(e.target.dataset.index);
                    const newName = prompt('Edit Section Name:', appSettings.sectionVisibility[idx].name);
                    if (newName && newName.trim()) {
                        appSettings.sectionVisibility[idx].name = newName.trim();
                        saveAppSettings();
                        render();
                        updateSectionTitles();
                        showToast('Section name updated');
                    }
                });
            });
            tbody.querySelectorAll('.delete-section').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = parseInt(e.target.dataset.index);
                    if (confirm(`Delete section "${appSettings.sectionVisibility[idx].name}"?`)) {
                        appSettings.sectionVisibility.splice(idx, 1);
                        saveAppSettings();
                        render();
                        applySectionVisibility();
                        updateSectionTitles();
                        showToast('Section deleted');
                    }
                });
            });
        }

        addBtn.addEventListener('click', () => {
            const name = input.value.trim();
            if (!name) return;
            appSettings.sectionVisibility.push({ name: name, id: 'custom-' + uid(), visible: true });
            input.value = '';
            saveAppSettings();
            render();
            applySectionVisibility();
            updateSectionTitles();
            showToast('Section added');
        });

        render();
    }

    function initDashboardVisibilityControls() {
        const tbody = document.querySelector('#dashboard-visibility-table tbody');

        function render() {
            tbody.innerHTML = '';
            appSettings.dashboardVisibility.forEach((card, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="text-3d">${index + 1}</span></td>
                    <td><span class="text-3d">${toUpper(card.name)}</span></td>
                    <td><input type="checkbox" ${card.visible !== false ? 'checked' : ''} data-index="${index}" /></td>
                    <td>
                        <button class="edit-dashboard-card" data-index="${index}">‚úèÔ∏è EDIT</button>
                        <button class="delete-dashboard-card" data-index="${index}">‚ùå DELETE</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            // Add event listeners for checkboxes
            tbody.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.index);
                    appSettings.dashboardVisibility[idx].visible = e.target.checked;
                    saveAppSettings();
                    updateDashboard();
                    showToast('Dashboard visibility updated');
                });
            });
            tbody.querySelectorAll('.edit-dashboard-card').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = parseInt(e.target.dataset.index);
                    const newName = prompt('Edit Card Name:', appSettings.dashboardVisibility[idx].name);
                    if (newName && newName.trim()) {
                        appSettings.dashboardVisibility[idx].name = newName.trim();
                        saveAppSettings();
                        render();
                        updateDashboard();
                        showToast('Card name updated');
                    }
                });
            });
            tbody.querySelectorAll('.delete-dashboard-card').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = parseInt(e.target.dataset.index);
                    if (confirm(`Delete card "${appSettings.dashboardVisibility[idx].name}"?`)) {
                        appSettings.dashboardVisibility.splice(idx, 1);
                        saveAppSettings();
                        render();
                        updateDashboard();
                        showToast('Card deleted');
                    }
                });
            });
        }

        render();
    }

    function initBackupRestoreInfo() {
        const lastBackupEl = document.getElementById('lastBackupFileName');
        const lastRestoreEl = document.getElementById('lastRestoreFileName');
        const BACKUP_INFO_KEY = 'backup.info.v89';
        
        function loadBackupInfo() {
            try {
                const raw = localStorage.getItem(BACKUP_INFO_KEY);
                return raw ? JSON.parse(raw) : { lastBackup: null, lastRestore: null };
            } catch (e) {
                return { lastBackup: null, lastRestore: null };
            }
        }
        
        function saveBackupInfo(info) {
            localStorage.setItem(BACKUP_INFO_KEY, JSON.stringify(info));
        }
        
        let backupInfo = loadBackupInfo();
        
        function updateDisplay() {
            if (lastBackupEl) lastBackupEl.textContent = backupInfo.lastBackup || 'None';
            if (lastRestoreEl) lastRestoreEl.textContent = backupInfo.lastRestore || 'None';
        }
        
        updateDisplay();
        
        // Expose functions to set values
        window.setLastBackupFile = function(name) {
            backupInfo.lastBackup = name;
            saveBackupInfo(backupInfo);
            updateDisplay();
        };
        
        window.setLastRestoreFile = function(name) {
            backupInfo.lastRestore = name;
            saveBackupInfo(backupInfo);
            updateDisplay();
        };
    }

    function initAutoFixControls() {
        const autoFixEnabledCheckbox = document.getElementById('autoFixEnabled');
        const runAutoFixBtn = document.getElementById('runAutoFixBtn');
        const AUTO_FIX_KEY = 'app.autoFixEnabled';

        let autoFixEnabled = false;
        function loadAutoFixSetting() {
            try {
                const raw = localStorage.getItem(AUTO_FIX_KEY);
                return raw ? JSON.parse(raw) : false;
            } catch (e) {
                return false;
            }
        }
        function saveAutoFixSetting(enabled) {
            localStorage.setItem(AUTO_FIX_KEY, JSON.stringify(enabled));
        }

        autoFixEnabled = loadAutoFixSetting();
        if (autoFixEnabledCheckbox) autoFixEnabledCheckbox.checked = autoFixEnabled;

        autoFixEnabledCheckbox.addEventListener('change', (e) => {
            autoFixEnabled = e.target.checked;
            saveAutoFixSetting(autoFixEnabled);
            showToast(`Auto fix ${autoFixEnabled ? 'enabled' : 'disabled'}`);
            if (autoFixEnabled) runAutoFix();
        });

        runAutoFixBtn.addEventListener('click', () => {
            runAutoFix();
            showToast('Auto fix completed');
        });
    }

    function updateCompanyTitle() {
        const titleEl = document.getElementById('companyTitle');
        const newName = document.getElementById('profile-company-name').value.trim() || 'SAKSHI AUTOMOBILES';
        if (titleEl) titleEl.textContent = newName;
    }

    function updateTypedTitle() {
        const typedTitle = document.getElementById('typed-title');
        if (typedTitle) {
            const text = document.getElementById('profile-app-title').value.trim() || appSettings.profile.companyName || 'SAKSHI AUTOMOBILES';
            // Create wavy snake animation for title
            // Use Intl.Segmenter for proper grapheme segmentation in Hindi
            const makeWavy = (text) => {
                // Fallback for browsers without Intl.Segmenter (e.g., Safari <14)
                try {
                    const segmenter = new Intl.Segmenter('hi', { granularity: 'grapheme' });
                    const graphemes = [...segmenter.segment(text)].map(s => s.segment);
                    return graphemes.map((char, i) => `<span style="display:inline-block; animation: snake-wave 2s ease-in-out infinite; animation-delay: ${i * 0.1}s;">${char === ' ' ? '&nbsp;' : char}</span>`).join('');
                } catch (e) {
                    // Fallback: split by character
                    return text.split('').map((char, i) => `<span style="display:inline-block; animation: snake-wave 2s ease-in-out infinite; animation-delay: ${i * 0.1}s;">${char === ' ' ? '&nbsp;' : char}</span>`).join('');
                }
            };
            typedTitle.innerHTML = `<div class="wavy">${makeWavy(text)}</div>`;
        }
    }

    function loadProfile() {
        document.getElementById('profile-company-name').value = appSettings.profile.companyName;
        document.getElementById('profile-app-title').value = appSettings.profile.appTitle || appSettings.profile.companyName;
        document.getElementById('profile-address').value = appSettings.profile.address;
        document.getElementById('profile-gstin').value = appSettings.profile.gstin;
        document.getElementById('profile-phone').value = appSettings.profile.phone;
        document.getElementById('profile-state-code').value = appSettings.profile.stateCode;
        document.getElementById('profile-email').value = appSettings.profile.email;
        document.getElementById('profile-website').value = appSettings.profile.website;
        updateCompanyTitle();
        updateProfileDisplay();
        updateTypedTitle();
    }

    function updateProfileDisplay() {
        const addressEl = document.getElementById('displayAddress');
        const gstinEl = document.getElementById('displayGstin');
        const phoneEl = document.getElementById('displayPhone');
        const stateCodeEl = document.getElementById('displayStateCode');
        const emailEl = document.getElementById('displayEmail');
        const websiteEl = document.getElementById('displayWebsite');
        if (addressEl) addressEl.textContent = appSettings.profile.address || '';
        if (gstinEl) gstinEl.textContent = appSettings.profile.gstin || '';
        if (phoneEl) phoneEl.textContent = appSettings.profile.phone || '';
        if (stateCodeEl) stateCodeEl.textContent = appSettings.profile.stateCode || '';
        if (emailEl) emailEl.textContent = appSettings.profile.email || '';
        if (websiteEl) websiteEl.textContent = appSettings.profile.website || '';
    }

    function initAppSettingsControls() {
        appSettings = loadAppSettings();
        
        const reminderDaysInput = document.getElementById('reminderDaysInput');
        if (reminderDaysInput) {
            reminderDaysInput.value = appSettings.reminderDays;
            reminderDaysInput.addEventListener('change', (e) => {
                const days = parseInt(e.target.value, 10);
                if (days > 0 && days <= 30) {
                    appSettings.reminderDays = days;
                    saveAppSettings();
                    updateDashboard();
                    showToast('Check reminder days updated');
                } else {
                    e.target.value = appSettings.reminderDays;
                }
            });
        }

        const reminderShowAfterDueInput = document.getElementById('reminderShowAfterDueInput');
        if (reminderShowAfterDueInput) {
            reminderShowAfterDueInput.value = appSettings.reminderShowAfterDue || 7;
            reminderShowAfterDueInput.addEventListener('change', (e) => {
                const days = parseInt(e.target.value, 10);
                if (days >= 0 && days <= 30) {
                    appSettings.reminderShowAfterDue = days;
                    saveAppSettings();
                    updateDashboard();
                    showToast('Reminder show after due updated');
                } else {
                    e.target.value = appSettings.reminderShowAfterDue || 7;
                }
            });
        }
        
        const pendingBillReminderDaysInput = document.getElementById('pendingBillReminderDaysInput');
        if (pendingBillReminderDaysInput) {
            pendingBillReminderDaysInput.value = appSettings.pendingBillReminderDays;
            pendingBillReminderDaysInput.addEventListener('change', (e) => {
                const days = parseInt(e.target.value, 10);
                if (days > 0 && days <= 90) {
                    appSettings.pendingBillReminderDays = days;
                    saveAppSettings();
                    updateDashboard();
                    showToast('Pending bill days updated');
                } else {
                    e.target.value = appSettings.pendingBillReminderDays;
                }
            });
        }

        const returnReminderDaysInput = document.getElementById('returnReminderDaysInput');
        if (returnReminderDaysInput) {
            returnReminderDaysInput.value = appSettings.returnReminderDays;
            returnReminderDaysInput.addEventListener('change', (e) => {
                const days = parseInt(e.target.value, 10);
                if (days > 0 && days <= 90) {
                    appSettings.returnReminderDays = days;
                    saveAppSettings();
                    updateDashboard();
                    showToast('Return reminder days updated');
                } else {
                    e.target.value = appSettings.returnReminderDays;
                }
            });
        }

        const checkRemindersEnabled = document.getElementById('checkRemindersEnabled');
        if (checkRemindersEnabled) {
            checkRemindersEnabled.checked = appSettings.checkRemindersEnabled;
            checkRemindersEnabled.addEventListener('change', (e) => {
                appSettings.checkRemindersEnabled = e.target.checked;
                saveAppSettings();
                updateDashboard();
                showToast(`Check reminders ${e.target.checked ? 'enabled' : 'disabled'}`);
            });
        }

        const pendingBillRemindersEnabled = document.getElementById('pendingBillRemindersEnabled');
        if (pendingBillRemindersEnabled) {
            pendingBillRemindersEnabled.checked = appSettings.pendingBillRemindersEnabled;
            pendingBillRemindersEnabled.addEventListener('change', (e) => {
                appSettings.pendingBillRemindersEnabled = e.target.checked;
                saveAppSettings();
                updateDashboard();
                showToast(`Pending bill reminders ${e.target.checked ? 'enabled' : 'disabled'}`);
            });
        }

        const returnRemindersEnabled = document.getElementById('returnRemindersEnabled');
        if (returnRemindersEnabled) {
            returnRemindersEnabled.checked = appSettings.returnRemindersEnabled;
            returnRemindersEnabled.addEventListener('change', (e) => {
                appSettings.returnRemindersEnabled = e.target.checked;
                saveAppSettings();
                updateDashboard();
                showToast(`Return reminders ${e.target.checked ? 'enabled' : 'disabled'}`);
            });
        }

        const upcomingCheckRemindersEnabled = document.getElementById('upcomingCheckRemindersEnabled');
        if (upcomingCheckRemindersEnabled) {
            upcomingCheckRemindersEnabled.checked = appSettings.showUpcomingReminders !== false;
            upcomingCheckRemindersEnabled.addEventListener('change', (e) => {
                appSettings.showUpcomingReminders = e.target.checked;
                saveAppSettings();
                updateDashboard();
                showToast(`Upcoming check reminders ${e.target.checked ? 'enabled' : 'disabled'}`);
            });
        }

        const autoBackupEnabled = document.getElementById('autoBackupEnabled');
        if (autoBackupEnabled) {
            autoBackupEnabled.checked = appSettings.autoBackup;
            autoBackupEnabled.addEventListener('change', (e) => {
                appSettings.autoBackup = e.target.checked;
                saveAppSettings();
                showToast(`Automatic backup ${e.target.checked ? 'enabled' : 'disabled'}`);
            });
        }

        // Add auto save toggle
        const autoSaveEnabledCheckbox = document.getElementById('autoSaveEnabled');
        if (autoSaveEnabledCheckbox) {
            autoSaveEnabledCheckbox.checked = appSettings.autoBackup;
            autoSaveEnabledCheckbox.addEventListener('change', (e) => {
                appSettings.autoBackup = e.target.checked;
                saveAppSettings();
                showToast(`Auto save ${e.target.checked ? 'enabled' : 'disabled'}`);
            });
        }
        
        initSectionVisibilityControls();
        initDashboardVisibilityControls();
        initBackupRestoreInfo();
        initAutoFixControls();
        initLockScreenControls();
        initTaxRateSettings();
        initCompanyManagement();
        initThemeControls();
        initAutoRefreshSettings(); // Added missing call
        initSizeControls(); // Added
        initBeepControls(); // Added
        initSpeechControls(); // Added
        populateCurrencyColorSelector(); // Added
        loadProfile();
        
        // Accordion Logic
        document.querySelectorAll('.accordion-header').forEach(header => {
            header.addEventListener('click', () => {
                const item = header.parentElement;
                const isActive = item.classList.contains('active');
                // Close all
                document.querySelectorAll('.accordion-item').forEach(i => i.classList.remove('active'));
                // Open this one if it wasn't active
                if (!isActive) {
                    item.classList.add('active');
                }
            });
        });

        // Profile save
        document.getElementById('save-profile-btn').addEventListener('click', () => {
            appSettings.profile.companyName = document.getElementById('profile-company-name').value.trim();
            appSettings.profile.appTitle = document.getElementById('profile-app-title').value.trim() || appSettings.profile.companyName;
            appSettings.profile.address = document.getElementById('profile-address').value.trim();
            appSettings.profile.gstin = document.getElementById('profile-gstin').value.trim();
            appSettings.profile.phone = document.getElementById('profile-phone').value.trim();
            appSettings.profile.stateCode = document.getElementById('profile-state-code').value.trim();
            appSettings.profile.email = document.getElementById('profile-email').value.trim();
            appSettings.profile.website = document.getElementById('profile-website').value.trim();
            saveAppSettings();
            updateCompanyTitle();
            updateProfileDisplay();
            updateTypedTitle();
            showToast('Profile saved');
        });
    }

    function initLockScreenControls() {
        const lockScreenEnabledCheckbox = document.getElementById('lockScreenEnabled');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const changeSecurityAnswerBtn = document.getElementById('changeSecurityAnswerBtn');
        const currentPasswordDisplay = document.getElementById('currentPasswordDisplay');
        const togglePasswordBtn = document.getElementById('togglePasswordVisibility');
        const currentSecurityAnswerDisplay = document.getElementById('currentSecurityAnswerDisplay');
        const toggleSecurityAnswerBtn = document.getElementById('toggleSecurityAnswerVisibility');
        const autoGenPasswordEnabledCheckbox = document.getElementById('autoGenPasswordEnabled');
        const autoGenPasswordTypeSelect = document.getElementById('timeFormatType');
        const todaysPasswordDisplay = document.getElementById('todaysPasswordDisplay');

        let passwordVisible = false;
        let answerVisible = false;

        if (lockScreenEnabledCheckbox) {
            lockScreenEnabledCheckbox.checked = appSettings.lockScreenEnabled !== false;
            lockScreenEnabledCheckbox.addEventListener('change', (e) => {
                appSettings.lockScreenEnabled = e.target.checked;
                saveAppSettings();
                if (e.target.checked) {
                    showLockScreen();
                } else {
                    hideLockScreen();
                }
                showToast(`Lock screen ${e.target.checked ? 'enabled' : 'disabled'}`);
            });
        }

        if (autoGenPasswordEnabledCheckbox) {
            autoGenPasswordEnabledCheckbox.checked = appSettings.autoGenPasswordEnabled || false;
            autoGenPasswordEnabledCheckbox.addEventListener('change', (e) => {
                appSettings.autoGenPasswordEnabled = e.target.checked;
                saveAppSettings();
                updateTodaysPassword();
                showToast(`Auto-generate password ${e.target.checked ? 'enabled' : 'disabled'}`);
            });
        }

        if (autoGenPasswordTypeSelect) {
            autoGenPasswordTypeSelect.value = appSettings.autoGenPasswordType || '24';
            autoGenPasswordTypeSelect.addEventListener('change', (e) => {
                appSettings.autoGenPasswordType = e.target.value;
                saveAppSettings();
                updateTodaysPassword();
                showToast('Password type updated');
            });
        }

        function updateTodaysPassword() {
            if (todaysPasswordDisplay) {
                if (appSettings.autoGenPasswordEnabled) {
                    const today = new Date();
                    if (appSettings.autoGenPasswordType === '12') {
                        const hh = today.getHours();
                        const mm = String(today.getMinutes()).padStart(2, '0');
                        const period = hh >= 12 ? 'P' : 'A';
                        const h12 = hh % 12 || 12;
                        todaysPasswordDisplay.value = String(h12).padStart(2, '0') + mm + period;
                    } else if (appSettings.autoGenPasswordType === 'ddmmyy') {
                        const dd = String(today.getDate()).padStart(2, '0');
                        const mm = String(today.getMonth() + 1).padStart(2, '0');
                        const yy = String(today.getFullYear()).slice(-2);
                        todaysPasswordDisplay.value = dd + mm + yy;
                    } else {
                        const hh = today.getHours();
                        const mm = String(today.getMinutes()).padStart(2, '0');
                        todaysPasswordDisplay.value = String(hh).padStart(2, '0') + mm;
                    }
                } else {
                    todaysPasswordDisplay.value = 'Not enabled';
                }
            }
        }

        if (changePasswordBtn) {
            changePasswordBtn.addEventListener('click', () => {
                if (appSettings.autoGenPasswordEnabled) {
                    alert('Auto-generate password is enabled. Cannot change password manually.');
                    return;
                }
                const currentPass = prompt('Enter current password:');
                if (!currentPass) return;
                if (decryptPassword(securitySettings.password) !== currentPass) {
                    alert('Incorrect current password.');
                    return;
                }
                const newPass = prompt('Enter new password:');
                if (!newPass) return;
                const confirmPass = prompt('Confirm new password:');
                if (newPass !== confirmPass) {
                    alert('Passwords do not match.');
                    return;
                }
                securitySettings.password = encryptPassword(newPass);
                saveSecuritySettings();
                updateSecurityDisplays();
                showToast('Password changed successfully.');
            });
        }

        if (changeSecurityAnswerBtn) {
            changeSecurityAnswerBtn.addEventListener('click', () => {
                const currentPass = prompt('Enter password to confirm:');
                if (!currentPass) return;
                if (decryptPassword(securitySettings.password) !== currentPass) {
                    alert('Incorrect password.');
                    return;
                }
                const newAnswer = prompt('Enter new security answer:');
                if (!newAnswer) return;
                securitySettings.securityAnswer = encryptPassword(newAnswer);
                saveSecuritySettings();
                updateSecurityDisplays();
                showToast('Security answer changed successfully.');
            });
        }

        if (togglePasswordBtn) {
            togglePasswordBtn.addEventListener('click', () => {
                passwordVisible = !passwordVisible;
                togglePasswordBtn.textContent = passwordVisible ? 'HIDE' : 'SHOW';
                updateSecurityDisplays();
            });
        }

        if (toggleSecurityAnswerBtn) {
            toggleSecurityAnswerBtn.addEventListener('click', (e) => {
                answerVisible = !answerVisible;
                toggleSecurityAnswerBtn.textContent = answerVisible ? 'HIDE' : 'SHOW';
                updateSecurityDisplays();
            });
        }

        function updateSecurityDisplays() {
            if (currentPasswordDisplay) {
                if (appSettings.autoGenPasswordEnabled) {
                    currentPasswordDisplay.type = 'text';
                    currentPasswordDisplay.value = 'Auto-generated';
                } else if (securitySettings.password) {
                    currentPasswordDisplay.type = passwordVisible ? 'text' : 'password';
                    currentPasswordDisplay.value = passwordVisible ? decryptPassword(securitySettings.password) : '*'.repeat(decryptPassword(securitySettings.password).length);
                } else {
                    currentPasswordDisplay.type = 'text';
                    currentPasswordDisplay.value = 'Not set';
                }
            }
            if (currentSecurityAnswerDisplay) {
                if (securitySettings.securityAnswer) {
                    currentSecurityAnswerDisplay.type = answerVisible ? 'text' : 'password';
                    currentSecurityAnswerDisplay.value = answerVisible ? decryptPassword(securitySettings.securityAnswer) : '*'.repeat(decryptPassword(securitySettings.securityAnswer).length);
                } else {
                    currentSecurityAnswerDisplay.type = 'text';
                    currentSecurityAnswerDisplay.value = 'Not set';
                }
            }
        }

        updateTodaysPassword();
        updateSecurityDisplays();
    }

    function initThemeControls() {
        const themeSelector = document.getElementById('themeSelector');
        const applyThemeBtn = document.getElementById('applyThemeBtn');
        const customThemeDiv = document.getElementById('customThemeDiv');
        const customAccent1 = document.getElementById('customAccent1');
        const customAccent2 = document.getElementById('customAccent2');
        const customAccent3 = document.getElementById('customAccent3');
        const customAccent4 = document.getElementById('customAccent4');
        const customTextColor = document.getElementById('customTextColor');
        const customDateColor = document.getElementById('customDateColor');
        const customInvoiceColor = document.getElementById('customInvoiceColor');
        const customDaysColor = document.getElementById('customDaysColor');
        const customDaysAgoColor = document.getElementById('customDaysAgoColor');
        const customCompanyColor = document.getElementById('customCompanyColor');
        const customAmountColor = document.getElementById('customAmountColor');
        const customButtonBgColor = document.getElementById('customButtonBgColor');
        const customCardBgColor = document.getElementById('customCardBgColor');
        const customWarningTextColor = document.getElementById('customWarningTextColor');
        const customSLColor = document.getElementById('customSLColor');
        const customCashColor = document.getElementById('customCashColor');
        const customOnlineColor = document.getElementById('customOnlineColor');
        const customCheckColor = document.getElementById('customCheckColor');
        const customLicColor = document.getElementById('customLicColor');
        const customHeaderBgColor = document.getElementById('customHeaderBgColor');

        const THEME_KEY = 'ui.themePrefs';
        let themePrefs = { selected: 'tiranga', custom: { accent1: '#ff9933', accent2: '#138808', accent3: '#2345a0', accent4: '#ffffff', textColor: '#111', dateColor: '#111', invoiceColor: '#111', daysColor: '#b95f00', daysAgoColor: '#b95f00', companyColor: '#111', amountColor: '#138808', buttonBgColor: 'linear-gradient(135deg, #ff9933 0%, #ffffff 33%, #2345a0 100%)', cardBgColor: 'linear-gradient(to bottom, #ff9933 33%, #ffffff 33%, #ffffff 66%, #138808 66%)', warningTextColor: '#b95f00', slColor: '#111', cashColor: '#138808', onlineColor: '#138808', checkColor: '#138808', licColor: '#138808', headerBgColor: 'linear-gradient(to bottom, #ff9933 33%, #ffffff 33%, #ffffff 66%, #138808 66%)' } };
        function loadThemePrefs() {
            try { const raw = localStorage.getItem(THEME_KEY); return raw ? JSON.parse(raw) : themePrefs; } catch(e){ return themePrefs; }
        }
        function saveThemePrefs(p){ localStorage.setItem(THEME_KEY, JSON.stringify(p)); }
        
        function applyTheme(theme) {
            const colors = theme === 'tiranga' ? { accent1: '#ff9933', accent2: '#138808', accent3: '#2345a0', accent4: '#ffffff', textColor: '#111', dateColor: '#111', invoiceColor: '#111', daysColor: '#b95f00', daysAgoColor: '#b95f00', companyColor: '#111', amountColor: '#138808', buttonBgColor: 'linear-gradient(135deg, #ff9933 0%, #ffffff 33%, #2345a0 100%)', cardBgColor: 'linear-gradient(to bottom, #ff9933 33%, #ffffff 33%, #ffffff 66%, #138808 66%)', warningTextColor: '#b95f00', slColor: '#111', cashColor: '#138808', onlineColor: '#138808', checkColor: '#138808', licColor: '#138808', headerBgColor: 'linear-gradient(to bottom, #ff9933 33%, #ffffff 33%, #ffffff 66%, #138808 66%)' } : themePrefs.custom;
            ROOT.style.setProperty('--accent-1', colors.accent1);
            ROOT.style.setProperty('--accent-2', colors.accent2);
            ROOT.style.setProperty('--accent-3', colors.accent3);
            ROOT.style.setProperty('--accent-4', colors.accent4);
            ROOT.style.setProperty('--main-text-color', colors.textColor);
            ROOT.style.setProperty('--date-color', colors.dateColor);
            ROOT.style.setProperty('--invoice-color', colors.invoiceColor);
            ROOT.style.setProperty('--days-color', colors.daysColor);
            ROOT.style.setProperty('--days-ago-color', colors.daysAgoColor);
            ROOT.style.setProperty('--company-color', colors.companyColor);
            ROOT.style.setProperty('--amount-color', colors.amountColor);
            ROOT.style.setProperty('--button-bg-color', colors.buttonBgColor);
            ROOT.style.setProperty('--card-bg-color', colors.cardBgColor);
            ROOT.style.setProperty('--warning-text-color', colors.warningTextColor);
            ROOT.style.setProperty('--sl-color', colors.slColor);
            ROOT.style.setProperty('--cash-color', colors.cashColor || '#138808');
            ROOT.style.setProperty('--online-color', colors.onlineColor || '#138808');
            ROOT.style.setProperty('--check-color', colors.checkColor || '#138808');
            ROOT.style.setProperty('--lic-color', colors.licColor || '#138808');
            ROOT.style.setProperty('--header-bg-color', colors.headerBgColor);
            showToast('Theme applied');
        }

        themePrefs = loadThemePrefs();
        themeSelector.value = themePrefs.selected;
        if (themePrefs.custom) {
            customAccent1.value = themePrefs.custom.accent1 || '#ff9933';
            customAccent2.value = themePrefs.custom.accent2 || '#138808';
            customAccent3.value = themePrefs.custom.accent3 || '#2345a0';
            customAccent4.value = themePrefs.custom.accent4 || '#ffffff';
            customTextColor.value = customDateColor.value;
            customDateColor.value = customDateColor.value;
            customInvoiceColor.value = customDateColor.value;
            customDaysColor.value = themePrefs.custom.daysColor;
            customDaysAgoColor.value = customDaysColor.value;
            customCompanyColor.value = themePrefs.custom.companyColor || '#111';
            customAmountColor.value = themePrefs.custom.amountColor || '#138808';
            customButtonBgColor.value = themePrefs.custom.buttonBgColor || 'linear-gradient(135deg, #ff9933 0%, #ffffff 33%, #2345a0 100%)';
            customCardBgColor.value = themePrefs.custom.cardBgColor || '#ffffff';
            customWarningTextColor.value = themePrefs.custom.warningTextColor || '#b95f00';
            customSLColor.value = themePrefs.custom.slColor || '#111';
            customCashColor.value = themePrefs.custom.cashColor || '#138808';
            customOnlineColor.value = themePrefs.custom.onlineColor || '#138808';
            customCheckColor.value = themePrefs.custom.checkColor || '#138808';
            customLicColor.value = themePrefs.custom.licColor || '#138808';
            customHeaderBgColor.value = themePrefs.custom.headerBgColor || '#ffffff';
        }
        applyTheme(themePrefs.selected);

        themeSelector.addEventListener('change', (e) => {
            themePrefs.selected = e.target.value;
            customThemeDiv.style.display = e.target.value === 'custom' ? 'block' : 'none';
            saveThemePrefs(themePrefs);
            applyTheme(e.target.value);
        });

        // Add event listeners for immediate color changes in custom mode
        [customAccent1, customAccent2, customAccent3, customAccent4, customTextColor, customDateColor, customInvoiceColor, customDaysColor, customDaysAgoColor, customCompanyColor, customAmountColor, customButtonBgColor, customCardBgColor, customWarningTextColor, customSLColor, customCashColor, customOnlineColor, customCheckColor, customLicColor, customHeaderBgColor].forEach(select => {
            select.addEventListener('change', () => {
                if (themeSelector.value === 'custom') {
                    themePrefs.custom.accent1 = customAccent1.value;
                    themePrefs.custom.accent2 = customAccent2.value;
                    themePrefs.custom.accent3 = customAccent3.value;
                    themePrefs.custom.accent4 = customAccent4.value;
                    themePrefs.custom.textColor = customTextColor.value;
                    themePrefs.custom.dateColor = customDateColor.value;
                    themePrefs.custom.invoiceColor = customInvoiceColor.value;
                    themePrefs.custom.daysColor = customDaysColor.value;
                    themePrefs.custom.daysAgoColor = customDaysColor.value;
                    themePrefs.custom.companyColor = customCompanyColor.value;
                    themePrefs.custom.amountColor = customAmountColor.value;
                    themePrefs.custom.buttonBgColor = customButtonBgColor.value;
                    themePrefs.custom.cardBgColor = customCardBgColor.value;
                    themePrefs.custom.warningTextColor = customWarningTextColor.value;
                    themePrefs.custom.slColor = customSLColor.value;
                    themePrefs.custom.cashColor = customCashColor.value;
                    themePrefs.custom.onlineColor = customOnlineColor.value;
                    themePrefs.custom.checkColor = customCheckColor.value;
                    themePrefs.custom.licColor = customLicColor.value;
                    themePrefs.custom.headerBgColor = customHeaderBgColor.value;
                    saveThemePrefs(themePrefs);
                    applyTheme('custom');
                }
            });
        });

        applyThemeBtn.addEventListener('click', () => {
            if (themeSelector.value === 'custom') {
                themePrefs.custom = {
                    accent1: customAccent1.value,
                    accent2: customAccent2.value,
                    accent3: customAccent3.value,
                    accent4: customAccent4.value,
                    textColor: customTextColor.value,
                    dateColor: customDateColor.value,
                    invoiceColor: customInvoiceColor.value,
                    daysColor: customDaysColor.value,
                    daysAgoColor: customDaysColor.value,
                    companyColor: customCompanyColor.value,
                    amountColor: customAmountColor.value,
                    buttonBgColor: customButtonBgColor.value,
                    cardBgColor: customCardBgColor.value,
                    warningTextColor: customWarningTextColor.value,
                    slColor: customSLColor.value,
                    cashColor: customCashColor.value,
                    onlineColor: customOnlineColor.value,
                    checkColor: customCheckColor.value,
                    licColor: customLicColor.value,
                    headerBgColor: customHeaderBgColor.value,
                };
                saveThemePrefs(themePrefs);
                applyTheme('custom');
            }
        });

        customThemeDiv.style.display = themePrefs.selected === 'custom' ? 'block' : 'none';
    }
    
    function initTaxRateSettings() {
        const list = document.getElementById('tax-rate-list');
        const addBtn = document.getElementById('add-tax-rate-btn');
        const input = document.getElementById('new-tax-rate-input');

        function render() {
            // Update settings UI
            const tbody = list.querySelector('tbody');
            tbody.innerHTML = '';
            appSettings.taxRates.sort((a,b) => a-b).forEach((rate, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="text-3d">${index + 1}</span></td>
                    <td><span class="text-3d">${rate}%</span></td>
                    <td><button class="delete-rate" data-rate="${rate}">‚ùå</button></td>
                `;
                tbody.appendChild(tr);
            });
            
            // Update GST form dropdowns
            const taxRateSelects = document.querySelectorAll('#g-taxRate, #g-gst-taxFilter');
            taxRateSelects.forEach(select => {
                const currentVal = select.value;
                let options = '';
                if(select.id === 'g-gst-taxFilter') options += '<option value="all">ALL</option>';
                appSettings.taxRates.forEach(rate => {
                    options += `<option value="${rate}">${rate}%</option>`;
                });
                select.innerHTML = options;
                select.value = currentVal;
            });
        }

        addBtn.addEventListener('click', () => {
            const newRate = parseFloat(input.value);
            if (newRate > 0 && newRate <= 100 && !appSettings.taxRates.includes(newRate)) {
                appSettings.taxRates.push(newRate);
                saveAppSettings();
                render();
                input.value = '';
            } else {
                alert("Invalid or duplicate tax rate.");
            }
        });

        list.addEventListener('click', e => {
            if (e.target.matches('.delete-rate')) {
                const rateToRemove = parseFloat(e.target.dataset.rate);
                if (appSettings.taxRates.length <= 1) {
                    alert("You must have at least one tax rate.");
                    return;
                }
                appSettings.taxRates = appSettings.taxRates.filter(r => r !== rateToRemove);
                saveAppSettings();
                render();
            }
        });

        render();
    }

    function f_renderCheckManagement(data, page = 1, rowsPerPage = 10) { // Smoothed: increased rows per page
        const tbody = document.querySelector('#check-management-table tbody');
        const tfoot = document.getElementById('check-management-tfoot');
        if (!tbody) return;
        const paginatedData = data.slice((page - 1) * rowsPerPage, page * rowsPerPage);
        if (paginatedData.length === 0) {
            tbody.innerHTML = `<tr class="no-results-row"><td colspan="7">NO MATCHING RECORDS FOUND.</td></tr>`;
            if (tfoot) tfoot.innerHTML = `<tr><td colspan="6" style="text-align:right;font-weight:bold;">TOTAL CHECKS:</td><td id="check-management-total" style="font-weight:bold;"></td></tr>
<tr><td colspan="6" style="text-align:right;font-weight:bold;">TOTAL CHECK AMOUNT:</td><td id="check-management-amount" style="font-weight:bold;"></td></tr>`;
            return;
        }
        tbody.innerHTML = '';
        
        paginatedData.forEach((item, index) => {
            const invoice = f_invoices.find(i => i.invoiceNo === item.invoice) || {};
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="text-3d">${((page - 1) * rowsPerPage) + index + 1}</span></td>
                <td>${item.invoice !== '-' ? makeInvoiceLink(item.invoice) : '-'}</td>
                <td><span class="company-text">${invoice.supplier ? toUpper(invoice.supplier) : '-'}</span></td>
                <td><span class="currency">${item.amount !== '-' ? INR(item.amount) : '-'}</span></td>
                <td>${f_formatDate(item.date)}</td>
                <td><span class="text-3d">${toUpper(item.no)}</span></td>
                <td><input type="checkbox" ${item.visible ? 'checked' : ''} data-checkno="${item.no}" /></td>
            `;
            tbody.appendChild(tr);
        });
        
        // Update total in tfoot
        if (tfoot) {
            const totalChecks = data.length;
            const totalAmount = data.reduce((sum, item) => sum + (item.amount !== '-' ? Number(item.amount) || 0 : 0), 0);
            const totalEl = document.getElementById('check-management-total');
            const amountEl = document.getElementById('check-management-amount');
            if (totalEl) totalEl.textContent = totalChecks;
            if (amountEl) amountEl.textContent = INR(totalAmount);
        }
        
        // Add event listeners for VISIBLE checkboxes
        tbody.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', (e) => {
                const checkNo = e.target.dataset.checkno;
                const payment = f_payments.find(p => p.checkNo === checkNo);
                if (payment) {
                    payment.visible = e.target.checked;
                    persistAll();
                    updateDashboard();
                    showToast('Check visibility updated');
                }
            });
        });
    }

    function renderCheckManagement(data, page = 1, rowsPerPage = 10) {
        f_renderCheckManagement(data, page, rowsPerPage);
        renderPagination('checkManagement', data.length, page, rowsPerPage);
    }

    function initCheckManagement() {
        currentPages['checkManagement'] = 1; // Added
        renderCheckManagement(getCheckManagementData());
    }

    function getCheckManagementData() {
        // Collect all checks
        let allChecks = [];
        f_payments.filter(p => p.type === 'check').forEach(p => {
            allChecks.push({ no: p.checkNo, status: 'USED', date: p.date, amount: p.amount, invoice: p.invoiceNo, visible: p.visible !== false });
        });
        f_defectiveChecks.forEach(d => {
            allChecks.push({ no: d.checkNo, status: 'DEFECTIVE', date: d.date, amount: '-', invoice: '-', visible: true });
        });
        
        // Remove duplicates by no, prefer used over defective
        const uniqueChecks = {};
        allChecks.forEach(c => {
            if (!uniqueChecks[c.no] || uniqueChecks[c.no].status === 'DEFECTIVE') {
                uniqueChecks[c.no] = c;
            }
        });
        
        const checks = Object.values(uniqueChecks);
        checks.sort((a, b) => getDateFromStr(a.date) - getDateFromStr(b.date));
        return checks;
    }

    function renderCompanyManagement(data, page = 1, rowsPerPage = 10) {
        const tbody = document.querySelector('#company-list-table tbody');
        tbody.innerHTML = '';
        const paginatedData = data.slice((page - 1) * rowsPerPage, page * rowsPerPage);
        paginatedData.forEach((name, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="text-3d">${((page - 1) * rowsPerPage) + index + 1}</span></td>
                <td><span class="text-3d">${toUpper(name)}</span></td>
                <td>
                    <button class="edit-company" data-index="${(page - 1) * rowsPerPage + index}">‚úèÔ∏è EDIT</button>
                    <button class="delete-company" data-index="${(page - 1) * rowsPerPage + index}">‚ùå DELETE</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        // Add event listeners for edit and delete
        tbody.querySelectorAll('.edit-company').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const idx = parseInt(e.target.dataset.index);
                const newName = prompt('Edit company name:', f_parties[idx]);
                if (newName && newName.trim()) {
                    const trimmedNew = newName.trim();
                    if (f_parties.includes(trimmedNew) && trimmedNew !== f_parties[idx]) {
                        alert('Company name already exists.');
                        return;
                    }
                    f_parties[idx] = trimmedNew;
                    updateAllAfterPartyChange();
                    showToast('Company name updated');
                }
            });
        });
        tbody.querySelectorAll('.delete-company').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const idx = parseInt(e.target.dataset.index);
                const nameToDelete = f_parties[idx];
                if (confirm(`Are you sure you want to delete company "${toUpper(nameToDelete)}"? This will NOT delete associated invoices.`)) {
                    f_parties.splice(idx, 1);
                    updateAllAfterPartyChange();
                    showToast('Company deleted');
                }
            });
        });
        renderPagination('companies', data.length, page, rowsPerPage);
    }

    function initCompanyManagement() {
        currentPages['companies'] = 1; // Added
        renderCompanyManagement(f_parties);
    }

    /* ---------------- Settings Controls (Beep & Speech) (Fixed: try-catch added) ---------------- */
    const beepEnabledCheckbox = document.getElementById('beepEnabled');
    const beepVolumeRange = document.getElementById('beepVolumeRange');
    const beepVolumeValue = document.getElementById('beepVolumeValue');
    const beepFrequencyRange = document.getElementById('beepFrequencyRange'); // New
    const beepFrequencyValue = document.getElementById('beepFrequencyValue'); // New
    const beepDurationRange = document.getElementById('beepDurationRange'); // New
    const beepDurationValue = document.getElementById('beepDurationValue'); // New
    const beepPatternSelect = document.getElementById('beepPatternSelect'); // New
    const testBeepBtn = document.getElementById('testBeepBtn'); // New
    const saveCustomBeepBtn = document.getElementById('saveCustomBeepBtn'); // New

    const speechEnabledCheckbox = document.getElementById('speechEnabled');
    const speechLangSelect = document.getElementById('speechLanguage');
    const speechTestBtn = document.getElementById('speechTestBtn');
    const speechVolumeRange = document.getElementById('speechVolumeRange');
    const speechVolumeValue = document.getElementById('speechVolumeValue');
    const speechPitchRange = document.getElementById('speechPitchRange');
    const speechPitchValue = document.getElementById('speechPitchValue');
    const speechRateRange = document.getElementById('speechRateRange');
    const speechRateValue = document.getElementById('speechRateValue');
    const speechVoiceType = document.getElementById('speechVoiceType');
    const speechSpeakButtons = document.getElementById('speechSpeakButtons');

    const SPEECH_KEY = 'ui.speechPrefs.v25'; 
    let speechPrefs = { enabled: false, lang: 'en-IN', volume: 1, pitch: 1.2, rate: 1, voiceType: 'female', speakButtons: false };
    let voices = [];
    let selectedVoice = null;

    function loadSpeechPrefs() {
        try { 
            const raw = localStorage.getItem(SPEECH_KEY); 
            return raw ? { ...speechPrefs, ...JSON.parse(raw) } : speechPrefs; 
        } catch(e){ return speechPrefs; }
    }
    function saveSpeechPrefs(p){ localStorage.setItem(SPEECH_KEY, JSON.stringify(p)); }
    
    function speak(text) {
        if (!speechPrefs.enabled || !text || !window.speechSynthesis || !selectedVoice) return;
        speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        
        utterance.volume = speechPrefs.volume;
        utterance.pitch = speechPrefs.pitch;
        utterance.rate = speechPrefs.rate;
        utterance.voice = selectedVoice;

        speechSynthesis.speak(utterance);
    }

    function selectVoiceForLang(lang, voiceType) {
        const langCode = lang.split('-')[0];
        let langVoices = voices.filter(v => v.lang.startsWith(langCode));
        
        if (voiceType === 'male') {
            selectedVoice = langVoices.find(v => v.name.toLowerCase().includes('male')) ||
                            langVoices.find(v => v.name.toLowerCase().includes('man')) ||
                            langVoices.find(v => v.name.toLowerCase().includes('boy')) ||
                            langVoices[0];
        } else if (voiceType === 'female') {
            selectedVoice = langVoices.find(v => v.name.toLowerCase().includes('female')) ||
                            langVoices.find(v => v.name.toLowerCase().includes('woman')) ||
                            langVoices.find(v => v.name.toLowerCase().includes('girl')) ||
                            langVoices[0];
        } else {
            selectedVoice = langVoices.find(v => v.default) || langVoices[0];
        }
        
        if (!selectedVoice) {
            console.warn(`No voice found for lang=${lang}, voiceType=${voiceType}. Speech will be silent.`);
        }
    }

    function getVoices() {
      return new Promise(resolve => {
        voices = speechSynthesis.getVoices();
        if (voices.length) {
          resolve(voices);
          return;
        }
        speechSynthesis.onvoiceschanged = () => {
          voices = speechSynthesis.getVoices();
          resolve(voices);
        };
      });
    }

    async function initSpeechControls() {
        speechPrefs = loadSpeechPrefs();
        if (speechEnabledCheckbox) speechEnabledCheckbox.checked = speechPrefs.enabled;
        if (speechLangSelect) speechLangSelect.value = speechPrefs.lang;
        if (speechVolumeRange) speechVolumeRange.value = speechPrefs.volume;
        if (speechVolumeValue) speechVolumeValue.textContent = (speechPrefs.volume * 100).toFixed(0);
        if (speechPitchRange) speechPitchRange.value = speechPrefs.pitch;
        if (speechPitchValue) speechPitchValue.textContent = speechPrefs.pitch.toFixed(1);
        if (speechRateRange) speechRateRange.value = speechPrefs.rate;
        if (speechRateValue) speechRateValue.textContent = speechRateRange.toFixed(1);
        if (speechVoiceType) speechVoiceType.value = speechPrefs.voiceType || 'female';
        if (speechSpeakButtons) speechSpeakButtons.checked = speechPrefs.speakButtons || false;

        await getVoices();
        selectVoiceForLang(speechPrefs.lang, speechPrefs.voiceType);

        speechEnabledCheckbox?.addEventListener('change', e => {
            speechPrefs.enabled = e.target.checked;
            saveSpeechPrefs(speechPrefs);
        });
        speechLangSelect?.addEventListener('change', e => {
            speechPrefs.lang = e.target.value;
            selectVoiceForLang(speechPrefs.lang, speechPrefs.voiceType);
            saveSpeechPrefs(speechPrefs);
        });
        speechVoiceType?.addEventListener('change', e => {
            speechPrefs.voiceType = e.target.value;
            selectVoiceForLang(speechPrefs.lang, speechPrefs.voiceType);
            saveSpeechPrefs(speechPrefs);
        });
        speechSpeakButtons?.addEventListener('change', e => {
            speechPrefs.speakButtons = e.target.checked;
            saveSpeechPrefs(speechPrefs);
        });
        speechTestBtn?.addEventListener('click', () => {
            const lang = speechLangSelect.value;
            let testTxt = 'This is a test.';
            if (lang === 'hi-IN') testTxt = '‡§Ø‡§π ‡§è‡§ï ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£ ‡§π‡•à‡•§';
            if (lang === 'kn-IN') testTxt = '‡≤á‡≤¶‡≥Å ‡≤í‡≤Ç‡≤¶‡≥Å ‡≤™‡≤∞‡≥Ä‡≤ï‡≥ç‡≤∑‡≥Ü.';
            if (lang === 'gu-IN') testTxt = '‡™Ü ‡™è‡™ï ‡™™‡™∞‡´Ä‡™ï‡´ç‡™∑‡™£ ‡™õ‡´á.';
            speak(testTxt);
        });

        speechVolumeRange?.addEventListener('input', e => {
            const val = parseFloat(e.target.value);
            speechPrefs.volume = val;
            if (speechVolumeValue) speechVolumeValue.textContent = (val * 100).toFixed(0);
            saveSpeechPrefs(speechPrefs);
        });
        speechPitchRange?.addEventListener('input', e => {
            const val = parseFloat(e.target.value);
            speechPrefs.pitch = val;
            if (speechPitchValue) speechPitchValue.textContent = val.toFixed(1);
            saveSpeechPrefs(speechPrefs);
        });
        speechRateRange?.addEventListener('input', e => {
            const val = parseFloat(e.target.value);
            speechPrefs.rate = val;
            if (speechRateValue) speechRateValue.textContent = val.toFixed(1);
            saveSpeechPrefs(speechPrefs);
        });
    }

    function initBeepControls() {
        beepPrefs = loadBeepPrefs();
        if (beepEnabledCheckbox) beepEnabledCheckbox.checked = beepPrefs.enabled;
        if (beepVolumeRange) beepVolumeRange.value = beepPrefs.volume;
        if (beepVolumeValue) beepVolumeValue.textContent = Math.round(beepPrefs.volume * 100); // Changed to 200%
        if (beepFrequencyRange) beepFrequencyRange.value = beepPrefs.frequency || 700;
        if (beepFrequencyValue) beepFrequencyValue.textContent = beepPrefs.frequency || 700;
        if (beepDurationRange) beepDurationRange.value = beepPrefs.duration || 120;
        if (beepDurationValue) beepDurationValue.textContent = beepPrefs.duration || 120;
        if (beepPatternSelect) beepPatternSelect.value = beepPrefs.pattern || 'single';
    }
    if (beepEnabledCheckbox) beepEnabledCheckbox.addEventListener('change', (e) => {
        beepPrefs.enabled = e.target.checked;
        saveBeepPrefs(beepPrefs);
    });
    if (beepVolumeRange) beepVolumeRange.addEventListener('input', (e) => {
        const vol = parseFloat(e.target.value);
        beepPrefs.volume = vol;
        if (beepVolumeValue) beepVolumeValue.textContent = Math.round(vol * 100); // Changed to 200%
        saveBeepPrefs(beepPrefs);
        playBeep(700, 120, 'single'); // Test with default
    });
    if (beepFrequencyRange) beepFrequencyRange.addEventListener('input', (e) => {
        const freq = parseInt(e.target.value, 10);
        beepPrefs.frequency = freq;
        if (beepFrequencyValue) beepFrequencyValue.textContent = freq;
        saveBeepPrefs(beepPrefs);
    });
    if (beepDurationRange) beepDurationRange.addEventListener('input', (e) => {
        const dur = parseInt(e.target.value, 10);
        beepPrefs.duration = dur;
        if (beepDurationValue) beepDurationValue.textContent = dur;
        saveBeepPrefs(beepPrefs);
    });
    if (beepPatternSelect) beepPatternSelect.addEventListener('change', (e) => {
        beepPrefs.pattern = e.target.value;
        saveBeepPrefs(beepPrefs);
    });
    if (testBeepBtn) testBeepBtn.addEventListener('click', () => playBeep());
    if (saveCustomBeepBtn) saveCustomBeepBtn.addEventListener('click', () => {
        saveBeepPrefs(beepPrefs);
        showToast('Custom beep settings saved');
    });
    initBeepControls();
    initSpeechControls();

    // Add speak button name on click (Fixed: Added)
    document.addEventListener('click', e => {
      if (e.target.matches('button')) {
        console.log('Button clicked:', e.target.textContent || e.target.getAttribute('aria-label')); // Debugging log
        showToast('Button clicked');
      }
      if (speechPrefs.speakButtons && speechPrefs.enabled && e.target.matches('button')) {
        const buttonName = (e.target.title || e.target.getAttribute('aria-label') || e.target.querySelector('.btn-text')?.textContent || e.target.textContent || '').trim().replace(/[‚öôÔ∏èüíæ‚Ü©üóë‚¨á‚¨Üüì§üìÅüßπüëÅÔ∏èüìÑüì•üñ®üü¢‚ùåüîç]/g, '').trim();
        if (buttonName) {
          let textToSpeak = '';
          const lang = speechPrefs.lang;
          if (lang === 'hi-IN') { textToSpeak = `‡§Ü‡§™‡§®‡•á ${buttonName} ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§π‡•à‡•§`;
          } else if (lang === 'kn-IN') { textToSpeak = `‡≤®‡≥Ä‡≤µ‡≥Å ${buttonName} ‡≤¨‡≤ü‡≤®‡≥ç ‡≤í‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥ç‡≤¶‡≥Ä‡≤∞‡≤ø.`;
          } else if (lang === 'gu-IN') { textToSpeak = `‡™§‡™Æ‡´á ${buttonName} ‡™¨‡™ü‡™® ‡™¶‡™¨‡™æ‡™µ‡´ç‡™Ø‡´Å‡™Ç ‡™õ‡´á.`;
          } else { textToSpeak = `You pressed the ${buttonName} button.`; }
          speak(textToSpeak);
        }
      }
    });

    /* ---------------- Lock Screen Functionality ---------------- */
    const lockScreen = document.getElementById('lockScreen');
    const passwordInput = document.getElementById('password-input');
    const unlockBtn = document.getElementById('unlock-btn');
    const forgetBtn = document.getElementById('forget-btn');
    const lockError = document.getElementById('lock-error');
    const SECURITY_KEY = 'app.security.v89';

    let securitySettings = { password: '', securityAnswer: '' };

    function loadSecuritySettings() {
        try {
            const raw = localStorage.getItem(SECURITY_KEY);
            return raw ? JSON.parse(raw) : securitySettings;
        } catch (e) {
            return securitySettings;
        }
    }

    function saveSecuritySettings() {
        localStorage.setItem(SECURITY_KEY, JSON.stringify(securitySettings));
    }

    function showLockScreen() {
        if (!appSettings.lockScreenEnabled) return;
        if (lockScreen) {
            lockScreen.style.display = 'flex';
            passwordInput.focus();
        }
    }

    function hideLockScreen() {
        if (lockScreen) {
            lockScreen.style.display = 'none';
        }
    }

    function unlockApp() {
        const enteredPassword = passwordInput.value.trim();
        let correctPassword = '';

        if (appSettings.autoGenPasswordEnabled) {
            const today = new Date();
            if (appSettings.autoGenPasswordType === '12') {
                const hh = today.getHours();
                const mm = String(today.getMinutes()).padStart(2, '0');
                const period = hh >= 12 ? 'P' : 'A';
                const h12 = hh % 12 || 12;
                correctPassword = String(h12).padStart(2, '0') + mm + period;
            } else if (appSettings.autoGenPasswordType === 'ddmmyy') {
                const dd = String(today.getDate()).padStart(2, '0');
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const yy = String(today.getFullYear()).slice(-2);
                correctPassword = dd + mm + yy;
            } else {
                const hh = today.getHours();
                const mm = String(today.getMinutes()).padStart(2, '0');
                correctPassword = String(hh).padStart(2, '0') + mm;
            }
        } else {
            if (!securitySettings.password) {
                // First time setup
                if (!enteredPassword) {
                    lockError.textContent = 'Please set a password.';
                    return;
                }
                securitySettings.password = encryptPassword(enteredPassword);
                saveSecuritySettings();
                hideLockScreen();
                showToast('Password setup complete');
                return;
            }
            correctPassword = decryptPassword(securitySettings.password);
        }

        if (enteredPassword === correctPassword) {
            hideLockScreen();
            lockError.textContent = '';
            passwordInput.value = '';
        } else {
            lockError.textContent = 'Incorrect password.';
        }
    }

    function handleForgetPassword() {
        if (appSettings.autoGenPasswordEnabled) {
            alert('Auto-generate password is enabled. Check today\'s password in settings.');
            return;
        }
        if (!securitySettings.securityAnswer) {
            const newAnswer = prompt('Security answer not set. Set a new security answer:');
            if (newAnswer) {
                securitySettings.securityAnswer = encryptPassword(newAnswer);
                saveSecuritySettings();
                alert('Security answer set. Now enter it to unlock.');
                return;
            } else {
                return;
            }
        }
        const enteredAnswer = prompt('Enter your security answer:');
        if (!enteredAnswer || decryptPassword(securitySettings.securityAnswer) !== enteredAnswer) {
            alert('Incorrect security answer.');
            return;
        }
        const newPassword = prompt('Enter new password:');
        if (!newPassword) return;
        const confirmPassword = prompt('Confirm new password:');
        if (newPassword !== confirmPassword) {
            alert('Passwords do not match.');
            return;
        }
        securitySettings.password = encryptPassword(newPassword);
        saveSecuritySettings();
        hideLockScreen();
        showToast('Password reset successfully.');
        passwordInput.value = '';
    }

    if (unlockBtn) unlockBtn.addEventListener('click', unlockApp);
    if (forgetBtn) forgetBtn.addEventListener('click', handleForgetPassword);

    /* ---------------- Tabs ---------------- */
    const tabDashboard = document.getElementById('tabDashboard');
    const tabFinance = document.getElementById('tabFinance');
    const tabStatement = document.getElementById('tabStatement');
    const tabReports = document.getElementById('tabReports');
    const tabSettings = document.getElementById('tabSettings');

    const allSections = {
        dashboard: document.getElementById('dashboardSection'),
        finance: document.getElementById('financeApp'),
        statement: document.getElementById('statementSection'),
        reports: document.getElementById('reportsSection'),
        settings: document.getElementById('settingsSection'),
        gst: document.getElementById('gstApp'),
        purchaseBill: document.getElementById('purchaseBillReportSection'),
        company: document.getElementById('companyReportSection'),
    };

    const allTabs = {
        dashboard: tabDashboard,
        finance: tabFinance,
        statement: tabStatement,
        reports: tabReports,
        settings: tabSettings,
    };
    
    // Navigation history for back button
    let history = [];
    let currentSection = 'dashboard';

    function setActiveTab(activeBtn){
      Object.values(allTabs).forEach((b) => {
        if (!b) return;
        b.classList.remove('active');
        b.classList.add('inactive');
        b.removeAttribute('aria-current');
      });
      if (!activeBtn) return;
      activeBtn.classList.add('active');
      activeBtn.classList.remove('inactive');
      activeBtn.setAttribute('aria-current', 'page');
    }

    function showSection(section, button, pushToHistory = true) {
        if (pushToHistory && currentSection && section !== allSections[currentSection]) {
            history.push(currentSection);
        }
        Object.values(allSections).forEach(s => {
            if (s) s.style.display = 'none';
        });
        if (section) {
            section.style.display = 'block';
            if(button) button.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        setActiveTab(button);
        currentSection = Object.keys(allSections).find(key => allSections[key] === section);
        // Handle back button visibility
        const backBtn = document.getElementById('backBtn');
        if (section === allSections.dashboard) {
            if (backBtn) backBtn.style.display = 'none';
        } else {
            if (backBtn) backBtn.style.display = 'inline-block';
        }
    }

    if (tabDashboard) tabDashboard.addEventListener('click', () => showSection(allSections.dashboard, tabDashboard));
    if (tabFinance) tabFinance.addEventListener('click', () => showSection(allSections.finance, tabFinance));
    if (tabStatement) tabStatement.addEventListener('click', () => showSection(allSections.statement, tabStatement));
    if (tabReports) tabReports.addEventListener('click', () => showSection(allSections.reports, tabReports));
    if (tabSettings) tabSettings.addEventListener('click', () => showSection(allSections.settings, tabSettings));

    const backBtn = document.getElementById('backBtn');
    if (backBtn) backBtn.addEventListener('click', () => {
        if (history.length > 0) {
            const prev = history.pop();
            showSection(allSections[prev], allTabs[prev], false);
        } else {
            showSection(allSections.dashboard, allTabs[dashboard], false);
        }
    });

    // Reports Navigation buttons
    document.getElementById('navToGst').addEventListener('click', () => showSection(allSections.gst, null));
    document.getElementById('navToPurchaseBill').addEventListener('click', () => showSection(allSections.purchaseBill, null));
    document.getElementById('navToCompany').addEventListener('click', () => showSection(allSections.company, null));

    // Settings Navigation buttons (renamed IDs)
    document.getElementById('navToGstSettings').addEventListener('click', () => showSection(allSections.gst, null));
    document.getElementById('navToPurchaseBillSettings').addEventListener('click', () => showSection(allSections.purchaseBill, null));
    document.getElementById('navToCompanySettings').addEventListener('click', () => showSection(allSections.company, null));

    /* ---------------- Data Stores (Fixed: try-catch added) ---------------- */
    const STORAGE_KEY = 'app.data.v89.plain';
    const BACKUP_KEY = 'app.data.v89.plain.backup';
    let f_invoices = [];
    let f_payments = []; 
    let f_returns = []; 
    let f_defectiveChecks = [];
    let f_expenses = [];
    let f_incomes = [];
    let g_lines = [];
    let f_parties = [];
    let paymentStatusCache = new Map();

    async function persistAll(force = false) {
      if (!appSettings.autoBackup && !force) {
        const badge = document.getElementById('saveBadge');
        if (badge) {
            badge.textContent = 'Unsaved';
            badge.className = 'badge warn';
        }
        return;
      }

      const payload = {
        invoices: f_invoices,
        payments: f_payments,
        expenses: f_expenses,
        incomes: f_incomes,
        returns: f_returns,
        defectiveChecks: f_defectiveChecks,
        gst: g_lines,
        parties: f_parties,
      };
      
      const dataString = JSON.stringify(payload);
      
      const previousData = localStorage.getItem(STORAGE_KEY);
      if (previousData) {
        localStorage.setItem(BACKUP_KEY, previousData);
      }
      try {
        localStorage.setItem(STORAGE_KEY, dataString);
      } catch (e) {
        console.error('Storage full or error:', e);
        showToast('Storage error! Data may not be saved.');
        return;
      }
      
      const badge = document.getElementById('saveBadge');
      if (badge) {
        badge.textContent = 'Saved ‚úî';
        badge.className = 'badge ok';
      }
      showToast(force ? 'Saved Manually' : 'Auto-saved');
      // Add browser notification for save
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('Data Saved', { body: 'Your data has been saved successfully.', icon: '/favicon.ico' });
      }
      updateEditPaymentSelect();
    }

    async function loadAll() {
      let dataString = localStorage.getItem(STORAGE_KEY);
      let loadedFromBackup = false;

      if (!dataString) {
        showToast('No saved data');
        return false;
      }

      try {
        const p = JSON.parse(dataString);
        f_invoices = p.invoices || [];
        f_payments = p.payments || [];
        f_expenses = p.expenses || [];
        f_incomes = p.incomes || [];
        f_returns = p.returns || [];
        f_defectiveChecks = p.defectiveChecks || [];
        g_lines = p.gst || [];
        f_parties = Array.isArray(p.parties) ? p.parties.filter(Boolean) : [];

      } catch (e) {
        console.warn('Primary data load failed, trying backup:', e.message);
        dataString = localStorage.getItem(BACKUP_KEY);
        if (!dataString) {
            alert('Load failed: Could not read primary data and no backup found.');
            return false;
        }
        try {
            const p = JSON.parse(dataString);
            f_invoices = p.invoices || [];
            f_payments = p.payments || [];
            f_expenses = p.expenses || [];
            f_incomes = p.incomes || [];
            f_returns = p.returns || [];
            f_defectiveChecks = p.defectiveChecks || [];
            g_lines = p.gst || [];
            f_parties = Array.isArray(p.parties) ? p.parties.filter(Boolean) : [];

            loadedFromBackup = true;

        } catch (backupError) {
            alert('Fatal: Could not load primary or backup data. Data may be corrupt.');
            return false;
        }
      }
      
      updateAllUI();
      showToast(loadedFromBackup ? 'Loaded from backup' : 'Loaded successfully');
      const badge = document.getElementById('saveBadge');
      if (badge) {
        badge.textContent = 'Loaded';
        badge.className = 'badge ok';
      }
      return true;
    }

    function clearAll() {
      if (!confirm('Clear all saved data from this browser? This cannot be undone.')) return;
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(BACKUP_KEY);
      localStorage.removeItem(SETTINGS_KEY);
      idbDel(SAVE_DIR_KEY);
      const badge = document.getElementById('saveBadge');
      if (badge) {
          badge.textContent = 'Cleared';
          badge.className = 'badge warn';
      }
      showToast('Cleared local data');
      window.location.reload();
    }

    const saveAllBtn = document.getElementById('saveAll');
    const loadAllBtn = document.getElementById('loadAll');
    const clearAllBtn = document.getElementById('clearAll');
    if (saveAllBtn) saveAllBtn.addEventListener('click', () => persistAll(true));
    if (loadAllBtn) loadAllBtn.addEventListener('click', loadAll);
    if (clearAllBtn) clearAllBtn.addEventListener('click', clearAll);

    function updateAllUI() {
        precomputePaymentStatus();
        updatePartyList();
        updateCompanyReportDropdown();
        updatePurchaseBillCompanyFilter();
        renderCompanyListForSettings();
        renderAllTables();
        updateDashboard();
        applySectionVisibility();
        initCheckManagement(); // Added
        updateEditPaymentSelect();
    }

    /* ---------------- Party (Company Name) helpers & autocomplete (Fixed: try-catch added) ---------------- */
    function updatePartyList() {
      f_parties = f_parties.map(p => (p||'').trim()).filter(Boolean);
      f_parties = [...new Set(f_parties)].sort();

      const companyFilters = document.querySelectorAll('#f-inv-companyFilter, #f-return-companyFilter, #dashboardCompanyFilter, #check-management-company-filter'); // Added check-management-company-filter
      companyFilters.forEach(companyFilter => {
          if (companyFilter) {
              const currentVal = companyFilter.value;
              companyFilter.innerHTML = `<option value="">All Companies</option>`;
              f_parties.forEach(p => {
                  const opt = document.createElement('option');
                  opt.value = p;
                  opt.textContent = toUpper(p);
                  companyFilter.appendChild(opt);
              });
              companyFilter.value = currentVal;
          }
      });
    }

    function ensureParty(name) {
      if (!name) return;
      const trimmed = String(name).trim();
      if (trimmed && !f_parties.find(p => toUpper(p) === name)) {
        f_parties.push(trimmed);
        updateAllAfterPartyChange();
      }
    }

    function createAutocomplete(inputId, suggestionsId) {
        const inputEl = document.getElementById(inputId);
        const suggestionsEl = document.getElementById(suggestionsId);
        if (!inputEl || !suggestionsEl) return;

        let activeSuggestion = -1;

        const showSuggestions = (query = '') => {
            const q = toUpper(query || '').trim();
            const matches = f_parties.filter(p => toUpper(p).includes(q));
            suggestionsEl.innerHTML = '';
            if (!matches.length) {
                suggestionsEl.setAttribute('aria-hidden', 'true');
                activeSuggestion = -1;
                return;
            }
            matches.forEach((m) => {
                const li = document.createElement('li');
                li.setAttribute('role', 'option');
                li.dataset.value = m;
                li.innerText = toUpper(m);
                li.addEventListener('mousedown', (ev) => {
                    ev.preventDefault();
                    selectSuggestion(m);
                });
                suggestionsEl.appendChild(li);
            });
            activeSuggestion = -1;
            suggestionsEl.setAttribute('aria-hidden', 'false');
        };

        const hideSuggestions = () => {
            suggestionsEl.setAttribute('aria-hidden', 'true');
            suggestionsEl.innerHTML = '';
            activeSuggestion = -1;
        };

        const selectSuggestion = (value) => {
            inputEl.value = value;
            hideSuggestions();
            inputEl.focus();
        };

        const debouncedShow = debounce(() => showSuggestions(inputEl.value), 200); // Smoothed debounce
        inputEl.addEventListener('input', debouncedShow);
        inputEl.addEventListener('focus', () => showSuggestions(inputEl.value));
        inputEl.addEventListener('keydown', (e) => {
            const visible = suggestionsEl.getAttribute('aria-hidden') === 'false';
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (!visible) showSuggestions(inputEl.value);
                moveSuggestion(1);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (!visible) showSuggestions(inputEl.value);
                moveSuggestion(-1);
            } else if (e.key === 'Enter') {
                if (visible && activeSuggestion >= 0) {
                    e.preventDefault();
                    const items = suggestionsEl.querySelectorAll('li');
                    const value = items[activeSuggestion]?.dataset.value;
                    if (value) selectSuggestion(value);
                }
            } else if (e.key === 'Escape') {
                hideSuggestions();
            }
        });
        inputEl.addEventListener('blur', () => setTimeout(hideSuggestions, 160));
    }

    createAutocomplete('f-companyName', 'companyNameSuggestions');
    createAutocomplete('f-returnCompanyName', 'returnCompanyNameSuggestions');
    createAutocomplete('stmName', 'stmNameSuggestions');

    /* ---------------- Choose a local Folder (File System Access API) (Fixed: Added persistence) ---------------- */
    const setFolderBtn = document.getElementById('setFolderBtn');
    const clearFolderBtn = document.getElementById('unsetFolderBtn');
    const folderBadge = document.getElementById('folderBadge');
    const SAVE_DIR_DB = 'app.fs.v89';
    const SAVE_DIR_STORE = 'handles';
    const SAVE_DIR_KEY = 'saveDirHandle';
    let saveDirHandle = null;

    function updateFolderBadge() {
      if (!folderBadge) return;
      if (saveDirHandle && saveDirHandle.name) {
        folderBadge.textContent = `üìÅ ${toUpper(saveDirHandle.name)} (saved across sessions successfully)`;
        folderBadge.className = 'badge ok';
      } else {
        folderBadge.textContent = '‚ùå NO FOLDER SELECTED';
        folderBadge.className = 'badge';
      }
    }

    function idbOpen() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(SAVE_DIR_DB, 1);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains(SAVE_DIR_STORE)) db.createObjectStore(SAVE_DIR_STORE);
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    async function idbSet(key, value) {
      const db = await idbOpen();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(SAVE_DIR_STORE, 'readwrite');
        tx.objectStore(SAVE_DIR_STORE).put(value, key);
        tx.oncomplete = () => { db.close(); resolve(); };
        tx.onerror = () => { const err = tx.error; db.close(); reject(err); };
      });
    }
    async function idbGet(key) {
      const db = await idbOpen();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(SAVE_DIR_STORE, 'readonly');
        const rq = tx.objectStore(SAVE_DIR_STORE).get(key);
        rq.onsuccess = () => { const v = rq.result; db.close(); resolve(v); };
        rq.onerror = () => { const err = rq.error; db.close(); reject(err); };
      });
    }
    async function idbDel(key) {
      const db = await idbOpen();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(SAVE_DIR_STORE, 'readwrite');
        tx.objectStore(SAVE_DIR_STORE).delete(key);
        tx.oncomplete = () => { db.close(); resolve(); };
        tx.onerror = () => { const err = rq.error; db.close(); reject(err); };
      });
    }

    async function verifyPermission(handle, withWrite = true) {
        if (!handle) return false;
        const opts = { mode: withWrite ? 'readwrite' : 'read' };
        if (await handle.queryPermission(opts) === 'granted') return true;
        if (await handle.requestPermission(opts) === 'granted') return true;
        return false;
    }

    async function loadSavedFolder() {
      try {
        const handle = await idbGet(SAVE_DIR_KEY);
        if (handle) {
          saveDirHandle = handle;
          updateFolderBadge();
        }
      } catch (e) {
        console.warn('Failed to load saved folder:', e);
      }
    }

    async function chooseFolder() {
      if (!('showDirectoryPicker' in window)) {
        alert('Folder selection not supported in this browser. Use Chrome/Edge.');
        return;
      }
      try {
        const handle = await window.showDirectoryPicker({ mode: 'readwrite' });
        saveDirHandle = handle;
        await idbSet(SAVE_DIR_KEY, handle);
        updateFolderBadge();
        showToast('Folder selected and saved');
      } catch (e) {
        if (e && e.name !== 'AbortError') {
            console.error("Error choosing folder:", e);
            alert('Folder pick canceled or failed.');
        }
      }
    }

    async function clearFolder() {
      saveDirHandle = null;
      await idbDel(SAVE_DIR_KEY);
      updateFolderBadge();
      showToast('Folder unset');
    }

    if (setFolderBtn) setFolderBtn.addEventListener('click', chooseFolder);
    if (clearFolderBtn) clearFolderBtn.addEventListener('click', clearFolder);
    
    async function saveBlobPreferFolder(blob, filename) {
        if (saveDirHandle && await verifyPermission(saveDirHandle, true)) {
            try {
                const fileHandle = await saveDirHandle.getFileHandle(filename, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(blob);
                await writable.close();
                showToast(`Saved: ${filename}`);
                return;
            } catch (e) {
                console.warn('Folder save failed, falling back to download:', e);
                showToast('Folder access failed. Downloading...');
            }
        }
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.removeChild(a);
      URL.revokeObjectURL(url);
    }

    /* ---------------- Backup & Restore (JSON) (Fixed: try-catch added) ---------------- */
    const backupBtn = document.getElementById('backupBtn');
    const restoreBtn = document.getElementById('restoreBtn');
    const restoreFileInput = document.getElementById('restoreFile');

    function preparePayloadForExport() {
      return {
        meta: {
          exportedAt: new Date().toISOString(),
          app: 'Combined Dashboard (Tiranga 3D Secure) - v16 App Title Real-Time Update Fixed - 5D Tiranga Type Buttons - Custom Beep Settings - Beep Volume 200% - All Bugs Fixed',
        },
        data: {
            invoices: f_invoices,
            payments: f_payments,
            expenses: f_expenses,
            incomes: f_incomes,
            returns: f_returns,
            defectiveChecks: f_defectiveChecks,
            gst: g_lines,
            parties: f_parties,
          }
      };
    }

    async function backupAll(){
      try {
        const payload = preparePayloadForExport();
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const name = `finance_backup_${new Date().toISOString().slice(0,10)}.json`;
        await saveBlobPreferFolder(blob, name);
        if (window.setLastBackupFile) window.setLastBackupFile(name);
      } catch (err) {
        alert('Backup failed: ' + (err.message || err));
      }
    }

    function restoreFromFile(file) {
      if (!file) return;
      const ok = confirm('Restoring will overwrite all current data. Continue?');
      if (!ok) return;
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const parsed = JSON.parse(e.target.result);
          let mainData = null;
          if (parsed.data && typeof parsed.data === 'object') mainData = parsed.data;
          else if (
            parsed.invoices || parsed.payments || parsed.expenses || parsed.incomes || parsed.gst
          )
            mainData = parsed;
          else throw new Error('Unrecognized backup format.');

          const restoredPayload = {
              invoices: mainData.invoices || [],
              payments: mainData.payments || [],
              expenses: mainData.expenses || [],
              incomes: mainData.incomes || [],
              returns: mainData.returns || [],
              defectiveChecks: mainData.defectiveChecks || [],
              gst: mainData.gst || mainData.g_lines || [],
              parties: mainData.parties || [],
          };
          
          localStorage.setItem(STORAGE_KEY, JSON.stringify(restoredPayload));

          await loadAll();
          showToast('Restore complete');
          const badge = document.getElementById('saveBadge');
          if (badge) {
            badge.textContent = 'Restored';
            badge.className = 'badge ok';
          }
          if (window.setLastRestoreFile) window.setLastRestoreFile(file.name);
        } catch (err) {
          alert('Restore failed: ' + (err.message || err));
        }
      };
      reader.readAsText(file);
    }
    if (backupBtn) backupBtn.addEventListener('click', backupAll);
    if (restoreBtn)
      restoreBtn.addEventListener(
        'click',
        () => restoreFileInput && restoreFileInput.click()
      );
    if (restoreFileInput)
      restoreFileInput.addEventListener('change', (ev) => {
        const f = ev.target.files && ev.target.files[0];
        if (f) restoreFromFile(f);
        restoreFileInput.value = '';
      });

    /* ---------------- Share Modal (preview + copy + whatsapp) (Fixed: DOMPurify used) ---------------- */
    const shareMainBtn = document.getElementById('shareMainBtn');
    const shareBackdrop = document.getElementById('shareBackdrop');
    const sharePreviewContainer = document.getElementById('sharePreviewContainer');
    const shareCopyModalBtn = document.getElementById('shareCopyModalBtn');
    const shareWhatsappModalBtn = document.getElementById('shareWhatsappModalBtn');
    const closeShareModalBtn = document.getElementById('closeShareModalBtn');

    function openShareModal() {
      populateShareModal();
      if (shareBackdrop) {
        shareBackdrop.style.display = 'flex';
        shareBackdrop.setAttribute('aria-hidden', 'false');
      }
    }
    function closeShareModal() {
      if (shareBackdrop) {
        shareBackdrop.style.display = 'none';
        shareBackdrop.setAttribute('aria-hidden', 'true');
      }
    }
    if (shareMainBtn) shareMainBtn.addEventListener('click', openShareModal);
    if (closeShareModalBtn)
      closeShareModalBtn.addEventListener('click', closeShareModal);
    if (shareBackdrop)
      shareBackdrop.addEventListener('click', (e) => {
        if (e.target === shareBackdrop) closeShareModal();
      });

    function populateShareModal() {
      const payload = preparePayloadForExport();
      const d = payload.data || {};
      const invoices = d.invoices || [];
      const payments = d.payments || [];
      const expenses = d.expenses || [];
      const incomes = d.incomes || [];
      const gst = d.gst || [];

      const sum = (arr) =>
        arr.reduce((s, it) => {
          if (!it) return s;
          if (it.amount !== undefined) return s + (Number(it.amount) || 0);
          if (it.invoiceAmount !== undefined)
            return s + (Number(it.invoiceAmount) || 0);
          if (it.grand !== undefined) return s + (Number(it.grand) || 0);
          return s;
        }, 0);
   const buildMiniTable = (title, arr, cols) => {
        if (!arr.length)
          return `<div class="share-section"><strong>${title}</strong><div class="small-muted">No entries</div></div>`;
        const rows = arr
          .slice(0, 5)
          .map((it) => `<tr>${cols.map((c) => `<td>${c(it)}</td>`).join('')}</tr>`)
          .join('');
        return `<div class="share-section"><div style="display:flex;justify-content:space-between;align-items:center;"><strong>${title}</strong><span class="small-muted">${arr.length} entries ‚Ä¢ Total: ${INR(
          sum(arr)
        )}</span></div>
          <div style="margin-top:8px;overflow:auto;"><table style="width:100%;border-collapse:collapse;"><thead><tr>${cols
            .map(
              (c) =>
                `<th style="background:#f7f9fb;padding:6px;border-bottom:1px solid #eee;">${
                  c.header || ''
                }</th>`
            )
            .join('')}</tr></thead>
          <tbody>${rows}</tbody></table></div></div>`;
      };

      const invCols = [
        (it) => toUpper(it.invoiceNo) || '-',
        (it) => toUpper(it.supplier) || '-',
        (it) => f_formatDate(it.date),
        (it) => INR(it.amount || 0),
      ];
      invCols.header = ['Invoice', 'Company Name', 'Date', 'Amount'];

      const payCols = [
        (it) => toUpper(it.type) || '',
        (it) => toUpper(it.invoiceNo) || '-',
        (it) => f_formatDate(it.date),
        (it) => INR(it.amount || 0),
        (it) => toUpper(it.checkNo || it.creditNoteNo || '-'),
      ];
      payCols.header = ['Type', 'Invoice', 'Date', 'Amount', 'Check#/Credit#'];

      const expCols = [
        (it) => toUpper(it.name) || '-',
        (it) => f_formatDate(it.date),
        (it) => toUpper(it.type) || '-',
        (it) => INR(it.amount || 0),
      ];
      expCols.header = ['Name', 'Date', 'Type', 'Amount'];

      const incCols = [
        (it) => f_formatDate(it.date),
        (it) => toUpper(it.type) || '-',
        (it) => INR(it.amount || 0),
      ];
      incCols.header = ['Date', 'Type', 'Amount'];

      const gstCols = [
        (it) => toUpper(it.mode),
        (it) => `${it.taxRate || ''}%`,
        (it) => INR(it.amount || 0),
        (it) => INR(it.sgst || 0),
        (it) => INR(it.cgst || 0),
        (it) => INR(it.grand || 0),
        (it) => toUpper(it.payment),
      ];
      gstCols.header = ['Mode', 'Tax%', 'Amount', 'SGST', 'CGST', 'Grand', 'Payment'];

      const html = [
        buildMiniTable('Invoices', invoices, invCols),
        buildMiniTable('Payments', payments, payCols),
        buildMiniTable('Expenses', expenses, expCols),
        buildMiniTable('Income', incomes, incCols),
        buildMiniTable('GST lines', gst, gstCols),
      ].join('');

      if (sharePreviewContainer) sharePreviewContainer.innerHTML = DOMPurify.sanitize(html);
    }

    async function copySharePayload() {
      const payload = preparePayloadForExport();
      const str = JSON.stringify(payload, null, 2);
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(str);
          showToast('Full JSON copied to clipboard');
        } else {
          const ta = document.createElement('textarea');
          ta.value = str;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          URL.revokeObjectURL(url);
          showToast('Full JSON copied (fallback)');
        }
      } catch (err) {
        alert('Copy failed: ' + (err.message || err));
      }
    }
    if (shareCopyModalBtn)
      shareCopyModalBtn.addEventListener('click', copySharePayload);

    function shareModalWhatsapp() {
      try {
        const payload = preparePayloadForExport();
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
        }
        const d = payload.data || {};
        const invoices = d.invoices || [];
        const payments = d.payments || [];
        const expenses = d.expenses || [];
        const incomes = d.incomes || [];
        const gst = d.gst || [];
        const sum = (arr) =>
          arr.reduce((s, it) => s + (Number(it.amount || it.grand || 0)), 0);
        const summary = `Finance Backup ‚Äî ${new Date().toLocaleString()}
Invoices: ${invoices.length} (Total ${INR(sum(invoices))})
Payments: ${payments.length} (Total ${INR(sum(payments))})
Expenses: ${expenses.length} (Total ${INR(sum(expenses))})
Income: ${incomes.length} (Total ${INR(sum(incomes))})
GST lines: ${gst.length} (Grand ${INR(sum(gst))})
‚úÖ Full JSON copied to clipboard ‚Äî paste to share full data.`;
        const waUrl = `https://wa.me/?text=${encodeURIComponent(summary)}`;
        window.open(waUrl, '_blank');
        closeShareModal();
      } catch (err) {
        alert('Share failed: ' + (err.message || err));
      }
    }
    if (shareWhatsappModalBtn)
      shareWhatsappModalBtn.addEventListener('click', shareModalWhatsapp);

    /* ---------------- Finance helpers & DOM (rest of app) (Fixed: try-catch added) ---------------- */
    function getDateFromStr(dateStr) {
        if (!dateStr) return null;
        const [year, month, day] = dateStr.split('-').map(Number);
        if (!year || !month || !day) return null;
        const d = new Date(year, month - 1, day);
        return isNaN(d.getTime()) ? null : d;
    }
    
    function f_formatDate(dateStr) {
      if (!dateStr) return '';
      const d = getDateFromStr(dateStr);
      if (!d) return '';
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      return `<span class="date-text">${day}/${month}/${year}</span>`;
    }

    function precomputePaymentStatus() {
        paymentStatusCache.clear();
        const paymentsByInvoice = new Map();
        for (const p of f_payments) {
            if (!paymentsByInvoice.has(p.invoiceNo)) {
                paymentsByInvoice.set(p.invoiceNo, []);
            }
            paymentsByInvoice.get(p.invoiceNo).push(p);
        }

        for (const invoice of f_invoices) {
            const invoicePayments = paymentsByInvoice.get(invoice.invoiceNo) || [];
            const paid = invoicePayments.reduce((s, p) => s + (Number(p.amount) || 0), 0);
            const remaining = +(Number(invoice.amount) - paid).toFixed(2);
            let status = 'pending';
            if (remaining <= 0.001) status = 'paid';
            else if (paid > 0) status = 'partial';
            paymentStatusCache.set(invoice.invoiceNo, { paid, remaining, status, invoicePayments });
        }
    }
    function f_computeStatus(invoice) {
        if (paymentStatusCache.has(invoice.invoiceNo)) {
            return paymentStatusCache.get(invoice.invoiceNo);
        }
        const invoicePayments = f_payments.filter((p) => p.invoiceNo === invoice.invoiceNo);
        const paid = invoicePayments.reduce((s, p) => s + (Number(p.amount) || 0), 0);
        const remaining = +(Number(invoice.amount) - paid).toFixed(2);
        let status = 'pending';
        if (remaining <= 0.001) status = 'paid';
        else if (paid > 0) status = 'partial';
        return { paid, remaining, status, invoicePayments };
    }

    function calculateDaysDifference(dateStr) {
        const targetDate = getDateFromStr(dateStr);
        if(!targetDate) return 0;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const diffTime = today - targetDate;
        if (diffTime < 0) return 0;
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    function formatPaymentType(type) {
        const upperType = toUpper(type);
        if (upperType === 'CHECK') return `<span class="text-3d">CHECK PAYMENT</span>`;
        if (upperType === 'CASH') return `<span class="text-3d-blue">CASH PAYMENT</span>`;
        if (upperType === 'ONLINE') return `<span class="text-3d-blue">ONLINE PAYMENT</span>`;
        if (upperType === 'BATAN') return `<span class="text-3d">MULTIPLE CHECK PAYMENT</span>`;
        if (upperType === 'MULTI_CASH') return `<span class="text-3d">MULTIPLE CASH PAYMENT</span>`;
        if (upperType === 'MULTI_ONLINE') return `<span class="text-3d">MULTIPLE ONLINE PAYMENT</span>`;
        if (upperType === 'CREDIT') return `<span class="text-3d">CREDIT NOTE</span>`;
        return `<span class="text-3d">${upperType}</span>`;
    }

    /* DOM references */
    const f_invoiceForm = document.getElementById('f-invoiceForm');
    const f_invoiceInput = document.getElementById('f-invoiceNo');
    const f_invoiceExistMsg = document.getElementById('f-invoiceExistMsg');
    const f_reportTableBody = document.querySelector('#f-reportTable tbody');
    const f_paymentForm = document.getElementById('f-paymentForm');
    const f_paymentTypeSelect = document.getElementById('f-paymentType');
    const f_checkDetailsDiv = document.getElementById('f-checkDetails');
    const f_creditDetailsDiv = document.getElementById('f-creditDetails');
    const f_batanDetailsDiv = document.getElementById('f-batanDetails');
    const f_multiCashDetailsDiv = document.getElementById('f-multiCashDetails');
    const f_multiOnlineDetailsDiv = document.getElementById('f-multiOnlineDetails');
    const f_checkNoInput = document.getElementById('f-checkNo');
    const f_creditNoteNoInput = document.getElementById('f-creditNoteNo');
    const f_batanInvoicesInput = document.getElementById('f-batanInvoices');
    const f_multiCashInvoicesInput = document.getElementById('f-multiCashInvoices');
    const f_multiOnlineInvoicesInput = document.getElementById('f-multiOnlineInvoices');
    const f_paymentAmountInput = document.getElementById('f-paymentAmount');
    const f_paymentDateInput = document.getElementById('f-paymentDate');
    const f_paymentInvoiceInput = document.getElementById('f-paymentInvoiceNo');
    const f_paymentInvoiceNoLabel = document.getElementById('f-paymentInvoiceNoLabel');
    const f_invoicePaymentInfo = document.getElementById('f-invoicePaymentInfo');
    const f_checkDuplicateMsg = document.getElementById('f-checkDuplicateMsg');
    const f_expenseForm = document.getElementById('f-expenseForm');
    const f_expenseTableBody = document.querySelector('#f-expenseTable tbody');
    const f_incomeForm = document.getElementById('f-incomeForm');
    const f_incomeTableBody = document.querySelector('#f-incomeTable tbody');
    const f_returnForm = document.getElementById('f-returnForm');
    const f_returnTableBody = document.querySelector('#f-returnTable tbody');
    const f_defectiveCheckForm = document.getElementById('f-defectiveCheckForm');
    const f_defectiveCheckTableBody = document.querySelector('#f-defectiveCheckTableBody');
    const f_expenseSearchBox = document.getElementById('f-expenseSearchBox');
    
    if (f_invoiceInput)
      f_invoiceInput.addEventListener('input', () => {
        const isEditing = document.getElementById('f-editingInvoice').value;
        if (f_invoiceExistMsg) {
            const exists = f_invoices.some(i => i.invoiceNo === f_invoiceInput.value && i.invoiceNo !== isEditing);
            f_invoiceExistMsg.textContent = exists ? `‚ö†Ô∏è INVOICE NO ${f_invoiceInput.value} ALREADY EXISTS!` : '';
            f_invoiceExistMsg.style.color = 'var(--danger-color)';
        }
    });

    const f_invoiceSubmitBtn = document.getElementById('f-invoiceSubmitBtn');
    if (f_invoiceForm)
      f_invoiceForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const invoiceNo = f_invoiceInput.value.trim();
        const companyName = document.getElementById('f-companyName').value.trim();
        const amount = parseFloat(document.getElementById('f-invoiceAmount').value);
        const date = document.getElementById('f-invoiceDate').value;
        const editing = document.getElementById('f-editingInvoice').value || '';
        if (!invoiceNo || !companyName || isNaN(amount) || !date) return;

        if (editing) {
          const idx = f_invoices.findIndex((i) => i.invoiceNo === editing);
          if (idx >= 0) {
            if (editing !== invoiceNo && f_invoices.some((i) => i.invoiceNo === invoiceNo)) {
              alert('ANOTHER INVOICE WITH THAT NUMBER EXISTS.'); return;
            }
            const prevNo = f_invoices[idx].invoiceNo;
            f_invoices[idx] = { ...f_invoices[idx], invoiceNo, supplier: companyName, amount, date };
            if (prevNo !== invoiceNo) {
              f_payments.forEach((p) => { if (p.invoiceNo === prevNo) p.invoiceNo = invoiceNo; });
            }
          }
        } else {
          if (f_invoices.some((i) => i.invoiceNo === invoiceNo)) { alert('INVOICE ALREADY EXISTS.'); return; }
          f_invoices.push({ id: uid(), invoiceNo, supplier: companyName, amount, date });
        }

        ensureParty(companyName);
        f_invoiceForm.reset();
        document.getElementById('f-editingInvoice').value = '';
        f_invoiceSubmitBtn.querySelector('.btn-text').textContent = 'Save Invoice';
        if (f_invoiceExistMsg) f_invoiceExistMsg.textContent = '';
        precomputePaymentStatus();
        applyFiltersAndRender('invoices');
        updateDashboard();
        persistAll();
        playBeep();
        speak('Invoice added successfully.');
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Invoice Added', { body: `Invoice ${invoiceNo} for ${companyName} added.`, icon: '/favicon.ico' });
        }
        // Add notification for invoice added
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Invoice Added', { body: `Invoice ${invoiceNo} for ${companyName} added successfully.`, icon: '/favicon.ico' });
        }
      });

    if (f_paymentTypeSelect)
      f_paymentTypeSelect.addEventListener('change', () => {
        const selectedType = f_paymentTypeSelect.value;
        if (f_checkDetailsDiv) f_checkDetailsDiv.style.display = (selectedType === 'check' || selectedType === 'batan') ? 'flex' : 'none';
        if (f_creditDetailsDiv) f_creditDetailsDiv.style.display = selectedType === 'credit' ? 'flex' : 'none';
        if (f_batanDetailsDiv) f_batanDetailsDiv.style.display = selectedType === 'batan' ? 'flex' : 'none';
        if (f_multiCashDetailsDiv) f_multiCashDetailsDiv.style.display = selectedType === 'multi_cash' ? 'flex' : 'none';
        if (f_multiOnlineDetailsDiv) f_multiOnlineDetailsDiv.style.display = selectedType === 'multi_online' ? 'flex' : 'none';
        if (f_paymentInvoiceNoLabel) f_paymentInvoiceNoLabel.style.display = (selectedType === 'batan' || selectedType === 'multi_cash' || selectedType === 'multi_online') ? 'none' : 'block';
        if (f_paymentInvoiceInput) f_paymentInvoiceInput.style.display = (selectedType === 'batan' || selectedType === 'multi_cash' || selectedType === 'multi_online') ? 'none' : 'block';
        if (selectedType !== 'check' && selectedType !== 'batan') { if (f_checkNoInput) f_checkNoInput.value = ''; }
        if (selectedType !== 'credit') { if (f_creditNoteNoInput) f_creditNoteNoInput.value = ''; }
        if (selectedType !== 'batan') { if (f_batanInvoicesInput) f_batanInvoicesInput.value = ''; }
        if (selectedType !== 'multi_cash') { if (f_multiCashInvoicesInput) f_multiCashInvoicesInput.value = ''; }
        if (selectedType !== 'multi_online') { if (f_multiOnlineInvoicesInput) f_multiOnlineInvoicesInput.value = ''; }
        if (f_paymentAmountInput) f_paymentAmountInput.readOnly = (selectedType === 'batan' || selectedType === 'multi_cash' || selectedType === 'multi_online');
      });
    if (f_paymentInvoiceInput)
      f_paymentInvoiceInput.addEventListener('input', () => {
        const val = f_paymentInvoiceInput.value.trim();
        const inv = f_invoices.find((i) => i.invoiceNo === val);
        if (!val) {
          if (f_invoicePaymentInfo) f_invoicePaymentInfo.textContent = '';
          if (f_paymentAmountInput) { f_paymentAmountInput.value = ''; f_paymentAmountInput.removeAttribute('max'); }
          return;
        }
        if (!inv) {
          if (f_invoicePaymentInfo) f_invoicePaymentInfo.textContent = '‚ö†Ô∏è INVOICE NOT FOUND!';
          if (f_paymentAmountInput) { f_paymentAmountInput.value = ''; f_paymentAmountInput.removeAttribute('max'); }
          return;
        }
        const { remaining } = f_computeStatus(inv);
        if (remaining <= 0) {
          if (f_invoicePaymentInfo) f_invoicePaymentInfo.textContent = `‚úÖ INVOICE ${val} FULLY PAID`;
          if (f_paymentAmountInput) { f_paymentAmountInput.value = '0.00'; f_paymentAmountInput.setAttribute('max', '0'); }
        } else {
          if (f_invoicePaymentInfo) f_invoicePaymentInfo.textContent = `REMAINING: ${INR(remaining)}`;
          if (f_paymentAmountInput) { f_paymentAmountInput.value = remaining.toFixed(2); f_paymentAmountInput.setAttribute('max', remaining.toFixed(2)); }
        }
      });

    f_batanInvoicesInput.addEventListener('input', () => {
      const invList = f_batanInvoicesInput.value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
      let totalRemaining = 0;
      let invalid = [];
      for (const invNo of invList) {
        const inv = f_invoices.find(i => i.invoiceNo === invNo);
        if (!inv) {
          invalid.push(invNo);
          continue;
        }
        const { remaining } = f_computeStatus(inv);
        totalRemaining += remaining;
      }
      if (invalid.length) {
        f_checkDuplicateMsg.textContent = `‚ö†Ô∏è INVALID INVOICES: ${invalid.join(', ')}`;
        f_paymentAmountInput.value = '';
      } else {
        f_checkDuplicateMsg.textContent = '';
        f_paymentAmountInput.value = totalRemaining.toFixed(2);
      }
    });

    f_multiCashInvoicesInput.addEventListener('input', () => {
      const invList = f_multiCashInvoicesInput.value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
      let totalRemaining = 0;
      let invalid = [];
      for (const invNo of invList) {
        const inv = f_invoices.find(i => i.invoiceNo === invNo);
        if (!inv) {
          invalid.push(invNo);
          continue;
        }
        const { remaining } = f_computeStatus(inv);
        totalRemaining += remaining;
      }
      if (invalid.length) {
        f_checkDuplicateMsg.textContent = `‚ö†Ô∏è INVALID INVOICES: ${invalid.join(', ')}`;
        f_paymentAmountInput.value = '';
      } else {
        f_checkDuplicateMsg.textContent = '';
        f_paymentAmountInput.value = totalRemaining.toFixed(2);
      }
    });

    f_multiOnlineInvoicesInput.addEventListener('input', () => {
      const invList = f_multiOnlineInvoicesInput.value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
      let totalRemaining = 0;
      let invalid = [];
      for (const invNo of invList) {
        const inv = f_invoices.find(i => i.invoiceNo === invNo);
        if (!inv) {
          invalid.push(invNo);
          continue;
        }
        const { remaining } = f_computeStatus(inv);
        totalRemaining += remaining;
      }
      if (invalid.length) {
        f_checkDuplicateMsg.textContent = `‚ö†Ô∏è INVALID INVOICES: ${invalid.join(', ')}`;
        f_paymentAmountInput.value = '';
      } else {
        f_checkDuplicateMsg.textContent = '';
        f_paymentAmountInput.value = totalRemaining.toFixed(2);
      }
    });

    if (f_paymentForm)
      f_paymentForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const type = f_paymentTypeSelect.value;
        let amount = parseFloat(f_paymentAmountInput.value);
        const date = f_paymentDateInput.value;
        const checkNo = (type === 'check' || type === 'batan') ? f_checkNoInput.value.trim() : null;
        const creditNoteNo = type === 'credit' ? f_creditNoteNoInput.value.trim() : null;

        if (isNaN(amount) || amount <= 0) { if (f_checkDuplicateMsg) f_checkDuplicateMsg.textContent = '‚ö†Ô∏è ENTER VALID AMOUNT'; return; }

        if (type === 'batan') {
          const invList = f_batanInvoicesInput.value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
          if (!invList.length) { if (f_checkDuplicateMsg) f_checkDuplicateMsg.textContent = '‚ö†Ô∏è ENTER INVOICE NOS'; return; }
          if (!checkNo) { if (f_checkDuplicateMsg) f_checkDuplicateMsg.textContent = '‚ö†Ô∏è ENTER CHECK NO'; return; }
          const invoices = [];
          for (const invNo of invList) {
            const inv = f_invoices.find(i => i.invoiceNo === invNo);
            if (!inv) { if (f_checkDuplicateMsg) f_checkDuplicateMsg.textContent = `‚ö†Ô∏è INVOICE ${invNo} NOT FOUND`; return; }
            invoices.push(inv);
          }
          const num = invoices.length;
          let eachAmount = Math.round((amount / num) * 100) / 100; // round to 2 decimals
          let totalAssigned = eachAmount * num;
          if (totalAssigned !== amount) {
            // distribute remainder
            const remainder = Math.round((amount - totalAssigned) * 100) / 100;
            if (remainder > 0) {
              eachAmount += remainder / num;
              eachAmount = Math.round(eachAmount * 100) / 100;
            }
          }
          for (let i = 0; i < num; i++) {
            const amt = i === num - 1 ? amount - (eachAmount * (num - 1)) : eachAmount;
            const inv = invoices[i];
            const { remaining } = f_computeStatus(inv);
            if (amt > remaining) { if (f_checkDuplicateMsg) f_checkDuplicateMsg.textContent = `‚ö†Ô∏è AMOUNT FOR ${inv.invoiceNo} EXCEEDS REMAINING ${INR(remaining)}`; return; }
            f_payments.push({ id: uid(), type, invoiceNo: inv.invoiceNo, amount: amt, date, checkNo, visible: true });
          }
        } else if (type === 'multi_cash') {
          const invList = f_multiCashInvoicesInput.value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
          if (!invList.length) { if (f_checkDuplicateMsg) f_checkDuplicateMsg.textContent = '‚ö†Ô∏è ENTER INVOICE NOS'; return; }
          const invoices = [];
          for (const invNo of invList) {
            const inv = f_invoices.find(i => i.invoiceNo === invNo);
            if (!inv) { if (f_checkDuplicateMsg) f_checkDuplicateMsg.textContent = `‚ö†Ô∏è INVOICE ${invNo} NOT FOUND`; return; }
            invoices.push(inv);
          }
          const num = invoices.length;
          let eachAmount = Math.round((amount / num) * 100) / 100;
          let totalAssigned = eachAmount * num;
          if (totalAssigned !== amount) {
            const remainder = Math.round((amount - totalAssigned) * 100) / 100;
            if (remainder > 0) {
              eachAmount += remainder / num;
              eachAmount = Math.round(eachAmount * 100) / 100;
            }
          }
          for (let i = 0; i < num; i++) {
            const amt = i === num - 1 ? amount - (eachAmount * (num - 1)) : eachAmount;
            const inv = invoices[i];
            const { remaining } = f_computeStatus(inv);
            if (amt > remaining) { if (f_checkDuplicateMsg) f_checkDuplicateMsg.textContent = `‚ö†Ô∏è AMOUNT FOR ${inv.invoiceNo} EXCEEDS REMAINING ${INR(remaining)}`; return; }
            f_payments.push({ id: uid(), type, invoiceNo: inv.invoiceNo, amount: amt, date, visible: true });
          }
        } else if (type === 'multi_online') {
          const invList = f_multiOnlineInvoicesInput.value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
          if (!invList.length) { if (f_checkDuplicateMsg) f_checkDuplicateMsg.textContent = '‚ö†Ô∏è ENTER INVOICE NOS'; return; }
          const invoices = [];
          for (const invNo of invList) {
            const inv = f_invoices.find(i => i.invoiceNo === invNo);
            if (!inv) { if (f_checkDuplicateMsg) f_checkDuplicateMsg.textContent = `‚ö†Ô∏è INVOICE ${invNo} NOT FOUND`; return; }
            invoices.push(inv);
          }
          const num = invoices.length;
          let eachAmount = Math.round((amount / num) * 100) / 100;
          let totalAssigned = eachAmount * num;
          if (totalAssigned !== amount) {
            const remainder = Math.round((amount - totalAssigned) * 100) / 100;
            if (remainder > 0) {
              eachAmount += remainder / num;
              eachAmount = Math.round(eachAmount * 100) / 100;
            }
          }
          for (let i = 0; i < num; i++) {
            const amt = i === num - 1 ? amount - (eachAmount * (num - 1)) : eachAmount;
            const inv = invoices[i];
            const { remaining } = f_computeStatus(inv);
            if (amt > remaining) { if (f_checkDuplicateMsg) f_checkDuplicateMsg.textContent = `‚ö†Ô∏è AMOUNT FOR ${inv.invoiceNo} EXCEEDS REMAINING ${INR(remaining)}`; return; }
            f_payments.push({ id: uid(), type, invoiceNo: inv.invoiceNo, amount: amt, date, visible: true });
          }
        } else {
          const invoiceNo = f_paymentInvoiceInput.value.trim();
          if (!invoiceNo) { if (f_invoicePaymentInfo) f_invoicePaymentInfo.textContent = '‚ö†Ô∏è ENTER INVOICE NO!'; return; }
          const invoice = f_invoices.find((i) => i.invoiceNo === invoiceNo);
          if (!invoice) { if (f_invoicePaymentInfo) f_invoicePaymentInfo.textContent = '‚ö†Ô∏è INVOICE NOT FOUND!'; return; }
          if (type === 'check' || type === 'batan') {
            if (!checkNo) { if (f_checkDuplicateMsg) f_checkDuplicateMsg.textContent = '‚ö†Ô∏è ENTER CHECK NO'; return; }
            if (f_payments.some((p) => p.type === type && p.checkNo === checkNo && p.invoiceNo !== invoiceNo)) { if (f_checkDuplicateMsg) f_checkDuplicateMsg.textContent = `‚ö†Ô∏è CHECK NO ${checkNo} ALREADY USED FOR ANOTHER INVOICE`; return; }
          }
          if (type === 'credit') {
            if (!creditNoteNo) { if (f_checkDuplicateMsg) f_checkDuplicateMsg.textContent = '‚ö†Ô∏è ENTER CREDIT NOTE NO'; return; }
          }
          precomputePaymentStatus();
          const { remaining } = f_computeStatus(invoice);
          if (amount > remaining + 0.001) { if (f_checkDuplicateMsg) f_checkDuplicateMsg.textContent = `‚ö†Ô∏è AMOUNT EXCEEDS REMAINING ${INR(remaining)}`; return; }
          f_payments.push({ id: uid(), type, invoiceNo, amount, date, checkNo, creditNoteNo, visible: true });
        }
        f_paymentForm.reset();
        f_paymentTypeSelect.value = 'check';
        if (f_checkDetailsDiv) f_checkDetailsDiv.style.display = 'flex';
        if (f_creditDetailsDiv) f_creditDetailsDiv.style.display = 'none';
        if (f_batanDetailsDiv) f_batanDetailsDiv.style.display = 'none';
        if (f_multiCashDetailsDiv) f_multiCashDetailsDiv.style.display = 'none';
        if (f_multiOnlineDetailsDiv) f_multiOnlineDetailsDiv.style.display = 'none';
        if (f_paymentInvoiceNoLabel) f_paymentInvoiceNoLabel.style.display = 'block';
        if (f_paymentInvoiceInput) f_paymentInvoiceInput.style.display = 'block';
        if (f_checkDuplicateMsg) f_checkDuplicateMsg.textContent = '';
        if (f_invoicePaymentInfo) f_invoicePaymentInfo.textContent = '';
        if (f_paymentAmountInput) f_paymentAmountInput.removeAttribute('max');
        precomputePaymentStatus();
        applyFiltersAndRender('invoices');
        updateDashboard();
        persistAll();
        updateEditPaymentSelect();
        playBeep();
        speak('Payment added successfully.');
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Payment Added', { body: `Payment of ${INR(amount)} added for invoice ${invoiceNo}.`, icon: '/favicon.ico' });
        }
        // Add notification for payment added
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Payment Added', { body: `Payment of ${INR(amount)} added for invoice ${invoiceNo}.`, icon: '/favicon.ico' });
        }
      });

    // Edit Payment Section Added Here
    const f_editPaymentSelect = document.getElementById('f-editPaymentSelect');
    const f_editPaymentForm = document.getElementById('f-editPaymentForm');
    const f_editPaymentDetails = document.getElementById('f-editPaymentDetails');
    const f_editPaymentType = document.getElementById('f-editPaymentType');
    const f_editCheckDetails = document.getElementById('f-editCheckDetails');
    const f_editCreditDetails = document.getElementById('f-editCreditDetails');
    const f_editBatanDetails = document.getElementById('f-editBatanDetails');
    const f_editMultiCashDetails = document.getElementById('f-editMultiCashDetails');
    const f_editMultiOnlineDetails = document.getElementById('f-editMultiOnlineDetails');
    const f_editCheckNo = document.getElementById('f-editCheckNo');
    const f_editCreditNoteNo = document.getElementById('f-editCreditNoteNo');
    const f_editBatanInvoices = document.getElementById('f-editBatanInvoices');
    const f_editMultiCashInvoices = document.getElementById('f-editMultiCashInvoices');
    const f_editMultiOnlineInvoices = document.getElementById('f-editMultiOnlineInvoices');
    const f_editPaymentAmount = document.getElementById('f-editPaymentAmount');
    const f_editPaymentDate = document.getElementById('f-editPaymentDate');
    const f_editPaymentInvoiceNo = document.getElementById('f-editPaymentInvoiceNo');
    const f_editingPaymentId = document.getElementById('f-editingPaymentId');
    const f_editPaymentSearch = document.getElementById('f-editPaymentSearch');

    function populateEditPaymentSelect(filter = '') {
        const query = toUpper(filter);
        f_editPaymentSelect.innerHTML = '<option value="">Select a payment</option>';
        f_payments.slice().sort((a, b) => getDateFromStr(b.date) - getDateFromStr(a.date)).forEach((p, index) => {
            const invoice = f_invoices.find(i => i.invoiceNo === p.invoiceNo);
            const company = invoice ? toUpper(invoice.supplier) : 'N/A';
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = `${index + 1}. ${p.invoiceNo}: ${company} - ${toUpper(p.type)} - ${INR(p.amount)} (${p.date})`;
            if (!query || toUpper(p.invoiceNo).includes(query) || toUpper(company).includes(query)) {
                f_editPaymentSelect.appendChild(option);
            }
        });
    }

    f_editPaymentSelect.addEventListener('change', () => {
        const selectedId = f_editPaymentSelect.value;
        if (!selectedId) {
            f_editPaymentDetails.style.display = 'none';
            return;
        }
        const payment = f_payments.find(p => p.id === selectedId);
        if (!payment) return;
        f_editPaymentType.value = payment.type;
        if (payment.checkNo) f_editCheckNo.value = payment.checkNo;
        if (payment.creditNoteNo) f_editCreditNoteNo.value = payment.creditNoteNo;
        f_editPaymentAmount.value = payment.amount;
        f_editPaymentDate.value = payment.date;
        f_editPaymentInvoiceNo.value = payment.invoiceNo;
        f_editingPaymentId.value = payment.id;
        f_editPaymentDetails.style.display = 'block';
        // Trigger change to show/hide fields
        f_editPaymentType.dispatchEvent(new Event('change'));
        // Set company display
        const invoice = f_invoices.find(i => i.invoiceNo === payment.invoiceNo);
        const company = invoice ? toUpper(invoice.supplier) : 'N/A';
        const companyInput = document.getElementById('f-editPaymentCompany');
        companyInput.value = company;
        // Auto-resize based on company name length
        companyInput.style.width = (company.length * 10) + 'px'; // Adjust multiplier as needed
        // Set SL
        const index = f_payments.findIndex(p => p.id === selectedId) + 1;
        document.getElementById('f-editPaymentSL').value = index; // Added SL
    });

    f_editPaymentType.addEventListener('change', () => {
        const selectedType = f_editPaymentType.value;
        if (f_editCheckDetails) f_editCheckDetails.style.display = (selectedType === 'check' || selectedType === 'batan') ? 'flex' : 'none';
        if (f_editCreditDetails) f_editCreditDetails.style.display = selectedType === 'credit' ? 'flex' : 'none';
        if (f_editBatanDetails) f_editBatanDetails.style.display = selectedType === 'batan' ? 'flex' : 'none';
        if (f_editMultiCashDetails) f_editMultiCashDetails.style.display = selectedType === 'multi_cash' ? 'flex' : 'none';
        if (f_editMultiOnlineDetails) f_editMultiOnlineDetails.style.display = selectedType === 'multi_online' ? 'flex' : 'none';
    });

    f_editPaymentForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = f_editingPaymentId.value;
        if (!id) return;
        const paymentIndex = f_payments.findIndex(p => p.id === id);
        if (paymentIndex === -1) return;
        const updatedPayment = {
            ...f_payments[paymentIndex],
            type: f_editPaymentType.value,
            amount: parseFloat(f_editPaymentAmount.value),
            date: f_editPaymentDate.value,
            invoiceNo: f_editPaymentInvoiceNo.value.trim(),
            checkNo: f_editPaymentType.value === 'check' || f_editPaymentType.value === 'batan' ? f_editCheckNo.value.trim() : null,
            creditNoteNo: f_editPaymentType.value === 'credit' ? f_editCreditNoteNo.value.trim() : null,
        };
        f_payments[paymentIndex] = updatedPayment;
        precomputePaymentStatus();
        applyFiltersAndRender('invoices');
        updateDashboard();
        persistAll();
        updateEditPaymentSelect();
        playBeep();
        speak('Payment updated successfully.');
        showToast('Payment updated successfully');
        f_editPaymentForm.reset();
        f_editPaymentDetails.style.display = 'none';
        f_editPaymentSelect.value = '';
        populateEditPaymentSelect();
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Payment Updated', { body: `Payment updated for invoice ${updatedPayment.invoiceNo}.`, icon: '/favicon.ico' });
        }
    });

    f_editPaymentSearch.addEventListener('input', () => {
        populateEditPaymentSelect(f_editPaymentSearch.value);
    });

    populateEditPaymentSelect();

    const f_returnSubmitBtn = document.getElementById('f-returnSubmitBtn');
    if (f_returnForm)
      f_returnForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const companyName = document.getElementById('f-returnCompanyName').value.trim();
        const itemName = document.getElementById('f-returnItemName').value.trim();
        const quantity = parseInt(document.getElementById('f-returnQuantity').value, 10);
        const mrp = parseFloat(document.getElementById('f-returnMrp').value);
        const creditNoteNo = document.getElementById('f-returnCreditNoteNo').value.trim();
        const returnDate = document.getElementById('f-returnDate').value;
        const editingId = document.getElementById('f-editingReturnId').value;
        if (!companyName || !itemName || isNaN(quantity) || quantity <= 0 || isNaN(mrp) || mrp < 0 || !returnDate) return;

        ensureParty(companyName);

        if (editingId) {
            const idx = f_returns.findIndex(r => r.id === editingId);
            if (idx > -1) { f_returns[idx] = { ...f_returns[idx], companyName, itemName, quantity, mrp, creditNoteNo, returnDate }; }
        } else {
            f_returns.push({ id: uid(), companyName, itemName, quantity, mrp, creditNoteNo, returnDate });
        }
        f_returnForm.reset();
        document.getElementById('f-editingReturnId').value = '';
        f_returnSubmitBtn.querySelector('.btn-text').textContent = 'Save Return';
        applyFiltersAndRender('returns');
        updateDashboard();
        persistAll();
        playBeep();
        speak('Return item added successfully.');
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Return Item Added', { body: `${quantity} x ${itemName} returned by ${companyName}.`, icon: '/favicon.ico' });
        }
        // Add notification for return added
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Return Item Added', { body: `${quantity} x ${itemName} returned by ${companyName}.`, icon: '/favicon.ico' });
        }
      });

    function f_renderReturnReport(data, page = 1, rowsPerPage = 10) { // Smoothed: increased rows per page
        if (!f_returnTableBody) return;
        const paginatedData = data.slice((page - 1) * rowsPerPage, page * rowsPerPage);
        if (paginatedData.length === 0) {
            f_returnTableBody.innerHTML = `<tr class="no-results-row"><td colspan="10">NO MATCHING RECORDS FOUND.</td></tr>`;
            return;
        }
        f_returnTableBody.innerHTML = '';
        
        paginatedData.forEach((item, index) => {
            const daysAgo = calculateDaysDifference(item.returnDate);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="text-3d">${((page - 1) * rowsPerPage) + index + 1}</span></td>
                <td><span class="company-text">${toUpper(item.companyName)}</span></td>
                <td><span class="text-3d">${toUpper(item.itemName)}</span></td>
                <td><span class="text-3d">${item.quantity}</span></td>
                <td><span class="currency">${INR(item.mrp)}</span></td>
                <td><span class="currency">${INR(item.quantity * item.mrp)}</span></td>
                <td><span class="${item.creditNoteNo ? 'text-3d-blue' : 'text-3d-red'}">${item.creditNoteNo ? toUpper(item.creditNoteNo) : 'PENDING'}</span></td>
                <td>${f_formatDate(item.returnDate)}</td>
                <td><span class="${item.creditNoteNo ? 'text-3d-blue' : 'days-ago-text'}">${item.creditNoteNo ? 'RECEIVED' : `${daysAgo} DAYS AGO`}</span></td>
                <td class="no-print"><div class="action-group">
                    <button class="action-btn view f-viewReturnBtn" data-id="${item.id}" title="View Return Item">View</button>
                    <button class="action-btn edit f-editReturnBtn" data-id="${item.id}" title="Edit Return Item">Edit</button>
                    <button class="action-btn delete f-deleteReturnBtn" data-id="${item.id}" title="Delete Return Item">Delete</button>
                </div></td>
            `;
            f_returnTableBody.appendChild(tr);
        });
        // Calculate totals for returns
        const totalReturnAmount = data.reduce((s, item) => s + (item.mrp * item.quantity), 0);
        document.getElementById('f-totalReturnAmount').textContent = INR(totalReturnAmount);
    }

    const f_defectiveCheckSubmitBtn = document.getElementById('f-defectiveCheckSubmitBtn');
    if (f_defectiveCheckForm)
      f_defectiveCheckForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const checkNo = document.getElementById('f-defectiveCheckNo').value.trim();
        const date = document.getElementById('f-defectiveCheckDate').value;
        const editingId = document.getElementById('f-editingDefectiveCheckId').value;
        if (!checkNo || !date) return;
        if (editingId) {
            const idx = f_defectiveChecks.findIndex(c => c.id === editingId);
            if (idx > -1) f_defectiveChecks[idx] = { ...f_defectiveChecks[idx], checkNo, date };
        } else {
            f_defectiveChecks.push({ id: uid(), checkNo, date });
        }
        f_defectiveCheckForm.reset();
        document.getElementById('f-editingDefectiveCheckId').value = '';
        f_defectiveCheckSubmitBtn.querySelector('.btn-text').textContent = 'Log Check';
        applyFiltersAndRender('defectiveChecks');
        persistAll();
        playBeep();
        speak('Defective check logged successfully.');
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Defective Check Logged', { body: `Check ${checkNo} logged as defective.`, icon: '/favicon.ico' });
        }
      });

    function f_renderDefectiveCheckReport(data, page = 1, rowsPerPage = 10) { // Smoothed: increased rows per page
        if (!f_defectiveCheckTableBody) return;
        const paginatedData = data.slice((page - 1) * rowsPerPage, page * rowsPerPage);
        if (paginatedData.length === 0) {
            f_defectiveCheckTableBody.innerHTML = `<tr class="no-results-row"><td colspan="4">NO MATCHING RECORDS FOUND.</td></tr>`;
            return;
        }
        f_defectiveCheckTableBody.innerHTML = '';
        
        paginatedData.forEach((item, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="text-3d">${((page - 1) * rowsPerPage) + index + 1}</span></td>
                <td><span class="text-3d">${toUpper(item.checkNo)}</span></td>
                <td>${f_formatDate(item.date)}</td>
                <td class="no-print"><div class="action-group">
                    <button class="action-btn edit f-editDefectiveCheckBtn" data-id="${item.id}" title="Edit Defective Check">Edit</button>
                    <button class="action-btn delete f-deleteDefectiveCheckBtn" data-id="${item.id}" title="Delete Defective Check">Delete</button>
                </div></td>
            `;
            f_returnTableBody.appendChild(tr);
        });
    }

    const editingExpenseIdInput = document.getElementById('f-editingExpenseId');
    const f_expenseSubmitBtn = document.getElementById('f-expenseSubmitBtn');
    if (f_expenseForm)
      f_expenseForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('f-expenseName').value.trim();
        const amount = parseFloat(document.getElementById('f-expenseAmount').value);
        const date = document.getElementById('f-expenseDate').value;
        const type = document.getElementById('f-expensePaymentType').value;
        const editingId = editingExpenseIdInput.value;
        if (!name || isNaN(amount) || amount <= 0 || !date) return;

        if (editingId) {
          const idx = f_expenses.findIndex(exp => exp.id === editingId);
          if (idx > -1) f_expenses[idx] = { ...f_expenses[idx], name, amount, date, type };
        } else {
          f_expenses.push({ id: uid(), name, amount, date, type });
        }
        f_expenseForm.reset();
        editingExpenseIdInput.value = '';
        f_expenseSubmitBtn.querySelector('.btn-text').textContent = 'Add Expense';
        applyFiltersAndRender('expenses');
        updateDashboard();
        persistAll();
        playBeep();
        speak('Expense added successfully.');
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Expense Added', { body: `Expense "${name}" of ${INR(amount)} added.`, icon: '/favicon.ico' });
        }
        // Add notification for expense added
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Expense Added', { body: `Expense "${name}" of ${INR(amount)} added.`, icon: '/favicon.ico' });
        }
      });
      
    function f_renderExpenseReport(data, page = 1, rowsPerPage = 10) { // Smoothed: increased rows per page
      if (!f_expenseTableBody) return;
      const paginatedData = data.slice((page - 1) * rowsPerPage, page * rowsPerPage);
      if (paginatedData.length === 0) {
          f_expenseTableBody.innerHTML = `<tr class="no-results-row"><td colspan="6">NO MATCHING RECORDS FOUND.</td></tr>`;
          return;
      }
      f_expenseTableBody.innerHTML = '';
      
      paginatedData.forEach((exp, i) => {
            const daysAgo = exp.type === 'pending' ? calculateDaysDifference(exp.date) : 0;
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><span class="text-3d">${((page - 1) * rowsPerPage) + i + 1}</span></td>
              <td><span class="text-3d">${toUpper(exp.name)}</span></td>
              <td><span class="currency">${INR(exp.amount)}</span></td>
              <td>${f_formatDate(exp.date)}</td>
              <td>${exp.type === 'pending' ? `<span class="text-3d-red">PENDING</span> <span class="days-text">(${daysAgo} DAYS)</span>` : `${formatPaymentType(exp.type)} <span class="text-3d-blue">(PAID)</span>`}</td>
              <td class="no-print"><div class="action-group">
                <button class="action-btn view f-viewExpenseBtn" data-id="${exp.id}" title="View Expense">View</button>
                <button class="action-btn edit f-editExpenseBtn" data-id="${exp.id}" title="Edit Expense">Edit</button>
                <button class="action-btn delete f-deleteExpenseBtn" data-id="${exp.id}" title="Delete Expense">Delete</button>
              </div></td>`;
            f_expenseTableBody.appendChild(tr);
        });
        // Calculate totals for expenses
        const totalExpenseAmount = data.reduce((s, exp) => s + exp.amount, 0);
        document.getElementById('f-totalExpenseAmount').textContent = INR(totalExpenseAmount);
    }

    const editingIncomeIdInput = document.getElementById('f-editingIncomeId');
    const f_incomeSubmitBtn = document.getElementById('f-incomeSubmitBtn');
    if (f_incomeForm)
      f_incomeForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const amount = parseFloat(document.getElementById('f-incomeAmount').value);
        const date = document.getElementById('f-incomeDate').value;
        const type = document.getElementById('f-incomePaymentType').value;
        const editingId = editingIncomeIdInput.value;
        if (isNaN(amount) || amount <= 0 || !date) return;
        
        if (editingId) {
          const idx = f_incomes.findIndex(inc => inc.id === editingId);
          if (idx > -1) f_incomes[idx] = { ...f_incomes[idx], amount, date, type };
        } else {
          f_incomes.push({ id: uid(), amount, date, type });
        }
        f_incomeForm.reset();
        editingIncomeIdInput.value = '';
        f_incomeSubmitBtn.querySelector('.btn-text').textContent = 'Add Income';
        applyFiltersAndRender('income');
        updateDashboard();
        persistAll();
        playBeep();
        speak('Income added successfully.');
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Income Added', { body: `Income of ${INR(amount)} added.`, icon: '/favicon.ico' });
        }
        // Add notification for income added
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Income Added', { body: `Income of ${INR(amount)} added.`, icon: '/favicon.ico' });
        }
      });

    function f_renderIncomeReport(data, page = 1, rowsPerPage = 10) { // Smoothed: increased rows per page
      if (!f_incomeTableBody) return;
      const paginatedData = data.slice((page - 1) * rowsPerPage, page * rowsPerPage);
      if (paginatedData.length === 0) {
          f_incomeTableBody.innerHTML = `<tr class="no-results-row"><td colspan="5">NO MATCHING RECORDS FOUND.</td></tr>`;
        }
        f_incomeTableBody.innerHTML = '';
        
        paginatedData.forEach((inc, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><span class="text-3d">${((page - 1) * rowsPerPage) + i + 1}</span></td>
              <td><span class="currency">${INR(inc.amount)}</span></td>
              <td>${f_formatDate(inc.date)}</td>
              <td>${formatPaymentType(inc.type)}</td>
              <td class="no-print"><div class="action-group">
                <button class="action-btn view f-viewIncomeBtn" data-id="${inc.id}" title="View Income">View</button>
                <button class="action-btn edit f-editIncomeBtn" data-id="${inc.id}" title="Edit Income">Edit</button>
                <button class="action-btn delete f-deleteIncomeBtn" data-id="${inc.id}" title="Delete Income">Delete</button>
              </div></td>`;
            f_incomeTableBody.appendChild(tr);
        });
        // Calculate totals for income
        const totalIncomeAmount = data.reduce((s, inc) => s + inc.amount, 0);
        document.getElementById('f-totalIncomeAmount').textContent = INR(totalIncomeAmount);
    }
    
    function highlightCard(cardId) {
        const card = document.getElementById(cardId);
        if (!card) return;
        
        document.querySelectorAll('.card.editing-highlight').forEach(c => c.classList.remove('editing-highlight'));
        
        card.classList.add('editing-highlight');
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => card.classList.remove('editing-highlight'), 2500);
    }
    
    function makeInvoiceLink(invNo) {
        if (!invNo || invNo === '-') return `<span class="invoice-text">${invNo}</span>`;
        return `<a href="#" class="lookup-link" data-lookup-type="invoice" data-lookup-value="${invNo}"><span class="invoice-text">${toUpper(invNo)}</span></a>`;
    }

    document.addEventListener('click', e => {
      const t = e.target;
      
      if (t.closest('.lookup-link') && t.closest('.lookup-link').dataset.lookupType === 'invoice') {
        e.preventDefault();
        const invoiceNo = t.closest('.lookup-link').dataset.lookupValue;
        if (invoiceNo) showInvoiceDetails(invoiceNo);
      }

      if (t.matches('.f-viewBtn')) showInvoiceDetails(t.dataset.invoice);
      
      if (t.matches('.f-editBtn')) {
        const inv = f_invoices.find((i) => i.invoiceNo === t.dataset.invoice);
        if (!inv) return alert('Invoice not found');
        document.getElementById('f-invoiceNo').value = inv.invoiceNo;
        document.getElementById('f-companyName').value = inv.supplier;
        document.getElementById('f-invoiceAmount').value = inv.amount;
        document.getElementById('f-invoiceDate').value = inv.date;
        document.getElementById('f-editingInvoice').value = inv.invoiceNo;
        f_invoiceSubmitBtn.querySelector('.btn-text').textContent = 'Update Invoice';
        highlightCard('f-invoiceCard');
      }
      if (t.matches('.f-deleteBtn')) {
        const invNo = t.dataset.invoice;
        if (!confirm(`Delete invoice #${toUpper(invNo)} and all its associated payments?`)) return;
        f_invoices = f_invoices.filter((i) => i.invoiceNo !== invNo);
        f_payments = f_payments.filter((p) => p.invoiceNo !== invNo);
        precomputePaymentStatus();
        applyFiltersAndRender('invoices');
        updateDashboard();
        persistAll();
        playBeep();
        speak('Invoice deleted successfully.');
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Invoice Deleted', { body: `Invoice ${invNo} and associated payments deleted.`, icon: '/favicon.ico' });
        }
      }

      if (t.matches('.f-viewReturnBtn')) {
        const item = f_returns.find(r => r.id === t.dataset.id);
        if (item) {
            const total = item.quantity * item.mrp;
            const status = item.creditNoteNo ? `<span class="text-3d-blue">RECEIVED</span>` : calculateDaysDifference(item.returnDate) + ' DAYS AGO';
            const content = `<p><strong>COMPANY:</strong> <span class="company-text">${toUpper(item.companyName)}</span><br>
                               <strong>ITEM NAME:</strong> <span class="text-3d">${toUpper(item.itemName)}</span><br>
                               <strong>QUANTITY:</strong> <span class="text-3d">${item.quantity}</span><br>
                               <strong>MRP:</strong> <span class="currency">${INR(item.mrp)}</span><br>
                               <strong>TOTAL:</strong> <span class="currency">${INR(total)}</span><br>
                               <strong>CREDIT NOTE NO:</strong> <span class="${item.creditNoteNo ? 'text-3d-blue' : 'text-3d-red'}">${item.creditNoteNo ? toUpper(item.creditNoteNo) : 'PENDING'}</span><br>
                               <strong>DATE:</strong> ${f_formatDate(item.returnDate)}<br>
                               <strong>STATUS:</strong> <span class="${item.creditNoteNo ? 'text-3d-blue' : 'days-ago-text'}">${status}</span></p>`;
            showDetailModal('Return Item Details', content);
        }
      }
      if (t.matches('.f-editReturnBtn')) {
        const item = f_returns.find(r => r.id === t.dataset.id);
        if (!item) return;
        document.getElementById('f-returnCompanyName').value = item.companyName;
        document.getElementById('f-returnItemName').value = item.itemName;
        document.getElementById('f-returnQuantity').value = item.quantity;
        document.getElementById('f-returnMrp').value = item.mrp;
        document.getElementById('f-returnCreditNoteNo').value = item.creditNoteNo || '';
        document.getElementById('f-returnDate').value = item.returnDate;
        document.getElementById('f-editingReturnId').value = item.id;
        f_returnSubmitBtn.querySelector('.btn-text').textContent = 'Update Return';
        highlightCard('f-returnCard');
      }
      if (t.matches('.f-deleteReturnBtn')) {
        const item = f_returns.find(r => r.id === t.dataset.id);
        if (!confirm(`Delete return item "${toUpper(item?.itemName) || 'this item'}"?`)) return;
        f_returns = f_returns.filter(r => r.id !== t.dataset.id);
        applyFiltersAndRender('returns');
        updateDashboard();
        persistAll();
        playBeep();
        speak('Return item deleted successfully.');
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Return Item Deleted', { body: `Return item "${toUpper(item?.itemName)}" deleted.`, icon: '/favicon.ico' });
        }
      }

      if (t.matches('.f-editDefectiveCheckBtn')) {
          const item = f_defectiveChecks.find(c => c.id === t.dataset.id);
          if (!item) return;
          document.getElementById('f-defectiveCheckNo').value = item.checkNo;
          document.getElementById('f-defectiveCheckDate').value = item.date;
          document.getElementById('f-editingDefectiveCheckId').value = item.id;
          f_defectiveCheckSubmitBtn.querySelector('.btn-text').textContent = 'Update Check';
          highlightCard('f-defectiveCheckCard');
      }
      if (t.matches('.f-deleteDefectiveCheckBtn')) {
          const item = f_defectiveChecks.find(c => c.id === t.dataset.id);
          if (!confirm(`Delete defective check log for #${toUpper(item?.checkNo || 'this check')}"?`)) return;
          f_defectiveChecks = f_defectiveChecks.filter(c => c.id !== t.dataset.id);
          applyFiltersAndRender('defectiveChecks');
          persistAll();
          playBeep();
          speak('Defective check deleted successfully.');
          if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('Defective Check Deleted', { body: `Defective check ${toUpper(item?.checkNo)} deleted.`, icon: '/favicon.ico' });
          }
      }

      if (t.matches('.f-viewExpenseBtn')) {
        const item = f_expenses.find(e => e.id === t.dataset.id);
        if (item) {
            const content = `<p><strong>EXPENSE:</strong> <span class="text-3d">${toUpper(item.name)}</span><br>
                               <strong>AMOUNT:</strong> <span class="currency">${INR(item.amount)}</span><br>
                               <strong>DATE:</strong> ${f_formatDate(item.date)}<br>
                               <strong>PAYMENT:</strong> ${formatPaymentType(item.type)}</p>`;
            showDetailModal('Expense Details', content);
        }
      }
      if (t.matches('.f-editExpenseBtn')) {
        const eItem = f_expenses.find(e => e.id === t.dataset.id);
        if (!eItem) return;
        document.getElementById('f-expenseName').value = eItem.name;
        document.getElementById('f-expenseAmount').value = eItem.amount;
        document.getElementById('f-expenseDate').value = eItem.date;
        document.getElementById('f-expensePaymentType').value = eItem.type;
        editingExpenseIdInput.value = eItem.id;
        f_expenseSubmitBtn.querySelector('.btn-text').textContent = 'Update Expense';
        highlightCard('f-expenseCard');
      }
      if (t.matches('.f-deleteExpenseBtn')) {
        const item = f_expenses.find(e => e.id === t.dataset.id);
        if (!confirm(`Delete expense "${toUpper(item?.name) || 'this expense'}"?`)) return;
        f_expenses = f_expenses.filter(e => e.id !== t.dataset.id);
        applyFiltersAndRender('expenses');
        updateDashboard();
        persistAll();
        playBeep();
        speak('Expense deleted successfully.');
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Expense Deleted', { body: `Expense "${toUpper(item?.name)}" deleted.`, icon: '/favicon.ico' });
        }
      }

      if (t.matches('.f-viewIncomeBtn')) {
        const item = f_incomes.find(i => i.id === t.dataset.id);
        if (item) {
             const content = `<p><strong>AMOUNT:</strong> <span class="currency">${INR(item.amount)}</span><br>
                               <strong>DATE:</strong> ${f_formatDate(item.date)}<br>
                               <strong>PAYMENT:</strong> ${formatPaymentType(item.type)}</p>`;
            showDetailModal('Income Details', content);
        }
      }
      if (t.matches('.f-editIncomeBtn')) {
        const it = f_incomes.find(i => i.id === t.dataset.id);
        if (!it) return;
        document.getElementById('f-incomeAmount').value = it.amount;
        document.getElementById('f-incomeDate').value = it.date;
        document.getElementById('f-incomePaymentType').value = it.type;
        editingIncomeIdInput.value = it.id;
        f_incomeSubmitBtn.querySelector('.btn-text').textContent = 'Update Income';
        highlightCard('f-incomeCard');
      }
      if (t.matches('.f-deleteIncomeBtn')) {
        const item = f_incomes.find(i => i.id === t.dataset.id);
        if (!confirm(`Delete income of ${INR(item?.amount || 0)}?`)) return;
        f_incomes = f_incomes.filter(i => i.id !== t.dataset.id);
        applyFiltersAndRender('income');
        updateDashboard();
        persistAll();
        playBeep();
        speak('Income deleted successfully.');
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Income Deleted', { body: `Income of ${INR(item?.amount)} deleted.`, icon: '/favicon.ico' });
        }
      }

      if (t.matches('.g-view')) {
            const line = g_lines.find(l => l.id === t.dataset.id);
            if (line) {
                const content = `<p><strong>AMOUNT:</strong> <span class="currency">${INR(line.amount)}</span><br>
                                   <strong>TAX RATE:</strong> ${line.taxRate}%<br>
                                   <strong>SGST:</strong> ${INR(line.sgst)}<br>
                                   <strong>CGST:</strong> ${INR(line.cgst)}<br>
                                   <strong>GRAND TOTAL:</strong> <span class="currency">${INR(line.grand)}</span><br>
                                   <strong>MODE:</strong> <span class="text-3d">${toUpper(line.mode)}</span><br>
                                   <strong>PAYMENT:</strong> ${formatPaymentType(line.payment)}</p>`;
                showDetailModal('GST Line Details', content);
            }
      }
    });

    function getStatus3dClass(status) {
        switch(status) {
            case 'paid': return 'text-3d-blue';
            case 'pending': return 'text-3d-red';
            case 'partial': return 'text-3d-purple';
            default: return 'text-3d';
        }
    }

    function f_renderReport(data, page = 1, rowsPerPage = 10) { // Smoothed: increased rows per page
      if (!f_reportTableBody) return;
      const paginatedData = data.slice((page - 1) * rowsPerPage, page * rowsPerPage);
      if (paginatedData.length === 0) {
          f_reportTableBody.innerHTML = `<tr class="no-results-row"><td colspan="10">NO MATCHING RECORDS FOUND.</td></tr>`;
          return;
      }
      f_reportTableBody.innerHTML = '';
      
      paginatedData.forEach((inv, index) => {
            const { paid, remaining, status, invoicePayments } = f_computeStatus(inv);
            const daysOverdue = (status === 'pending' || status === 'partial') ? calculateDaysDifference(inv.date) : 0;
            const paymentTypes = status === 'paid' ? [...new Set(invoicePayments.map(p => p.type))].join(', ') : (daysOverdue > 0 ? `${daysOverdue} DAYS` : '-');
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><span class="text-3d">${((page - 1) * rowsPerPage) + index + 1}</span></td>
              <td>${makeInvoiceLink(inv.invoiceNo)}</td>
              <td><span class="company-text">${toUpper(inv.supplier)}</span></td>
              <td><span class="currency">${INR(inv.amount)}</span></td>
              <td>${f_formatDate(inv.date)}</td>
              <td><span class="currency">${INR(paid)}</span></td>
              <td><span class="currency">${INR(remaining)}</span></td>
              <td><span class="${getStatus3dClass(status)}">${toUpper(status)}</span></td>
              <td><span class="${status === 'paid' ? 'text-3d-blue' : 'days-text'}">${paymentTypes}</span></td>
              <td class="no-print"><div class="action-group">
                <button class="action-btn view f-viewBtn" data-invoice="${inv.invoiceNo}" title="View Invoice">View</button>
                <button class="action-btn edit f-editBtn" data-invoice="${inv.invoiceNo}" title="Edit Invoice">Edit</button>
                <button class="action-btn delete f-deleteBtn" data-invoice="${inv.invoiceNo}" title="Delete Invoice">Delete</button>
              </div></td>`;
            f_reportTableBody.appendChild(tr);
        });
        // Calculate totals for invoices
        const totalInvoiceAmount = data.reduce((s, inv) => s + inv.amount, 0);
        const totalPaid = data.reduce((s, inv) => s + f_computeStatus(inv).paid, 0);
        const totalRemaining = data.reduce((s, inv) => s + f_computeStatus(inv).remaining, 0);
        document.getElementById('f-totalInvoiceAmount').textContent = INR(totalInvoiceAmount);
        document.getElementById('f-totalPaid').textContent = INR(totalPaid);
        document.getElementById('f-totalRemaining').textContent = INR(totalRemaining);
    }

    /* ---------------- GST logic ---------------- */
    let g_editId = null;

    const g_amountInput = document.getElementById('g-amount');
    const g_taxRate = document.getElementById('g-taxRate');
    const g_mode = document.getElementById('g-mode');
    const g_paymentMode = document.getElementById('g-paymentMode');
    const g_addBtn = document.getElementById('g-addBtn');
    const g_billingBody = document.querySelector('#g-billingTable tbody');
    
    function g_round2(x) {
      return +(Math.round((x + Number.EPSILON) * 100) / 100);
    }

    function g_addItem() {
      const entered = parseFloat(g_amountInput.value);
      const taxRate = parseInt(g_taxRate.value, 10);
      const mode = g_mode.value;
      const paymentMode = g_paymentMode.value;
      if (isNaN(entered) || !taxRate) { alert('Please enter valid amount and select a tax rate.'); return; }

      let amount = 0, sgst = 0, cgst = 0, grand = 0;
      if (mode === 'without') {
        amount = g_round2(entered);
        const taxSplit = (amount * taxRate) / 200;
        sgst = g_round2(taxSplit);
        cgst = g_round2(taxSplit);
        grand = g_round2(amount + sgst + cgst);
      } else {
        grand = g_round2(entered);
        const basic = (grand * 100) / (100 + taxRate);
        amount = g_round2(basic);
        const totalTax = g_round2(grand - amount);
        const half = g_round2(totalTax / 2);
        sgst = half;
        cgst = g_round2(totalTax - half);
      }
      if (g_editId) {
          const idx = g_lines.findIndex(l => l.id === g_editId);
          if (idx > -1) { g_lines[idx] = { ...g_lines[idx], amount, sgst, cgst, grand, taxRate, payment: paymentMode, mode, date: g_lines[idx].date }; }
          g_editId = null;
          g_addBtn.querySelector('.btn-text').textContent = 'Add';
      } else {
          g_lines.push({ id: uid(), date: new Date().toISOString().slice(0,10), amount, sgst, cgst, grand, taxRate, payment: paymentMode, mode });
      }

      g_amountInput.value = '';
      applyFiltersAndRender('gst');
      updateDashboard();
      persistAll();
      playBeep();
      speak('GST line added successfully.');
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('GST Line Added', { body: `GST line of ${INR(grand)} added.`, icon: '/favicon.ico' });
      }
      // Add notification for GST added
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('GST Line Added', { body: `GST line of ${INR(grand)} added.`, icon: '/favicon.ico' });
      }
    }
    if (g_addBtn) g_addBtn.addEventListener('click', g_addItem);

    g_billingBody.addEventListener('click', (e) => {
        const target = e.target;
        const id = target.closest('button')?.dataset.id;
        if (!id) return;

        if (target.matches('.g-edit')) {
            const line = g_lines.find(l => l.id === id);
            if (line) {
                g_editId = id;
                g_mode.value = line.mode;
                g_amountInput.value = (line.mode === 'with' ? line.grand : line.amount).toFixed(2);
                g_taxRate.value = line.taxRate;
                g_paymentMode.value = line.payment;
                g_addBtn.querySelector('.btn-text').textContent = 'Update';
                highlightCard('g-gstCard');
            }
        }
        if (target.matches('.g-delete')) {
            if (confirm('Delete this GST billing line?')) {
                g_lines = g_lines.filter(l => l.id !== id);
                applyFiltersAndRender('gst');
                updateDashboard();
                persistAll();
                playBeep();
                speak('GST line deleted successfully.');
                if ('Notification' in window && Notification.permission === 'granted') {
                  new Notification('GST Line Deleted', { body: `GST line deleted.`, icon: '/favicon.ico' });
                }
            }
        }
    });

    function f_renderGstReport(data, page = 1, rowsPerPage = 10) { // Smoothed: increased rows per page
        if (!g_billingBody) return;
        const paginatedData = data.slice((page - 1) * rowsPerPage, page * rowsPerPage);
        if (paginatedData.length === 0) {
            g_billingBody.innerHTML = `<tr class="no-results-row"><td colspan="9">NO MATCHING RECORDS FOUND.</td></tr>`;
            g_updateTotals([]);
            return;
        }
        g_billingBody.innerHTML = '';
        
        paginatedData.forEach((d, i) => {
            const row = g_billingBody.insertRow();
            row.innerHTML = `
                <td><span class="text-3d">${((page - 1) * rowsPerPage) + i + 1}</span></td>
                <td>${f_formatDate(d.date)}</td>
                <td><span class="currency">${INR(+d.amount)}</span></td>
                <td><span class="text-3d">${d.taxRate}%</span></td>
                <td><span class="currency">${INR(+d.sgst)}</span></td>
                <td><span class="currency">${INR(+d.cgst)}</span></td>
                <td><span class="currency">${INR(+d.grand)}</span></td>
                <td>${formatPaymentType(d.payment)}</td>
                <td class="no-print"><div class="action-group">
                    <button class="action-btn view g-view" data-id="${d.id}" title="View GST Item">View</button>
                    <button class="action-btn edit g-edit" data-id="${d.id}" title="Edit GST Item">Edit</button>
                    <button class="action-btn delete g-delete" data-id="${d.id}" title="Delete GST Item">Delete</button>
                </div></td>`;
        });
        g_updateTotals(data);
    }

    function g_updateTotals(filteredData) {
        const container = document.getElementById('g-summary-container');
        if(!container) return;
        
        let summaryHtml = '';

        // Per-rate Totals
        appSettings.taxRates.forEach(rate => {
            const rateItems = filteredData.filter(l => l.taxRate == rate);
            const amount = rateItems.reduce((s,l) => s + (+l.amount || 0), 0);
            const tax = rateItems.reduce((s,l) => s + (+l.sgst || 0) + (+l.cgst || 0), 0);
            const grand = rateItems.reduce((s,l) => s + (+l.grand || 0), 0);
            
            summaryHtml += `<div class="rate-block">
                <div class="summary-line">${rate}%:</div>
                <div>Amount: ${INR(amount)}</div>
                <div>Tax: ${INR(tax)}</div>
                <div>Grand: ${INR(grand)}</div>
            </div>`;
        });

        // Overall Totals
        const totalAmount = filteredData.reduce((sum, line) => sum + (+line.amount || 0), 0);
        const totalSgst = filteredData.reduce((sum, line) => sum + (+line.sgst || 0), 0);
        const totalCgst = filteredData.reduce((sum, line) => sum + (+line.cgst || 0), 0);
        const totalGrand = filteredData.reduce((sum, line) => sum + (+line.grand || 0), 0);
        
        summaryHtml += `<div class="rate-block">
            <div class="summary-line">
                TOTAL: ${INR(totalAmount)} | SGST: ${INR(totalSgst)} | CGST: ${INR(totalCgst)} | GRAND: ${INR(totalGrand)}
            </div>
        </div>`;
        
        // Payment Totals
        const cashTotal = filteredData.filter(l => l.payment === 'cash').reduce((s,l) => s + (+l.grand || 0), 0);
        const onlineTotal = filteredData.filter(l => l.payment === 'online').reduce((s,l) => s + (+l.grand || 0), 0);

        summaryHtml += `<div>
            <div class="summary-line">CASH TOTAL: ${INR(cashTotal)}</div>
            <div class="summary-line">ONLINE TOTAL: ${INR(onlineTotal)}</div>
        </div>`;
        
        container.innerHTML = DOMPurify.sanitize(summaryHtml);
    }
    
    /* ---------------- Dashboard & charts ---------------- */
    const salesCtx = document.getElementById('salesChart')?.getContext('2d');
    const gstCtx = document.getElementById('gstChart')?.getContext('2d');
    const incExpCtx = document.getElementById('incExpChart')?.getContext('2d');
    const cashflowCtx = document.getElementById('cashflowChart')?.getContext('2d');
    let salesChart, gstChart, incExpChart, cashflowChart;

    function updateCheckReminders(mode = 'upcoming') {
        const remindersList = document.getElementById('remindersList');
        if (!remindersList) return;
        
        remindersList.innerHTML = '';
        if (!appSettings.checkRemindersEnabled || !appSettings.showUpcomingReminders) {
            remindersList.innerHTML = `<p class="no-reminders">ALL WAYS CHECK REMINDERS ARE DISABLED IN SETTINGS.</p>`;
            return;
        }

        const reminderDays = appSettings.reminderDays || 3;
        const showAfterDue = appSettings.reminderShowAfterDue || 7;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        let startDate, endDate;

        if (mode === 'upcoming') {
            startDate = new Date(today);
            endDate = new Date(today);
            endDate.setDate(today.getDate() + reminderDays);
        } else if (mode === 'all') {
            startDate = new Date(today);
            endDate = new Date(today);
            endDate.setDate(today.getDate() + 365); // All coming in a year
        } else if (mode === 'overdue') {
            startDate = new Date(today);
            startDate.setDate(today.getDate() - showAfterDue);
            endDate = new Date(today);
        }

        const upcomingChecks = f_payments
            .filter(p => {
                const pDate = getDateFromStr(p.date);
                return p.type === 'check' && pDate && pDate >= startDate && pDate <= endDate && p.visible !== false;
            })
            .map(p => {
                const pDate = getDateFromStr(p.date);
                const daysDiff = Math.floor((pDate - today) / (1000 * 60 * 60 * 24));
                let dueLabel;
                if (daysDiff === 0) dueLabel = 'TODAY';
                else if (daysDiff === 1) dueLabel = 'TOMORROW';
                else if (daysDiff > 1) dueLabel = `IN ${daysDiff} DAYS`;
                else dueLabel = `${Math.abs(daysDiff)} DAYS AGO`;
                return { ...p, dueLabel: dueLabel };
            })
            .sort((a, b) => getDateFromStr(a.date) - getDateFromStr(b.date));
        
        if (upcomingChecks.length === 0) {
            remindersList.innerHTML = `<p class="no-reminders">NO ${mode.toUpperCase()} CHECK REMINDERS FOUND.</p>`;
            return;
        }

        let totalAmount = upcomingChecks.reduce((sum, p) => sum + p.amount, 0);
        const todayChecks = upcomingChecks.filter(p => getDateFromStr(p.date).getTime() === today.getTime());
        const totalToday = todayChecks.reduce((sum, p) => sum + p.amount, 0);

        upcomingChecks.forEach((p, index) => {
            const invoice = f_invoices.find(i => i.invoiceNo === p.invoiceNo);
            const div = document.createElement('div');
            div.className = 'reminder-item';
            div.innerHTML = `<span class="text-3d">${index + 1}</span>. CHECK <strong class="text-3d">${toUpper(p.checkNo)}</strong> FOR <span class="currency">${INR(p.amount)}</span> IS DUE <span class="date-tag">${p.dueLabel}</span> (${f_formatDate(p.date)})
                             <div class="small-muted">FOR INVOICE: ${makeInvoiceLink(p.invoiceNo)} (COMPANY: <span class="company-text">${invoice ? toUpper(invoice.supplier) : 'N/A'}</span>)</div>`;
            remindersList.appendChild(div);
        });
        // Add total amount at the end
        const totalDiv = document.createElement('div');
        totalDiv.className = 'reminder-item';
        totalDiv.innerHTML = `<strong>TOTAL ${mode.toUpperCase()} CHECK AMOUNT:</strong> <span class="currency">${INR(totalAmount)}</span>`;
        remindersList.appendChild(totalDiv);

        // Add total today amount if applicable
        if (mode === 'upcoming' && totalToday > 0) {
            const todayTotalDiv = document.createElement('div');
            todayTotalDiv.className = 'reminder-item';
            todayTotalDiv.innerHTML = `<strong>TOTAL AMOUNT TODAY:</strong> <span class="currency">${INR(totalToday)}</span>`;
            remindersList.appendChild(todayTotalDiv);
        }

        // Add browser notification for upcoming checks
        if ('Notification' in window && Notification.permission === 'granted') {
            upcomingChecks.forEach(p => {
                new Notification(`Check Reminder: ${toUpper(p.checkNo)}`, {
                    body: `Check for ${INR(p.amount)} is due ${p.dueLabel}`,
                    icon: '/favicon.ico'
                });
            });
        }
    }

    // Add button event listeners for filter modes
    document.getElementById('filterUpcomingReminders').addEventListener('click', () => updateCheckReminders('upcoming'));
    document.getElementById('filterComingReminders').addEventListener('click', () => updateCheckReminders('all'));
    document.getElementById('filterOverdueReminders').addEventListener('click', () => updateCheckReminders('overdue'));
    
    function updatePendingBillReminders() {
        const list = document.getElementById('pendingBillsList');
        if (!list) return;

        list.innerHTML = '';
        if (!appSettings.pendingBillRemindersEnabled) {
            list.innerHTML = `<p class="no-reminders">PENDING BILL REMINDERS ARE DISABLED IN SETTINGS.</p>`;
            return;
        }

        const pendingDays = appSettings.pendingBillReminderDays || 15;

        const pendingInvoices = f_invoices
            .filter(inv => ['pending', 'partial'].includes(f_computeStatus(inv).status))
            .map(inv => ({ ...inv, daysOverdue: calculateDaysDifference(inv.date) }))
            .filter(inv => inv.daysOverdue > pendingDays)
            .sort((a, b) => b.daysOverdue - a.daysOverdue);
        
        if (pendingInvoices.length === 0) {
            list.innerHTML = `<p class="no-reminders">NO PENDING BILLS FOUND.</p>`;
            return;
        }

        let totalAmount = pendingInvoices.reduce((sum, inv) => sum + f_computeStatus(inv).remaining, 0);

        pendingInvoices.slice(0, 5).forEach((inv, index) => {
            const { remaining } = f_computeStatus(inv);
            const div = document.createElement('div');
            div.className = 'reminder-item';
            div.innerHTML = `<span class="text-3d">${index + 1}</span>. BILL ${makeInvoiceLink(inv.invoiceNo)} IS PENDING FOR <span class="days-text">${inv.daysOverdue} DAYS</span>.
                             <div class="small-muted">COMPANY: <span class="company-text">${toUpper(inv.supplier)}</span> | REMAINING: <strong>${INR(remaining)}</strong></div>`;
            list.appendChild(div);
        });
        // Add total amount at the end
        const totalDiv = document.createElement('div');
        totalDiv.className = 'reminder-item';
        totalDiv.innerHTML = `<strong>TOTAL PENDING BILL AMOUNT:</strong> <span class="currency">${INR(totalAmount)}</span>`;
        list.appendChild(totalDiv);
        // Add browser notification for pending bills
        if ('Notification' in window && Notification.permission === 'granted') {
            pendingInvoices.forEach(inv => {
                new Notification(`Pending Bill Reminder: ${toUpper(inv.invoiceNo)}`, {
                    body: `Bill overdue by ${inv.daysOverdue} days, remaining ${INR(f_computeStatus(inv).remaining)}`,
                    icon: '/favicon.ico'
                });
            });
        }
    }

    function updateReturnReminders() {
        const list = document.getElementById('returnRemindersList');
        if (!list) return;

        list.innerHTML = '';
        if (!appSettings.returnRemindersEnabled) {
            list.innerHTML = `<p class="no-reminders">RETURN ITEMS REMINDERS ARE DISABLED IN SETTINGS.</p>`;
            return;
        }

        const reminderDays = appSettings.returnReminderDays || 7;

        const pendingReturns = f_returns
            .filter(r => !r.creditNoteNo)
            .map(r => ({ ...r, daysAgo: calculateDaysDifference(r.returnDate) }))
            .filter(r => r.daysAgo > reminderDays)
            .sort((a, b) => b.daysAgo - a.daysAgo);
        
        if (pendingReturns.length === 0) {
            list.innerHTML = `<p class="no-reminders">NO PENDING RETURN ITEMS REMINDERS.</p>`;
            return;
        }

        let totalAmount = pendingReturns.reduce((sum, r) => sum + r.quantity * r.mrp, 0);
        pendingReturns.slice(0, 5).forEach((r, index) => {
            const div = document.createElement('div');
            div.className = 'reminder-item';
            div.innerHTML = `<span class="text-3d">${index + 1}</span>. RETURN <strong class="text-3d">${r.quantity} X ${toUpper(r.itemName)}</strong> FOR <strong>${INR(r.quantity * r.mrp)}</strong> IS PENDING CREDIT NOTE FOR <span class="date-tag">${r.daysAgo} DAYS</span> (${f_formatDate(r.returnDate)})
                             <div class="small-muted">COMPANY: <span class="company-text">${toUpper(r.companyName)}</span></div>`;
            list.appendChild(div);
        });
        // Add total amount at the end
        const totalDiv = document.createElement('div');
        totalDiv.className = 'reminder-item';
        totalDiv.innerHTML = `<strong>TOTAL PENDING RETURN AMOUNT:</strong> <span class="currency">${INR(totalAmount)}</span>`;
        list.appendChild(totalDiv);
        // Add browser notification for return reminders
        if ('Notification' in window && Notification.permission === 'granted') {
            pendingReturns.forEach(r => {
                new Notification(`Return Reminder: ${toUpper(r.itemName)}`, {
                    body: `Return pending credit note for ${r.daysAgo} days`,
                    icon: '/favicon.ico'
                });
            });
        }
    }

    // Request notification permission on app load
    if ('Notification' in window) {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                console.log('Notification permission granted');
            }
        });
    }

    function buildSalesSeriesFromInvoices(fromDate, toDate, companyFilter) {
      let items = f_invoices.slice().sort((a, b) => getDateFromStr(a.date) - getDateFromStr(b.date));
      if (fromDate) items = items.filter(i => getDateFromStr(i.date) >= getDateFromStr(fromDate));
      if (toDate) items = items.filter(i => getDateFromStr(i.date) <= getDateFromStr(toDate));
      if (companyFilter && companyFilter !== '') items = items.filter(i => toUpper(i.supplier) === companyFilter);
      return { labels: items.map((i) => i.date), data: items.map((i) => i.amount) };
    }
    function buildGstBreakdownFromGSTTable(fromDate, toDate, companyFilter) {
      let items = g_lines.slice();
      if (fromDate) items = items.filter(l => getDateFromStr(l.date) >= getDateFromStr(fromDate));
      if (toDate) items = items.filter(l => getDateFromStr(l.date) > getDateFromStr(toDate));
      // GST doesn't have company, but filter if needed
      const grandByRate = {};
      appSettings.taxRates.forEach(rate => grandByRate[rate] = 0);
      items.forEach(l => {
        if(grandByRate[l.taxRate] !== undefined) grandByRate[l.taxRate] += (+l.grand || 0);
      });
      const rates = Object.keys(grandByRate).map(r => `${r}% GST`);
      const values = Object.values(grandByRate);
      return { labels: rates, data: values };
    }
    function renderDashboardCards(fromDate, toDate, companyFilter) {
      let filteredInvoices = f_invoices.slice();
      let filteredPayments = f_payments.slice();
      let filteredExpenses = f_expenses.slice();
      let filteredIncomes = f_incomes.slice();
      let filteredReturns = f_returns.slice();

      if (fromDate) {
        filteredInvoices = filteredInvoices.filter(i => getDateFromStr(i.date) >= getDateFromStr(fromDate));
        filteredPayments = filteredPayments.filter(p => getDateFromStr(p.date) >= getDateFromStr(fromDate));
        filteredExpenses = filteredExpenses.filter(e => getDateFromStr(e.date) >= getDateFromStr(e.date));
        filteredIncomes = filteredIncomes.filter(i => getDateFromStr(i.date) >= getDateFromStr(i.date));
        filteredReturns = filteredReturns.filter(r => getDateFromStr(r.returnDate) >= getDateFromStr(r.returnDate));
      }
      if (toDate) {
        filteredInvoices = filteredInvoices.filter(i => getDateFromStr(i.date) <= getDateFromStr(toDate));
        filteredPayments = filteredPayments.filter(p => getDateFromStr(p.date) <= getDateFromStr(p.date));
        filteredExpenses = filteredExpenses.filter(e => getDateFromStr(e.date) <= getDateFromStr(e.date));
        filteredIncomes = filteredIncomes.filter(i => getDateFromStr(i.date) <= getDateFromStr(i.date));
        filteredReturns = filteredReturns.filter(r => getDateFromStr(r.returnDate) <= getDateFromStr(r.returnDate));
      }
      if (companyFilter && companyFilter !== '') {
        filteredInvoices = filteredInvoices.filter(i => toUpper(i.supplier) === toUpper(companyFilter));
        filteredPayments = filteredPayments.filter(p => {
          const invoice = f_invoices.find(i => i.invoiceNo === p.invoiceNo);
          return invoice && toUpper(invoice.supplier) === toUpper(companyFilter);
        });
        filteredReturns = filteredReturns.filter(r => toUpper(r.companyName) === toUpper(companyFilter));
      }

      const totalInvoiceAmount = filteredInvoices.reduce((s, i) => s + i.amount, 0);
      const totalExpenseAmount = filteredExpenses.reduce((s, e) => s + e.amount, 0);
      const totalGstApprox = g_lines.filter(l => {
        if (fromDate && getDateFromStr(l.date) < getDateFromStr(fromDate)) return false;
        if (toDate && getDateFromStr(l.date) > getDateFromStr(toDate)) return false;
        return true;
      }).reduce((s, l) => s + (+l.sgst || 0) + (+l.cgst || 0), 0);
      const onlinePayment = filteredPayments.filter(p => p.type === 'online').reduce((s, p) => s + p.amount, 0) + filteredIncomes.filter(i => i.type === 'online').reduce((s, i) => s + i.amount, 0);
      const cashPayment = filteredPayments.filter(p => p.type === 'cash').reduce((s, p) => s + p.amount, 0) + filteredIncomes.filter(i => i.type === 'cash').reduce((s, i) => s + i.amount, 0);
      const checkPayment = filteredPayments.filter(p => p.type === 'check').reduce((s, p) => s + p.amount, 0);

      const totalIncomeAmount = filteredIncomes.reduce((s, i) => s + i.amount, 0);
      const cashIncome = filteredIncomes.filter(i => i.type === 'cash').reduce((s, i) => s + i.amount, 0);
      const onlineIncome = filteredIncomes.filter(i => i.type === 'online').reduce((s, i) => s + i.amount, 0);
      const pendingBills = filteredInvoices.filter(inv => f_computeStatus(inv).status !== 'paid').length;
      const returnItemsCount = filteredReturns.length;
      const returnItemsTotalAmount = filteredReturns.reduce((s, r) => s + r.quantity * r.mrp, 0); // Added total MRP amount
      const netProfit = totalIncomeAmount + totalInvoiceAmount - totalExpenseAmount;

      const totalRemaining = filteredInvoices.reduce((s, inv) => s + f_computeStatus(inv).remaining, 0);

      const cardsDefinition = [
        { id: "totalSales", icon: 'üí∞', title: 'TOTAL INVOICE PURCHASE', subtitle: 'TOTAL INVOICE PURCHASE AMOUNT', value: totalInvoiceAmount, entries: filteredInvoices.length },
        { id: "totalPurchases", icon: 'üõí', title: 'TOTAL EXPENSES (‡§ñ‡§∞‡•ç‡§ö‡•ã‡§Ç)', subtitle: 'TOTAL EXPENSE AMOUNT', value: totalExpenseAmount, entries: filteredExpenses.length },
        { id: "gstCollected", icon: 'üìä', title: 'GST COLLECTED', subtitle: 'SGST + CGST', value: totalGstApprox, entries: g_lines.length },
        { id: "onlinePayments", icon: 'üí≥', title: 'ONLINE PAYMENTS', subtitle: 'UPI / ONLINE', value: onlinePayment, entries: filteredPayments.filter(p => p.type === 'online').length + filteredIncomes.filter(i => i.type === 'online').length },
        { id: "cashPayments", icon: 'üíµ', title: 'CASH PAYMENTS', subtitle: 'CASH IN HAND', value: cashPayment, entries: filteredPayments.filter(p => p.type === 'cash').length + filteredIncomes.filter(i => i.type === 'cash').length },
        { id: "checkPayments", icon: 'üìù', title: 'CHECK PAYMENTS', subtitle: 'VIA BANK CHECK', value: checkPayment, entries: filteredPayments.filter(p => p.type === 'check').length },
        { id: "totalIncome", icon: 'üí∏', title: 'TOTAL INCOME', subtitle: `CASH: ${INR(cashIncome)}<br>ONLINE: ${INR(onlineIncome)}`, value: totalIncomeAmount, entries: filteredIncomes.length }, // Updated subtitle to two lines
        { id: "pendingBills", icon: '‚è≥', title: 'PENDING BILLS', subtitle: `${pendingBills} UNPAID INVOICES`, value: totalRemaining, entries: pendingBills },
        { id: "returnItems", icon: 'üì¶', title: 'RETURN ITEMS', subtitle: 'TOTAL MRP FOR RETURNED ITEMS', value: returnItemsTotalAmount, entries: returnItemsCount }, // Updated to show total MRP amount
        { id: "netProfit", icon: 'üìà', title: 'NET PROFIT', subtitle: 'INCOME + SALES - EXPENSES', value: netProfit, entries: filteredIncomes.length + filteredInvoices.length + filteredExpenses.length },
      ];
      
      const visibleCards = appSettings.dashboardVisibility.filter(c => c.visible);
      const cards = visibleCards.map(v => cardsDefinition.find(c => c.id === v.id)).filter(Boolean);

      const container = document.getElementById('dashboardCards');
      if (!container) return;
      container.innerHTML = '';
      cards.forEach((c, index) => {
        const el = document.createElement('div');
        el.className = 'summary-card';
        el.innerHTML = `<div class="card-sl text-3d-blue">SL: ${index + 1}</div><div class="card-entries text-3d-green">Entries: ${c.entries}</div><div class="card-icon">${c.icon}</div><p>${c.title}</p><h2>${INR(c.value)}</h2><p class="muted">${c.subtitle}</p>`;
        container.appendChild(el);
      });
    }
    function createSalesChart(fromDate, toDate, companyFilter) {
      try {
        if (!salesCtx) return;
        const s = buildSalesSeriesFromInvoices(fromDate, toDate, companyFilter);
        if (salesChart) salesChart.destroy();
        salesChart = new Chart(salesCtx, {
          type: 'line',
          data: {
            labels: s.labels.length ? s.labels : [],
            datasets: [{ label: 'Sales', data: s.data.length ? s.data : [], borderColor: '#ff9933', backgroundColor: 'rgba(255, 153, 51, 0.1)', fill: true, tension: 0.3, pointRadius: 4, pointBackgroundColor: '#2345a0' }],
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => INR(ctx.parsed.y) } } },
            animation: { duration: 2000, easing: 'easeOutBounce' }
          },
        });
      } catch (e) {
        console.warn('Sales chart creation failed:', e);
      }
    }
    function createGstChart(fromDate, toDate, companyFilter) {
      try {
        if (!gstCtx) return;
        const s = buildGstBreakdownFromGSTTable(fromDate, toDate, companyFilter);
        if (gstChart) gstChart.destroy();
        gstChart = new Chart(gstCtx, {
          type: 'bar',
          data: {
            labels: s.labels,
            datasets: [{ label: 'GST Amount', data: s.data, backgroundColor: ['#ff9933', '#138808', '#2345a0', '#f1c40f', '#e74c3c'] }],
          },
          options: {
            responsive: true,
            plugins: { tooltip: { callbacks: { label: (ctx) => INR(ctx.parsed.y) } } },
            animation: { duration: 2000, easing: 'easeOutBounce' }
          },
        });
        const filteredGsts = g_lines.filter(l => {
          if (fromDate && getDateFromStr(l.date) < getDateFromStr(fromDate)) return false;
          if (toDate && getDateFromStr(l.date) > getDateFromStr(toDate)) return false;
          return true;
        });
        const gstSummary = document.getElementById('gstSummary');
        if (gstSummary) {
          const totalGst = filteredGsts.reduce((s, l) => s + (+l.sgst || 0) + (+l.cgst || 0), 0);
          gstSummary.innerHTML = `TOTAL GST COLLECTED: <span class="currency">${INR(totalGst)}</span>`;
        }
      } catch (e) {
        console.warn('GST chart creation failed:', e);
      }
    }

    function monthKey(d) {
      const dt = getDateFromStr(d);
      if(!dt) return null;
      return `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, '0')}`;
    }
    function buildMonthlySeries(fromDate, toDate, companyFilter) {
      let items = [...f_incomes, ...f_expenses];
      if (fromDate) items = items.filter(item => getDateFromStr(item.date) >= getDateFromStr(fromDate));
      if (toDate) items = items.filter(item => getDateFromStr(item.date) <= getDateFromStr(item.date));
      // Company filter not applicable for income/expenses

      const months = new Set();
      items.forEach(item => {
        const k = monthKey(item.date);
        if(k) months.add(k);
      });
      
      const keys = Array.from(months).sort();
      const incMap = {}, expMap = {}, cashflow = {};
      keys.forEach((k) => { incMap[k] = 0; expMap[k] = 0; cashflow[k] = 0; });
      
      f_incomes.forEach((i) => {
        const k = monthKey(i.date);
        if(k && incMap[k] !== undefined) {
            incMap[k] += Number(i.amount || 0);
            cashflow[k] += Number(i.amount || 0);
        }
      });
      f_expenses.forEach((e) => {
        const k = monthKey(e.date);
        if(k && expMap[k] !== undefined) {
            expMap[k] += Number(e.amount || 0);
            cashflow[k] -= Number(e.amount || 0);
        }
      });
      return { keys, incMap, expMap, cashflow };
    }
    function createIncExpChart(fromDate, toDate, companyFilter) {
      try {
        if (!incExpCtx) return;
        const { keys, incMap, expMap } = buildMonthlySeries(fromDate, toDate, companyFilter);
        if (incExpChart) incExpChart.destroy();
        incExpChart = new Chart(incExpCtx, {
          type: 'bar',
          data: {
            labels: keys,
            datasets: [
              { label: 'Income', data: keys.map((k) => incMap[k] || 0), backgroundColor: '#138808' },
              { label: 'Expenses', data: keys.map((k) => expMap[k] || 0), backgroundColor: '#ff9933' },
            ],
          },
          options: {
            responsive: true,
            plugins: { tooltip: { callbacks: { label: (ctx) => INR(ctx.parsed.y) } } },
            animation: { duration: 2000, easing: 'easeOutBounce' }
          },
        });
      } catch (e) {
        console.warn('Inc/Exp chart creation failed:', e);
      }
    }
    function createCashflowChart(fromDate, toDate, companyFilter) {
      try {
        if (!cashflowCtx) return;
        const { keys, cashflow } = buildMonthlySeries(fromDate, toDate, companyFilter);
        if (cashflowChart) cashflowChart.destroy();
        cashflowChart = new Chart(cashflowCtx, {
          type: 'line',
          data: {
            labels: keys,
            datasets: [{ label: 'Net Cashflow', data: keys.map((k) => cashflow[k] || 0), borderColor: '#2345a0', backgroundColor: 'rgba(35,69,160,0.06)', fill: true, tension: 0.3 }],
          },
          options: {
            responsive: true,
            plugins: { tooltip: { callbacks: { label: (ctx) => INR(ctx.parsed.y) } } },
            animation: { duration: 2000, easing: 'easeOutBounce' }
          },
        });
      } catch (e) {
        console.warn('Cashflow chart creation failed:', e);
      }
    }

    function renderRecentInvoices(fromDate, toDate, companyFilter) {
      const tbody = document.querySelector('#recentInvoicesTable tbody');
      if (!tbody) return;
      let recent = f_invoices.slice().sort((a, b) => getDateFromStr(b.date) - getDateFromStr(a.date));
      if (fromDate) recent = recent.filter(i => getDateFromStr(i.date) >= getDateFromStr(fromDate));
      if (toDate) recent = recent.filter(i => getDateFromStr(i.date) <= getDateFromStr(toDate));
      if (companyFilter && companyFilter !== '') recent = recent.filter(i => toUpper(i.supplier) === companyFilter);
      recent = recent.slice(0, 6);
      tbody.innerHTML = '';
      recent.forEach((inv) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span class="text-3d">${recent.indexOf(inv) + 1}</span></td>
          <td>${makeInvoiceLink(inv.invoiceNo)}</td>
          <td><span class="company-text">${toUpper(inv.supplier)}</span></td>
          <td>${f_formatDate(inv.date)}</td>
          <td><span class="currency">${INR(inv.amount)}</span></td>
        `;
        tbody.appendChild(tr);
      });
      const rc = document.getElementById('recentCount');
      if (rc) rc.innerText = `Showing ${recent.length}`;
    }

    function updateDashboard(fromDate, toDate, companyFilter) {
      updateCheckReminders('upcoming'); // Default to upcoming
      updatePendingBillReminders();
      updateReturnReminders();
      renderDashboardCards(fromDate, toDate, companyFilter);
      createSalesChart(fromDate, toDate, companyFilter);
      createGstChart(fromDate, toDate, companyFilter);
      renderRecentInvoices(fromDate, toDate, companyFilter);
      createIncExpChart(fromDate, toDate, companyFilter);
      createCashflowChart(fromDate, toDate, companyFilter);
    }
    const refreshAllBtn = document.getElementById('refreshAll');
    if (refreshAllBtn)
      refreshAllBtn.addEventListener('click', () => {
        precomputePaymentStatus();
        renderAllTables();
        const fromDate = document.getElementById('dashboardFromDate').value;
        const toDate = document.getElementById('dashboardToDate').value;
        const companyFilter = document.getElementById('dashboardCompanyFilter').value;
        updateDashboard(fromDate, toDate, companyFilter);
        playBeep();
        speak('Dashboard refreshed successfully.');
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Dashboard Refreshed', { body: 'All data has been refreshed.', icon: '/favicon.ico' });
        }
      });

    // Dashboard filter event listeners
    const dashboardFromDate = document.getElementById('dashboardFromDate');
    const dashboardToDate = document.getElementById('dashboardToDate');
    const dashboardCompanyFilter = document.getElementById('dashboardCompanyFilter');
    const resetDashboardFilters = document.getElementById('resetDashboardFilters');

    function applyDashboardFilters() {
      const fromDate = dashboardFromDate.value;
      const toDate = dashboardToDate.value;
      const companyFilter = dashboardCompanyFilter.value;
      updateDashboard(fromDate, toDate, companyFilter);
    }

    if (dashboardFromDate) dashboardFromDate.addEventListener('input', applyDashboardFilters);
    if (dashboardToDate) dashboardToDate.addEventListener('input', applyDashboardFilters);
    if (dashboardCompanyFilter) dashboardCompanyFilter.addEventListener('change', applyDashboardFilters);
    if (resetDashboardFilters) resetDashboardFilters.addEventListener('click', () => {
      dashboardFromDate.value = '';
      dashboardToDate.value = '';
      dashboardCompanyFilter.value = '';
      applyDashboardFilters();
      playBeep();
      speak('Dashboard filters reset.');
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('Filters Reset', { body: 'Dashboard filters have been reset.', icon: '/favicon.ico' });
        }
      });

    /* ---------------- Statement System ---------------- */
    const lookupInvoiceInput = document.getElementById('lookupInvoiceNo');
    const lookupCheckInput = document.getElementById('lookupCheckNo');
    const lookupBtn = document.getElementById('lookupBtn');
    const lookupResultEl = document.getElementById('lookupResult');

    lookupInvoiceInput.addEventListener('input', () => { if(lookupInvoiceInput.value) lookupCheckInput.value = ''; });
    lookupCheckInput.addEventListener('input', () => { if(lookupCheckInput.value) lookupInvoiceInput.value = ''; });

    function performLookup() {
        const invoiceQuery = lookupInvoiceInput.value.trim();
        const checkQuery = lookupCheckInput.value.trim();
        lookupResultEl.innerHTML = '';

        if (invoiceQuery) {
            showInvoiceDetails(invoiceQuery, lookupResultEl);
        } else if (checkQuery) {
            const payment = f_payments.find(p => p.type === 'check' && p.checkNo === checkQuery);
            if (!payment) {
                lookupResultEl.innerHTML = `<p class="muted">CHECK NO. <strong class="text-3d">${checkQuery}</strong> NOT FOUND.</p>`;
                return;
            }

            const invoice = f_invoices.find(i => i.invoiceNo === payment.invoiceNo);
            let paymentTypeText = '';
            if (payment.type === 'check') {
                paymentTypeText = `CHECK NUMBER: ${payment.checkNo}`;
            } else if (payment.type === 'cash') {
                paymentTypeText = 'CASH IN HAND PAYMENT PAID';
            } else {
                paymentTypeText = formatPaymentType(payment.type);
            }
            let html = `<h4>DETAILS FOR CHECK NO: <span class="text-3d">${checkQuery}</span></h4>
                        <p><strong>SL NO:</strong> <span class="text-3d">1</span></p>
                        <p><strong>COMPANY NAME:</strong> <span class="company-text">${invoice ? toUpper(invoice.supplier) : '-'}</span></p>
                        <p><strong>INVOICE NUMBER:</strong> ${invoice ? makeInvoiceLink(invoice.invoiceNo) : '-'}</p>
                        <p><strong>DATE:</strong> ${f_formatDate(payment.date)}</p>
                        <p><strong>AMOUNT:</strong> <span class="currency">${INR(payment.amount)}</span></p>
                        <p><strong>PAYMENT TYPE:</strong> ${paymentTypeText}</p>`;
            lookupResultEl.innerHTML = DOMPurify.sanitize(html);
        } else {
            lookupResultEl.innerHTML = `<p class="muted">Enter an invoice or check number to search.</p>`;
        }
    }
    lookupBtn.addEventListener('click', performLookup);

    const detailModalBackdrop = document.getElementById('detailModalBackdrop');
    const detailModalTitle = document.getElementById('detailModalTitle');
    const detailModalContent = document.getElementById('detailModalContent');
    const closeDetailModalBtn = document.getElementById('closeDetailModalBtn');
    
    function showDetailModal(title, content) {
        if (!detailModalBackdrop) return;
        detailModalTitle.innerHTML = title;
        detailModalContent.innerHTML = DOMPurify.sanitize(content);
        detailModalBackdrop.style.display = 'flex';
        detailModalBackdrop.setAttribute('aria-hidden', 'false');
    }
    function closeDetailModal() { 
        if (detailModalBackdrop) { 
            detailModalBackdrop.style.display = 'none'; 
            detailModalBackdrop.setAttribute('aria-hidden', 'true'); 
        } 
    }
    if(closeDetailModalBtn) closeDetailModalBtn.addEventListener('click', closeDetailModal);
    if(detailModalBackdrop) detailModalBackdrop.addEventListener('click', (e) => { if(e.target === detailModalBackdrop) closeDetailModal(); });

    function showInvoiceDetails(invoiceNo, targetElement = null) {
        const upperInvoiceNo = toUpper(invoiceNo);
        const invoice = f_invoices.find(i => i.invoiceNo === upperInvoiceNo);
        const modalTitle = `DETAILS FOR INVOICE: <span class="text-3d">${upperInvoiceNo}</span>`;
        
        if (!invoice) {
            const content = `<p class="muted">INVOICE <strong class="text-3d">${upperInvoiceNo}</strong> NOT FOUND.</p>`;
            if (targetElement) targetElement.innerHTML = DOMPurify.sanitize(content);
            else showDetailModal(`INVOICE NOT FOUND`, content);
            return;
        }

        const { paid, remaining, status, invoicePayments } = f_computeStatus(invoice);
        const daysOverdue = (status === 'pending' || status === 'partial') ? calculateDaysDifference(invoice.date) : 0;
        const paymentTypes = status === 'paid' ? [...new Set(invoicePayments.map(p => p.type))].join(', ') : (daysOverdue > 0 ? `${daysOverdue} DAYS` : '-');

        let paymentTypeText = paymentTypes;
        if (status === 'paid' && invoicePayments.length > 0) {
            const lastPayment = invoicePayments[invoicePayments.length - 1];
            if (lastPayment.type === 'check') {
                paymentTypeText = `CHECK NUMBER: ${lastPayment.checkNo}`;
            } else if (lastPayment.type === 'cash') {
                paymentTypeText = 'CASH IN HAND PAYMENT PAID';
            } else {
                paymentTypeText = formatPaymentType(lastPayment.type);
            }
        }

        let html = `<p><strong>SL NO:</strong> <span class="text-3d">1</span></p>
                     <p><strong>COMPANY NAME:</strong> <span class="company-text">${toUpper(invoice.supplier)}</span></p>
                     <p><strong>INVOICE NUMBER:</strong> ${makeInvoiceLink(invoice.invoiceNo)}</p>
                     <p><strong>DATE:</strong> ${f_formatDate(invoice.date)}</p>
                     <p><strong>AMOUNT:</strong> <span class="currency">${INR(invoice.amount)}</span></p>
                     <p><strong>PAYMENT TYPE:</strong> ${paymentTypeText}</p>`;

        if (invoicePayments.length) {
            html += `<h4>PAYMENTS RECEIVED (${INR(paid)} TOTAL):</h4>`;
            const paymentsHtml = invoicePayments.map(p => {
                let paymentHtml = `<li>${f_formatDate(p.date)}: <span class="currency">${INR(p.amount)}</span> ${p.type === 'cash' ? 'CASH IN HAND' : `VIA ${formatPaymentType(p.type)}`}`;
                if (p.type === 'check' && p.checkNo) {
                    paymentHtml += ` (CHECK NO: <strong class="text-3d">${toUpper(p.checkNo)}</strong>)`;
                }
                if (p.type === 'credit' && p.creditNoteNo) {
                    paymentHtml += ` (CREDIT NOTE NO: <strong class="text-3d">${toUpper(p.creditNoteNo)}</strong>)`;
                    // Add return details for credit notes
                    const returnItem = f_returns.find(r => r.creditNoteNo === p.creditNoteNo && r.companyName === invoice.supplier);
                    if (returnItem) {
                        paymentHtml += `<br>&nbsp;&nbsp;&nbsp;&nbsp;ITEM NAME: <strong class="text-3d">${toUpper(returnItem.itemName)}</strong>, QTY: <strong class="text-3d">${returnItem.quantity}</strong>, MRP: <span class="currency">${INR(returnItem.mrp)}</span>, TOTAL: <span class="currency">${INR(returnItem.quantity * returnItem.mrp)}</span>, RETURN DATE: ${f_formatDate(returnItem.returnDate)}`;
                    }
                }
                paymentHtml += `</li>`;
                return paymentHtml;
            }).join('');
            html += `<ul style="list-style:inside; padding-left:0; text-transform:none;">${paymentsHtml}</ul>`;
        } else {
            html += `<p class="muted">NO PAYMENTS RECORDED FOR THIS INVOICE.</p>`;
        }
        
        const companyReturns = f_returns.filter(r => r.companyName === invoice.supplier && !r.creditNoteNo);
        if (companyReturns.length) {
            html += `<h4>RETURN ITEMS FROM THIS COMPANY:</h4>`;
            const returnsHtml = companyReturns.map(r => {
                const daysAgo = calculateDaysDifference(r.returnDate);
                return `<li>${f_formatDate(r.returnDate)} (<span class="days-ago-text">${daysAgo} DAYS AGO</span>): <span class="text-3d">${r.quantity}</span> X <span class="text-3d">${toUpper(r.itemName)}</span> (MRP: ${INR(r.mrp)})</li>`;
            }).join('');
            html += `<ul style="list-style:inside; padding-left:0; text-transform:none;">${returnsHtml}</ul>`;
            const totalReturn = companyReturns.reduce((s, r) => s + r.mrp * r.quantity, 0);
            html += `<p><strong>TOTAL RETURN MRP:</strong> <span class="currency">${INR(totalReturn)}</span></p>`;
        } else {
             html += `<h4>RETURN ITEMS FROM THIS COMPANY:</h4><p class="muted">NO RETURN ITEMS FOUND FOR THIS COMPANY.</p>`;
        }
        
        if (targetElement) {
            targetElement.innerHTML = `<h4>${modalTitle}</h4>` + DOMPurify.sanitize(html);
        } else {
            showDetailModal(modalTitle, html);
        }
    }

    const stmGenerate = document.getElementById('stmGenerate');
    const stmPrint = document.getElementById('stmPrint');
    const stmExportPdfBtn = document.getElementById('stmExportPdf');
    const stmWhatsapp = document.getElementById('stmWhatsapp');
    const stmName = document.getElementById('stmName');
    const stmEmail = document.getElementById('stmEmail');
    const stmFrom = document.getElementById('stmFrom');
    const stmTo = document.getElementById('stmTo');
    const stmType = document.getElementById('stmType');
    const stmHeadRow = document.getElementById('stmHeadRow');
    const stmBody = document.getElementById('stmBody');
    const stmTotals = document.getElementById('stmTotals');
    const stmHeaderInfo = document.getElementById('stmHeaderInfo');
    const stmMeta = document.getElementById('stmMeta');

    function within(dateStr, from, to) {
        const d = getDateFromStr(dateStr);
        if (!d) return false;
        const f = from ? getDateFromStr(from) : null;
        const t = to ? getDateFromStr(to) : null;

        if (f && d < f) return false;
        if (t && d > t) return false;

        return true;
    }

    function genStatement() {
      stmGenerate.classList.add('loading');
      setTimeout(() => {
        const name = stmName.value.trim();
        const email = stmEmail.value.trim() || '-';
        const from = stmFrom.value;
        const to = stmTo.value;
        const type = stmType.value;
        stmBody.innerHTML = '';
        stmHeadRow.innerHTML = '';
        stmTotals.innerHTML = '';

        const dateRange = from || to ? ` (<span class="text-3d">${from || '‚Äî'}</span> ‚Üí <span class="text-3d">${to || '‚Äî'}</span>)` : '';
        stmHeaderInfo.innerHTML = `NAME: <span class="text-3d">${name || 'ALL'}</span> | EMAIL: ${email}${dateRange}`;

        let rows = [], total = 0;
        
        const invoiceNameFilter = (item) => !name || toUpper(item.supplier) === name;
        const returnNameFilter = (item) => !name || toUpper(item.companyName) === name;

        if (type === 'pending') {
          const items = f_invoices.filter((x) => invoiceNameFilter(x) && within(x.date, from, to) && ['pending', 'partial'].includes(f_computeStatus(x).status));
          if (items.length) {
            rows.push({
              section: 'PENDING INVOICES',
              head: ['SL', 'INVOICE', 'COMPANY NAME', 'DATE', 'AMOUNT', 'REMAINING', 'DAYS OVERDUE'],
              data: items.map((i, index) => {
                const s = f_computeStatus(i);
                const daysOverdue = calculateDaysDifference(i.date);
                return [`<span class="text-3d">${index + 1}</span>`, makeInvoiceLink(i.invoiceNo), `<span class="company-text">${toUpper(i.supplier)}</span>`, f_formatDate(i.date), `<span class="currency">${INR(i.amount)}</span>`, `<span class="currency">${INR(s.remaining)}</span>`, `<span class="days-text">${daysOverdue} DAYS</span>`];
              }),
            });
            total = items.reduce((s, i) => s + f_computeStatus(i).remaining, 0);
          }
        } else {
          if (['invoices', 'combined'].includes(type)) {
            const items = f_invoices.filter((x) => invoiceNameFilter(x) && within(x.date, from, to));
            if (items.length) {
              rows.push({
                section: 'INVOICES',
                head: ['SL', 'INVOICE', 'COMPANY NAME', 'DATE', 'AMOUNT'],
                data: items.map((i, index) => [`<span class="text-3d">${index + 1}</span>`, makeInvoiceLink(i.invoiceNo), `<span class="company-text">${toUpper(i.supplier)}</span>`, f_formatDate(i.date), `<span class="currency">${INR(i.amount)}</span>`]),
              });
              total += items.reduce((s, i) => s + i.amount, 0);
            }
          }
          if (['payments', 'combined'].includes(type)) {
            const relevantInvoiceNos = f_invoices.filter(invoiceNameFilter).map(i => i.invoiceNo);
            const items = f_payments.filter((x) => relevantInvoiceNos.includes(x.invoiceNo) && within(x.date, from, to));
            if (items.length) {
              rows.push({
                section: 'PAYMENTS',
                head: ['SL', 'INVOICE NO', 'COMPANY NAME', 'DATE', 'AMOUNT', 'TYPE', 'CHECK#/CREDIT#', 'STATUS'],
                data: items.map((p, index) => {
                  const invoice = f_invoices.find(i => i.invoiceNo === p.invoiceNo);
                  const company = invoice ? toUpper(invoice.supplier) : '-';
                  const status = p.type === 'credit' ? 'CREDIT ADJUSTED' : 'RECEIVED';
                  return [`<span class="text-3d">${index + 1}</span>`, makeInvoiceLink(p.invoiceNo), `<span class="company-text">${company}</span>`, f_formatDate(p.date), `<span class="currency">${INR(p.amount)}</span>`, formatPaymentType(p.type), `<span class="text-3d">${toUpper(p.checkNo || p.creditNoteNo || '-')}</span>`, `<span class="text-3d-blue">${status}</span>`];
                }),
              });
            }
          }
          if (['returns', 'combined'].includes(type)) {
              const items = f_returns.filter(x => returnNameFilter(x) && within(x.returnDate, from, to));
              if (items.length) {
                  rows.push({
                      section: 'RETURN ITEMS',
                      head: ['SL', 'COMPANY', 'ITEM', 'QTY', 'MRP', 'DATE', 'DAYS AGO'],
                      data: items.map((i, index) => [`<span class="text-3d">${index + 1}</span>`, `<span class="company-text">${toUpper(i.companyName)}</span>`, `<span class="text-3d">${toUpper(i.itemName)}</span>`, `<span class="text-3d">${i.quantity}</span>`, `<span class="currency">${INR(i.mrp)}</span>`, f_formatDate(i.returnDate), `<span class="days-ago-text">${calculateDaysDifference(i.returnDate)} DAYS AGO</span>`])
                  });
              }
          }
          if (!name) {
              if (['expenses', 'combined'].includes(type)) {
                const items = f_expenses.filter((x) => within(x.date, from, to));
                if (items.length) {
                  rows.push({ section: 'EXPENSES', head: ['SL', 'NAME', 'DATE', 'TYPE', 'AMOUNT'], data: items.map((e, index) => [`<span class="text-3d">${index + 1}</span>`, `<span class="text-3d">${toUpper(e.name)}</span>`, f_formatDate(e.date), formatPaymentType(e.type), `<span class="currency">${INR(e.amount)}</span>`]) });
                }
              }
              if (['income', 'combined'].includes(type)) {
                const items = f_incomes.filter((x) => within(x.date, from, to));
                if (items.length) {
                  rows.push({ section: 'INCOME', head: ['SL', 'DATE', 'TYPE', 'AMOUNT'], data: items.map((e, index) => [`<span class="text-3d">${index + 1}</span>`, f_formatDate(e.date), formatPaymentType(e.type), `<span class="currency">${INR(e.amount)}</span>`]) });
                }
              }
              if (['gst', 'combined'].includes(type)) {
                const items = g_lines.filter(x => within(x.date, from, to));
                if (items.length) {
                  rows.push({ section: 'GST', head: ['SL', 'DATE', 'MODE', 'TAX%', 'AMOUNT', 'SGST', 'CGST', 'GRAND', 'PAYMENT'], data: items.map((g, index) => [`<span class="text-3d">${index + 1}</span>`, f_formatDate(g.date), toUpper(g.mode),g.taxRate + '%',`<span class="currency">${INR(+g.amount)}</span>`,`<span class="currency">${INR(+g.sgst)}</span>`,`<span class="currency">${INR(+g.cgst)}</span>`,`<span class="currency">${INR(+g.grand)}</span>`,formatPaymentType(g.payment)]) });
                }
              }
          }
        }

        if (!rows.length) {
          stmHeadRow.innerHTML = `<th>NO DATA</th>`;
          stmBody.innerHTML = `<tr><td>PLEASE ADJUST FILTERS OR ADD ENTRIES FOR THIS COMPANY.</td></tr>`;
          stmTotals.textContent = '';
          stmMeta.textContent = 'NO RESULTS';
          stmMeta.className = 'badge warn';
        } else {
            stmMeta.textContent = toUpper(type);
            stmMeta.className = 'badge ok';

            if (rows.length === 1) {
              const headCols = rows[0].head;
              stmHeadRow.innerHTML = headCols.map((h) => `<th>${h}</th>`).join('');
              stmBody.innerHTML = rows[0].data.map((r) => `<tr>${r.map((c) => `<td>${c}</td>`).join('')}</tr>`).join('');
            } else {
              stmHeadRow.innerHTML = `<th>SECTION</th><th>DETAILS</th>`;
              const bodyParts = rows.map(sec => {
                const inner = `<table style="width:100%; border-collapse:collapse;">
                    <thead><tr>${sec.head.map(h => `<th style="background:#f7f9fb; color:#234; padding:6px;">${h}</th>`).join('')}</tr></thead>
                    <tbody>${sec.data.map(r => `<tr>${r.map(c => `<td style="padding:6px; border-top:1px solid #f1f1f1;">${c}</td>`).join('')}</tr>`).join('')}</tbody>
                  </table>`;
                return `<tr><td style="vertical-align:top; width:160px;"><strong>${sec.section}</strong></td><td>${inner}</td></tr>`;
              });
              stmBody.innerHTML = bodyParts.join('');
            }

            if (stmTotals && type === 'pending') {
                stmTotals.innerHTML = `TOTAL PENDING: <span class="currency">${INR(total)}</span>`;
            }
        }
        stmGenerate.classList.remove('loading');
      }, 250);
    }
    if (stmGenerate) stmGenerate.addEventListener('click', genStatement);
    if (stmPrint) stmPrint.addEventListener('click', () => {
        document.getElementById('statementSection').classList.add('printing');
        window.print();
        document.getElementById('statementSection').classList.remove('printing');
    });
    if (stmExportPdfBtn) stmExportPdfBtn.addEventListener('click', () => exportStatementToPdf(false));
    if (stmWhatsapp)
      stmWhatsapp.addEventListener('click', () => {
        const name = toUpper(stmName.value.trim());
        const email = stmEmail.value.trim() || '-';
        const from = stmFrom.value;
        const to = stmTo.value;
        const type = toUpper(stmType.value);
        
        const nameFilter = (item) => !name || toUpper(item.supplier) === name;
        const relevantInvoiceNos = f_invoices.filter(nameFilter).map(i => i.invoiceNo);

        const invSum = f_invoices.filter(x => nameFilter(x) && within(x.date, from, to)).reduce((s, i) => s + i.amount, 0);
        const paySum = f_payments.filter(x => relevantInvoiceNos.includes(x.invoiceNo) && within(x.date, from, to)).reduce((s, i) => s + i.amount, 0);
        
        let msg = `STATEMENT (${type})\nNAME: ${name || 'ALL'}\nEMAIL: ${email}\nRANGE: ${from || '‚Äî'} TO ${to || '‚Äî'}\n\nINVOICES: ${INR(invSum)}\nPAYMENTS: ${INR(paySum)}`;
        
        if (!name) {
            const expSum = f_expenses.filter((x) => within(x.date, from, to)).reduce((s, i) => s + i.amount, 0);
            const incSum = f_incomes.filter((x) => within(x.date, from, to)).reduce((s, i) => s + i.amount, 0);
            const gstSum = g_lines.reduce((s, i) => s + (+i.grand || 0), 0);
            msg += `\nEXPENSES: ${INR(expSum)}\nINCOME: ${INR(incSum)}\nGST GRAND: ${INR(gstSum)}`;
        }
        msg += `\n\nTHANKS.`
        const waUrl = `https://wa.me/?text=${encodeURIComponent(msg)}`;
        window.open(waUrl, '_blank');
      });
    
    // ---------------- PDF & Print Functions ----------------
    document.addEventListener('click', e => {
      if (e.target.matches('.print-section-btn')) {
        const targetId = e.target.dataset.target;
        const sectionEl = document.querySelector(`[data-print-area="${targetId}"]`);
        if (sectionEl) {
          const parentSection = sectionEl.closest('section');
          parentSection.classList.add('printing');
          window.print();
          parentSection.classList.remove('printing');
        }
      }
    });

    function getFilteredData(reportKey) {
        const config = reportConfig[reportKey];
        if (!config) return [];
        let data = config.data();
        if (config.filter) data = data.filter(config.filter);
        if (config.sort) data = data.sort(config.sort);
        return data;
    }

    async function exportPdf(title, head, body, preview = false, filename = 'report.pdf') {
        if (typeof window.jsPDF === 'undefined' || typeof window.jsPDF.plugin.autotable === 'undefined') {
            alert('PDF library not loaded. Please try again.');
            return;
        }
        const { jsPDF } = window.jsPDF;
        const doc = new jsPDF();

        doc.setFontSize(18);
        doc.text(title, 14, 22);
        doc.setFontSize(11);
        doc.setTextColor(100);
        doc.text(`GENERATED: ${new Date().toLocaleString()}`, 14, 28);

        doc.autoTable({
            head: head,
            body: body,
            startY: 35,
            theme: 'striped',
            headStyles: { fillColor: [35, 69, 160] },
            didParseCell: (data) => {
                // Strip HTML for PDF export
                if (typeof data.cell.text[0] === 'string') {
                    data.cell.text[0] = data.cell.text[0].replace(/<[^>]+>/g, '');
                }
            }
        });

        const blob = doc.output('blob');
        if (preview) {
            doc.output('dataurlnewwindow');
        } else {
            await saveBlobPreferFolder(blob, filename);
        }
    }

    async function exportFinanceReportToPdf(type, preview) {
        let title, head, body;
        const filename = `${type}_report_${new Date().toISOString().slice(0, 10)}.pdf`;

        const data = getFilteredData(type);

        switch (type) {
            case 'invoices':
                title = 'INVOICE & PAYMENT REPORT';
                head = [['SL', 'INVOICE', 'COMPANY', 'AMOUNT', 'DATE', 'PAID', 'REMAINING', 'STATUS', 'DETAILS']];
                body = data.map((inv, i) => {
                    const { paid, remaining, status, invoicePayments } = f_computeStatus(inv);
                    const daysOverdue = (status === 'pending' || status === 'partial') ? calculateDaysDifference(inv.date) : 0;
                    const paymentTypes = status === 'paid' ? [...new Set(invoicePayments.map(p => p.type))].join(', ') : (daysOverdue > 0 ? `${daysOverdue} DAYS` : '-');
                    return [i + 1, toUpper(inv.invoiceNo), toUpper(inv.supplier), INR(inv.amount), inv.date, INR(paid), INR(remaining), toUpper(status), paymentTypes];
                });
                break;
            case 'expenses':
                title = 'EXPENSE REPORT';
                head = [['SL', 'EXPENSE NAME', 'AMOUNT', 'DATE', 'PAYMENT TYPE']];
                body = data.map((exp, i) => [i + 1, toUpper(exp.name), INR(exp.amount), exp.date, exp.type === 'pending' ? 'PENDING' : toUpper(exp.type) + ' (PAID)']);
                break;
            case 'income':
                title = 'INCOME REPORT';
                head = [['SL', 'AMOUNT', 'DATE', 'PAYMENT TYPE']];
                body = data.map((inc, i) => [i + 1, INR(inc.amount), inc.date, toUpper(inc.type)]);
                break;
            default: return;
        }
        await exportPdf(title, head, body, preview, filename);
    }

    async function exportReturnsToPdf(preview) {
        const title = 'RETURN ITEMS REPORT';
        const head = [['SL', 'COMPANY', 'ITEM', 'QTY', 'MRP', 'TOTAL', 'CREDIT NOTE NO', 'STATUS']];
        const data = getFilteredData('returns');
        const body = data.map((item, i) => [
            i + 1,
            toUpper(item.companyName),
            toUpper(item.itemName),
            item.quantity,
            INR(item.mrp),
            INR(item.quantity * item.mrp),
            toUpper(item.creditNoteNo || 'PENDING'),
            item.creditNoteNo ? 'RECEIVED' : `${calculateDaysDifference(item.returnDate)} DAYS AGO`
        ]);
        const filename = `returns_report_${new Date().toISOString().slice(0, 10)}.pdf`;
        await exportPdf(title, head, body, preview, filename);
    }

    async function exportDefectiveChecksToPdf(preview) {
        const title = 'DEFECTIVE CHECKS REPORT';
        const head = [['SL', 'CHECK NO', 'DATE LOGGED']];
        const data = getFilteredData('defectiveChecks');
        const body = data.map((item, i) => [i + 1, toUpper(item.checkNo), item.date]);
        const filename = `defective_checks_report_${new Date().toISOString().slice(0, 10)}.pdf`;
        await exportPdf(title, head, body, preview, filename);
    }
    
    async function exportGstToPdf(preview) {
        const title = 'GST BILLING REPORT';
        const head = [['SL', 'DATE', 'AMOUNT', 'TAX%', 'SGST', 'CGST', 'GRAND TOTAL', 'PAYMENT']];
        const data = getFilteredData('gst');
        const body = data.map((line, i) => [i + 1, line.date, INR(line.amount), `${line.taxRate}%`, INR(line.sgst), INR(line.cgst), INR(line.grand), toUpper(line.payment)]);
        const filename = `gst_report_${new Date().toISOString().slice(0, 10)}.pdf`;
        await exportPdf(title, head, body, preview, filename);
    }

    async function exportStatementToPdf(preview = false) {
        if (!stmBody || !stmBody.textContent.trim() || stmBody.textContent.includes('No data')) {
            alert('Please generate a statement first.');
            return;
        }
        const { jsPDF } = window.jsPDF;
        const doc = new jsPDF();
        
        const title = "STATEMENT";
        const headerInfoEl = document.getElementById('stmHeaderInfo');
        const headerInfo = headerInfoEl ? headerInfoEl.textContent.replace(/<[^>]+>/g, '') : '';
        const filename = `statement_${document.getElementById('stmName').value.trim() || 'all'}_${new Date().toISOString().slice(0,10)}.pdf`;

        doc.setFontSize(18);
        doc.text(title, 14, 22);
        doc.setFontSize(10);
        doc.text(headerInfo, 14, 28);

        const tableEl = document.getElementById('stmTable');
        doc.autoTable({ html: tableEl, startY: 35, theme: 'grid' });

        const totalsEl = document.getElementById('stmTotals');
        if (totalsEl && totalsEl.textContent.trim()) {
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(totalsEl.textContent.replace(/<[^>]+>/g, ''), 14, doc.autoTable.previous.finalY + 10);
        }
        
        const blob = doc.output('blob');
        if (preview) {
            doc.output('dataurlnewwindow');
        } else {
            await saveBlobPreferFolder(blob, filename);
        }
    }
    
    /* ---------------- Reports (Company & Purchase Bill) ---------------- */
    const purchaseBillFromDate = document.getElementById('purchase-bill-from-date');
    const purchaseBillToDate = document.getElementById('purchase-bill-to-date');
    const purchaseBillCompanyFilter = document.getElementById('purchase-bill-company-filter');
    const purchaseBillGenerateBtn = document.getElementById('purchase-bill-generate');
    const purchaseBillResultsCard = document.getElementById('purchase-bill-results-card');
    const purchaseBillTitle = document.getElementById('purchase-bill-title');
    const purchaseBillReportTableBody = document.querySelector('#purchaseBillReportTable tbody');
    const purchaseBillReportTotal = document.getElementById('purchaseBillReportTotal');

    function updatePurchaseBillCompanyFilter() {
        if (!purchaseBillCompanyFilter) return;
        const currentVal = purchaseBillCompanyFilter.value;
        purchaseBillCompanyFilter.innerHTML = `<option value="">All Companies</option>`;
        f_parties.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p;
            opt.textContent = toUpper(p);
            purchaseBillCompanyFilter.appendChild(opt);
        });
        purchaseBillCompanyFilter.value = currentVal;
    }

    purchaseBillGenerateBtn?.addEventListener('click', () => {
        const from = purchaseBillFromDate.value;
        const to = purchaseBillToDate.value;
        const company = purchaseBillCompanyFilter.value;

        const filteredInvoices = f_invoices.filter(inv => {
            return within(inv.date, from, to) && (!company || toUpper(inv.supplier) === toUpper(company));
        });

        purchaseBillReportTableBody.innerHTML = '';
        let total = 0;
        filteredInvoices.forEach((inv, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="text-3d">${index + 1}</span></td>
                <td>${makeInvoiceLink(inv.invoiceNo)}</td>
                <td><span class="company-text">${toUpper(inv.supplier)}</span></td>
                <td><span class="currency">${INR(inv.amount)}</span></td>
                <td>${f_formatDate(inv.date)}</td>
            `;
            purchaseBillReportTableBody.appendChild(tr);
            total += inv.amount;
        });

        purchaseBillReportTotal.textContent = INR(total);
        purchaseBillTitle.textContent = `Purchase Bill Report${company ? ' for ' + toUpper(company) : ''}`;
        purchaseBillResultsCard.style.display = 'block';
        playBeep();
        speak('Purchase bill report generated successfully.');
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Purchase Bill Report', { body: `Report generated for ${filteredInvoices.length} invoices.`, icon: '/favicon.ico' });
        }
    });

    async function exportPurchaseBillReportToPdf(preview) {
        const from = purchaseBillFromDate.value;
        const to = purchaseBillToDate.value;
        const company = purchaseBillCompanyFilter.value;

        const filteredInvoices = f_invoices.filter(inv => {
            return within(inv.date, from, to) && (!company || toUpper(inv.supplier) === toUpper(company));
        });

        const title = `Purchase Bill Report${company ? ' for ' + toUpper(company) : ''}`;
        const head = [['SL', 'Invoice No', 'Company Name', 'Amount', 'Date']];
        const body = filteredInvoices.map((inv, i) => [
            i + 1, toUpper(inv.invoiceNo), toUpper(inv.supplier), INR(inv.amount), inv.date
        ]);
        const total = filteredInvoices.reduce((s, inv) => s + inv.amount, 0);
        body.push(['', '', 'TOTAL', INR(total), '']);

        const filename = `purchase_bill_report_${new Date().toISOString().slice(0, 10)}.pdf`;
        await exportPdf(title, head, body, preview, filename);
    }
    
    const companyReportSelect = document.getElementById('company-report-select');
    const companyGenerateBtn = document.getElementById('company-generate');
    const companyResultsCard = document.getElementById('company-results-card');
    const companyTitle = document.getElementById('company-title');
    const companySummaryCards = document.getElementById('company-summary-cards');
    const companyReportTableBody = document.querySelector('#companyReportTable tbody');

    function updateCompanyReportDropdown() {
        if (!companyReportSelect) return;
        const currentVal = companyReportSelect.value;
        companyReportSelect.innerHTML = `<option value="">SELECT A COMPANY</option>`;
        f_parties.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p;
            opt.textContent = toUpper(p);
            companyReportSelect.appendChild(opt);
        });
        companyReportSelect.value = currentVal;
    }

    companyGenerateBtn?.addEventListener('click', () => {
        const company = companyReportSelect.value;
        if (!company) {
            alert('Please select a company.');
            return;
        }
        
        const companyInvoices = f_invoices.filter(i => toUpper(i.supplier) === toUpper(company));
        const invoiceNos = companyInvoices.map(i => i.invoiceNo);
        const companyPayments = f_payments.filter(p => invoiceNos.includes(p.invoiceNo));
        const companyReturns = f_returns.filter(r => toUpper(r.companyName) === toUpper(company));

        const totalBilled = companyInvoices.reduce((s, i) => s + i.amount, 0);
        const totalPaid = companyPayments.reduce((s, p) => s + p.amount, 0);
        const totalReturns = companyReturns.reduce((s, r) => s + r.quantity * r.mrp, 0); // Added total MRP amount

        companyTitle.textContent = `Report for ${toUpper(company)}`;
        companySummaryCards.innerHTML = `
            <div class="summary-card"><p>TOTAL BILLED</p><h2>${INR(totalBilled)}</h2></div>
            <div class="summary-card"><p>TOTAL PAID</p><h2>${INR(totalPaid)}</h2></div>
            <div class="summary-card"><p>TOTAL RETURNS (MRP)</p><h2>${INR(totalReturns)}</h2></div>
            <div class="summary-card"><p>REMAINING BALANCE</p><h2>${INR(totalBilled - totalPaid)}</h2></div>
        `;
        
        let allTransactions = [];
        companyInvoices.forEach(i => allTransactions.push({ date: i.date, type: 'invoice', data: i }));
        companyPayments.forEach(p => allTransactions.push({ date: p.date, type: 'payment', data: p }));
        companyReturns.forEach(r => allTransactions.push({ date: r.returnDate, type: 'return', data: r }));
        
        allTransactions.sort((a,b) => getDateFromStr(a.date) - getDateFromStr(b.date));

        companyReportTableBody.innerHTML = '';
        allTransactions.forEach((tx, i) => {
            const tr = document.createElement('tr');
            let details = '', amount = '', status = '', moreDetails = '';
            if (tx.type === 'invoice') {
                details = 'PURCHASE BILL';
                amount = `<span class="currency">${INR(tx.data.amount)}</span>`;
                const { status: invStatus } = f_computeStatus(tx.data);
                status = `<span class="${getStatus3dClass(invStatus)}">${toUpper(invStatus)}</span>`;
            } else if (tx.type === 'payment') {
                details = `PAYMENT RECEIVED VIA ${formatPaymentType(tx.data.type)}`;
                amount = `<span class="currency">${INR(tx.data.amount)}</span>`;
                status = `<span class="text-3d-blue">RECEIVED</span>`;
                if(tx.data.checkNo) moreDetails = `Check No: ${toUpper(tx.data.checkNo)}`;
                if(tx.data.creditNoteNo) moreDetails = `Credit Note No: ${toUpper(tx.data.creditNoteNo)}`;
            } else if (tx.type === 'return') {
                details = `RETURN ITEM: ${toUpper(tx.data.itemName)} (x${tx.data.quantity})`;
                amount = `<span class="currency">${INR(tx.data.quantity * tx.data.mrp)}</span> (MRP)`;
                status = tx.data.creditNoteNo ? `<span class="text-3d-blue">ADJUSTED</span>` : `<span class="text-3d-red">PENDING CREDIT</span>`;
            }
            tr.innerHTML = `
                <td><span class="text-3d">${i+1}</span></td>
                <td>${f_formatDate(tx.date)}</td>
                <td>${tx.data.invoiceNo ? makeInvoiceLink(tx.data.invoiceNo) : '-'}</td>
                <td><span class="text-3d">${details}</span></td>
                <td>${amount}</td>
                <td>${status}</td>
                <td><span class="text-3d">${moreDetails}</span></td>
            `;
            companyReportTableBody.appendChild(tr);
        });

        companyResultsCard.style.display = 'block';
        playBeep();
        speak('Company report generated successfully.');
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('Company Report', { body: `Report generated for ${toUpper(company)}.`, icon: '/favicon.ico' });
        }
    });

    async function exportCompanyReportToPdf(preview) {
        const company = companyReportSelect.value;
        if (!company) return;

        const companyInvoices = f_invoices.filter(i => toUpper(i.supplier) === toUpper(company));
        const invoiceNos = companyInvoices.map(i => i.invoiceNo);
        const companyPayments = f_payments.filter(p => invoiceNos.includes(p.invoiceNo));
        const companyReturns = f_returns.filter(r => toUpper(r.companyName) === toUpper(company));

        let allTransactions = [];
        companyInvoices.forEach(i => allTransactions.push({ date: i.date, type: 'invoice', data: i }));
        companyPayments.forEach(p => allTransactions.push({ date: p.date, type: 'payment', data: p }));
        companyReturns.forEach(r => allTransactions.push({ date: r.returnDate, type: 'return', data: r }));
        
        allTransactions.sort((a,b) => getDateFromStr(a.date) - getDateFromStr(b.date));
        
        const title = `Transaction Report for ${toUpper(company)}`;
        const head = [['SL', 'Date', 'Invoice No', 'Details', 'Amount', 'Status', 'More Details']];
        const body = allTransactions.map((tx, i) => {
            let details = '', amount = '', status = '', moreDetails = '';
            if (tx.type === 'invoice') {
                details = 'PURCHASE BILL';
                amount = INR(tx.data.amount);
                const { status: invStatus } = f_computeStatus(tx.data);
                status = toUpper(invStatus);
            } else if (tx.type === 'payment') {
                details = `PAYMENT RECEIVED VIA ${toUpper(tx.data.type)}`;
                amount = INR(tx.data.amount);
                status = 'RECEIVED';
                if(tx.data.checkNo) moreDetails = `Check No: ${toUpper(tx.data.checkNo)}`;
                if(tx.data.creditNoteNo) moreDetails = `Credit Note No: ${toUpper(tx.data.creditNoteNo)}`;
            } else if (tx.type === 'return') {
                details = `RETURN ITEM: ${toUpper(tx.data.itemName)} (x${tx.data.quantity})`;
                amount = `${INR(tx.data.quantity * tx.data.mrp)} (MRP)`;
                status = tx.data.creditNoteNo ? 'ADJUSTED' : 'PENDING CREDIT';
            }
            return [i+1, tx.date, tx.data.invoiceNo || '-', details, amount, status, moreDetails];
        });
        
        const filename = `company_report_${company}_${new Date().toISOString().slice(0, 10)}.pdf`;
        await exportPdf(title, head, body, preview, filename);
    }

    /* ---------------- Filters & Pagination ---------------- */
    const currentPages = {};
    const reportConfig = {
        invoices: {
            data: () => f_invoices,
            render: f_renderReport,
            paginationEl: document.getElementById('f-reportPagination'),
            filter: (inv) => {
                const company = document.getElementById('f-inv-companyFilter').value;
                const status = document.getElementById('f-statusFilter').value;
                const from = document.getElementById('f-inv-fromDate').value;
                const to = document.getElementById('f-inv-toDate').value;
                const search = toUpper(document.getElementById('f-searchBox').value);

                return (!company || inv.supplier === company) &&
                    (!status || status === 'all' || f_computeStatus(inv).status === status) &&
                    within(inv.date, from, to) &&
                    (!search || toUpper(inv.invoiceNo).includes(search));
            },
            sort: (a,b) => getDateFromStr(b.date) - getDateFromStr(a.date),
            indicator: document.getElementById('f-inv-filter-indicator')
        },
        returns: {
            data: () => f_returns,
            render: f_renderReturnReport,
            paginationEl: document.getElementById('f-returnPagination'),
            filter: (item) => {
                const company = document.getElementById('f-return-companyFilter').value;
                const from = document.getElementById('f-return-fromDate').value;
                const to = document.getElementById('f-return-toDate').value;
                return (!company || item.companyName === company) && within(item.returnDate, from, to);
            },
            sort: (a,b) => getDateFromStr(b.returnDate) - getDateFromStr(a.returnDate),
            indicator: document.getElementById('f-return-filter-indicator')
        },
        defectiveChecks: {
            data: () => f_defectiveChecks,
            render: f_renderDefectiveCheckReport,
            paginationEl: document.getElementById('f-defectiveCheckPagination'),
            filter: (item) => {
                const from = document.getElementById('f-defective-fromDate').value;
                const to = document.getElementById('f-defective-toDate').value;
                return within(item.date, from, to);
            },
            sort: (a,b) => getDateFromStr(b.date) - getDateFromStr(a.date),
            indicator: document.getElementById('f-defective-filter-indicator')
        },
        expenses: {
            data: () => f_expenses,
            render: f_renderExpenseReport,
            paginationEl: document.getElementById('f-expensePagination'),
            filter: (exp) => {
                const from = document.getElementById('f-exp-fromDate').value;
                const to = document.getElementById('f-exp-toDate').value;
                const search = toUpper(document.getElementById('f-expenseSearchBox').value);
                return within(exp.date, from, to) && (!search || toUpper(exp.name).includes(search));
            },
            sort: (a,b) => getDateFromStr(b.date) - getDateFromStr(a.date),
            indicator: document.getElementById('f-exp-filter-indicator')
        },
        income: {
            data: () => f_incomes,
            render: f_renderIncomeReport,
            paginationEl: document.getElementById('f-incomePagination'),
            filter: (inc) => {
                const from = document.getElementById('f-inc-fromDate').value;
                const to = document.getElementById('f-inc-toDate').value;
                return within(inc.date, from, to);
            },
            sort: (a,b) => getDateFromStr(b.date) - getDateFromStr(a.date),
            indicator: document.getElementById('f-inc-filter-indicator')
        },
        gst: {
            data: () => g_lines,
            render: f_renderGstReport,
            paginationEl: document.getElementById('g-billingPagination'),
            filter: (line) => {
                const from = document.getElementById('g-gst-fromDate').value;
                const to = document.getElementById('g-gst-toDate').value;
                const payment = document.getElementById('g-gst-paymentFilter').value;
                const tax = document.getElementById('g-gst-taxFilter').value;
                return within(line.date, from, to) &&
                       (payment === 'all' || line.payment === payment) &&
                       (tax === 'all' || line.taxRate == tax);
            },
            sort: (a,b) => getDateFromStr(b.date) - getDateFromStr(a.date),
            indicator: document.getElementById('g-gst-filter-indicator')
        },
        checkManagement: {
            data: () => getCheckManagementData(),
            render: renderCheckManagement,
            paginationEl: document.getElementById('check-management-pagination'),
            filter: (item) => {
                const fromDate = document.getElementById('check-management-from-date').value;
                const toDate = document.getElementById('check-management-to-date').value;
                const company = document.getElementById('check-management-company-filter').value;
                const status = document.getElementById('check-management-status-filter').value;
                const search = toUpper(document.getElementById('check-management-search-box').value);

                return within(item.date, fromDate, toDate) &&
                       (!company || (item.invoice !== '-' && f_invoices.find(i => i.invoiceNo === item.invoice)?.supplier === company)) &&
                       (!status || item.status === status) &&
                       (!search || toUpper(item.no).includes(search) || (item.invoice !== '-' && toUpper(item.invoice).includes(search)));
            },
            sort: (a,b) => getDateFromStr(b.date) - getDateFromStr(a.date),
            indicator: document.getElementById('check-management-filter-indicator')
        },
        companies: {
            data: () => f_parties,
            render: renderCompanyManagement,
            paginationEl: document.getElementById('company-list-pagination'),
            filter: null,
            sort: null,
            indicator: null
        }
    };
    
    function renderPagination(reportKey, totalItems, currentPage, rowsPerPage = 10) { // Smoothed: increased rows per page
        const config = reportConfig[reportKey];
        if (!config || !config.paginationEl) return;
        
        const totalPages = Math.ceil(totalItems / rowsPerPage);
        config.paginationEl.innerHTML = '';
        if (totalPages <= 1) return;

        // Previous button
        const prevBtn = document.createElement('button');
        prevBtn.className = 'pagination-btn';
        prevBtn.textContent = '¬´';
        prevBtn.disabled = currentPage === 1;
        prevBtn.addEventListener('click', () => { applyFiltersAndRender(reportKey, currentPage - 1); });
        config.paginationEl.appendChild(prevBtn);

        // Page buttons
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);
        if (currentPage <= 3) endPage = Math.min(5, totalPages);
        if (currentPage > totalPages - 3) startPage = Math.max(1, totalPages - 4);

        if (startPage > 1) {
            const firstBtn = document.createElement('button');
            firstBtn.className = 'pagination-btn'; firstBtn.textContent = '1';
            firstBtn.addEventListener('click', () => { applyFiltersAndRender(reportKey, 1); });
            config.paginationEl.appendChild(firstBtn);
            if (startPage > 2) config.paginationEl.insertAdjacentHTML('beforeend', `<span>...</span>`);
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.className = 'pagination-btn';
            pageBtn.textContent = i;
            if (i === currentPage) pageBtn.classList.add('active');
            pageBtn.addEventListener('click', () => { applyFiltersAndRender(reportKey, i); });
            config.paginationEl.appendChild(pageBtn);
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) config.paginationEl.insertAdjacentHTML('beforeend', `<span>...</span>`);
            const lastBtn = document.createElement('button');
            lastBtn.className = 'pagination-btn'; lastBtn.textContent = totalPages;
            lastBtn.addEventListener('click', () => { applyFiltersAndRender(reportKey, totalPages); });
            config.paginationEl.appendChild(lastBtn);
        }

        // Next button
        const nextBtn = document.createElement('button');
        nextBtn.className = 'pagination-btn';
        nextBtn.textContent = '¬ª';
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.addEventListener('click', () => { applyFiltersAndRender(reportKey, currentPage + 1); });
        config.paginationEl.appendChild(nextBtn);
    }
    
    function applyFiltersAndRender(reportKey, page = 1) {
        const config = reportConfig[reportKey];
        if (!config) return;
        
        let filteredData = config.data();
        let filtersAreActive = false;
        const filterGroup = document.querySelector(`[data-filter-group="${reportKey}"]`);

        if (filterGroup) {
            const inputs = filterGroup.querySelectorAll('input, select');
            inputs.forEach(input => {
                if ((input.type === 'text' && input.value !== '') ||
                    (input.tagName === 'SELECT' && input.value !== '' && input.value !== 'all') ||
                    (input.type === 'date' && input.value !== '')) {
                    filtersAreActive = true;
                }
            });
        }
        
        if (config.filter) filteredData = filteredData.filter(config.filter);
        if (config.sort) filteredData.sort(config.sort);
        
        if (config.indicator) config.indicator.style.display = filtersAreActive ? 'inline-block' : 'none';

        currentPages[reportKey] = page;
        config.render(filteredData, page, 10); // Pass rowsPerPage = 10
        renderPagination(reportKey, filteredData.length, page, 10);
    }

    document.querySelectorAll('.filter-row').forEach(row => {
        const reportKey = row.dataset.filterGroup;
        if(reportKey) {
            row.addEventListener('input', debounce(() => applyFiltersAndRender(reportKey), 200)); // Smoothed debounce
        }
    });

    document.querySelectorAll('.reset-filters').forEach(btn => {
        btn.addEventListener('click', () => {
            const filterRow = btn.closest('.filter-row');
            if (filterRow) {
                filterRow.querySelectorAll('input, select').forEach(el => {
                    if(el.tagName === 'SELECT') el.value = el.querySelector('option[value=""], option[value="all"]')?.value || '';
                    else el.value = '';
                });
                const reportKey = filterRow.dataset.filterGroup;
                if(reportKey) applyFiltersAndRender(reportKey);
            }
        });
    });

    function renderAllTables() {
        Object.keys(reportConfig).forEach(key => applyFiltersAndRender(key));
    }
    
    /* ---------------- Company Management in Settings ---------------- */
    function initCompanyManagement() {
        currentPages['companies'] = 1; // Added
        renderCompanyManagement(f_parties);
    }

    function updateAllAfterPartyChange() {
        updatePartyList();
        updateCompanyReportDropdown();
        updatePurchaseBillCompanyFilter();
        renderCompanyListForSettings();
        persistAll();
    }

    function renderCompanyListForSettings() {
        // This function was missing, now added
        initCompanyManagement();
    }

    /* ---------------- Auto Refresh ---------------- */
    let autoRefreshTimer = null;
    let autoRefreshCounter = 0;

    function initAutoRefreshSettings() {
        const enabledCheckbox = document.getElementById('autoRefreshEnabled');
        const settingsDiv = document.getElementById('autoRefreshSettings');
        const intervalInput = document.getElementById('autoRefreshInterval');
        const countInput = document.getElementById('autoRefreshCount');

        const ar = appSettings.autoRefresh || { enabled: false, interval: 600, count: 0 }; // Increased default interval to 600s
        enabledCheckbox.checked = ar.enabled;
        settingsDiv.style.display = ar.enabled ? 'block' : 'block'; // Always visible now
        intervalInput.value = ar.interval;
        countInput.value = ar.count;
        
        enabledCheckbox.addEventListener('change', e => {
            ar.enabled = e.target.checked;
            // settingsDiv.style.display = ar.enabled ? 'block' : 'none'; // Removed hide
            appSettings.autoRefresh = ar;
            saveAppSettings();
            if (ar.enabled) startAutoRefresh(); else stopAutoRefresh();
        });
        
        intervalInput.addEventListener('change', () => {
            ar.interval = parseInt(intervalInput.value, 10);
            if (ar.interval < 10) ar.interval = 10;
            intervalInput.value = ar.interval;
            appSettings.autoRefresh = ar;
            saveAppSettings();
            if (ar.enabled) startAutoRefresh();
        });
        
        countInput.addEventListener('change', () => {
            ar.count = parseInt(countInput.value, 10);
            appSettings.autoRefresh = ar;
            saveAppSettings();
            if (ar.enabled) startAutoRefresh();
        });

        if (ar.enabled) startAutoRefresh();
    }
    
    function startAutoRefresh() {
        stopAutoRefresh();
        const ar = appSettings.autoRefresh;
        if (!ar.enabled) return;
        
        autoRefreshCounter = ar.count;
        autoRefreshTimer = setInterval(() => {
            if (ar.count > 0) {
                autoRefreshCounter--;
                if (autoRefreshCounter < 0) {
                    stopAutoRefresh();
                    document.getElementById('autoRefreshEnabled').checked = false;
                    ar.enabled = false;
                    saveAppSettings();
                    showToast('Auto-refresh finished');
                    return;
                }
            }
            showToast('Auto-refreshing...');
            precomputePaymentStatus();
            renderAllTables();
            const fromDate = document.getElementById('dashboardFromDate').value;
            const toDate = document.getElementById('dashboardToDate').value;
            const companyFilter = document.getElementById('dashboardCompanyFilter').value;
            updateDashboard(fromDate, toDate, companyFilter);
            playBeep();
            speak('Dashboard auto-refreshed.');
            if ('Notification' in window && Notification.permission === 'granted') {
              new Notification('Auto Refresh', { body: 'Dashboard data has been refreshed.', icon: '/favicon.ico' });
            }
        }, ar.interval * 1000);
    }
    
    function stopAutoRefresh() {
        if (autoRefreshTimer) {
            clearInterval(autoRefreshTimer);
            autoRefreshTimer = null;
        }
    }

    // ---------------- Currency Amount Color Selector ----------------
    const currencyColorSelector = document.getElementById('currencyColorSelector');
    const CURRENCY_COLOR_KEY = 'ui.currencyColor';

    function loadCurrencyColor() {
        try {
            const raw = localStorage.getItem(CURRENCY_COLOR_KEY);
            return raw || '#138808'; // Default green
        } catch(e){ return '#138808'; }
    }

    function saveCurrencyColor(color) {
        localStorage.setItem(CURRENCY_COLOR_KEY, JSON.stringify(color));
    }

    function populateCurrencyColorSelector() {
        if (!currencyColorSelector) return;
        currencyColorSelector.innerHTML = `
            <option value="#138808">Green (Default)</option>
            <option value="#ff9933">Saffron</option>
            <option value="#2345a0">Navy</option>
            <option value="#ffffff">White</option>
            <option value="#000000">Black</option>
            <option value="#111111">Dark Gray</option>
            <option value="#ff0000">Red</option>
            <option value="#00ff00">Green</option>
            <option value="#0000ff">Blue</option>
            <option value="#ffff00">Yellow</option>
            <option value="#ff00ff">Magenta</option>
            <option value="#00ffff">Cyan</option>
            <option value="#800080">Purple</option>
            <option value="#ffa500">Orange</option>
            <option value="#ffc0cb">Pink</option>
            <option value="#a52a2a">Brown</option>
            <option value="#808080">Gray</option>
            <option value="#800000">Maroon</option>
            <option value="#808000">Olive</option>
            <option value="#008080">Teal</option>
            <option value="#000080">Navy</option>
            <option value="#ffffe0">Light Yellow</option>
            <option value="#87ceeb">Sky Blue</option>
            <option value="#dc143c">Crimson</option>
            <option value="#00ff7f">Spring Green</option>
            <option value="#ff1493">Deep Pink</option>
            <option value="#00bfff">Deep Sky Blue</option>
            <option value="#ff6347">Tomato</option>
            <option value="#daa520">Golden Rod</option>
            <option value="#8b0000">Dark Red</option>
            <option value="#556b2f">Dark Olive Green</option>
            <option value="#ff4500">Orange Red</option>
            <option value="#9370db">Medium Purple</option>
            <option value="#32cd32">Lime Green</option>
            <option value="#8a2be2">Blue Violet</option>
            <option value="#5f9ea0">Cadet Blue</option>
            <option value="#d2691e">Chocolate</option>
            <option value="#6495ed">Cornflower Blue</option>
            <option value="#ffb6c1">Light Pink</option>
            <option value="#daa520">Golden Rod</option>
            <option value="#b0c4de">Light Steel Blue</option>
            <option value="#ffff00">Yellow</option>
            <option value="#00ff00">Lime</option>
            <option value="#800080">Indigo</option>
            <option value="#800080">Violet</option>
            <option value="#ffd700">Gold</option>
            <option value="#c0c0c0">Silver</option>
            <option value="#daa520">Dark Golden Rod</option>
            <option value="#98fb98">Pale Green</option>
            <option value="#f0e68c">Khaki</option>
            <option value="#dda0dd">Plum</option>
            <option value="#b0e0e6">Powder Blue</option>
            <option value="#a0522d">Sienna</option>
            <option value="#87ceeb">Sky Blue</option>
            <option value="#6b8e23">Olive Drab</option>
            <option value="#708090">Slate Gray</option>
            <option value="#00ff7f">Spring Green</option>
            <option value="#4682b4">Steel Blue</option>
            <option value="#d2b48c">Tan</option>
            <option value="#008080">Teal</option>
            <option value="#d8bfd8">Thistle</option>
            <option value="#ff6347">Tomato</option>
            <option value="#40e0d0">Turquoise</option>
            <option value="#ee82ee">Violet</option>
            <option value="#f5deb3">Wheat</option>
            <option value="#ffffff">White Smoke</option>
        `;
        currencyColorSelector.value = loadCurrencyColor();
        ROOT.style.setProperty('--amount-color', currencyColorSelector.value);
    }

    if (currencyColorSelector) {
        populateCurrencyColorSelector();
        currencyColorSelector.addEventListener('change', (e) => {
            const selectedColor = e.target.value;
            ROOT.style.setProperty('--amount-color', selectedColor);
            saveCurrencyColor(selectedColor);
            showToast('Currency color updated');
        });
    }

    // ---------------- Title Color Selector ----------------
    const titleColorSelector = document.getElementById('titleColorSelector');
    const TITLE_COLOR_KEY = 'ui.titleColor';

    function loadTitleColor() {
        try {
            const raw = localStorage.getItem(TITLE_COLOR_KEY);
            return raw || '#ffffff'; // Default white
        } catch(e){ return '#ffffff'; }
    }

    function saveTitleColor(color) {
        localStorage.setItem(TITLE_COLOR_KEY, color);
    }

    function applyTitleColor(color) {
        const appTitle = document.getElementById('typed-title');
        if (appTitle) {
            appTitle.style.color = color;
        }
    }

    if (titleColorSelector) {
        titleColorSelector.value = loadTitleColor();
        applyTitleColor(loadTitleColor());
        titleColorSelector.addEventListener('change', (e) => {
            const selectedColor = e.target.value;
            applyTitleColor(selectedColor);
            saveTitleColor(selectedColor);
            showToast('Title color updated');
        });
    }

    // ---------------- Button Style Selector ----------------
    const buttonStyleSelector = document.getElementById('buttonStyleSelector');
    const BUTTON_STYLE_KEY = 'ui.buttonStyle';

    function loadButtonStyle() {
        try {
            const raw = localStorage.getItem(BUTTON_STYLE_KEY);
            return raw || 'default';
        } catch(e){ return 'default'; }
    }

    function saveButtonStyle(style) {
        localStorage.setItem(BUTTON_STYLE_KEY, style);
    }

    function applyButtonStyle(style) {
        document.body.dataset.buttonStyle = style;
    }

    if (buttonStyleSelector) {
        buttonStyleSelector.value = loadButtonStyle();
        applyButtonStyle(loadButtonStyle());
        buttonStyleSelector.addEventListener('change', (e) => {
            const style = e.target.value;
            applyButtonStyle(style);
            saveButtonStyle(style);
            showToast('Button style updated');
        });
    }

    // ---------------- Hindu Tilak Selector ----------------
    const selectHinduTilak = document.getElementById('selectHinduTilak');
    const HINDU_TILAK_KEY = 'ui.hinduTilak';

    function loadHinduTilak() {
        try {
            const raw = localStorage.getItem(HINDU_TILAK_KEY);
            return raw || '‡•ê'; // Default Om
        } catch(e){ return '‡•ê'; }
    }

    function saveHinduTilak(symbol) {
        localStorage.setItem(HINDU_TILAK_KEY, symbol);
    }

    function applyHinduTilak(symbol) {
        const hinduTilak = document.getElementById('hinduTilak');
        if (hinduTilak) {
            hinduTilak.textContent = symbol;
        }
    }

    if (selectHinduTilak) {
        selectHinduTilak.value = loadHinduTilak();
        applyHinduTilak(loadHinduTilak());
        selectHinduTilak.addEventListener('change', (e) => {
            const symbol = e.target.value;
            applyHinduTilak(symbol);
            saveHinduTilak(symbol);
            showToast('Hindu Tilak updated');
        });
    }

    // ---------------- Hindu Tilak Color Selector ----------------
    const hinduTilakColorSelector = document.getElementById('hinduTilakColorSelector');
    const HINDU_TILAK_COLOR_KEY = 'ui.hinduTilakColor';

    function loadHinduTilakColor() {
        try {
            const raw = localStorage.getItem(HINDU_TILAK_COLOR_KEY);
            return raw || '#ffd700'; // Default Gold
        } catch(e){ return '#ffd700'; }
    }

    function saveHinduTilakColor(color) {
        localStorage.setItem(HINDU_TILAK_COLOR_KEY, color);
    }

    function applyHinduTilakColor(color) {
        const hinduTilak = document.getElementById('hinduTilak');
        if (hinduTilak) {
            hinduTilak.style.color = color;
            // Update text-shadow based on color for glow effect
            hinduTilak.style.textShadow = `0 0 20px ${color}80, 0 0 40px ${color}50`;
        }
    }

    if (hinduTilakColorSelector) {
        hinduTilakColorSelector.value = loadHinduTilakColor();
        applyHinduTilakColor(loadHinduTilakColor());
        hinduTilakColorSelector.addEventListener('change', (e) => {
            const color = e.target.value;
            applyHinduTilakColor(color);
            saveHinduTilakColor(color);
            showToast('Hindu Tilak Color updated');
        });
    }

    // ---------------- Show Hindu Logo Checkbox ----------------
    const showHinduLogoCheckbox = document.getElementById('showHinduLogo');
    const SHOW_HINDU_LOGO_KEY = 'ui.showHinduLogo';

    function loadShowHinduLogo() {
        try {
            const raw = localStorage.getItem(SHOW_HINDU_LOGO_KEY);
            return raw ? JSON.parse(raw) : false; // Default false
        } catch(e){ return false; }
    }

    function saveShowHinduLogo(enabled) {
        localStorage.setItem(SHOW_HINDU_LOGO_KEY, JSON.stringify(enabled));
    }

    function applyShowHinduLogo(enabled) {
        const hinduTilak = document.getElementById('hinduTilak');
        if (hinduTilak) {
            hinduTilak.style.display = enabled ? 'block' : 'none';
        }
    }

    if (showHinduLogoCheckbox) {
        showHinduLogoCheckbox.checked = loadShowHinduLogo();
        applyShowHinduLogo(loadShowHinduLogo());
        showHinduLogoCheckbox.addEventListener('change', (e) => {
            const enabled = e.target.checked;
            applyShowHinduLogo(enabled);
            saveShowHinduLogo(enabled);
            showToast(enabled ? 'Hindu Tilak shown above title' : 'Hindu Tilak hidden');
        });
    }

    // ---------------- New Color Selectors for SL, DAYS, DAYS AGO, PENDING ----------------
    const slColorSelector = document.getElementById('slColorSelector');
    const daysColorSelector = document.getElementById('daysColorSelector');
    const daysAgoColorSelector = document.getElementById('daysAgoColorSelector');
    const pendingColorSelector = document.getElementById('pendingColorSelector');

    const SL_COLOR_KEY = 'ui.slColor';
    const DAYS_COLOR_KEY = 'ui.daysColor';
    const DAYS_AGO_COLOR_KEY = 'ui.daysAgoColor';
    const PENDING_COLOR_KEY = 'ui.pendingColor';

    function loadSLColor() {
        try {
            const raw = localStorage.getItem(SL_COLOR_KEY);
            return raw || '#111111'; // Default dark gray
        } catch(e){ return '#111111'; }
    }

    function saveSLColor(color) {
        localStorage.setItem(SL_COLOR_KEY, color);
    }

    function applySLColor(color) {
        ROOT.style.setProperty('--sl-color', color);
    }

    function loadDaysColor() {
        try {
            const raw = localStorage.getItem(DAYS_COLOR_KEY);
            return raw || '#b95f00'; // Default orange
        } catch(e){ return '#b95f00'; }
    }

    function saveDaysColor(color) {
        localStorage.setItem(DAYS_COLOR_KEY, color);
    }

    function applyDaysColor(color) {
        ROOT.style.setProperty('--days-color', color);
    }

    function loadDaysAgoColor() {
        try {
            const raw = localStorage.getItem(DAYS_AGO_COLOR_KEY);
            return raw || '#b95f00'; // Default orange
        } catch(e){ return '#b95f00'; }
    }

    function saveDaysAgoColor(color) {
        localStorage.setItem(DAYS_AGO_COLOR_KEY, color);
    }

    function applyDaysAgoColor(color) {
        ROOT.style.setProperty('--days-ago-color', color);
    }

    function loadPendingColor() {
        try {
            const raw = localStorage.getItem(PENDING_COLOR_KEY);
            return raw || '#d92525'; // Default red
        } catch(e){ return '#d92525'; }
    }

    function savePendingColor(color) {
        localStorage.setItem(PENDING_COLOR_KEY, color);
    }

    function applyPendingColor(color) {
        ROOT.style.setProperty('--danger-color', color);
    }

    function populateColorSelector(selector, defaultColor) {
        if (!selector) return;
        selector.innerHTML = `
            <option value="#111111">Dark Gray (Default)</option>
            <option value="#000000">Black</option>
            <option value="#ffffff">White</option>
            <option value="#ff0000">Red</option>
            <option value="#00ff00">Green</option>
            <option value="#0000ff">Blue</option>
            <option value="#ffff00">Yellow</option>
            <option value="#ff00ff">Magenta</option>
            <option value="#00ffff">Cyan</option>
            <option value="#800080">Purple</option>
            <option value="#ffa500">Orange</option>
            <option value="#ffc0cb">Pink</option>
            <option value="#a52a2a">Brown</option>
            <option value="#808080">Gray</option>
            <option value="#800000">Maroon</option>
            <option value="#808000">Olive</option>
            <option value="#008080">Teal</option>
            <option value="#000080">Navy</option>
            <option value="#ffffe0">Light Yellow</option>
            <option value="#87ceeb">Sky Blue</option>
            <option value="#dc143c">Crimson</option>
            <option value="#00ff7f">Spring Green</option>
            <option value="#ff1493">Deep Pink</option>
            <option value="#00bfff">Deep Sky Blue</option>
            <option value="#ff6347">Tomato</option>
            <option value="#daa520">Golden Rod</option>
            <option value="#8b0000">Dark Red</option>
            <option value="#556b2f">Dark Olive Green</option>
            <option value="#ff4500">Orange Red</option>
            <option value="#9370db">Medium Purple</option>
            <option value="#32cd32">Lime Green</option>
            <option value="#8a2be2">Blue Violet</option>
            <option value="#5f9ea0">Cadet Blue</option>
            <option value="#d2691e">Chocolate</option>
            <option value="#6495ed">Cornflower Blue</option>
            <option value="#ffb6c1">Light Pink</option>
            <option value="#daa520">Golden Rod</option>
            <option value="#b0c4de">Light Steel Blue</option>
            <option value="#ffff00">Yellow</option>
            <option value="#00ff00">Lime</option>
            <option value="#800080">Indigo</option>
            <option value="#800080">Violet</option>
            <option value="#ffd700">Gold</option>
            <option value="#c0c0c0">Silver</option>
            <option value="#daa520">Dark Golden Rod</option>
            <option value="#98fb98">Pale Green</option>
            <option value="#f0e68c">Khaki</option>
            <option value="#dda0dd">Plum</option>
            <option value="#b0e0e6">Powder Blue</option>
            <option value="#a0522d">Sienna</option>
            <option value="#87ceeb">Sky Blue</option>
            <option value="#6b8e23">Olive Drab</option>
            <option value="#708090">Slate Gray</option>
            <option value="#00ff7f">Spring Green</option>
            <option value="#4682b4">Steel Blue</option>
            <option value="#d2b48c">Tan</option>
            <option value="#008080">Teal</option>
            <option value="#d8bfd8">Thistle</option>
            <option value="#ff6347">Tomato</option>
            <option value="#40e0d0">Turquoise</option>
            <option value="#ee82ee">Violet</option>
            <option value="#f5deb3">Wheat</option>
            <option value="#ffffff">White Smoke</option>
        `;
        selector.value = defaultColor;
    }

    if (slColorSelector) {
        populateColorSelector(slColorSelector, loadSLColor());
        applySLColor(loadSLColor());
        slColorSelector.addEventListener('change', (e) => {
            const color = e.target.value;
            applySLColor(color);
            saveSLColor(color);
            showToast('SL Text Color updated');
        });
    }

    if (daysColorSelector) {
        populateColorSelector(daysColorSelector, loadDaysColor());
        applyDaysColor(loadDaysColor());
        daysColorSelector.addEventListener('change', (e) => {
            const color = e.target.value;
            applyDaysColor(color);
            saveDaysColor(color);
            showToast('Days Text Color updated');
        });
    }

    if (daysAgoColorSelector) {
        populateColorSelector(daysAgoColorSelector, loadDaysAgoColor());
        applyDaysAgoColor(loadDaysAgoColor());
        daysAgoColorSelector.addEventListener('change', (e) => {
            const color = e.target.value;
            applyDaysAgoColor(color);
            saveDaysAgoColor(color);
            showToast('Days Ago Text Color updated');
        });
    }

    if (pendingColorSelector) {
        populateColorSelector(pendingColorSelector, loadPendingColor());
        applyPendingColor(loadPendingColor());
        pendingColorSelector.addEventListener('change', (e) => {
            const color = e.target.value;
            applyPendingColor(color);
            savePendingColor(color);
            showToast('Pending Text Color updated');
        });
    }

    // ---------------- Quick Search in Dashboard ----------------
    function performQuickSearch() {
        const invoiceQuery = document.getElementById('quickSearchInvoice').value.trim();
        const checkQuery = document.getElementById('quickSearchCheck').value.trim();
        const resultEl = document.getElementById('quickSearchResult');
        resultEl.innerHTML = '';

        if (invoiceQuery) {
            showInvoiceDetails(invoiceQuery, resultEl);
        } else if (checkQuery) {
            const payment = f_payments.find(p => p.type === 'check' && p.checkNo === checkQuery);
            if (!payment) {
                resultEl.innerHTML = `<p class="muted">CHECK NO. <strong class="text-3d">${checkQuery}</strong> NOT FOUND.</p>`;
                return;
            }

            const invoice = f_invoices.find(i => i.invoiceNo === payment.invoiceNo);
            let paymentTypeText = '';
            if (payment.type === 'check') {
                paymentTypeText = `CHECK NUMBER: ${payment.checkNo}`;
            } else if (payment.type === 'cash') {
                paymentTypeText = 'CASH IN HAND PAYMENT PAID';
            } else {
                paymentTypeText = formatPaymentType(payment.type);
            }
            let html = `<h4>DETAILS FOR CHECK NO: <span class="text-3d">${checkQuery}</span></h4>
                        <p><strong>SL NO:</strong> <span class="text-3d">1</span></p>
                        <p><strong>COMPANY NAME:</strong> <span class="company-text">${invoice ? toUpper(invoice.supplier) : '-'}</span></p>
                        <p><strong>INVOICE NUMBER:</strong> ${invoice ? makeInvoiceLink(invoice.invoiceNo) : '-'}</p>
                        <p><strong>DATE:</strong> ${f_formatDate(payment.date)}</p>
                        <p><strong>AMOUNT:</strong> <span class="currency">${INR(payment.amount)}</span></p>
                        <p><strong>PAYMENT TYPE:</strong> ${paymentTypeText}</p>`;
            resultEl.innerHTML = DOMPurify.sanitize(html);
        } else {
            resultEl.innerHTML = `<p class="muted">Enter an invoice or check number to search.</p>`;
        }
    }

    const quickSearchForm = document.getElementById('quickSearchForm');
    if (quickSearchForm) {
        // Remove submit event, add input events for auto-search
        quickSearchForm.addEventListener('input', debounce(performQuickSearch, 500)); // Auto search on input with debounce
    }

    /* ---------------- Init & startup ---------------- */
    function initInputUppercase() {
        document.querySelectorAll('input[type="text"], input[type="email"]').forEach(input => {
            if (input.id.includes('password') || input.id.includes('security-answer') || input.id === 'profile-address') return; // Exclude address
            input.addEventListener('input', (e) => {
                const start = e.target.selectionStart;
                const end = e.target.selectionEnd;
                e.target.value = toUpper(e.target.value);
                e.target.setSelectionRange(start, end);
            });
        });
    }
    
    async function initialRender() {
      await loadSavedFolder(); // Added back to load saved folder on startup
      initAppSettingsControls();
      initInputUppercase();
      
      if (appSettings.lockScreenEnabled) {
        showLockScreen();
      }
      const loaded = await loadAll();
      if (loaded) {
        showSection(allSections.dashboard, allTabs.dashboard);
      }
      updateTypedTitle();
    }

    initialRender();

    // Run auto fix on load if enabled
    if (appSettings.autoFixEnabled) runAutoFix();

    function runAutoFix() {
        // Placeholder for auto fix logic
        // This would validate dates, ensure positive amounts, remove duplicates, trim names, etc.
        // For now, just log
        console.log('Running auto fix');
        const fixes = [];
        // Fix dates
        f_invoices.forEach(inv => {
            if (!inv.date || !/^\d{4}-\d{2}-\d{2}$/.test(inv.date)) {
                inv.date = new Date().toISOString().slice(0,10);
                fixes.push(`Fixed date for invoice ${inv.invoiceNo}`);
            }
        });
        // Fix amounts
        f_invoices.forEach(inv => {
            if (inv.amount < 0) inv.amount = Math.abs(inv.amount);
        });
        f_payments.forEach(p => {
            if (p.amount < 0) p.amount = Math.abs(p.amount);
        });
        // Trim names
        f_parties = f_parties.map(p => p.trim());
        f_invoices.forEach(inv => {
            inv.supplier = inv.supplier.trim();
        });
        // Remove duplicates
        f_parties = [...new Set(f_parties)];
        // Update UI
        updateAllUI();
        persistAll();
        const autoFixResults = document.getElementById('autoFixResults');
        if (autoFixResults) {
            autoFixResults.style.display = 'block';
            const list = document.getElementById('autoFixList');
            if (list) {
                list.innerHTML = fixes.map(f => `<li>${f}</li>`).join('');
            }
        }
    }

    // Add SAVE UI SETTINGS button handler
    document.getElementById('saveUiSettings').addEventListener('click', () => {
        showToast('UI Settings Saved Successfully!');
    });

    // Update Edit Payment Select function
    function updateEditPaymentSelect() {
        populateEditPaymentSelect();
    }

    // Call updateEditPaymentSelect in relevant places
    // Added to f_paymentForm submit and f_editPaymentForm submit
    // Also in updateAllUI
  </script>
</body>
</html>